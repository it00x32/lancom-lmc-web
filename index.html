<!DOCTYPE html>
<html lang="de">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>LANCOM Management Cloud</title>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
<style>
:root {
  --bg:      #01091e;
  --bg2:     #061528;
  --card:    #091c32;
  --card2:   #0d2038;
  --border:  rgba(45,95,255,.18);
  --border2: rgba(45,95,255,.30);
  --accent:  #2d5fff;
  --accent2: #aadaf7;
  --green:   #a0ed3a;
  --red:     #ff004d;
  --amber:   #77c8d2;
  --blue:    #aadaf7;
  --purple:  #2d5fff;
  --teal:    #77c8d2;
  --pink:    #77c8d2;
  --text:    #e2e8f0;
  --text2:   #94a3b8;
  --text3:   #475569;
  --r:       10px;
  --shadow:  0 4px 32px rgba(0,0,0,.5);
}
*{box-sizing:border-box;margin:0;padding:0;}
body{background:var(--bg);background-image:radial-gradient(ellipse 80% 60% at 10% 0%,rgba(45,95,255,.1) 0%,transparent 60%),radial-gradient(ellipse 60% 50% at 90% 100%,rgba(170,218,247,.06) 0%,transparent 60%);color:var(--text);font-family:'Segoe UI',-apple-system,BlinkMacSystemFont,sans-serif;min-height:100vh;}

/* ── LOGIN ─────────────────────────────────────────── */
#login-screen{display:flex;align-items:center;justify-content:center;min-height:100vh;padding:24px;}
.login-card{background:var(--card);border:1px solid var(--border2);border-radius:20px;box-shadow:var(--shadow),0 0 60px rgba(45,95,255,.15);padding:48px 40px;width:100%;max-width:420px;animation:fadeUp .4s ease;}
.login-logo{text-align:center;margin-bottom:32px;}
.login-logo .logo-icon{width:64px;height:64px;border-radius:16px;background:linear-gradient(135deg,var(--accent),var(--blue));display:inline-flex;align-items:center;justify-content:center;font-size:28px;color:#fff;margin-bottom:16px;box-shadow:0 0 30px rgba(45,95,255,.4);}
.login-logo h1{font-size:22px;font-weight:700;}
.login-logo p{font-size:13px;color:var(--text2);margin-top:4px;}
.form-group{margin-bottom:20px;}
.form-group label{display:block;font-size:11px;font-weight:700;color:var(--text2);margin-bottom:8px;letter-spacing:.08em;text-transform:uppercase;}
.form-group input{width:100%;padding:13px 16px;background:var(--bg2);border:1px solid var(--border);border-radius:var(--r);color:var(--text);font-size:14px;outline:none;transition:border-color .2s,box-shadow .2s;font-family:'Courier New',monospace;}
.form-group input:focus{border-color:var(--accent);box-shadow:0 0 0 3px rgba(45,95,255,.2);}
.form-group input::placeholder{color:var(--text3);}
.save-token-row{display:flex;align-items:center;gap:10px;margin-bottom:20px;}
.toggle-switch{position:relative;width:36px;height:20px;flex-shrink:0;}
.toggle-switch input{opacity:0;width:0;height:0;position:absolute;}
.toggle-slider{position:absolute;inset:0;cursor:pointer;background:var(--card2);border:1px solid var(--border2);border-radius:20px;transition:background .2s,border-color .2s;}
.toggle-slider:before{content:'';position:absolute;width:14px;height:14px;left:2px;top:2px;background:var(--text3);border-radius:50%;transition:transform .2s,background .2s;}
.toggle-switch input:checked+.toggle-slider{background:var(--accent);border-color:var(--accent);}
.toggle-switch input:checked+.toggle-slider:before{transform:translateX(16px);background:#fff;}
.save-token-label{font-size:13px;color:var(--text2);cursor:pointer;user-select:none;}
.btn-primary{width:100%;padding:14px;background:linear-gradient(135deg,var(--accent),#001d41);border:none;border-radius:var(--r);color:#fff;font-size:15px;font-weight:700;cursor:pointer;transition:opacity .2s,transform .1s,box-shadow .2s;box-shadow:0 4px 20px rgba(45,95,255,.4);letter-spacing:.03em;}
.btn-primary:hover{opacity:.9;}
.btn-primary:active{transform:scale(.98);}
.btn-primary:disabled{opacity:.5;cursor:not-allowed;}
.login-error{background:rgba(255,0,77,.12);border:1px solid rgba(255,0,77,.3);border-radius:8px;padding:12px 14px;color:#ff8099;font-size:13px;margin-bottom:20px;display:none;}

/* ── ACCOUNT PICKER ─────────────────────────────── */
#account-picker{display:none;position:fixed;inset:0;z-index:500;background:rgba(1,9,30,.9);backdrop-filter:blur(8px);align-items:center;justify-content:center;}
.picker-card{background:var(--card);border:1px solid var(--border2);border-radius:20px;padding:32px;width:420px;max-height:85vh;box-shadow:var(--shadow);animation:fadeUp .3s ease;display:flex;flex-direction:column;}
.picker-card h2{font-size:18px;font-weight:700;margin-bottom:6px;flex-shrink:0;}
.picker-card p{color:var(--text2);font-size:13px;margin-bottom:24px;flex-shrink:0;}
.account-list{display:flex;flex-direction:column;gap:10px;overflow-y:auto;flex:1;min-height:0;padding-right:4px;}
.account-list::-webkit-scrollbar{width:5px;}
.account-list::-webkit-scrollbar-track{background:transparent;}
.account-list::-webkit-scrollbar-thumb{background:var(--border2);border-radius:3px;}
.account-item{display:flex;align-items:center;gap:14px;padding:14px 16px;background:var(--bg2);border:1px solid var(--border);border-radius:var(--r);cursor:pointer;transition:all .2s;}
.account-item:hover{border-color:var(--accent);background:rgba(45,95,255,.08);}
.account-item .acc-icon{width:36px;height:36px;border-radius:8px;background:rgba(45,95,255,.15);color:var(--accent);display:flex;align-items:center;justify-content:center;font-size:14px;}
.account-item .acc-name{font-size:14px;font-weight:600;}
.account-item .acc-id{font-size:11px;color:var(--text2);font-family:monospace;margin-top:2px;}

/* ── LOADING ─────────────────────────────────────── */
#loading-overlay{position:fixed;inset:0;z-index:999;background:rgba(1,9,30,.85);backdrop-filter:blur(8px);display:flex;flex-direction:column;align-items:center;justify-content:center;gap:20px;}
.spinner{width:48px;height:48px;border-radius:50%;border:3px solid var(--border2);border-top-color:var(--accent);animation:spin .8s linear infinite;}
.loading-text{color:var(--text2);font-size:14px;}

/* ── APP SHELL ───────────────────────────────────── */
#app{display:none;height:100vh;flex-direction:column;overflow:hidden;}

/* ── HEADER ─────────────────────────────────────── */
.header{position:sticky;top:0;z-index:100;background:rgba(1,9,30,.9);backdrop-filter:blur(20px);border-bottom:1px solid var(--border);padding:0 24px;height:58px;display:flex;align-items:center;gap:12px;}
.header-logo{display:flex;align-items:center;gap:10px;flex-shrink:0;margin-right:4px;}
.header-logo .logo-badge{width:34px;height:34px;border-radius:9px;background:linear-gradient(135deg,var(--accent),var(--blue));display:flex;align-items:center;justify-content:center;font-size:15px;color:#fff;}
.header-logo .logo-text{font-weight:700;font-size:14px;line-height:1.2;}
.header-logo .logo-text span{display:block;font-size:11px;color:var(--text2);font-weight:400;}
.header-account{display:flex;align-items:center;gap:7px;background:var(--card);border:1px solid var(--border);border-radius:7px;padding:5px 11px;}
.header-account .dot{width:7px;height:7px;border-radius:50%;background:var(--green);animation:pulse 2s infinite;}
.header-account .name{font-size:13px;font-weight:600;}
.header-spacer{flex:1;}
.sync-info{font-size:12px;color:var(--text2);white-space:nowrap;}
#countdown{color:var(--accent2);font-weight:600;}
#refresh-select{background:var(--bg2);border:1px solid var(--border);border-radius:6px;color:var(--text1);font-size:12px;padding:4px 8px;cursor:pointer;outline:none;height:34px;}
#refresh-select:hover{border-color:var(--accent);}
#refresh-select option{background:var(--bg2);}
.icon-btn{width:34px;height:34px;border-radius:7px;background:var(--card);border:1px solid var(--border);color:var(--text2);cursor:pointer;font-size:13px;display:flex;align-items:center;justify-content:center;transition:all .2s;}
.icon-btn:hover{border-color:var(--accent);color:var(--accent);background:rgba(45,95,255,.1);}

/* ── TRAFFIC MONITOR ────────────────────────────── */
.traffic-grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(290px,1fr));gap:14px;padding:0 24px 24px;overflow-y:auto;}
.tc{background:var(--card);border:1px solid var(--border);border-radius:12px;padding:16px;transition:border-color .2s;}
.tc:hover{border-color:var(--border2);}
.tc-dev{font-size:12px;font-weight:700;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;}
.tc-if{font-size:11px;color:var(--text2);margin-top:2px;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;}
.tc-rates{display:flex;gap:18px;margin:10px 0 8px;}
.tc-rate{font-size:14px;font-weight:700;font-variant-numeric:tabular-nums;line-height:1.2;}
.tc-rate-lbl{font-size:10px;font-weight:400;color:var(--text3);letter-spacing:.04em;}
.tc-spark{width:100%;height:54px;display:block;overflow:visible;}
.tc-scale{display:flex;justify-content:space-between;font-size:9px;color:var(--text3);margin-top:2px;opacity:.7;}
.tc-offline{opacity:.45;}

/* ── SETTINGS ───────────────────────────────────── */
.settings-wrap{padding:24px;max-width:600px;}
.settings-card{background:var(--card);border:1px solid var(--border);border-radius:12px;padding:20px 24px;margin-bottom:20px;}
.settings-card-title{font-size:13px;font-weight:700;color:var(--text);margin-bottom:18px;display:flex;align-items:center;gap:8px;}
.settings-card-title i{color:var(--accent2);}
.settings-row{display:grid;grid-template-columns:160px 1fr;align-items:start;gap:12px;margin-bottom:16px;}
.settings-row:last-child{margin-bottom:0;}
.settings-label{font-size:11px;font-weight:700;color:var(--text2);text-transform:uppercase;letter-spacing:.08em;padding-top:9px;}
.settings-input{width:100%;background:var(--bg2);border:1px solid var(--border);border-radius:8px;color:var(--text);font-size:13px;padding:8px 12px;outline:none;transition:border-color .2s;}
.settings-input:focus{border-color:var(--accent);box-shadow:0 0 0 2px rgba(45,95,255,.15);}
.settings-hint{font-size:11px;color:var(--text3);margin-top:5px;line-height:1.4;}
.settings-save-btn{background:var(--accent);border:none;border-radius:8px;color:#fff;font-size:13px;font-weight:700;padding:8px 22px;cursor:pointer;transition:opacity .2s;}
.settings-save-btn:hover{opacity:.85;}

/* ── SIDEBAR LAYOUT ──────────────────────────────── */
.app-body{display:flex;flex:1;overflow:hidden;}
.sidebar{width:216px;flex-shrink:0;background:var(--bg2);border-right:1px solid var(--border);display:flex;flex-direction:column;overflow:hidden;transition:width .22s ease;}
.sidebar.collapsed{width:54px;}
.sidebar-header{display:flex;align-items:center;justify-content:flex-end;padding:10px 10px 6px;flex-shrink:0;}
.sidebar.collapsed .sidebar-header{justify-content:center;}
.sidebar-toggle-btn{width:28px;height:28px;border-radius:6px;border:1px solid var(--border);background:var(--card);color:var(--text3);cursor:pointer;display:flex;align-items:center;justify-content:center;font-size:11px;transition:all .2s;flex-shrink:0;}
.sidebar-toggle-btn:hover{border-color:var(--accent);color:var(--accent);background:rgba(45,95,255,.08);}
.sidebar-nav{flex:1;overflow-y:auto;overflow-x:hidden;padding:0 8px 8px;}
.sidebar-nav::-webkit-scrollbar{width:3px;}
.sidebar-nav::-webkit-scrollbar-thumb{background:var(--border2);border-radius:2px;}
.sidebar-group-label{font-size:9px;font-weight:700;color:var(--text3);text-transform:uppercase;letter-spacing:.1em;padding:12px 10px 4px;white-space:nowrap;overflow:hidden;transition:opacity .15s;}
.sidebar.collapsed .sidebar-group-label{opacity:0;padding:12px 0 4px;}
.tab-btn{display:flex;align-items:center;gap:9px;padding:7px 10px;border-radius:8px;border:none;background:none;color:var(--text2);font-size:13px;font-weight:500;cursor:pointer;width:100%;white-space:nowrap;overflow:hidden;transition:background .15s,color .15s;position:relative;margin-bottom:1px;}
.tab-btn:hover{background:rgba(255,255,255,.05);color:var(--text);}
.tab-btn.active{background:rgba(45,95,255,.13);color:var(--accent);font-weight:600;}
.tb-icon{width:20px;height:20px;display:flex;align-items:center;justify-content:center;font-size:13px;flex-shrink:0;}
.tab-btn .tb-label{flex:1;text-align:left;overflow:hidden;text-overflow:ellipsis;transition:opacity .15s,width .15s;}
.sidebar.collapsed .tb-label{opacity:0;width:0;font-size:0;}
.tab-badge{background:rgba(45,95,255,.2);color:var(--accent2);font-size:10px;font-weight:700;padding:1px 6px;border-radius:10px;min-width:18px;text-align:center;flex-shrink:0;transition:opacity .15s;}
.sidebar.collapsed .tab-badge{opacity:0;width:0;padding:0;}
.tab-btn.active .tab-badge{background:rgba(45,95,255,.35);}
.sidebar-sep{height:1px;background:var(--border);margin:6px 2px;}
.sidebar-bottom{padding:8px;flex-shrink:0;border-top:1px solid var(--border);}
/* Tooltip in collapsed mode */
.sidebar.collapsed .tab-btn{justify-content:center;}
.sidebar.collapsed .tab-btn::after{content:attr(data-tooltip);position:fixed;left:62px;background:var(--card2,#1e2235);border:1px solid var(--border2);border-radius:7px;padding:5px 11px;font-size:12px;font-weight:500;color:var(--text);white-space:nowrap;opacity:0;pointer-events:none;z-index:2000;transform:translateY(-50%);box-shadow:0 4px 20px rgba(0,0,0,.4);}
.sidebar.collapsed .tab-btn:hover::after{opacity:1;}
.content-area{flex:1;overflow:hidden;display:flex;flex-direction:column;}
.tab-section{display:none;flex:1;overflow:auto;}
.tab-section.active{display:flex;flex-direction:column;}

/* ── STATS BAR ───────────────────────────────────── */
.stats-bar{display:grid;grid-template-columns:repeat(auto-fill,minmax(130px,1fr));gap:10px;padding:16px 24px 10px;}
.stat-card{background:var(--card);border:1px solid var(--border);border-radius:var(--r);padding:14px 16px;display:flex;align-items:center;gap:12px;transition:border-color .2s,transform .15s;}
.stat-card:hover{border-color:var(--border2);transform:translateY(-1px);}
.stat-icon{width:38px;height:38px;border-radius:9px;display:flex;align-items:center;justify-content:center;font-size:15px;flex-shrink:0;}
.stat-val{font-size:24px;font-weight:800;line-height:1;font-variant-numeric:tabular-nums;}
.stat-lbl{font-size:10px;color:var(--text2);margin-top:2px;font-weight:600;text-transform:uppercase;letter-spacing:.04em;}
.si-total  {background:rgba(45,95,255,.15);color:var(--accent);}
.si-online {background:rgba(160,237,58,.15); color:var(--green);}
.si-offline{background:rgba(255,0,77,.15); color:var(--red);}
.si-alert  {background:rgba(119,200,210,.15);color:var(--amber);}
.si-fw     {background:rgba(170,218,247,.15);color:var(--blue);}
.si-cfg    {background:rgba(45,95,255,.15);color:var(--purple);}
.si-wlan   {background:rgba(119,200,210,.15);color:var(--teal);}
.sv-total  {color:var(--text);}
.sv-online {color:var(--green);}
.sv-offline{color:var(--red);}
.sv-alert  {color:var(--amber);}
.sv-fw     {color:var(--blue);}
.sv-cfg    {color:var(--purple);}
.sv-wlan   {color:var(--teal);}

/* ── TOOLBAR ─────────────────────────────────────── */
.toolbar{display:flex;align-items:center;gap:10px;padding:6px 24px 12px;flex-wrap:wrap;}
.toolbar-title{font-size:14px;font-weight:700;color:var(--text2);}
.toolbar-count{background:var(--card2);border:1px solid var(--border);border-radius:20px;padding:2px 10px;font-size:12px;font-weight:600;color:var(--accent2);}
.toolbar-spacer{flex:1;}
.filter-group{display:flex;gap:4px;}
.filter-btn{padding:5px 13px;border-radius:20px;font-size:12px;font-weight:600;border:1px solid var(--border);background:transparent;color:var(--text2);cursor:pointer;transition:all .2s;}
.filter-btn:hover,.filter-btn.active{background:var(--accent);border-color:var(--accent);color:#fff;}
.search-box{display:flex;align-items:center;gap:7px;background:var(--card);border:1px solid var(--border);border-radius:7px;padding:5px 11px;}
.search-box i{color:var(--text3);font-size:12px;}
.search-box input{background:none;border:none;outline:none;color:var(--text);font-size:13px;width:160px;}
.search-box input::placeholder{color:var(--text3);}

/* ── DEVICE GRID ─────────────────────────────────── */
.device-grid{display:grid;padding:0 24px 24px;grid-template-columns:repeat(auto-fill,minmax(340px,1fr));gap:14px;}
.device-card{background:var(--card);border:1px solid var(--border);border-radius:var(--r);overflow:hidden;transition:border-color .2s,transform .15s,box-shadow .2s;animation:fadeUp .3s ease;}
.device-card:hover{border-color:var(--border2);transform:translateY(-2px);box-shadow:0 8px 40px rgba(0,0,0,.4);}
.device-card.offline{border-color:rgba(255,0,77,.2);}
.device-card.alert{border-color:rgba(119,200,210,.3);}
.card-header{padding:14px 16px 12px;border-bottom:1px solid rgba(255,255,255,.05);display:flex;align-items:flex-start;gap:10px;}
.device-icon{width:38px;height:38px;border-radius:9px;flex-shrink:0;display:flex;align-items:center;justify-content:center;font-size:16px;}
.device-icon.online {background:rgba(160,237,58,.15);color:var(--green);}
.device-icon.offline{background:rgba(255,0,77,.15);color:var(--red);}
.card-header-info{flex:1;min-width:0;}
.device-name{font-size:13px;font-weight:700;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;}
.device-site{font-size:11px;color:var(--text2);margin-top:2px;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;}
.card-badges{display:flex;gap:4px;align-items:flex-start;flex-shrink:0;flex-wrap:wrap;justify-content:flex-end;}
.badge{display:inline-flex;align-items:center;gap:3px;padding:2px 7px;border-radius:20px;font-size:10px;font-weight:700;letter-spacing:.02em;white-space:nowrap;}
.badge-online {background:rgba(160,237,58,.15); color:var(--green); border:1px solid rgba(160,237,58,.25);}
.badge-offline{background:rgba(255,0,77,.15); color:var(--red);   border:1px solid rgba(255,0,77,.25);}
.badge-alert  {background:rgba(119,200,210,.15);color:var(--amber); border:1px solid rgba(119,200,210,.3);}
.badge-fw-old {background:rgba(170,218,247,.12);color:var(--blue);  border:1px solid rgba(170,218,247,.2);}
.badge-fw-ok  {background:rgba(160,237,58,.12); color:#4ade80;      border:1px solid rgba(160,237,58,.2);}
.badge-cfg-old{background:rgba(45,95,255,.12);color:#c084fc;      border:1px solid rgba(45,95,255,.2);}
.badge-cfg-ok {background:rgba(160,237,58,.12); color:#4ade80;      border:1px solid rgba(160,237,58,.2);}
.card-body{padding:12px 16px;}
.info-grid{display:grid;grid-template-columns:1fr 1fr;gap:8px 14px;}
.info-row{display:flex;flex-direction:column;gap:1px;min-width:0;}
.info-row.full{grid-column:1/-1;}
.info-lbl{font-size:9px;font-weight:700;color:var(--text3);text-transform:uppercase;letter-spacing:.06em;}
.info-val{font-size:12px;font-weight:500;color:var(--text);white-space:nowrap;overflow:hidden;text-overflow:ellipsis;}
.info-val.mono{font-family:'Courier New',monospace;font-size:11px;}
.card-footer{padding:10px 16px;border-top:1px solid rgba(255,255,255,.05);display:flex;flex-direction:column;gap:5px;}
.card-footer-primary{display:flex;gap:5px;}
.card-footer-secondary{display:flex;gap:5px;}
.action-btn{display:inline-flex;align-items:center;gap:5px;padding:6px 10px;border-radius:7px;font-size:11px;font-weight:600;border:1px solid;cursor:pointer;transition:all .2s;flex:1;min-width:0;justify-content:center;}
.action-btn.icon-only{flex:0 0 auto;padding:6px 11px;}
.action-btn:disabled{opacity:.35;cursor:not-allowed;}
.btn-reboot{background:rgba(255,0,77,.1);border-color:rgba(255,0,77,.25);color:#ff8099;}
.btn-reboot:hover:not(:disabled){background:rgba(255,0,77,.2);border-color:rgba(255,0,77,.5);}
.btn-fw{background:rgba(170,218,247,.1);border-color:rgba(170,218,247,.25);color:var(--blue);}
.btn-fw:hover:not(:disabled){background:rgba(170,218,247,.2);border-color:rgba(170,218,247,.5);}
.btn-cfg{background:rgba(45,95,255,.1);border-color:rgba(45,95,255,.25);color:#c084fc;}
.btn-cfg:hover:not(:disabled){background:rgba(45,95,255,.2);border-color:rgba(45,95,255,.5);}
.btn-snmp{background:rgba(119,200,210,.1);border-color:rgba(119,200,210,.25);color:var(--teal);}
.btn-snmp:hover:not(:disabled){background:rgba(119,200,210,.2);border-color:rgba(119,200,210,.5);}
.snmp-card-debug{padding:8px 14px 10px;border-top:1px solid rgba(255,255,255,.05);font-size:11px;line-height:1.6;word-break:break-word;color:var(--text2);display:none;}

/* ── DATA TABLES ─────────────────────────────────── */
.table-wrap{padding:0 24px 24px;overflow:auto;}
.data-table{width:100%;border-collapse:collapse;font-size:13px;}
.data-table th{padding:10px 12px;text-align:left;font-size:10px;font-weight:700;color:var(--text3);text-transform:uppercase;letter-spacing:.07em;background:var(--card2);border-bottom:1px solid var(--border);white-space:nowrap;position:sticky;top:0;}
.data-table th:first-child{border-radius:var(--r) 0 0 0;}
.data-table th:last-child{border-radius:0 var(--r) 0 0;}
.data-table td{padding:9px 12px;border-bottom:1px solid rgba(255,255,255,.04);vertical-align:middle;color:var(--text);}
.data-table tr:hover td{background:rgba(45,95,255,.05);}
.data-table tr:last-child td{border-bottom:none;}
.data-table .mono{font-family:'Courier New',monospace;font-size:11px;color:var(--text2);}
.data-table .muted{color:var(--text2);}
.data-table .device-ref{font-weight:600;font-size:12px;}
.table-section{background:var(--card);border:1px solid var(--border);border-radius:var(--r);overflow:hidden;}
.table-header{padding:14px 16px 10px;display:flex;align-items:center;gap:10px;border-bottom:1px solid var(--border);}
.table-header h3{font-size:13px;font-weight:700;}
.table-header .count{font-size:11px;color:var(--accent2);background:rgba(45,95,255,.15);padding:2px 8px;border-radius:10px;font-weight:600;}
.table-header-spacer{flex:1;}
.table-search{display:flex;align-items:center;gap:6px;background:var(--bg2);border:1px solid var(--border);border-radius:6px;padding:4px 10px;}
.table-search i{color:var(--text3);font-size:11px;}
.table-search input{background:none;border:none;outline:none;color:var(--text);font-size:12px;width:140px;}
.table-search input::placeholder{color:var(--text3);}

/* ── MINI STAT CARDS (per tab) ───────────────────── */
.mini-stats{display:flex;gap:10px;padding:12px 24px 0;flex-wrap:wrap;}
.mini-stat{background:var(--card);border:1px solid var(--border);border-radius:var(--r);padding:10px 16px;display:flex;align-items:center;gap:10px;}
.mini-stat .ms-icon{width:30px;height:30px;border-radius:7px;display:flex;align-items:center;justify-content:center;font-size:13px;}
.mini-stat .ms-val{font-size:20px;font-weight:800;line-height:1;}
.mini-stat .ms-lbl{font-size:10px;color:var(--text2);font-weight:600;text-transform:uppercase;}

/* ── BAND BADGES ─────────────────────────────────── */
.band-24{background:rgba(170,218,247,.15);color:var(--blue);border:1px solid rgba(170,218,247,.25);padding:2px 7px;border-radius:5px;font-size:10px;font-weight:700;}
.band-5 {background:rgba(45,95,255,.15);color:var(--purple);border:1px solid rgba(45,95,255,.25);padding:2px 7px;border-radius:5px;font-size:10px;font-weight:700;}
.band-6 {background:rgba(119,200,210,.15);color:var(--teal);border:1px solid rgba(119,200,210,.25);padding:2px 7px;border-radius:5px;font-size:10px;font-weight:700;}

/* ── STATUS DOTS ─────────────────────────────────── */
.sdot{display:inline-flex;align-items:center;gap:5px;font-size:12px;}
.sdot:before{content:'';width:7px;height:7px;border-radius:50%;flex-shrink:0;}
.sdot-green:before{background:var(--green);box-shadow:0 0 6px var(--green);}
.sdot-red:before{background:var(--red);}
.sdot-amber:before{background:var(--amber);}
.sdot-blue:before{background:var(--blue);}

/* ── SIGNAL BAR ─────────────────────────────────── */
.signal-bar{display:flex;align-items:flex-end;gap:2px;height:16px;}
.signal-bar span{display:block;width:4px;border-radius:1px;background:var(--border2);}
.signal-bar.s1 span:nth-child(1),.signal-bar.s2 span:nth-child(-n+2),.signal-bar.s3 span:nth-child(-n+3),.signal-bar.s4 span{background:var(--green);}
.signal-bar.s1 span:nth-child(1){background:var(--red);}
.signal-bar.s2 span:nth-child(-n+2){background:var(--amber);}
.signal-bar span:nth-child(1){height:4px;}
.signal-bar span:nth-child(2){height:7px;}
.signal-bar span:nth-child(3){height:11px;}
.signal-bar span:nth-child(4){height:16px;}

/* ── EMPTY STATE ─────────────────────────────────── */
.empty-state{text-align:center;padding:60px 40px;color:var(--text2);}
.empty-state i{font-size:40px;color:var(--text3);margin-bottom:12px;display:block;}
.empty-state h3{font-size:16px;font-weight:700;color:var(--text);margin-bottom:6px;}
.empty-state p{font-size:13px;}

/* ── TOAST ───────────────────────────────────────── */
#toast-container{position:fixed;bottom:24px;right:24px;z-index:9999;display:flex;flex-direction:column;gap:8px;pointer-events:none;}
.toast{display:flex;align-items:center;gap:10px;background:var(--card2);border:1px solid var(--border2);border-radius:var(--r);padding:12px 16px;min-width:260px;max-width:360px;box-shadow:var(--shadow);pointer-events:all;animation:slideIn .3s ease;}
.toast.success{border-color:rgba(160,237,58,.4);}
.toast.error{border-color:rgba(255,0,77,.4);}
.toast.info{border-color:rgba(45,95,255,.4);}
.toast-icon{font-size:16px;}
.toast.success .toast-icon{color:var(--green);}
.toast.error .toast-icon{color:var(--red);}
.toast.info .toast-icon{color:var(--accent);}
.toast-msg{font-size:12px;flex:1;line-height:1.4;}
.toast-msg strong{display:block;margin-bottom:1px;}
.toast.fade-out{animation:fadeOut .3s ease forwards;}

/* ── SITE GROUP HEADER ───────────────────────────── */
.site-header{grid-column:1/-1;display:flex;align-items:center;gap:10px;padding:8px 0 4px;margin-top:6px;}
.site-header:first-child{margin-top:0;}
.site-header-name{font-size:12px;font-weight:700;color:var(--text2);text-transform:uppercase;letter-spacing:.08em;}
.site-header-line{flex:1;height:1px;background:var(--border);}
.site-header-count{font-size:11px;color:var(--text3);background:var(--card2);border:1px solid var(--border);border-radius:10px;padding:1px 8px;}

/* ── SYNC BAR ────────────────────────────────────── */
.sync-bar{text-align:center;padding:6px;font-size:11px;color:var(--text3);border-top:1px solid rgba(255,255,255,.04);}

/* ── ANIMATIONS ──────────────────────────────────── */
@keyframes spin   {to{transform:rotate(360deg);}}
@keyframes pulse  {0%,100%{opacity:1;}50%{opacity:.4;}}
@keyframes fadeUp {from{opacity:0;transform:translateY(10px);}to{opacity:1;transform:none;}}
@keyframes slideIn{from{opacity:0;transform:translateX(20px);}to{opacity:1;transform:none;}}
@keyframes fadeOut{to{opacity:0;transform:translateX(20px);}}

/* ── TOPOLOGY ────────────────────────────────────── */
#tab-topology{background:var(--bg);overflow:hidden;min-height:0;}
#tab-topology:fullscreen{display:flex;flex-direction:column;background:var(--bg);}
#topo-wrap{flex:1;position:relative;overflow:hidden;min-height:0;height:0;}
#topo-svg{width:100%;height:100%;cursor:grab;display:block;background:radial-gradient(ellipse 70% 50% at 50% 50%,rgba(45,95,255,.04) 0%,transparent 70%);}
.topo-select{background:var(--card);border:1px solid var(--border);border-radius:7px;color:var(--text);padding:5px 10px;font-size:13px;outline:none;cursor:pointer;min-width:220px;font-family:inherit;transition:border-color .2s;}
.topo-select:focus{border-color:var(--accent);}
.topo-select option{background:var(--card2);}
.topo-node{cursor:pointer;}
.topo-node:hover .topo-node-rect{stroke-width:2.5px!important;}
.detail-section-title{font-size:10px;font-weight:700;color:var(--text3);text-transform:uppercase;letter-spacing:.08em;margin:14px 0 6px;padding-bottom:4px;border-bottom:1px solid var(--border);}
.detail-section-title:first-child{margin-top:0;}

/* ── RESPONSIVE ──────────────────────────────────── */
@media(max-width:900px){.stats-bar{grid-template-columns:repeat(3,1fr);} .device-grid{grid-template-columns:1fr;padding:0 12px 20px;}}
@media(max-width:600px){.stats-bar{grid-template-columns:repeat(2,1fr);padding:12px 12px 6px;} .toolbar{padding:6px 12px 10px;} .table-wrap{padding:0 12px 16px;} .mini-stats{padding:10px 12px 0;}}

/* ── LIGHT THEME ────────────────────────────────── */
[data-theme="light"]{--bg:#f1f5f9;--bg2:#e8edf5;--card:#ffffff;--card2:#f8fafc;--border:rgba(45,95,255,.14);--border2:rgba(45,95,255,.26);--text:#0f172a;--text2:#475569;--text3:#94a3b8;--shadow:0 4px 32px rgba(0,0,0,.10);}
[data-theme="light"] body{background-image:radial-gradient(ellipse 80% 60% at 10% 0%,rgba(45,95,255,.07) 0%,transparent 60%),radial-gradient(ellipse 60% 50% at 90% 100%,rgba(170,218,247,.04) 0%,transparent 60%);}
[data-theme="light"] .header{background:rgba(241,245,249,.95);}
[data-theme="light"] #loading-overlay{background:rgba(241,245,249,.88);}

/* ── GLOBAL SEARCH ──────────────────────────────── */
#search-overlay{display:none;position:fixed;inset:0;z-index:2000;background:rgba(1,9,30,.75);backdrop-filter:blur(12px);align-items:flex-start;justify-content:center;padding-top:72px;}
[data-theme="light"] #search-overlay{background:rgba(15,23,42,.5);}
.search-modal{background:var(--card);border:1px solid var(--border2);border-radius:16px;width:calc(100% - 40px);max-width:580px;box-shadow:var(--shadow),0 0 60px rgba(45,95,255,.2);overflow:hidden;animation:fadeUp .2s ease;}
.search-modal-input-wrap{display:flex;align-items:center;gap:12px;padding:16px 20px;border-bottom:1px solid var(--border);}
.search-modal-input{background:none;border:none;outline:none;color:var(--text);font-size:16px;flex:1;font-family:inherit;}
.search-modal-input::placeholder{color:var(--text3);}
.search-results{max-height:380px;overflow-y:auto;}
.search-result-item{display:flex;align-items:center;gap:12px;padding:11px 20px;cursor:pointer;transition:background .15s;}
.search-result-item:hover,.search-result-item.focused{background:rgba(45,95,255,.08);}
.search-result-icon{width:32px;height:32px;border-radius:8px;display:flex;align-items:center;justify-content:center;font-size:13px;flex-shrink:0;}
.search-result-name{font-size:13px;font-weight:600;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;}
.search-result-sub{font-size:11px;color:var(--text2);}
.search-result-badge{margin-left:auto;font-size:10px;font-weight:700;padding:2px 7px;border-radius:10px;background:var(--card2);border:1px solid var(--border);color:var(--text2);white-space:nowrap;flex-shrink:0;}
.search-hint{text-align:center;padding:32px;color:var(--text3);font-size:13px;}
.search-section-header{font-size:10px;font-weight:700;color:var(--text3);text-transform:uppercase;letter-spacing:.08em;padding:7px 20px 5px;background:var(--bg2);border-top:1px solid var(--border);}

/* ── ALERTS ─────────────────────────────────────── */
.alert-row-critical td{background:rgba(255,0,77,.04);}
.alert-row-warning td{background:rgba(119,200,210,.03);}
.alert-sev-critical{color:var(--red);font-weight:700;}
.alert-sev-warning{color:var(--amber);font-weight:700;}
.alert-sev-info{color:var(--blue);font-weight:700;}

/* ── SITE TILES ──────────────────────────────────── */
.site-tiles{display:flex;flex-wrap:wrap;gap:10px;padding:12px 24px 0;}
.site-tile{background:var(--card);border:1px solid var(--border);border-radius:var(--r);padding:14px 18px;cursor:pointer;transition:all .2s;min-width:130px;display:flex;flex-direction:column;gap:3px;animation:fadeUp .3s ease;}
.site-tile:hover{border-color:var(--accent);transform:translateY(-1px);box-shadow:0 4px 16px rgba(45,95,255,.15);}
.site-tile.active{border-color:var(--accent);background:rgba(45,95,255,.07);}
.site-tile-name{font-size:11px;font-weight:700;color:var(--text2);text-transform:uppercase;letter-spacing:.05em;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;}
.site-tile-count{font-size:26px;font-weight:800;color:var(--text);line-height:1.1;}
.site-tile-detail{font-size:10px;display:flex;gap:10px;margin-top:2px;}

/* ── MISC ────────────────────────────────────────── */
.offline-since{font-size:10px;color:var(--text3);margin-top:1px;}

/* ── CLIENT EXPLORER ────────────────────────────── */
.ce-search-card{margin:20px 24px 0;background:var(--card);border:1px solid var(--border2);border-radius:14px;padding:22px 26px;}
.ce-mac-input{background:var(--bg2);border:1px solid var(--border2);border-radius:10px;color:var(--text);font-size:17px;font-family:'Courier New',monospace;padding:12px 16px;outline:none;transition:border-color .2s,box-shadow .2s;letter-spacing:.04em;width:100%;max-width:460px;}
.ce-mac-input:focus{border-color:var(--accent);box-shadow:0 0 0 3px rgba(45,95,255,.15);}
.ce-mac-input::placeholder{color:var(--text3);font-family:'Segoe UI',sans-serif;font-size:14px;letter-spacing:normal;}
.ce-search-btn{background:linear-gradient(135deg,var(--accent),#001d41);border:none;border-radius:10px;color:#fff;font-size:14px;font-weight:700;padding:0 24px;height:48px;cursor:pointer;transition:opacity .2s;white-space:nowrap;box-shadow:0 4px 14px rgba(45,95,255,.35);}
.ce-search-btn:hover{opacity:.88;}
.ce-hit{background:var(--card);border:1px solid var(--border);border-radius:12px;padding:16px 20px;margin-bottom:10px;transition:border-color .2s;}
.ce-hit.direct{border-color:rgba(160,237,58,.45);background:rgba(160,237,58,.04);}
.ce-hit.via{opacity:.65;}
.ce-hit-device{font-size:15px;font-weight:700;}
.ce-hit-port{font-family:'Courier New',monospace;font-size:14px;font-weight:700;color:var(--accent2);}
.ce-field{display:flex;flex-direction:column;gap:2px;}
.ce-field-lbl{font-size:9px;font-weight:700;color:var(--text3);text-transform:uppercase;letter-spacing:.07em;}
.ce-field-val{font-size:13px;font-weight:600;}
.ce-scan-btn{background:rgba(45,95,255,.15);border:1px solid rgba(45,95,255,.3);border-radius:8px;color:var(--accent2);font-size:13px;font-weight:700;padding:8px 16px;cursor:pointer;transition:all .2s;white-space:nowrap;display:inline-flex;align-items:center;gap:7px;}
.ce-scan-btn:hover{background:rgba(45,95,255,.25);border-color:var(--accent);}
.ce-scan-btn:disabled{opacity:.4;cursor:not-allowed;}
.ce-prog-track{width:100px;height:5px;background:var(--border);border-radius:3px;overflow:hidden;}
.ce-prog-bar{height:100%;background:var(--accent);border-radius:3px;transition:width .4s;}
.ce-row-scanning td{background:rgba(45,95,255,.04)!important;}
#ce-mac-modal{display:none;position:fixed;inset:0;z-index:2000;background:rgba(1,9,30,.8);backdrop-filter:blur(10px);align-items:flex-start;justify-content:center;padding:24px 16px;}
.ce-mac-modal-box{background:var(--card2);border:1px solid var(--border2);border-radius:16px;width:100%;max-width:1100px;max-height:calc(100vh - 48px);display:flex;flex-direction:column;box-shadow:var(--shadow),0 0 60px rgba(45,95,255,.15);animation:fadeUp .2s ease;overflow:hidden;}
.ce-mac-modal-head{padding:18px 22px 14px;border-bottom:1px solid var(--border);display:flex;align-items:center;gap:12px;flex-shrink:0;}
.ce-mac-modal-search{background:var(--bg2);border:1px solid var(--border);border-radius:8px;color:var(--text);font-size:13px;padding:7px 12px;outline:none;flex:1;max-width:280px;transition:border-color .2s;}
.ce-mac-modal-search:focus{border-color:var(--accent);}
.ce-mac-modal-body{overflow-y:auto;flex:1;}
.ce-row-done td{background:transparent;}
.ce-row-error td{background:rgba(255,0,77,.03)!important;}

/* ── BULK ACTION BAR ─────────────────────────────── */
#bulk-bar{position:fixed;bottom:0;left:0;right:0;z-index:200;background:rgba(13,18,39,.97);border-top:1px solid var(--accent);backdrop-filter:blur(12px);padding:10px 24px;display:none;align-items:center;gap:10px;animation:slideUp .25s ease;}
@keyframes slideUp{from{transform:translateY(100%);}to{transform:none;}}
.bulk-sel-count{font-size:14px;font-weight:700;color:var(--accent2);white-space:nowrap;}
.bulk-btn{display:inline-flex;align-items:center;gap:6px;padding:7px 14px;border-radius:7px;font-size:12px;font-weight:600;border:1px solid;cursor:pointer;transition:all .2s;white-space:nowrap;}
.bulk-btn-red{background:rgba(255,0,77,.1);border-color:rgba(255,0,77,.3);color:#ff8099;}
.bulk-btn-red:hover{background:rgba(255,0,77,.2);}
.bulk-btn-blue{background:rgba(170,218,247,.1);border-color:rgba(170,218,247,.3);color:var(--blue);}
.bulk-btn-blue:hover{background:rgba(170,218,247,.2);}
.bulk-btn-purple{background:rgba(45,95,255,.1);border-color:rgba(45,95,255,.3);color:#c084fc;}
.bulk-btn-purple:hover{background:rgba(45,95,255,.2);}
.bulk-btn-gray{background:rgba(255,255,255,.06);border-color:var(--border);color:var(--text2);}
.bulk-btn-gray:hover{background:rgba(255,255,255,.1);}
.card-select{position:absolute;top:10px;right:10px;z-index:5;display:none;width:20px;height:20px;}
.bulk-mode .card-select{display:flex;align-items:center;justify-content:center;}
.bulk-mode .device-card{cursor:pointer;user-select:none;}
.device-card.bulk-selected{border-color:var(--accent)!important;box-shadow:0 0 0 2px rgba(45,95,255,.3);}
.device-card .card-header{position:relative;}

/* ── ACTION STATUS MODAL ─────────────────────────── */
#action-modal{display:none;position:fixed;inset:0;z-index:3500;background:rgba(0,0,0,.7);backdrop-filter:blur(8px);align-items:center;justify-content:center;}
.action-modal-box{background:var(--card);border:1px solid var(--border2);border-radius:16px;width:min(560px,96vw);max-height:80vh;display:flex;flex-direction:column;box-shadow:var(--shadow),0 0 60px rgba(45,95,255,.15);animation:fadeUp .25s ease;}
.action-device-row{display:flex;align-items:center;gap:10px;padding:8px 16px;border-bottom:1px solid rgba(255,255,255,.04);}
.action-device-status{width:22px;text-align:center;font-size:13px;flex-shrink:0;}

/* ── CONFIG PREVIEW MODAL ────────────────────────── */
#cfg-preview-modal{display:none;position:fixed;inset:0;z-index:3500;background:rgba(0,0,0,.7);backdrop-filter:blur(8px);align-items:center;justify-content:center;}

/* ── VARIABLES MODAL ─────────────────────────────── */
#vars-modal{display:none;position:fixed;inset:0;z-index:3500;background:rgba(0,0,0,.7);backdrop-filter:blur(8px);align-items:center;justify-content:center;}
.var-row{display:grid;grid-template-columns:180px 1fr 90px;gap:10px;padding:8px 0;border-bottom:1px solid rgba(255,255,255,.05);align-items:center;}
.var-row:last-child{border-bottom:none;}
.var-val-input{background:rgba(255,255,255,.06);border:1px solid var(--border);border-radius:7px;color:var(--text);padding:6px 10px;font-size:12px;outline:none;width:100%;}
.var-val-input:focus{border-color:var(--accent);}

/* ── FIRMWARE TAB ─────────────────────────────────── */
.fw-group{background:var(--card);border:1px solid var(--border);border-radius:var(--r);overflow:hidden;margin-bottom:14px;}
.fw-group-header{padding:12px 18px;border-bottom:1px solid var(--border);display:flex;align-items:center;gap:12px;flex-wrap:wrap;}
.fw-group-label{font-size:13px;font-weight:700;font-family:'Courier New',monospace;color:var(--text);}

/* ── SITES TAB ───────────────────────────────────── */
.sites-grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(260px,1fr));gap:14px;padding:16px 24px 24px;}
.site-card{background:var(--card);border:1px solid var(--border);border-radius:var(--r);padding:18px 20px;transition:all .2s;cursor:pointer;animation:fadeUp .3s ease;}
.site-card:hover{border-color:var(--accent);transform:translateY(-2px);box-shadow:0 8px 32px rgba(0,0,0,.3);}
.site-card-name{font-size:15px;font-weight:700;margin-bottom:12px;display:flex;align-items:center;gap:8px;}
.site-stat-row{display:flex;gap:20px;flex-wrap:wrap;}
.site-stat{display:flex;flex-direction:column;gap:2px;}
.site-stat-val{font-size:22px;font-weight:800;line-height:1;}
.site-stat-lbl{font-size:10px;color:var(--text2);text-transform:uppercase;letter-spacing:.04em;font-weight:600;}

/* ── BTN WEBCONFIG / PREVIEW ─────────────────────── */
.btn-web{background:rgba(119,200,210,.1);border-color:rgba(119,200,210,.25);color:var(--teal);}
.btn-web:hover:not(:disabled){background:rgba(119,200,210,.2);border-color:rgba(119,200,210,.5);}
.btn-preview{background:rgba(45,95,255,.08);border-color:rgba(45,95,255,.2);color:var(--accent2);}
.btn-preview:hover:not(:disabled){background:rgba(45,95,255,.15);border-color:rgba(45,95,255,.4);}

/* ── MAC BLACKLIST ───────────────────────────────── */
.btn-block{font-size:11px;padding:3px 8px;border-radius:6px;border:1px solid rgba(255,0,77,.3);background:rgba(255,0,77,.08);color:var(--red);cursor:pointer;white-space:nowrap;transition:background .15s,border-color .15s;}
.btn-block:hover{background:rgba(255,0,77,.18);border-color:rgba(255,0,77,.6);}
.btn-block.blocked{border-color:rgba(160,237,58,.3);background:rgba(160,237,58,.08);color:var(--green);}
.btn-block.blocked:hover{background:rgba(160,237,58,.18);border-color:rgba(160,237,58,.6);}
.blacklist-panel{margin:16px 0 4px;background:var(--card);border:1px solid var(--border2);border-radius:12px;overflow:hidden;}
.blacklist-header{display:flex;align-items:center;gap:8px;padding:12px 16px;border-bottom:1px solid var(--border2);background:rgba(255,0,77,.04);}
.blacklist-header i{color:var(--red);}
.blacklist-title{font-weight:700;font-size:14px;color:var(--red);}
.blacklist-count{font-size:12px;color:var(--text3);background:rgba(255,0,77,.1);border:1px solid rgba(255,0,77,.2);border-radius:99px;padding:1px 8px;}
.blacklist-spacer{flex:1;}
.btn-gen-addin{font-size:12px;padding:5px 12px;border-radius:8px;border:1px solid rgba(45,95,255,.3);background:rgba(45,95,255,.1);color:var(--accent2);cursor:pointer;display:flex;align-items:center;gap:6px;font-weight:600;transition:background .15s,border-color .15s;}
.btn-gen-addin:hover{background:rgba(45,95,255,.2);border-color:rgba(45,95,255,.5);}
.btn-gen-addin:disabled{opacity:.5;cursor:not-allowed;}
#blacklist-empty{padding:20px;text-align:center;color:var(--text3);font-size:13px;}
.blacklist-table{width:100%;border-collapse:collapse;}
.blacklist-table th{padding:8px 14px;font-size:11px;font-weight:600;text-transform:uppercase;letter-spacing:.06em;color:var(--text3);border-bottom:1px solid var(--border2);text-align:left;}
.blacklist-table td{padding:8px 14px;font-size:13px;border-bottom:1px solid rgba(255,255,255,.03);}
.blacklist-table tr:last-child td{border-bottom:none;}
.blacklist-table tr:hover td{background:rgba(255,255,255,.02);}
.btn-unblock{font-size:11px;padding:2px 8px;border-radius:5px;border:1px solid rgba(255,0,77,.25);background:transparent;color:var(--red);cursor:pointer;opacity:.7;transition:opacity .15s,background .15s;}
.btn-unblock:hover{opacity:1;background:rgba(255,0,77,.1);}
.blacklist-addin-info{font-size:11px;color:var(--text3);padding:0 16px 10px;display:flex;align-items:center;gap:6px;}
.blacklist-addin-info i{color:var(--green);font-size:10px;}

/* ── DEVICE LOG MODAL ────────────────────────────── */
#log-modal{display:none;position:fixed;inset:0;z-index:3500;background:rgba(0,0,0,.75);backdrop-filter:blur(8px);align-items:center;justify-content:center;}
.log-modal-box{background:var(--card);border:1px solid var(--border2);border-radius:16px;width:min(860px,96vw);max-height:85vh;display:flex;flex-direction:column;box-shadow:var(--shadow),0 0 60px rgba(0,0,0,.4);animation:fadeUp .25s ease;}
.log-modal-head{display:flex;align-items:center;gap:12px;padding:16px 20px;border-bottom:1px solid var(--border2);flex-shrink:0;}
.log-modal-title{font-size:15px;font-weight:700;flex:1;}
.log-modal-sub{font-size:12px;color:var(--text3);}
.log-modal-close{width:30px;height:30px;border-radius:7px;border:1px solid var(--border);background:var(--bg2);color:var(--text2);cursor:pointer;display:flex;align-items:center;justify-content:center;font-size:13px;transition:all .15s;}
.log-modal-close:hover{border-color:var(--red);color:var(--red);}
.log-modal-toolbar{display:flex;align-items:center;gap:8px;padding:10px 16px;border-bottom:1px solid var(--border2);flex-shrink:0;flex-wrap:wrap;}
.log-source-row{display:flex;gap:6px;width:100%;padding-bottom:8px;border-bottom:1px solid rgba(255,255,255,.06);margin-bottom:2px;}
.log-source-btn{flex:1;padding:5px 10px;border-radius:8px;border:1px solid var(--border);background:transparent;color:var(--text2);cursor:pointer;font-size:12px;font-weight:600;transition:all .15s;display:flex;align-items:center;justify-content:center;gap:6px;}
.log-source-btn:hover{border-color:var(--accent);color:var(--accent);}
.log-source-btn.active{background:rgba(45,95,255,.15);border-color:rgba(45,95,255,.4);color:var(--accent2);}
.log-filter-btn{padding:4px 11px;border-radius:20px;font-size:11px;font-weight:600;border:1px solid var(--border);background:transparent;color:var(--text2);cursor:pointer;transition:all .15s;}
.log-filter-btn:hover,.log-filter-btn.active{background:var(--accent);border-color:var(--accent);color:#fff;}
.log-search{display:flex;align-items:center;gap:6px;background:var(--bg2);border:1px solid var(--border);border-radius:6px;padding:4px 10px;margin-left:auto;}
.log-search i{color:var(--text3);font-size:11px;}
.log-search input{background:none;border:none;outline:none;color:var(--text);font-size:12px;width:180px;}
.log-table-wrap{flex:1;overflow-y:auto;min-height:0;}
.log-table{width:100%;border-collapse:collapse;font-size:12px;}
.log-table th{position:sticky;top:0;background:var(--bg2);padding:8px 14px;font-size:10px;font-weight:700;text-transform:uppercase;letter-spacing:.07em;color:var(--text3);border-bottom:1px solid var(--border2);text-align:left;z-index:1;}
.log-table td{padding:7px 14px;border-bottom:1px solid rgba(255,255,255,.03);vertical-align:top;}
.log-table tr:hover td{background:rgba(255,255,255,.025);}
.log-table tr:last-child td{border-bottom:none;}
.log-sev{display:inline-flex;align-items:center;gap:3px;padding:2px 7px;border-radius:20px;font-size:10px;font-weight:700;white-space:nowrap;}
.log-sev-0,.log-sev-1{background:rgba(255,0,77,.15);color:var(--red);border:1px solid rgba(255,0,77,.25);}
.log-sev-2,.log-sev-3{background:rgba(119,200,210,.15);color:var(--amber);border:1px solid rgba(119,200,210,.25);}
.log-sev-4,.log-sev-5{background:rgba(170,218,247,.12);color:var(--blue);border:1px solid rgba(170,218,247,.2);}
.log-sev-6,.log-sev-7{background:rgba(255,255,255,.06);color:var(--text2);border:1px solid var(--border);}
.log-raw{font-family:'Courier New',monospace;font-size:11px;color:var(--text);word-break:break-word;line-height:1.5;}
.log-modal-footer{display:flex;align-items:center;gap:10px;padding:10px 16px;border-top:1px solid var(--border2);flex-shrink:0;}
.log-count-info{font-size:12px;color:var(--text3);flex:1;}
.log-load-more{padding:5px 14px;border-radius:7px;border:1px solid var(--border);background:var(--bg2);color:var(--text2);font-size:12px;font-weight:600;cursor:pointer;transition:all .15s;}
.log-load-more:hover{border-color:var(--accent);color:var(--accent);}
.log-load-more:disabled{opacity:.4;cursor:not-allowed;}
.log-empty{text-align:center;padding:40px;color:var(--text3);}

/* ── PREDICTIVE ANOMALY – LANCOM Brand Colors ─────── */
/* Electric Blue #2d5fff · Dark Blue #001d41 · Light Blue #aadaf7  */
/* Apple Green #a0ed3a · Red #ff004d · Turquoise #77c8d2            */
.pa-wrap{padding:0 24px 32px;display:flex;flex-direction:column;gap:20px;}
.pa-kpi-row{display:grid;grid-template-columns:repeat(auto-fill,minmax(150px,1fr));gap:10px;}
.pa-kpi{background:var(--card);border:1px solid rgba(45,95,255,.3);border-radius:12px;padding:14px 16px;}
.pa-kpi-val{font-size:28px;font-weight:800;font-variant-numeric:tabular-nums;line-height:1;}
.pa-kpi-lbl{font-size:10px;color:var(--text2);font-weight:700;text-transform:uppercase;letter-spacing:.05em;margin-top:3px;}
.pa-kpi-icon{width:32px;height:32px;border-radius:8px;display:flex;align-items:center;justify-content:center;font-size:13px;margin-bottom:8px;}
.pki-red   {background:rgba(255,0,77,.15);  color:#ff004d;}
.pki-amber {background:rgba(119,200,210,.15);color:#77c8d2;}
.pki-blue  {background:rgba(45,95,255,.15); color:#2d5fff;}
.pki-green {background:rgba(160,237,58,.15);color:#a0ed3a;}
.pa-section-title{font-size:13px;font-weight:700;color:var(--text2);margin-bottom:10px;display:flex;align-items:center;gap:8px;}
.pa-section-title i{color:#2d5fff;}
.pa-alert-list{display:flex;flex-direction:column;gap:8px;}
.pa-alert{background:var(--card);border:1px solid rgba(45,95,255,.2);border-radius:10px;padding:14px;display:flex;align-items:flex-start;gap:12px;}
.pa-alert-critical{border-color:rgba(255,0,77,.5);background:rgba(255,0,77,.04);}
.pa-alert-warning {border-color:rgba(45,95,255,.4);background:rgba(45,95,255,.04);}
.pa-alert-icon{width:34px;height:34px;border-radius:9px;display:flex;align-items:center;justify-content:center;font-size:14px;flex-shrink:0;}
.pai-critical{background:rgba(255,0,77,.15);  color:#ff004d;}
.pai-warning {background:rgba(45,95,255,.15); color:#2d5fff;}
.pa-alert-body{flex:1;min-width:0;}
.pa-alert-title{font-size:13px;font-weight:700;margin-bottom:3px;}
.pa-alert-desc{font-size:12px;color:var(--text2);line-height:1.45;}
.pa-alert-meta{display:flex;align-items:center;gap:10px;margin-top:5px;flex-wrap:wrap;}
.pa-model-badge{background:rgba(45,95,255,.15);border:1px solid rgba(45,95,255,.35);color:#2d5fff;font-size:10px;font-weight:700;padding:1px 7px;border-radius:8px;}
.pa-conf-badge{font-size:11px;font-weight:700;padding:2px 7px;border-radius:6px;background:rgba(45,95,255,.12);color:#aadaf7;border:1px solid rgba(45,95,255,.3);}
.pa-risk-table{width:100%;border-collapse:collapse;font-size:12.5px;}
.pa-risk-table th{text-align:left;padding:7px 14px;background:rgba(0,29,65,.6);color:#aadaf7;font-size:10px;font-weight:700;text-transform:uppercase;letter-spacing:.05em;border-bottom:1px solid rgba(45,95,255,.3);}
.pa-risk-table td{padding:8px 14px;border-bottom:1px solid var(--border);vertical-align:middle;}
.pa-risk-table tr:last-child td{border-bottom:none;}
.pa-risk-table tbody tr:hover>td{background:rgba(45,95,255,.05);}
.pa-device-detail{padding:14px;background:rgba(0,17,48,.35);display:grid;grid-template-columns:repeat(auto-fill,minmax(300px,1fr));gap:10px;}
.pa-pred-card{background:var(--card);border:1px solid rgba(45,95,255,.2);border-radius:9px;padding:12px 14px;}
.pa-pred-critical{border-color:rgba(255,0,77,.4); background:rgba(255,0,77,.03);}
.pa-pred-warning {border-color:rgba(45,95,255,.4);background:rgba(45,95,255,.03);}
.pa-pred-header{display:flex;align-items:flex-start;gap:10px;margin-bottom:8px;}
.pa-pred-icon{width:28px;height:28px;border-radius:7px;display:flex;align-items:center;justify-content:center;font-size:12px;flex-shrink:0;margin-top:1px;}
.ppi-critical{background:rgba(255,0,77,.15);  color:#ff004d;}
.ppi-warning {background:rgba(45,95,255,.15); color:#2d5fff;}
.pa-pred-title{font-size:12px;font-weight:700;margin-bottom:2px;}
.pa-pred-desc{font-size:11px;color:var(--text2);line-height:1.4;}
.pa-sparkline{margin:8px 0;border-radius:4px;overflow:hidden;background:rgba(0,29,65,.3);padding:4px 6px 2px;}
.pa-fixes{margin-top:8px;}
.pa-fix-chip{display:inline-flex;align-items:center;gap:4px;background:rgba(0,29,65,.5);border:1px solid rgba(45,95,255,.3);color:#aadaf7;font-size:10px;font-weight:600;padding:3px 8px;border-radius:7px;}
.pa-model-row{font-size:10px;color:var(--text3);margin-top:8px;display:flex;align-items:center;gap:5px;}

/* ── LIFECYCLE PLANNER ───────────────────────────────── */
.lc-wrap{padding:0 24px 32px;display:flex;flex-direction:column;gap:20px;}
.lc-kpi-row{display:grid;grid-template-columns:repeat(auto-fill,minmax(150px,1fr));gap:10px;}
.lc-kpi{background:var(--card);border:1px solid var(--border);border-radius:12px;padding:14px 16px;}
.lc-kpi-val{font-size:28px;font-weight:800;font-variant-numeric:tabular-nums;line-height:1;}
.lc-kpi-lbl{font-size:10px;color:var(--text2);font-weight:700;text-transform:uppercase;letter-spacing:.05em;margin-top:3px;}
.lc-kpi-icon{width:32px;height:32px;border-radius:8px;display:flex;align-items:center;justify-content:center;font-size:13px;margin-bottom:8px;}
.lki-red   {background:rgba(255,0,77,.15);color:var(--red);}
.lki-amber {background:rgba(119,200,210,.15);color:var(--amber);}
.lki-blue  {background:rgba(170,218,247,.15);color:var(--blue);}
.lki-green {background:rgba(160,237,58,.15); color:var(--green);}
.lc-section-title{font-size:13px;font-weight:700;color:var(--text2);margin-bottom:10px;display:flex;align-items:center;gap:8px;}
.lc-section-title i{color:var(--accent2);}
.lc-filter-row{display:flex;align-items:center;gap:6px;flex-wrap:wrap;}
.lc-filter-btn{padding:5px 14px;border-radius:20px;font-size:12px;font-weight:600;border:1px solid var(--border);background:transparent;color:var(--text2);cursor:pointer;transition:all .15s;}
.lc-filter-btn:hover,.lc-filter-btn.active{background:var(--accent);border-color:var(--accent);color:#fff;}
.lc-count-badge{display:inline-flex;align-items:center;justify-content:center;min-width:16px;height:16px;border-radius:8px;font-size:9px;font-weight:700;padding:0 4px;margin-left:4px;}
.lcb-red   {background:rgba(255,0,77,.2);  color:var(--red);}
.lcb-amber {background:rgba(119,200,210,.2); color:var(--amber);}
.lcb-blue  {background:rgba(170,218,247,.2); color:var(--blue);}
.lcb-green {background:rgba(160,237,58,.2);  color:var(--green);}
.lc-grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(340px,1fr));gap:12px;}
.lc-card{background:var(--card);border:1px solid var(--border);border-radius:10px;overflow:hidden;transition:border-color .15s;}
.lc-card:hover{border-color:var(--border2);}
.lc-card.lc-critical{border-color:rgba(255,0,77,.35);}
.lc-card.lc-soon    {border-color:rgba(119,200,210,.3);}
.lc-card-header{padding:12px 14px 10px;border-bottom:1px solid var(--border);}
.lc-card-name{font-size:13px;font-weight:700;margin-bottom:4px;}
.lc-card-meta{font-size:11px;color:var(--text2);display:flex;gap:8px;flex-wrap:wrap;align-items:center;}
.lc-risks{padding:10px 14px;display:flex;flex-direction:column;gap:6px;}
.lc-risk{display:flex;align-items:flex-start;gap:9px;padding:8px 10px;border-radius:7px;background:var(--bg2);}
.lc-risk-icon{width:26px;height:26px;border-radius:6px;display:flex;align-items:center;justify-content:center;font-size:11px;flex-shrink:0;margin-top:1px;}
.lri-red   {background:rgba(255,0,77,.15);color:var(--red);}
.lri-amber {background:rgba(119,200,210,.15);color:var(--amber);}
.lri-blue  {background:rgba(170,218,247,.15);color:var(--blue);}
.lri-purple{background:rgba(45,95,255,.15);color:var(--purple);}
.lc-risk-body{flex:1;min-width:0;}
.lc-risk-title{font-size:12px;font-weight:700;}
.lc-risk-desc{font-size:11px;color:var(--text2);margin-top:2px;line-height:1.45;}
.lc-cap-bar-wrap{background:var(--bg);border-radius:3px;height:4px;margin-top:5px;}
.lc-cap-bar{height:100%;border-radius:3px;}
.lc-risk-months{font-size:10px;font-weight:700;padding:2px 8px;border-radius:10px;align-self:flex-start;flex-shrink:0;white-space:nowrap;border:1px solid transparent;}
.lrm-critical{background:rgba(255,0,77,.15);color:var(--red);  border-color:rgba(255,0,77,.3);}
.lrm-soon    {background:rgba(119,200,210,.15);color:var(--amber);border-color:rgba(119,200,210,.3);}
.lrm-medium  {background:rgba(170,218,247,.12);color:var(--blue); border-color:rgba(170,218,247,.25);}
.lc-upgrade{margin:0 14px 12px;padding:9px 12px;background:rgba(45,95,255,.07);border:1px solid rgba(45,95,255,.2);border-radius:8px;font-size:11.5px;color:var(--text2);line-height:1.6;}
.lc-upgrade strong{color:var(--accent2);}
.lc-ok-state{padding:12px 14px;font-size:12px;color:var(--green);display:flex;align-items:center;gap:6px;}

/* ── ENERGIE DASHBOARD ───────────────────────────────── */
.energy-wrap{padding:0 24px 32px;display:flex;flex-direction:column;gap:20px;}
.energy-kpi-row{display:grid;grid-template-columns:repeat(auto-fill,minmax(160px,1fr));gap:10px;}
.energy-kpi{background:var(--card);border:1px solid var(--border);border-radius:12px;padding:16px 18px;display:flex;flex-direction:column;gap:4px;}
.energy-kpi-val{font-size:26px;font-weight:800;font-variant-numeric:tabular-nums;line-height:1;}
.energy-kpi-lbl{font-size:11px;color:var(--text2);font-weight:600;text-transform:uppercase;letter-spacing:.05em;}
.energy-kpi-sub{font-size:10px;color:var(--text3);margin-top:2px;}
.energy-kpi-icon{width:34px;height:34px;border-radius:8px;display:flex;align-items:center;justify-content:center;font-size:14px;margin-bottom:6px;}
.eki-power{background:rgba(119,200,210,.15);color:var(--amber);}
.eki-co2  {background:rgba(160,237,58,.15); color:var(--green);}
.eki-cost {background:rgba(45,95,255,.15);color:var(--accent2);}
.eki-poe  {background:rgba(170,218,247,.15);color:var(--blue);}
.eki-dev  {background:rgba(45,95,255,.15);color:var(--purple);}

.energy-section-title{font-size:13px;font-weight:700;color:var(--text2);margin-bottom:10px;display:flex;align-items:center;gap:8px;}
.energy-section-title i{color:var(--accent2);}

.energy-sites-grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(300px,1fr));gap:12px;}
.energy-site-card{background:var(--card);border:1px solid var(--border);border-radius:10px;padding:16px 18px;}
.energy-site-name{font-size:13px;font-weight:700;margin-bottom:12px;display:flex;align-items:center;gap:6px;}
.energy-site-name i{color:var(--accent);font-size:12px;}
.energy-site-stats{display:flex;gap:14px;margin-bottom:12px;flex-wrap:wrap;}
.energy-site-stat{display:flex;flex-direction:column;gap:1px;}
.energy-site-stat-val{font-size:18px;font-weight:700;font-variant-numeric:tabular-nums;}
.energy-site-stat-lbl{font-size:9px;color:var(--text3);text-transform:uppercase;letter-spacing:.05em;}
.energy-bar-wrap{background:var(--bg);border-radius:4px;height:6px;overflow:hidden;}
.energy-bar{height:100%;border-radius:4px;background:linear-gradient(90deg,var(--amber),var(--accent));transition:width .4s ease;}

.energy-dev-table{width:100%;border-collapse:collapse;font-size:12.5px;}
.energy-dev-table th{text-align:left;padding:7px 12px;background:var(--bg2);color:var(--text3);font-size:10px;font-weight:700;text-transform:uppercase;letter-spacing:.05em;border-bottom:1px solid var(--border2);}
.energy-dev-table td{padding:7px 12px;border-bottom:1px solid var(--border);}
.energy-dev-table tr:last-child td{border-bottom:none;}
.energy-dev-table tr:hover td{background:rgba(255,255,255,.02);}
.energy-type-badge{display:inline-flex;align-items:center;gap:4px;padding:2px 8px;border-radius:10px;font-size:10px;font-weight:700;}
.etb-router{background:rgba(45,95,255,.15);color:var(--accent2);}
.etb-ap    {background:rgba(119,200,210,.15);color:var(--teal);}
.etb-switch{background:rgba(170,218,247,.15);color:var(--blue);}
.etb-other {background:rgba(255,255,255,.06);color:var(--text3);}

.energy-suggest-list{display:flex;flex-direction:column;gap:8px;}
.energy-suggest{background:var(--card);border:1px solid var(--border);border-radius:10px;padding:14px 16px;display:flex;align-items:flex-start;gap:12px;}
.energy-suggest-icon{width:32px;height:32px;border-radius:8px;display:flex;align-items:center;justify-content:center;font-size:13px;flex-shrink:0;}
.esi-green {background:rgba(160,237,58,.15); color:var(--green);}
.esi-amber {background:rgba(119,200,210,.15);color:var(--amber);}
.esi-blue  {background:rgba(170,218,247,.15);color:var(--blue);}
.esi-purple{background:rgba(45,95,255,.15);color:var(--purple);}
.energy-suggest-body{flex:1;min-width:0;}
.energy-suggest-title{font-size:13px;font-weight:700;margin-bottom:3px;}
.energy-suggest-desc{font-size:12px;color:var(--text2);line-height:1.5;}
.energy-suggest-badge{margin-left:auto;flex-shrink:0;background:rgba(119,200,210,.15);color:var(--amber);font-size:10px;font-weight:700;padding:2px 8px;border-radius:10px;border:1px solid rgba(119,200,210,.25);align-self:flex-start;}
.energy-note{font-size:11px;color:var(--text3);margin-top:4px;line-height:1.4;}
</style>
</head>
<body>

<!-- LOGIN -->
<div id="login-screen">
  <div class="login-card">
    <div class="login-logo">
      <div class="logo-icon"><i class="fa-solid fa-network-wired"></i></div>
      <h1>LANCOM Management Cloud</h1>
      <p>Network Management Dashboard</p>
    </div>
    <div class="login-error" id="login-error"></div>
    <div class="form-group">
      <label>API-Key</label>
      <input type="password" id="api-key-input" placeholder="LMC API-Key eingeben…" autocomplete="off">
    </div>
    <div class="save-token-row">
      <label class="toggle-switch">
        <input type="checkbox" id="save-token-cb">
        <span class="toggle-slider"></span>
      </label>
      <span class="save-token-label" onclick="document.getElementById('save-token-cb').click()">API-Token speichern</span>
    </div>
    <button class="btn-primary" id="login-btn" onclick="doLogin()">
      <i class="fa-solid fa-right-to-bracket"></i>&nbsp; Anmelden
    </button>
  </div>
</div>

<!-- ACCOUNT PICKER -->
<div id="account-picker">
  <div class="picker-card">
    <h2><i class="fa-solid fa-building" style="color:var(--accent);margin-right:10px"></i>Account wählen</h2>
    <p>Mehrere Accounts gefunden. Bitte einen auswählen.</p>
    <div style="position:relative;margin-bottom:14px;flex-shrink:0">
      <i class="fa-solid fa-magnifying-glass" style="position:absolute;left:12px;top:50%;transform:translateY(-50%);color:var(--text3);font-size:13px;pointer-events:none"></i>
      <input id="account-search" type="text" placeholder="Suchen…" oninput="filterAccounts(this.value)"
        style="width:100%;padding:9px 12px 9px 34px;background:var(--bg2);border:1px solid var(--border);border-radius:var(--r);color:var(--text);font-size:13px;outline:none;box-sizing:border-box;"
        onfocus="this.style.borderColor='var(--accent)'" onblur="this.style.borderColor='var(--border)'">
    </div>
    <div class="account-list" id="account-list"></div>
  </div>
</div>

<!-- LOADING -->
<div id="loading-overlay" style="display:none">
  <div class="spinner"></div>
  <div class="loading-text" id="loading-text">Lade Daten…</div>
</div>

<!-- MAIN APP -->
<div id="app">

  <!-- HEADER -->
  <header class="header">
    <div class="header-logo">
      <div class="logo-badge"><i class="fa-solid fa-network-wired"></i></div>
      <div class="logo-text">LANCOM LMC<span>Management Cloud</span></div>
    </div>
    <div class="header-account">
      <div class="dot"></div>
      <span class="name" id="header-account-name">–</span>
    </div>
    <div class="header-spacer"></div>
    <select id="refresh-select" onchange="setRefreshInterval(+this.value)" title="Auto-Update Intervall"
      style="background:var(--bg2);border:1px solid var(--border);border-radius:6px;color:var(--text1);font-size:12px;padding:4px 8px;cursor:pointer;outline:none;">
      <option value="0">Manuell</option>
      <option value="10">10 Sek</option>
      <option value="30">30 Sek</option>
      <option value="60" selected>60 Sek</option>
    </select>
    <span class="sync-info" id="sync-info-text" style="display:none">in <span id="countdown">–</span>s</span>
    <button class="icon-btn" onclick="openSearch()" title="Suchen (/)">
      <i class="fa-solid fa-magnifying-glass"></i>
    </button>
    <button class="icon-btn" id="theme-btn" onclick="toggleTheme()" title="Theme wechseln">
      <i class="fa-solid fa-moon" id="theme-icon"></i>
    </button>
    <button class="icon-btn" onclick="refreshDashboard()" title="Jetzt aktualisieren">
      <i class="fa-solid fa-arrows-rotate" id="refresh-icon"></i>
    </button>
    <button class="icon-btn" onclick="doLogout()" title="Abmelden">
      <i class="fa-solid fa-right-from-bracket"></i>
    </button>
  </header>

  <!-- APP BODY: SIDEBAR + CONTENT -->
  <div class="app-body">

  <!-- SIDEBAR -->
  <aside class="sidebar" id="sidebar">
    <div class="sidebar-header">
      <button class="sidebar-toggle-btn" onclick="toggleSidebar()" title="Menü ein-/ausblenden">
        <i class="fa-solid fa-bars"></i>
      </button>
    </div>
    <nav class="sidebar-nav">

      <!-- Übersicht -->
      <button class="tab-btn active" onclick="showTab('devices')" id="tab-btn-devices" data-tooltip="Geräte">
        <span class="tb-icon"><i class="fa-solid fa-server"></i></span>
        <span class="tb-label">Geräte</span>
        <span class="tab-badge" id="badge-devices">–</span>
      </button>

      <!-- Monitoring -->
      <div class="sidebar-group-label">Monitoring</div>
      <button class="tab-btn" onclick="showTab('wlan')" id="tab-btn-wlan" data-tooltip="WLAN Clients">
        <span class="tb-icon"><i class="fa-solid fa-wifi"></i></span>
        <span class="tb-label">WLAN Clients</span>
        <span class="tab-badge" id="badge-wlan">–</span>
      </button>
      <button class="tab-btn" onclick="showTab('vpn')" id="tab-btn-vpn" data-tooltip="VPN">
        <span class="tb-icon"><i class="fa-solid fa-shield-halved"></i></span>
        <span class="tb-label">VPN</span>
        <span class="tab-badge" id="badge-vpn">–</span>
      </button>
      <button class="tab-btn" onclick="showTab('wan')" id="tab-btn-wan" data-tooltip="WAN">
        <span class="tb-icon"><i class="fa-solid fa-globe"></i></span>
        <span class="tb-label">WAN</span>
        <span class="tab-badge" id="badge-wan">–</span>
      </button>
      <button class="tab-btn" onclick="showTab('traffic')" id="tab-btn-traffic" data-tooltip="Traffic">
        <span class="tb-icon"><i class="fa-solid fa-chart-area"></i></span>
        <span class="tb-label">Traffic</span>
        <span class="tab-badge" id="badge-traffic">–</span>
      </button>
      <button class="tab-btn" onclick="showTab('energy')" id="tab-btn-energy" data-tooltip="Energie / CO₂">
        <span class="tb-icon"><i class="fa-solid fa-leaf"></i></span>
        <span class="tb-label">Energie / CO₂</span>
      </button>

      <!-- Analyse -->
      <div class="sidebar-group-label">Analyse</div>
      <button class="tab-btn" onclick="showTab('neighbors')" id="tab-btn-neighbors" data-tooltip="Nachbarschaft">
        <span class="tb-icon"><i class="fa-solid fa-satellite-dish"></i></span>
        <span class="tb-label">Nachbarschaft</span>
        <span class="tab-badge" id="badge-neighbors">–</span>
      </button>
      <button class="tab-btn" onclick="showTab('lldp')" id="tab-btn-lldp" data-tooltip="LLDP / Switches">
        <span class="tb-icon"><i class="fa-solid fa-diagram-project"></i></span>
        <span class="tb-label">LLDP / Switches</span>
        <span class="tab-badge" id="badge-lldp">–</span>
      </button>
      <button class="tab-btn" onclick="showTab('topology')" id="tab-btn-topology" data-tooltip="Netzwerkplan">
        <span class="tb-icon"><i class="fa-solid fa-sitemap"></i></span>
        <span class="tb-label">Netzwerkplan</span>
      </button>
      <button class="tab-btn" onclick="showTab('client-explorer')" id="tab-btn-client-explorer" data-tooltip="Client Explorer">
        <span class="tb-icon"><i class="fa-solid fa-magnifying-glass-location"></i></span>
        <span class="tb-label">Client Explorer</span>
        <span class="tab-badge" id="badge-client-explorer">–</span>
      </button>
      <button class="tab-btn" onclick="showTab('lifecycle')" id="tab-btn-lifecycle" data-tooltip="Lifecycle-Planner">
        <span class="tb-icon"><i class="fa-solid fa-timeline"></i></span>
        <span class="tb-label">Lifecycle-Planner</span>
        <span class="tab-badge" id="badge-lifecycle">–</span>
      </button>
      <button class="tab-btn" onclick="showTab('anomaly')" id="tab-btn-anomaly" data-tooltip="Predictive Anomaly">
        <span class="tb-icon"><i class="fa-solid fa-brain"></i></span>
        <span class="tb-label">Predictive Anomaly</span>
        <span class="tab-badge" id="badge-anomaly">–</span>
      </button>

      <!-- Verwaltung -->
      <div class="sidebar-group-label">Verwaltung</div>
      <button class="tab-btn" onclick="showTab('addins')" id="tab-btn-addins" data-tooltip="Add-ins">
        <span class="tb-icon"><i class="fa-solid fa-puzzle-piece"></i></span>
        <span class="tb-label">Add-ins</span>
        <span class="tab-badge" id="badge-addins">–</span>
      </button>
      <button class="tab-btn" onclick="showTab('firmware')" id="tab-btn-firmware" data-tooltip="Firmware">
        <span class="tb-icon"><i class="fa-solid fa-microchip"></i></span>
        <span class="tb-label">Firmware</span>
        <span class="tab-badge" id="badge-firmware">–</span>
      </button>
      <button class="tab-btn" onclick="showTab('sites')" id="tab-btn-sites" data-tooltip="Standorte">
        <span class="tb-icon"><i class="fa-solid fa-location-dot"></i></span>
        <span class="tb-label">Standorte</span>
        <span class="tab-badge" id="badge-sites">–</span>
      </button>

      <!-- System -->
      <div class="sidebar-sep"></div>
      <button class="tab-btn" onclick="showTab('alerts')" id="tab-btn-alerts" data-tooltip="Alerts">
        <span class="tb-icon"><i class="fa-solid fa-bell"></i></span>
        <span class="tb-label">Alerts</span>
        <span class="tab-badge" id="badge-alerts">–</span>
      </button>

    </nav>
    <div class="sidebar-bottom">
      <button class="tab-btn" onclick="showTab('settings')" id="tab-btn-settings" data-tooltip="Einstellungen">
        <span class="tb-icon"><i class="fa-solid fa-gear"></i></span>
        <span class="tb-label">Einstellungen</span>
      </button>
    </div>
  </aside>

  <!-- CONTENT AREA -->
  <div class="content-area">

  <!-- TAB: GERÄTE -->
  <section class="tab-section active" id="tab-devices">
    <div class="stats-bar">
      <div class="stat-card"><div class="stat-icon si-total"><i class="fa-solid fa-server"></i></div><div><div class="stat-val sv-total" id="s-total">–</div><div class="stat-lbl">Geräte</div></div></div>
      <div class="stat-card"><div class="stat-icon si-online"><i class="fa-solid fa-circle-check"></i></div><div><div class="stat-val sv-online" id="s-online">–</div><div class="stat-lbl">Online</div></div></div>
      <div class="stat-card"><div class="stat-icon si-offline"><i class="fa-solid fa-circle-xmark"></i></div><div><div class="stat-val sv-offline" id="s-offline">–</div><div class="stat-lbl">Offline</div></div></div>
      <div class="stat-card"><div class="stat-icon si-alert"><i class="fa-solid fa-triangle-exclamation"></i></div><div><div class="stat-val sv-alert" id="s-alerts">–</div><div class="stat-lbl">Alerts</div></div></div>
      <div class="stat-card"><div class="stat-icon si-fw"><i class="fa-solid fa-microchip"></i></div><div><div class="stat-val sv-fw" id="s-fw">–</div><div class="stat-lbl">FW veraltet</div></div></div>
      <div class="stat-card"><div class="stat-icon si-cfg"><i class="fa-solid fa-gear"></i></div><div><div class="stat-val sv-cfg" id="s-cfg">–</div><div class="stat-lbl">Konfig veraltet</div></div></div>
      <div class="stat-card"><div class="stat-icon si-wlan"><i class="fa-solid fa-wifi"></i></div><div><div class="stat-val sv-wlan" id="s-wlan">–</div><div class="stat-lbl">WLAN Clients</div></div></div>
    </div>
    <div id="site-tiles" class="site-tiles" style="display:none"></div>
    <div class="toolbar">
      <span class="toolbar-title">Geräte</span>
      <span class="toolbar-count" id="device-count">0</span>
      <div class="toolbar-spacer"></div>
      <div class="filter-group" id="status-filter-group">
        <button class="filter-btn active" onclick="setFilter('all',this)">Alle</button>
        <button class="filter-btn" onclick="setFilter('online',this)">Online</button>
        <button class="filter-btn" onclick="setFilter('offline',this)">Offline</button>
        <button class="filter-btn" onclick="setFilter('alert',this)">Alert</button>
      </div>
      <button id="bulk-mode-btn" class="icon-btn" onclick="toggleBulkMode()" title="Mehrfachauswahl">
        <i class="fa-solid fa-check-square"></i>
      </button>
      <button class="icon-btn" onclick="exportDevicesCsv()" title="Als CSV exportieren">
        <i class="fa-solid fa-file-csv"></i>
      </button>
      <div class="search-box">
        <i class="fa-solid fa-magnifying-glass"></i>
        <input type="text" id="search-input" placeholder="Suchen…" oninput="renderDevices()">
      </div>
    </div>
    <div class="toolbar" id="site-filter-toolbar" style="display:none;padding-top:0;border-top:none;gap:6px;">
      <i class="fa-solid fa-map-marker-alt" style="color:var(--text3);font-size:12px;margin-right:2px;flex-shrink:0"></i>
      <div class="filter-group" id="site-filter-group" style="flex-wrap:wrap;"></div>
    </div>
    <div class="device-grid" id="device-grid"></div>
    <div class="sync-bar" id="sync-bar">Letzte Aktualisierung: –</div>
  </section>

  <!-- TAB: WLAN CLIENTS -->
  <section class="tab-section" id="tab-wlan">
    <div class="mini-stats" id="wlan-mini-stats"></div>
    <div class="toolbar">
      <span class="toolbar-title">WLAN Clients</span>
      <span class="toolbar-count" id="wlan-count">0</span>
      <div class="toolbar-spacer"></div>
      <div class="filter-group">
        <button class="filter-btn active" onclick="setWlanFilter('all',this)">Alle</button>
        <button class="filter-btn" onclick="setWlanFilter('GHZ24',this)">2.4 GHz</button>
        <button class="filter-btn" onclick="setWlanFilter('GHZ5',this)">5 GHz</button>
        <button class="filter-btn" onclick="setWlanFilter('GHZ6',this)">6 GHz</button>
      </div>
      <div class="search-box">
        <i class="fa-solid fa-magnifying-glass"></i>
        <input type="text" id="wlan-search" placeholder="MAC / IP / Gerät…" oninput="renderWlan()">
      </div>
    </div>
    <div class="table-wrap">
      <div class="table-section">
        <table class="data-table">
          <thead>
            <tr>
              <th>AP / Gerät</th>
              <th>Interface</th>
              <th>SSID</th>
              <th>Netzwerk (intern)</th>
              <th>Hostname</th>
              <th>MAC-Adresse</th>
              <th>IP-Adresse</th>
              <th>Band</th>
              <th>Kanal</th>
              <th>Signal</th>
              <th>↓ Rx</th>
              <th>↑ Tx</th>
              <th>Rate</th>
              <th style="width:90px"></th>
            </tr>
          </thead>
          <tbody id="wlan-tbody"></tbody>
        </table>
        <div id="wlan-empty" class="empty-state" style="display:none">
          <i class="fa-solid fa-wifi"></i>
          <h3>Keine WLAN Clients</h3>
          <p>Aktuell sind keine WLAN-Geräte verbunden.</p>
        </div>
      </div>

      <!-- MAC-Sperrliste -->
    <div class="blacklist-panel">
      <div class="blacklist-header">
        <i class="fa-solid fa-ban"></i>
        <span class="blacklist-title">MAC-Sperrliste</span>
        <span class="blacklist-count" id="blacklist-count">0</span>
        <div class="blacklist-spacer"></div>
        <button class="btn-gen-addin" onclick="generateBlacklistAddin()" id="btn-gen-addin" title="Add-in mit Sperrliste generieren/aktualisieren">
          <i class="fa-solid fa-code"></i> Add-in generieren
        </button>
      </div>
      <div id="blacklist-addin-info" class="blacklist-addin-info" style="display:none">
        <i class="fa-solid fa-circle-check"></i>
        <span id="blacklist-addin-name"></span>
      </div>
      <div id="blacklist-list">
        <div id="blacklist-empty" style="padding:20px;text-align:center;color:var(--text3);font-size:13px;">
          <i class="fa-solid fa-circle-check" style="display:block;font-size:20px;margin-bottom:8px;opacity:.3;color:var(--green)"></i>
          Keine MAC-Adressen gesperrt
        </div>
      </div>
    </div>
    </div><!-- /table-wrap -->
  </section>

  <!-- TAB: VPN -->
  <section class="tab-section" id="tab-vpn">
    <div class="mini-stats" id="vpn-mini-stats"></div>
    <div class="toolbar">
      <span class="toolbar-title">VPN Verbindungen</span>
      <span class="toolbar-count" id="vpn-count">0</span>
      <div class="toolbar-spacer"></div>
      <div class="search-box">
        <i class="fa-solid fa-magnifying-glass"></i>
        <input type="text" id="vpn-search" placeholder="Partner / IP…" oninput="renderVpn()">
      </div>
    </div>
    <div class="table-wrap">
      <div class="table-section">
        <table class="data-table">
          <thead>
            <tr>
              <th>Gerät</th>
              <th>Partner / Gegenstelle</th>
              <th>Protokoll</th>
              <th>Status</th>
              <th>Rolle</th>
              <th>Peer IP</th>
              <th>↓ Rx</th>
              <th>↑ Tx</th>
            </tr>
          </thead>
          <tbody id="vpn-tbody"></tbody>
        </table>
        <div id="vpn-empty" class="empty-state" style="display:none">
          <i class="fa-solid fa-shield-halved"></i>
          <h3>Keine VPN-Verbindungen</h3>
          <p>Keine aktiven VPN-Tunnel gefunden.</p>
        </div>
      </div>
    </div>
  </section>

  <!-- TAB: WAN -->
  <section class="tab-section" id="tab-wan">
    <div class="mini-stats" id="wan-mini-stats"></div>
    <div class="toolbar">
      <span class="toolbar-title">WAN Interfaces</span>
      <span class="toolbar-count" id="wan-count">0</span>
      <div class="toolbar-spacer"></div>
      <div class="search-box">
        <i class="fa-solid fa-magnifying-glass"></i>
        <input type="text" id="wan-search" placeholder="Gerät / Interface…" oninput="renderWan()">
      </div>
    </div>
    <div class="table-wrap">
      <div class="table-section">
        <table class="data-table">
          <thead>
            <tr>
              <th>Gerät</th>
              <th>Interface</th>
              <th>Typ</th>
              <th>Status</th>
              <th>IP-Adresse</th>
              <th>Gateway</th>
              <th>↓ Rx</th>
              <th>↑ Tx</th>
            </tr>
          </thead>
          <tbody id="wan-tbody"></tbody>
        </table>
        <div id="wan-empty" class="empty-state" style="display:none">
          <i class="fa-solid fa-globe"></i>
          <h3>Keine WAN-Daten</h3>
          <p>WAN-Interface-Daten konnten nicht geladen werden.</p>
        </div>
      </div>
    </div>
  </section>

  <!-- TAB: TRAFFIC MONITOR -->
  <section class="tab-section" id="tab-traffic">
    <div class="toolbar">
      <span class="toolbar-title">Traffic Monitor</span>
      <span class="toolbar-count" id="traffic-count">0</span>
      <div class="toolbar-spacer"></div>
      <span id="traffic-since" style="font-size:11px;color:var(--text3);white-space:nowrap;"></span>
      <button class="icon-btn" onclick="reloadTraffic()" title="Neu laden"><i class="fa-solid fa-arrows-rotate" id="traffic-refresh-icon"></i></button>
    </div>
    <div id="traffic-loading" style="display:none;flex:1;align-items:center;justify-content:center;flex-direction:column;gap:14px;color:var(--text2);font-size:14px;">
      <i class="fa-solid fa-circle-notch fa-spin" style="font-size:28px;color:var(--accent)"></i>Lade Verkehrsdaten (letzte 60 Minuten)…
    </div>
    <div id="traffic-empty" class="empty-state" style="display:none;">
      <i class="fa-solid fa-chart-area"></i><h3>Keine Daten</h3><p>Keine WAN-Interfaces mit Verlaufsdaten gefunden.</p>
    </div>
    <div class="traffic-grid" id="traffic-grid"></div>
  </section>

  <!-- TAB: ENERGIE / CO₂ -->
  <section class="tab-section" id="tab-energy">
    <div class="toolbar">
      <span class="toolbar-title"><i class="fa-solid fa-leaf" style="color:var(--green);margin-right:6px"></i>Energie / CO₂</span>
      <div class="toolbar-spacer"></div>
      <div style="display:flex;align-items:center;gap:7px;">
        <label style="font-size:11px;font-weight:700;color:var(--text2);text-transform:uppercase;letter-spacing:.06em;white-space:nowrap;">Strompreis</label>
        <div style="display:flex;align-items:center;background:var(--card);border:1px solid var(--border);border-radius:7px;overflow:hidden;">
          <input id="energy-price-input" type="number" min="0" step="0.01"
            style="width:70px;background:none;border:none;outline:none;color:var(--text);font-size:13px;font-weight:600;padding:5px 8px;font-variant-numeric:tabular-nums;"
            value="0.32" oninput="saveEnergyPrice();renderEnergy()">
          <span style="font-size:12px;color:var(--text3);padding-right:9px;font-weight:600;">€/kWh</span>
        </div>
      </div>
      <button class="icon-btn" onclick="renderEnergy()" title="Neu berechnen"><i class="fa-solid fa-arrows-rotate"></i></button>
    </div>
    <div class="energy-wrap" id="energy-wrap">
      <div class="empty-state"><i class="fa-solid fa-leaf"></i><h3>Keine Daten</h3><p>Zuerst Geräte laden.</p></div>
    </div>
  </section>

  <!-- TAB: NACHBARSCHAFT -->
  <section class="tab-section" id="tab-neighbors">
    <div class="mini-stats" id="nb-mini-stats"></div>
    <div class="toolbar">
      <span class="toolbar-title">WLAN Nachbarschaft</span>
      <span class="toolbar-count" id="nb-count">0</span>
      <div class="toolbar-spacer"></div>
      <div class="filter-group">
        <button class="filter-btn active" onclick="setNbFilter('all',this)">Alle</button>
        <button class="filter-btn" onclick="setNbFilter('GHZ24',this)">2.4 GHz</button>
        <button class="filter-btn" onclick="setNbFilter('GHZ5',this)">5 GHz</button>
        <button class="filter-btn" onclick="setNbFilter('GHZ6',this)">6 GHz</button>
      </div>
      <div class="search-box">
        <i class="fa-solid fa-magnifying-glass"></i>
        <input type="text" id="nb-search" placeholder="SSID / BSSID…" oninput="renderNeighbors()">
      </div>
    </div>
    <div class="table-wrap">
      <div class="table-section">
        <table class="data-table">
          <thead>
            <tr>
              <th>Erkannt von</th>
              <th>SSID</th>
              <th>BSSID</th>
              <th>Band</th>
              <th>Kanal</th>
              <th>Signal</th>
              <th>Sicherheit</th>
              <th>Eigenes Netz</th>
            </tr>
          </thead>
          <tbody id="nb-tbody"></tbody>
        </table>
        <div id="nb-empty" class="empty-state" style="display:none">
          <i class="fa-solid fa-satellite-dish"></i>
          <h3>Keine Nachbar-APs</h3>
          <p>Es wurden keine WLAN-Nachbarnetze erkannt.</p>
        </div>
      </div>
    </div>
  </section>

  <!-- TAB: LLDP -->
  <section class="tab-section" id="tab-lldp">
    <div class="mini-stats" id="lldp-mini-stats"></div>
    <div class="toolbar">
      <span class="toolbar-title">LLDP / Switch-Ports</span>
      <span class="toolbar-count" id="lldp-count">0</span>
      <div class="toolbar-spacer"></div>
      <div class="filter-group">
        <button class="filter-btn active" onclick="setLldpView('lldp',this)">LLDP Nachbarn</button>
        <button class="filter-btn" onclick="setLldpView('ports',this)">Alle Ports</button>
      </div>
      <div class="search-box">
        <i class="fa-solid fa-magnifying-glass"></i>
        <input type="text" id="lldp-search" placeholder="Switch / Port / Nachbar…" oninput="renderLldp()">
      </div>
    </div>

    <!-- LLDP NACHBARN VIEW -->
    <div id="lldp-view-lldp">
      <div class="table-wrap">
        <div class="table-section">
          <table class="data-table">
            <thead>
              <tr>
                <th>Switch</th>
                <th>Port</th>
                <th>Beschreibung</th>
                <th>LLDP Nachbar</th>
                <th>Status</th>
                <th>Speed</th>
                <th>VLAN</th>
                <th>PoE</th>
                <th>↓ Rx</th>
                <th>↑ Tx</th>
              </tr>
            </thead>
            <tbody id="lldp-tbody"></tbody>
          </table>
          <div id="lldp-empty" class="empty-state" style="display:none">
            <i class="fa-solid fa-diagram-project"></i>
            <h3>Keine LLDP-Nachbarn</h3>
            <p>Es wurden keine Switch-Ports mit LLDP-Nachbarn gefunden.</p>
          </div>
        </div>
      </div>
    </div>

    <!-- ALLE PORTS VIEW -->
    <div id="lldp-view-ports" style="display:none">
      <div class="table-wrap">
        <div class="table-section">
          <table class="data-table">
            <thead>
              <tr>
                <th>Switch</th>
                <th>Port</th>
                <th>Beschreibung</th>
                <th>LLDP Nachbar</th>
                <th>Status</th>
                <th>Loop</th>
                <th>Speed</th>
                <th>VLAN</th>
                <th>Config</th>
                <th>PoE</th>
                <th>↓ Rx</th>
                <th>↑ Tx</th>
              </tr>
            </thead>
            <tbody id="ports-tbody"></tbody>
          </table>
          <div id="ports-empty" class="empty-state" style="display:none">
            <i class="fa-solid fa-plug"></i>
            <h3>Keine Port-Daten</h3>
            <p>Es wurden keine Switch-Port-Daten gefunden.</p>
          </div>
        </div>
      </div>
    </div>
  </section>

  <!-- TAB: NETZWERKPLAN -->
  <section class="tab-section" id="tab-topology">
    <div class="toolbar">
      <span class="toolbar-title">Netzwerkplan</span>
      <div class="toolbar-spacer"></div>
      <label style="font-size:12px;color:var(--text2);flex-shrink:0;font-weight:600">Standort:</label>
      <select id="topo-site-select" class="topo-select" onchange="topoChangeSite(this.value)" style="min-width:130px;">
        <option value="">Alle Standorte</option>
      </select>
      <label style="font-size:12px;color:var(--text2);flex-shrink:0;font-weight:600">Startgerät:</label>
      <select id="topo-root-select" class="topo-select" onchange="topoChangeRoot()">
        <option value="">– Daten werden geladen –</option>
      </select>
      <button class="icon-btn" onclick="topoZoom(1.25)" title="Vergrößern"><i class="fa-solid fa-magnifying-glass-plus"></i></button>
      <button class="icon-btn" onclick="topoZoom(0.8)" title="Verkleinern"><i class="fa-solid fa-magnifying-glass-minus"></i></button>
      <button class="icon-btn" onclick="topoFit()" title="Ansicht einpassen"><i class="fa-solid fa-compress-arrows-alt"></i></button>
      <button class="icon-btn" onclick="topoExportSvg()" title="Als SVG exportieren"><i class="fa-solid fa-file-arrow-down"></i></button>
      <button class="icon-btn" id="topo-fs-btn" onclick="topoToggleFullscreen()" title="Vollbild"><i class="fa-solid fa-expand"></i></button>
    </div>
    <div id="topo-wrap">
      <svg id="topo-svg" xmlns="http://www.w3.org/2000/svg">
        <defs>
          <filter id="topo-glow" x="-40%" y="-40%" width="180%" height="180%">
            <feGaussianBlur in="SourceGraphic" stdDeviation="5" result="blur"/>
            <feMerge><feMergeNode in="blur"/><feMergeNode in="SourceGraphic"/></feMerge>
          </filter>
          <marker id="topo-arrow" markerWidth="8" markerHeight="6" refX="7" refY="3" orient="auto">
            <path d="M0,0 L8,3 L0,6 Z" fill="rgba(45,95,255,.4)"/>
          </marker>
        </defs>
        <g id="topo-g"></g>
      </svg>
      <!-- Legend -->
      <div style="position:absolute;bottom:16px;right:16px;background:rgba(13,18,39,.92);border:1px solid var(--border);border-radius:10px;padding:10px 14px;font-size:11px;pointer-events:none;backdrop-filter:blur(8px);">
        <div style="font-size:10px;font-weight:700;color:var(--text3);text-transform:uppercase;letter-spacing:.08em;margin-bottom:7px;">Legende</div>
        <div style="display:flex;align-items:center;gap:7px;margin-bottom:5px"><span style="width:9px;height:9px;border-radius:50%;background:var(--green);display:inline-block;flex-shrink:0"></span><span style="color:var(--text2)">Online</span></div>
        <div style="display:flex;align-items:center;gap:7px;margin-bottom:5px"><span style="width:9px;height:9px;border-radius:50%;background:var(--red);display:inline-block;flex-shrink:0"></span><span style="color:var(--text2)">Offline</span></div>
        <div style="display:flex;align-items:center;gap:7px;margin-bottom:5px"><span style="width:9px;height:9px;border-radius:50%;background:var(--amber);display:inline-block;flex-shrink:0"></span><span style="color:var(--text2)">Alert</span></div>
        <div style="display:flex;align-items:center;gap:7px;margin-bottom:5px"><span style="width:20px;height:2px;background:rgba(45,95,255,.6);display:inline-block;flex-shrink:0"></span><span style="color:var(--text2)">Verbindung</span></div>
        <div style="display:flex;align-items:center;gap:7px;margin-bottom:5px"><span style="width:20px;height:2px;background:rgba(119,200,210,.65);display:inline-block;flex-shrink:0"></span><span style="color:var(--text2)">&gt;1 Mbps</span></div>
        <div style="display:flex;align-items:center;gap:7px;margin-bottom:5px"><span style="width:20px;height:2px;background:rgba(160,237,58,.65);display:inline-block;flex-shrink:0"></span><span style="color:var(--text2)">&gt;10 Mbps</span></div>
        <div style="display:flex;align-items:center;gap:7px;margin-bottom:5px"><span style="width:20px;height:2px;background:rgba(119,200,210,.75);display:inline-block;flex-shrink:0"></span><span style="color:var(--text2)">&gt;100 Mbps</span></div>
        <div style="display:flex;align-items:center;gap:7px;margin-bottom:5px"><span style="width:20px;height:2px;background:rgba(255,0,77,.75);display:inline-block;flex-shrink:0"></span><span style="color:var(--text2)">&gt;900 Mbps</span></div>
        <div style="display:flex;align-items:center;gap:7px"><span style="width:20px;height:2px;background:rgba(45,95,255,.25);display:inline-block;flex-shrink:0;border-top:2px dashed rgba(45,95,255,.25)"></span><span style="color:var(--text2)">Offline-Link</span></div>
      </div>
      <!-- Hint -->
      <div style="position:absolute;bottom:16px;left:16px;font-size:11px;color:var(--text3);pointer-events:none;">Klick auf Gerät → Details &nbsp;·&nbsp; Scroll → Zoom &nbsp;·&nbsp; Drag → Pan</div>

      <!-- Detail Panel -->
      <div id="topo-detail" style="display:none;position:absolute;top:0;right:0;bottom:0;width:420px;background:var(--card);border-left:1px solid var(--border);flex-direction:column;z-index:20;box-shadow:-8px 0 32px rgba(0,0,0,.4);">
        <div style="padding:14px 16px 12px;border-bottom:1px solid var(--border);display:flex;align-items:center;gap:10px;flex-shrink:0;">
          <span id="topo-detail-dot" style="width:10px;height:10px;border-radius:50%;flex-shrink:0;display:inline-block;"></span>
          <div style="flex:1;min-width:0;">
            <div id="topo-detail-name" style="font-size:15px;font-weight:700;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;"></div>
            <div id="topo-detail-sub" style="font-size:11px;color:var(--text2);margin-top:2px;"></div>
          </div>
          <button id="topo-detail-setroot" style="background:rgba(45,95,255,.15);border:1px solid var(--border);border-radius:6px;color:var(--accent2);font-size:11px;font-weight:600;padding:4px 10px;cursor:pointer;white-space:nowrap;flex-shrink:0;" title="Als Startgerät setzen"><i class="fa-solid fa-sitemap"></i> Startpunkt</button>
          <button onclick="topoCloseDetail()" style="background:none;border:1px solid var(--border);border-radius:6px;color:var(--text2);cursor:pointer;font-size:14px;padding:4px 8px;flex-shrink:0;">✕</button>
        </div>
        <div style="flex:1;overflow-y:auto;padding:14px 16px;" id="topo-detail-content"></div>
      </div>
      <!-- Empty state -->
      <div id="topo-empty" style="display:none;position:absolute;inset:0;flex-direction:column;align-items:center;justify-content:center;color:var(--text2);">
        <i class="fa-solid fa-sitemap" style="font-size:40px;color:var(--text3);margin-bottom:12px"></i>
        <h3 style="font-size:16px;font-weight:700;color:var(--text);margin-bottom:6px">Keine Topologie-Daten</h3>
        <p style="font-size:13px">Keine LLDP-Verbindungen oder Geräte vorhanden.</p>
      </div>
    </div>
  </section>

  <!-- TAB: CLIENT EXPLORER -->
  <section class="tab-section" id="tab-client-explorer">

    <!-- MAC SEARCH CARD -->
    <div class="ce-search-card" style="flex-shrink:0">
      <div style="font-size:12px;font-weight:700;color:var(--text2);text-transform:uppercase;letter-spacing:.08em;margin-bottom:14px">
        <i class="fa-solid fa-magnifying-glass-location" style="color:var(--accent);margin-right:7px"></i>MAC-Adresse suchen
      </div>
      <div style="display:flex;gap:10px;align-items:flex-start;flex-wrap:wrap">
        <div style="flex:1;min-width:220px">
          <input type="text" id="ce-mac-input" class="ce-mac-input"
            placeholder="aa:bb:cc:dd:ee:ff"
            oninput="ceFormatHint(this.value)"
            onkeydown="if(event.key==='Enter')ceLookup()">
          <div id="ce-mac-hint" style="font-size:11px;color:var(--text3);margin-top:7px">
            Formate: <code>aa:bb:cc:dd:ee:ff</code> &nbsp;·&nbsp; <code>aa-bb-cc-dd-ee-ff</code> &nbsp;·&nbsp; <code>aabbccddeeff</code>
          </div>
        </div>
        <button class="ce-search-btn" onclick="ceLookup()">
          <i class="fa-solid fa-magnifying-glass"></i>&nbsp; Suchen
        </button>
        <button class="icon-btn" onclick="ceClearResult()" title="Ergebnis löschen" style="height:48px;width:48px">
          <i class="fa-solid fa-xmark"></i>
        </button>
      </div>
    </div>

    <!-- RESULT AREA -->
    <div id="ce-result-area" style="display:none;padding:16px 24px 0;flex-shrink:0"></div>

    <!-- SCAN TOOLBAR -->
    <div class="toolbar" style="flex-shrink:0;border-top:1px solid var(--border);margin-top:12px">
      <span class="toolbar-title"><i class="fa-solid fa-ethernet" style="margin-right:6px;color:var(--text3)"></i>SNMP-Scan</span>
      <span class="toolbar-count" id="ce-scan-summary">–</span>
      <div class="toolbar-spacer"></div>
      <div id="ce-progress-wrap" style="display:none;align-items:center;gap:10px;font-size:12px;color:var(--text2)">
        <span id="ce-progress-text">0 / 0</span>
        <div class="ce-prog-track"><div class="ce-prog-bar" id="ce-prog" style="width:0%"></div></div>
      </div>
      <button class="icon-btn" onclick="ceMacTableOpen()" title="Alle MACs anzeigen" id="ce-mac-table-btn">
        <i class="fa-solid fa-table-list"></i>
      </button>
      <button id="ce-scan-start-btn" class="ce-scan-btn" onclick="startCeScan()">
        <i class="fa-solid fa-play"></i> Online-Geräte scannen
      </button>
      <button id="ce-scan-cancel-btn" onclick="cancelCeScan()" style="display:none;background:rgba(255,0,77,.1);border:1px solid rgba(255,0,77,.25);border-radius:8px;color:var(--red);font-size:12px;font-weight:600;padding:8px 16px;cursor:pointer;white-space:nowrap">
        <i class="fa-solid fa-stop"></i> Abbrechen
      </button>
    </div>

    <!-- DEVICE TABLE -->
    <div class="table-wrap" style="flex:1">
      <div class="table-section">
        <table class="data-table">
          <thead>
            <tr>
              <th>Gerät</th>
              <th>IP-Adresse</th>
              <th>Typ</th>
              <th>MACs</th>
              <th>Status</th>
              <th></th>
            </tr>
          </thead>
          <tbody id="ce-device-tbody"></tbody>
        </table>
        <div id="ce-device-empty" class="empty-state">
          <i class="fa-solid fa-ethernet"></i>
          <h3>Noch kein Scan gestartet</h3>
          <p>Klicke auf <strong>"Online-Geräte scannen"</strong> um die SNMP-Abfrage zu starten.</p>
        </div>
      </div>
    </div>
  </section>

  <!-- CE: MAC TABLE MODAL -->
  <div id="ce-mac-modal" onclick="if(event.target===this)ceMacTableClose()">
    <div class="ce-mac-modal-box">
      <div class="ce-mac-modal-head">
        <i class="fa-solid fa-table-list" style="color:var(--accent);font-size:16px"></i>
        <span style="font-size:14px;font-weight:700">Alle MACs</span>
        <span id="ce-mac-modal-count" style="font-size:12px;color:var(--text3)">–</span>
        <div class="toolbar-spacer"></div>
        <input class="ce-mac-modal-search" id="ce-mac-modal-q" type="text" placeholder="MAC / IP / Gerät / Port…" oninput="ceMacTableFilter(this.value)">
        <button class="icon-btn" onclick="ceMacTableClose()" title="Schließen" style="flex-shrink:0"><i class="fa-solid fa-xmark"></i></button>
      </div>
      <div class="ce-mac-modal-body">
        <table class="data-table">
          <thead><tr>
            <th>MAC-Adresse</th>
            <th>IP</th>
            <th>Gerät</th>
            <th>Port</th>
            <th style="text-align:right">Gescannt</th>
          </tr></thead>
          <tbody id="ce-mac-modal-tbody"></tbody>
        </table>
        <div id="ce-mac-modal-empty" class="empty-state" style="display:none">
          <i class="fa-solid fa-ethernet"></i>
          <h3>Keine MACs vorhanden</h3>
          <p>Zuerst einen SNMP-Scan durchführen.</p>
        </div>
      </div>
    </div>
  </div>

  <!-- TAB: LIFECYCLE PLANNER -->
  <section class="tab-section" id="tab-lifecycle">
    <div class="toolbar">
      <span class="toolbar-title"><i class="fa-solid fa-timeline" style="color:var(--accent2);margin-right:6px"></i>Lifecycle-Planner</span>
      <div class="toolbar-spacer"></div>
      <button class="icon-btn" onclick="renderLifecycle()" title="Neu analysieren"><i class="fa-solid fa-arrows-rotate"></i></button>
    </div>
    <div class="lc-wrap" id="lc-wrap">
      <div class="empty-state"><i class="fa-solid fa-timeline"></i><h3>Keine Daten</h3><p>Zuerst Geräte laden.</p></div>
    </div>
  </section>

  <!-- TAB: PREDICTIVE ANOMALY -->
  <section class="tab-section" id="tab-anomaly">
    <div class="toolbar">
      <span class="toolbar-title"><i class="fa-solid fa-brain" style="color:var(--purple);margin-right:6px"></i>Predictive Anomaly</span>
      <div class="toolbar-spacer"></div>
      <span id="pa-last-run" style="color:var(--text3);font-size:12px"></span>
      <button class="icon-btn" onclick="paState.loaded=false;paState.results={};renderAnomalyPage()" title="Neu analysieren"><i class="fa-solid fa-arrows-rotate"></i></button>
    </div>
    <div class="pa-wrap" id="pa-wrap">
      <div class="empty-state"><i class="fa-solid fa-brain"></i><h3>Keine Daten</h3><p>Zuerst Geräte laden, dann Analyse starten.</p></div>
    </div>
  </section>

  <!-- TAB: ALERTS -->
  <!-- ═══════════════════════════════ ADD-INS TAB ════════════════════════════ -->
  <section class="tab-section" id="tab-addins">
    <div class="toolbar">
      <span class="toolbar-title"><i class="fa-solid fa-puzzle-piece" style="color:var(--accent);margin-right:6px"></i>Add-ins</span>
      <span class="toolbar-count" id="addins-count">–</span>
      <div class="toolbar-spacer"></div>
      <input id="addins-search" type="text" placeholder="Suchen…" oninput="addinsFilter(this.value)"
        style="background:rgba(255,255,255,.06);border:1px solid var(--border);border-radius:8px;color:var(--text);padding:6px 12px;font-size:13px;width:200px;outline:none">
      <button onclick="openVarsModal()" style="background:rgba(255,255,255,.06);border:1px solid var(--border);border-radius:8px;color:var(--text2);font-size:13px;font-weight:600;padding:7px 14px;cursor:pointer;display:inline-flex;align-items:center;gap:7px;white-space:nowrap">
        <i class="fa-solid fa-sliders"></i> Variablen
      </button>
      <button onclick="addinCreateOpen()" style="background:rgba(45,95,255,.2);border:1px solid rgba(45,95,255,.4);border-radius:8px;color:var(--accent2);font-size:13px;font-weight:700;padding:7px 14px;cursor:pointer;display:inline-flex;align-items:center;gap:7px;white-space:nowrap">
        <i class="fa-solid fa-plus"></i> Neu
      </button>
      <button class="icon-btn" onclick="loadAddins()" title="Neu laden"><i class="fa-solid fa-arrows-rotate" id="addins-refresh-icon"></i></button>
    </div>
    <div id="addins-empty" class="empty-state" style="display:none">
      <i class="fa-solid fa-puzzle-piece" style="font-size:36px;color:var(--border);margin-bottom:12px"></i>
      <div>Keine Add-ins gefunden.</div>
    </div>
    <div id="addins-loading" class="empty-state" style="display:none">
      <i class="fa-solid fa-circle-notch fa-spin" style="font-size:28px;color:var(--accent);margin-bottom:12px"></i>
      <div style="color:var(--text2)">Add-ins werden geladen…</div>
    </div>
    <div class="table-wrap" id="addins-table-wrap" style="display:none">
      <table class="data-table">
        <thead><tr>
          <th style="width:36px"></th>
          <th>Name</th>
          <th>Netzwerke</th>
          <th>Kommentar</th>
          <th style="width:80px"></th>
        </tr></thead>
        <tbody id="addins-tbody"></tbody>
      </table>
    </div>
  </section>

  <!-- ── Add-in Script View Modal ─────────────────────────────────────────── -->
  <div id="addin-script-modal" style="display:none;position:fixed;inset:0;background:rgba(0,0,0,.65);z-index:3000;align-items:center;justify-content:center" onclick="if(event.target===this)addinScriptClose()">
    <div style="background:var(--card);border:1px solid var(--border);border-radius:16px;width:min(860px,96vw);max-height:88vh;display:flex;flex-direction:column;overflow:hidden">
      <div style="display:flex;align-items:center;gap:12px;padding:16px 20px;border-bottom:1px solid var(--border)">
        <i class="fa-solid fa-code" style="color:var(--accent);font-size:16px"></i>
        <span id="addin-script-title" style="font-size:14px;font-weight:700;flex:1">Skript</span>
        <div id="addin-script-os-tabs" style="display:flex;gap:6px"></div>
        <button class="icon-btn" onclick="addinScriptClose()"><i class="fa-solid fa-xmark"></i></button>
      </div>
      <div id="addin-script-info" style="padding:10px 20px 0;display:flex;gap:10px;flex-wrap:wrap"></div>
      <pre id="addin-script-content" style="flex:1;overflow:auto;margin:0;padding:18px 20px;font-size:12px;line-height:1.6;font-family:'Cascadia Code','Fira Code','Consolas',monospace;color:var(--text);background:rgba(0,0,0,.2);white-space:pre-wrap;word-break:break-word"></pre>
    </div>
  </div>

  <!-- ── Add-in Erstellen Modal ───────────────────────────────────────────── -->
  <div id="addin-create-modal" style="display:none;position:fixed;inset:0;background:rgba(0,0,0,.65);z-index:3000;align-items:center;justify-content:center" onclick="if(event.target===this)addinCreateClose()">
    <div style="background:var(--card);border:1px solid var(--border);border-radius:16px;width:min(720px,96vw);max-height:92vh;display:flex;flex-direction:column;overflow:hidden">
      <!-- Header -->
      <div style="display:flex;align-items:center;gap:12px;padding:16px 20px;border-bottom:1px solid var(--border)">
        <i class="fa-solid fa-puzzle-piece" style="color:var(--accent);font-size:16px"></i>
        <span id="addin-modal-title" style="font-size:14px;font-weight:700;flex:1">Neues Add-in erstellen</span>
        <button class="icon-btn" onclick="addinCreateClose()"><i class="fa-solid fa-xmark"></i></button>
      </div>
      <!-- Body -->
      <div style="overflow-y:auto;padding:20px;display:flex;flex-direction:column;gap:16px">
        <!-- Name + Aktiviert -->
        <div style="display:flex;gap:14px;align-items:flex-start">
          <div style="flex:1">
            <label style="font-size:12px;font-weight:600;color:var(--text2);display:block;margin-bottom:6px">
              Name <span style="color:var(--red)">*</span>
              <span style="font-weight:400;color:var(--text3);margin-left:6px">nur a–z A–Z 0–9 und –</span>
            </label>
            <input id="addin-create-name" type="text" placeholder="Mein-Addin"
              oninput="addinCreateValidateName(this)"
              style="width:100%;background:rgba(255,255,255,.06);border:1px solid var(--border);border-radius:8px;color:var(--text);padding:9px 12px;font-size:14px;outline:none;box-sizing:border-box">
            <div id="addin-create-name-err" style="font-size:11px;color:var(--red);margin-top:4px;display:none">
              Nur Buchstaben, Ziffern und Bindestriche erlaubt.
            </div>
          </div>
          <div style="display:flex;flex-direction:column;align-items:center;gap:6px;padding-top:22px">
            <label class="toggle-switch">
              <input type="checkbox" id="addin-create-enabled">
              <span class="toggle-slider"></span>
            </label>
            <span style="font-size:11px;color:var(--text3)">Aktiv</span>
          </div>
        </div>
        <!-- Kommentar -->
        <div>
          <label style="font-size:12px;font-weight:600;color:var(--text2);display:block;margin-bottom:6px">Kommentar</label>
          <input id="addin-create-comment" type="text" placeholder="Optionale Beschreibung"
            style="width:100%;background:rgba(255,255,255,.06);border:1px solid var(--border);border-radius:8px;color:var(--text);padding:9px 12px;font-size:14px;outline:none;box-sizing:border-box">
        </div>
        <!-- Netzwerk-Zuweisung (nur im Edit-Modus) -->
        <div id="addin-net-section-wrap" style="display:none">
          <label style="font-size:12px;font-weight:600;color:var(--text2);display:block;margin-bottom:8px">
            <i class="fa-solid fa-network-wired" style="margin-right:6px;color:var(--text3)"></i>Netzwerk-Zuweisung
          </label>
          <div id="addin-net-section" style="background:rgba(0,0,0,.15);border:1px solid var(--border);border-radius:8px;padding:10px 14px;min-height:44px"></div>
        </div>
        <!-- OS-Typen -->
        <div>
          <label style="font-size:12px;font-weight:600;color:var(--text2);display:block;margin-bottom:8px">Skript gilt für</label>
          <div style="display:flex;flex-wrap:wrap;gap:8px" id="addin-create-os-wrap">
            <label id="lbl-addin-os-lcos" onclick="osLabelClick(this)" style="display:flex;align-items:center;gap:6px;font-size:12px;cursor:pointer;border-radius:6px;padding:6px 10px;border:1px solid rgba(45,95,255,.5);background:rgba(45,95,255,.18);color:var(--accent2);font-weight:600;transition:all .15s">
              <input type="radio" name="addin-os-group" id="addin-os-lcos" checked style="display:none"> LCOS
            </label>
            <label id="lbl-addin-os-lcoslx" onclick="osLabelClick(this)" style="display:flex;align-items:center;gap:6px;font-size:12px;cursor:pointer;border-radius:6px;padding:6px 10px;border:1px solid var(--border);background:rgba(255,255,255,.04);color:var(--text2);transition:all .15s">
              <input type="radio" name="addin-os-group" id="addin-os-lcoslx" style="display:none"> LCOS-LX
            </label>
            <label id="lbl-addin-os-swos" onclick="osLabelClick(this)" style="display:flex;align-items:center;gap:6px;font-size:12px;cursor:pointer;border-radius:6px;padding:6px 10px;border:1px solid var(--border);background:rgba(255,255,255,.04);color:var(--text2);transition:all .15s">
              <input type="radio" name="addin-os-group" id="addin-os-swos" style="display:none"> GS-2xxx (SwOS)
            </label>
            <label id="lbl-addin-os-sdk4" onclick="osLabelClick(this)" style="display:flex;align-items:center;gap:6px;font-size:12px;cursor:pointer;border-radius:6px;padding:6px 10px;border:1px solid var(--border);background:rgba(255,255,255,.04);color:var(--text2);transition:all .15s">
              <input type="radio" name="addin-os-group" id="addin-os-sdk4" style="display:none"> GS-3xxx (SDK4)
            </label>
            <label id="lbl-addin-os-xs" onclick="osLabelClick(this)" style="display:flex;align-items:center;gap:6px;font-size:12px;cursor:pointer;border-radius:6px;padding:6px 10px;border:1px solid var(--border);background:rgba(255,255,255,.04);color:var(--text2);transition:all .15s">
              <input type="radio" name="addin-os-group" id="addin-os-xs" style="display:none"> XS-5xxx
            </label>
            <label id="lbl-addin-os-fx" onclick="osLabelClick(this)" style="display:flex;align-items:center;gap:6px;font-size:12px;cursor:pointer;border-radius:6px;padding:6px 10px;border:1px solid var(--border);background:rgba(255,255,255,.04);color:var(--text2);transition:all .15s">
              <input type="radio" name="addin-os-group" id="addin-os-fx" style="display:none"> LCOS-FX
            </label>
          </div>
        </div>
        <!-- Skript -->
        <div>
          <label style="font-size:12px;font-weight:600;color:var(--text2);display:block;margin-bottom:6px">Skript-Inhalt</label>
          <textarea id="addin-create-script" rows="14" placeholder="# LCOS-Skript hier eingeben…"
            style="width:100%;background:rgba(0,0,0,.25);border:1px solid var(--border);border-radius:8px;color:var(--text);padding:12px;font-size:12px;font-family:'Cascadia Code','Fira Code','Consolas',monospace;line-height:1.6;outline:none;resize:vertical;box-sizing:border-box"></textarea>
        </div>
        <!-- Error / Status -->
        <div id="addin-create-error" style="display:none;background:rgba(255,0,77,.1);border:1px solid rgba(255,0,77,.3);border-radius:8px;padding:10px 14px;font-size:13px;color:var(--red)"></div>
      </div>
      <!-- Footer -->
      <div style="display:flex;justify-content:flex-end;gap:10px;padding:14px 20px;border-top:1px solid var(--border)">
        <button onclick="addinCreateClose()"
          style="background:rgba(255,255,255,.06);border:1px solid var(--border);border-radius:8px;color:var(--text2);font-size:13px;font-weight:600;padding:8px 18px;cursor:pointer">
          Abbrechen
        </button>
        <button id="addin-create-save-btn" onclick="addinCreateSave()"
          style="background:rgba(45,95,255,.25);border:1px solid rgba(45,95,255,.5);border-radius:8px;color:var(--accent2);font-size:13px;font-weight:700;padding:8px 22px;cursor:pointer;display:inline-flex;align-items:center;gap:8px">
          <i id="addin-save-icon" class="fa-solid fa-floppy-disk"></i> <span id="addin-save-text">Erstellen</span>
        </button>
      </div>
    </div>
  </div>

  <section class="tab-section" id="tab-alerts">
    <div class="mini-stats" id="alerts-mini-stats"></div>
    <div class="toolbar">
      <span class="toolbar-title">Alerts</span>
      <span class="toolbar-count" id="alerts-count">0</span>
      <div class="toolbar-spacer"></div>
      <button class="icon-btn" onclick="reloadAlerts()" title="Neu laden"><i class="fa-solid fa-arrows-rotate" id="alerts-refresh-icon"></i></button>
    </div>
    <div id="alerts-loading" class="empty-state" style="display:none">
      <i class="fa-solid fa-circle-notch fa-spin"></i>
      <h3>Lade Alerts…</h3>
    </div>
    <div class="table-wrap">
      <div class="table-section">
        <table class="data-table">
          <thead><tr><th>Schwere</th><th>Gerät</th><th>Standort</th><th>Nachricht</th><th>Zeitpunkt</th><th>Status</th></tr></thead>
          <tbody id="alerts-tbody"></tbody>
        </table>
        <div id="alerts-empty" class="empty-state" style="display:none">
          <i class="fa-solid fa-bell-slash"></i>
          <h3>Keine Alerts</h3>
          <p>Aktuell sind keine offenen Alerts vorhanden.</p>
        </div>
      </div>
    </div>
  </section>

  <!-- TAB: FIRMWARE -->
  <section class="tab-section" id="tab-firmware">
    <div class="toolbar">
      <span class="toolbar-title"><i class="fa-solid fa-microchip" style="color:var(--blue);margin-right:6px"></i>Firmware-Übersicht</span>
      <span class="toolbar-count" id="firmware-count">–</span>
      <div class="toolbar-spacer"></div>
      <button class="icon-btn" onclick="renderFirmware()" title="Aktualisieren"><i class="fa-solid fa-arrows-rotate"></i></button>
    </div>
    <div style="padding:0 24px 24px;overflow-y:auto;flex:1" id="firmware-wrap">
      <div class="empty-state"><i class="fa-solid fa-microchip"></i><h3>Keine Daten</h3><p>Zuerst Geräte laden.</p></div>
    </div>
  </section>

  <!-- TAB: STANDORTE -->
  <section class="tab-section" id="tab-sites">
    <div class="toolbar">
      <span class="toolbar-title"><i class="fa-solid fa-location-dot" style="color:var(--accent);margin-right:6px"></i>Standorte</span>
      <span class="toolbar-count" id="sites-count">–</span>
      <div class="toolbar-spacer"></div>
      <button class="icon-btn" onclick="loadSites()" title="Neu laden"><i class="fa-solid fa-arrows-rotate"></i></button>
    </div>
    <div class="sites-grid" id="sites-grid">
      <div class="empty-state" style="grid-column:1/-1"><i class="fa-solid fa-location-dot"></i><h3>Keine Standorte</h3><p>Zuerst Geräte laden.</p></div>
    </div>
  </section>

  <!-- TAB: EINSTELLUNGEN -->
  <section class="tab-section" id="tab-settings">
    <div class="toolbar">
      <span class="toolbar-title">Einstellungen</span>
    </div>
    <div class="settings-wrap">

      <!-- SNMP -->
      <div class="settings-card">
        <div class="settings-card-title">
          <i class="fa-solid fa-network-wired"></i> SNMP (v2c)
        </div>
        <div class="settings-row">
          <span class="settings-label">Read Community</span>
          <div>
            <input id="set-snmp-read" type="text" class="settings-input" placeholder="public">
            <div class="settings-hint">Wird für SNMP-Abfragen (MAC-Tabellen) im Netzwerkplan verwendet.</div>
          </div>
        </div>
        <div class="settings-row">
          <span class="settings-label">Write Community</span>
          <div>
            <input id="set-snmp-write" type="text" class="settings-input" placeholder="private">
            <div class="settings-hint">Für zukünftige Konfigurationsänderungen via SNMP (aktuell noch nicht aktiv).</div>
          </div>
        </div>
        <div class="settings-row">
          <span class="settings-label"></span>
          <div style="display:flex;align-items:center;gap:14px;">
            <button onclick="saveSnmpSettings()" class="settings-save-btn">
              <i class="fa-solid fa-floppy-disk"></i> Speichern
            </button>
            <span id="snmp-save-msg" style="font-size:12px;color:var(--green);display:none;">
              <i class="fa-solid fa-circle-check"></i> Gespeichert
            </span>
          </div>
        </div>
      </div>

    </div>
  </section>

  </div><!-- /content-area -->
  </div><!-- /app-body -->

</div><!-- #app -->

<!-- BULK ACTION BAR -->
<div id="bulk-bar">
  <i class="fa-solid fa-check-square" style="color:var(--accent);font-size:15px;flex-shrink:0"></i>
  <span class="bulk-sel-count" id="bulk-count">0 ausgewählt</span>
  <button class="bulk-btn bulk-btn-red" onclick="bulkActionReboot()"><i class="fa-solid fa-power-off"></i> Neustart</button>
  <button class="bulk-btn bulk-btn-blue" onclick="bulkActionFirmware()"><i class="fa-solid fa-microchip"></i> FW Update</button>
  <button class="bulk-btn bulk-btn-purple" onclick="bulkActionRollout()"><i class="fa-solid fa-rotate"></i> Konfig</button>
  <div style="flex:1"></div>
  <button class="bulk-btn bulk-btn-gray" onclick="bulkSelectAll()"><i class="fa-solid fa-check-double"></i> Alle</button>
  <button class="bulk-btn bulk-btn-gray" onclick="bulkClear()"><i class="fa-solid fa-times"></i> Abwählen</button>
  <button class="bulk-btn" style="background:none;border:1px solid rgba(255,0,77,.3);color:var(--red)" onclick="toggleBulkMode()"><i class="fa-solid fa-xmark"></i> Beenden</button>
</div>

<!-- ACTION STATUS MODAL -->
<div id="action-modal" onclick="if(event.target===this)closeActionModal()">
  <div class="action-modal-box">
    <div style="display:flex;align-items:center;gap:12px;padding:16px 20px;border-bottom:1px solid var(--border);flex-shrink:0">
      <i class="fa-solid fa-gear fa-spin" style="color:var(--accent);font-size:15px"></i>
      <span id="action-modal-title" style="font-size:14px;font-weight:700;flex:1">Aktion läuft…</span>
      <span id="action-modal-summary" style="font-size:12px;color:var(--text2)"></span>
    </div>
    <div id="action-device-list" style="overflow-y:auto;flex:1"></div>
    <div style="padding:12px 20px;border-top:1px solid var(--border);display:flex;justify-content:flex-end;flex-shrink:0">
      <button id="action-modal-close-btn" onclick="closeActionModal()" style="display:none;background:var(--accent);border:none;border-radius:8px;color:#fff;font-size:13px;font-weight:700;padding:8px 22px;cursor:pointer">
        Schließen
      </button>
    </div>
  </div>
</div>

<!-- CONFIG PREVIEW MODAL -->
<div id="cfg-preview-modal" onclick="if(event.target===this)closeCfgPreview()">
  <div style="background:var(--card);border:1px solid var(--border);border-radius:16px;width:min(860px,96vw);max-height:88vh;display:flex;flex-direction:column;overflow:hidden;animation:fadeUp .25s ease">
    <div style="display:flex;align-items:center;gap:12px;padding:16px 20px;border-bottom:1px solid var(--border);flex-shrink:0">
      <i class="fa-solid fa-eye" style="color:var(--accent);font-size:15px"></i>
      <span id="cfg-preview-title" style="font-size:14px;font-weight:700;flex:1">Konfig-Vorschau</span>
      <button class="icon-btn" onclick="closeCfgPreview()"><i class="fa-solid fa-xmark"></i></button>
    </div>
    <pre id="cfg-preview-content" style="flex:1;overflow:auto;margin:0;padding:18px 20px;font-size:11px;line-height:1.6;font-family:'Cascadia Code','Fira Code','Consolas',monospace;color:var(--text);background:rgba(0,0,0,.25);white-space:pre-wrap;word-break:break-word"></pre>
  </div>
</div>

<!-- DEVICE LOG MODAL -->
<div id="log-modal" onclick="if(event.target===this)closeLogModal()">
  <div class="log-modal-box">
    <div class="log-modal-head">
      <i class="fa-solid fa-file-lines" style="color:var(--accent);font-size:15px;flex-shrink:0"></i>
      <div class="log-modal-title" id="log-modal-title">Gerätelog</div>
      <span class="log-modal-sub" id="log-modal-sub"></span>
      <button class="log-modal-close" onclick="closeLogModal()"><i class="fa-solid fa-xmark"></i></button>
    </div>
    <div class="log-modal-toolbar">
      <div class="log-source-row">
        <button class="log-source-btn active" id="log-src-device" onclick="setLogSource('device',this)">
          <i class="fa-solid fa-file-lines"></i> Gerätelog
        </button>
        <button class="log-source-btn" id="log-src-siem" onclick="setLogSource('siem',this)">
          <i class="fa-solid fa-shield-halved"></i> SIEM
        </button>
      </div>
      <button class="log-filter-btn active" onclick="setLogSevFilter('all',this)">Alle</button>
      <button class="log-filter-btn" onclick="setLogSevFilter('critical',this)" style="color:var(--red)">Kritisch</button>
      <button class="log-filter-btn" onclick="setLogSevFilter('warning',this)" style="color:var(--amber)">Warnung</button>
      <button class="log-filter-btn" onclick="setLogSevFilter('info',this)" style="color:var(--blue)">Info</button>
      <div class="log-search">
        <i class="fa-solid fa-magnifying-glass"></i>
        <input type="text" id="log-search-input" placeholder="Nachricht filtern…" oninput="renderLogTable()">
      </div>
    </div>
    <div class="log-table-wrap">
      <table class="log-table">
        <thead>
          <tr>
            <th style="width:145px">Zeit</th>
            <th style="width:90px">Schwere</th>
            <th>Nachricht</th>
          </tr>
        </thead>
        <tbody id="log-tbody"></tbody>
      </table>
      <div id="log-empty" class="log-empty" style="display:none">
        <i class="fa-solid fa-circle-check" style="font-size:24px;opacity:.3;display:block;margin-bottom:10px;color:var(--green)"></i>
        Keine Logeinträge gefunden.
      </div>
    </div>
    <div class="log-modal-footer">
      <span class="log-count-info" id="log-count-info">–</span>
      <button class="log-load-more" id="log-load-more" onclick="loadMoreLogs()" disabled>
        <i class="fa-solid fa-angles-down"></i> Mehr laden
      </button>
    </div>
  </div>
</div>

<!-- VARIABLES MODAL -->
<div id="vars-modal" onclick="if(event.target===this)closeVarsModal()">
  <div style="background:var(--card);border:1px solid var(--border);border-radius:16px;width:min(700px,96vw);max-height:85vh;display:flex;flex-direction:column;overflow:hidden;animation:fadeUp .25s ease">
    <div style="display:flex;align-items:center;gap:12px;padding:16px 20px;border-bottom:1px solid var(--border);flex-shrink:0">
      <i class="fa-solid fa-sliders" style="color:var(--accent);font-size:15px"></i>
      <span style="font-size:14px;font-weight:700;flex:1">Add-in Variablen</span>
      <span id="vars-count" style="font-size:12px;color:var(--text2)"></span>
      <button class="icon-btn" onclick="closeVarsModal()"><i class="fa-solid fa-xmark"></i></button>
    </div>
    <div id="vars-list" style="overflow-y:auto;flex:1"></div>
  </div>
</div>

<!-- GLOBAL SEARCH -->
<div id="search-overlay" onclick="if(event.target===this)closeSearch()">
  <div class="search-modal">
    <div class="search-modal-input-wrap">
      <i class="fa-solid fa-magnifying-glass" style="font-size:18px;color:var(--text3);flex-shrink:0"></i>
      <input type="text" id="search-modal-input" class="search-modal-input" placeholder="Geräte, WLAN, VPN suchen…" oninput="runSearch(this.value)" autocomplete="off">
      <span class="search-kbd" onclick="closeSearch()">ESC</span>
    </div>
    <div id="search-results" class="search-results">
      <div class="search-hint"><i class="fa-solid fa-magnifying-glass" style="font-size:28px;color:var(--text3);margin-bottom:12px;display:block;opacity:.5"></i>Beginne mit der Eingabe… &nbsp;<span style="opacity:.5">/</span></div>
    </div>
  </div>
</div>

<div id="toast-container"></div>

<script>
// ─── STATE ────────────────────────────────────────────────────────────────────
const S = {
  apiKey:'', accountId:'', accountName:'',
  devices:{}, statistics:{},
  wlanClients:{},      // {deviceId: count}
  wlanStations:[],     // full station objects
  wlanNetworkMap:{},   // "{deviceId}:{ssid}" → internal LCOS LX network name
  wlanNeighbors:[], // neighbor AP objects
  accountNetworks:[], // [{id, name}] — LMC config networks
  vpnConnections:[], wanInterfaces:[], lldpNeighbors:[], lldpTable:[],
  configStates:{},
  lastSync:null, filter:'all', wlanFilter:'all', nbFilter:'all',
  activeTab:'devices',
  timer:null, countdown:0, refreshInterval:0,
};

// ─── HELPERS ──────────────────────────────────────────────────────────────────
function isOnline(d) {
  const s = d.heartbeatState || d.status?.heartbeatState || '';
  return typeof s === 'string' && s.toUpperCase() === 'ACTIVE';
}
// WAN logicalState: LANCOM uses eWan* enum values (e.g. "eWanInit" = active)
// "UP" covers REST-standard; anything with Disconnect/Idle/Down = inactive
function isWanUp(s) {
  if(!s) return false;
  const l = s.toLowerCase();
  return !(l.includes('disconnect') || l.includes('idle') || l === 'down' || l === 'false');
}
function fmtWanState(s) {
  if(!s) return '–';
  if(s === 'UP' || s === 'eWanInit' || s === 'eWanConnected') return 'UP';
  if(isWanUp(s)) return s.replace(/^eWan/, ''); // strip prefix → e.g. "Init"
  return s.replace(/^eWan/, ''); // show raw value without prefix
}
function fmt(v, unit='') { return (v===undefined||v===null||v==='') ? '–' : (v+unit); }
function fmtBytes(b) {
  if (!b && b!==0) return '–';
  b=Number(b); if(isNaN(b)) return '–';
  if(b<1024) return b+'B';
  if(b<1048576) return (b/1024).toFixed(1)+'K';
  if(b<1073741824) return (b/1048576).toFixed(1)+'M';
  return (b/1073741824).toFixed(2)+'G';
}
function fmtRate(kbps) {
  if(!kbps && kbps!==0) return '–';
  kbps=Number(kbps); if(isNaN(kbps)) return '–';
  return kbps<1000 ? kbps+'kbps' : (kbps/1000).toFixed(1)+'Mbps';
}
function signalLevel(rssi) {
  rssi=Number(rssi)||0;
  if(rssi>=-60) return 4;
  if(rssi>=-70) return 3;
  if(rssi>=-80) return 2;
  return 1;
}
function signalBar(rssi) {
  const lvl=signalLevel(rssi);
  return `<div class="signal-bar s${lvl}"><span></span><span></span><span></span><span></span></div>`;
}
function bandBadge(band) {
  if(!band) return '–';
  const b=band.toUpperCase();
  if(b.includes('6')) return '<span class="band-6">6 GHz</span>';
  if(b.includes('5')) return '<span class="band-5">5 GHz</span>';
  return '<span class="band-24">2.4 GHz</span>';
}
function statusDot(up, label='') {
  const cl = up ? 'sdot-green' : 'sdot-red';
  return `<span class="sdot ${cl}">${label||(up?'Up':'Down')}</span>`;
}
function escHtml(s) {
  return String(s||'').replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;');
}
function deviceName(d) {
  if(!d) return '–';
  return d.label||d.name||d.status?.deviceLabel||d.siteName||d.id?.substring(0,8)||'–';
}

// ─── API ──────────────────────────────────────────────────────────────────────
async function api(service, path, method='GET', body=null) {
  const r = await fetch('/api', {
    method:'POST',
    headers:{'Content-Type':'application/json'},
    body:JSON.stringify({api_key:S.apiKey, service, path, method, body}),
  });
  const text = await r.text();
  if(!r.ok) {
    let msg = `HTTP ${r.status}`;
    try { const e=JSON.parse(text); msg=e?.message||e?.error||e?.detail||msg; } catch{}
    throw new Error(msg);
  }
  if(!text.trim()) return null;
  try { return JSON.parse(text); }
  catch {
    const lines=text.trim().split('\n').filter(l=>l.trim());
    try { return lines.map(l=>JSON.parse(l)); } catch { return null; }
  }
}

// ─── LOGIN ────────────────────────────────────────────────────────────────────
document.getElementById('api-key-input').addEventListener('keydown', e=>{ if(e.key==='Enter') doLogin(); });
(function(){
  const saved=localStorage.getItem('lmc_api_key');
  if(saved){ document.getElementById('api-key-input').value=saved; document.getElementById('save-token-cb').checked=true; }
})();

async function doLogin() {
  const key=document.getElementById('api-key-input').value.trim();
  if(!key) return;
  const btn=document.getElementById('login-btn');
  const errEl=document.getElementById('login-error');
  btn.disabled=true; btn.innerHTML='<i class="fa-solid fa-circle-notch fa-spin"></i>&nbsp; Verbinde…';
  errEl.style.display='none';
  S.apiKey=key;
  try {
    const accounts=await api('auth','/accounts');
    if(!accounts||!accounts.length) throw new Error('Keine Accounts für diesen API-Key gefunden.');
    if(document.getElementById('save-token-cb').checked) localStorage.setItem('lmc_api_key',key);
    else localStorage.removeItem('lmc_api_key');
    if(accounts.length===1) { await selectAccount(accounts[0].id); }
    else { showAccountPicker(accounts); }
  } catch(e) {
    errEl.textContent=e.message||'Verbindung fehlgeschlagen.';
    errEl.style.display='block';
    btn.disabled=false; btn.innerHTML='<i class="fa-solid fa-right-to-bracket"></i>&nbsp; Anmelden';
  }
}

let _pickerAccounts = [];

function showAccountPicker(accounts) {
  _pickerAccounts = accounts;
  document.getElementById('account-picker').style.display='flex';
  const inp = document.getElementById('account-search');
  if(inp) { inp.value=''; setTimeout(()=>inp.focus(),80); }
  renderAccountList('');
}

function filterAccounts(q) {
  renderAccountList(q);
}

function renderAccountList(q) {
  const lq = q.trim().toLowerCase();
  const list = document.getElementById('account-list');
  const filtered = lq
    ? _pickerAccounts.filter(a => (a.name||'').toLowerCase().includes(lq) || (a.id||'').toLowerCase().includes(lq) || (a.identifier||'').toLowerCase().includes(lq))
    : _pickerAccounts;
  if(!filtered.length) {
    list.innerHTML=`<div style="text-align:center;color:var(--text3);font-size:13px;padding:24px 0"><i class="fa-solid fa-face-frown-open" style="display:block;font-size:22px;margin-bottom:8px;opacity:.4"></i>Kein Account gefunden</div>`;
    return;
  }
  list.innerHTML='';
  filtered.forEach(acc=>{
    const item=document.createElement('div');
    item.className='account-item';
    const displayName=acc.name||acc.identifier||acc.id.substring(0,8)+'…';
    item.innerHTML=`<div class="acc-icon"><i class="fa-solid fa-building"></i></div><div><div class="acc-name">${escHtml(displayName)}</div><div class="acc-id">${escHtml(acc.id)}</div></div><i class="fa-solid fa-chevron-right" style="color:var(--text3);margin-left:auto"></i>`;
    item.onclick=()=>{ document.getElementById('account-picker').style.display='none'; selectAccount(acc.id,acc.name); };
    list.appendChild(item);
  });
}

async function selectAccount(accountId, knownName) {
  S.accountId=accountId;
  if(knownName) { S.accountName=knownName; }
  else { try { const d=await api('auth',`/accounts/${accountId}`); S.accountName=d?.name||accountId; } catch { S.accountName=accountId; } }
  document.getElementById('login-screen').style.display='none';
  document.getElementById('app').style.display='flex';
  document.getElementById('header-account-name').textContent=S.accountName;
  // Gespeichertes Intervall laden
  const savedInterval=parseInt(localStorage.getItem('refreshInterval')||'0',10);
  S.refreshInterval=savedInterval;
  const sel=document.getElementById('refresh-select');
  if(sel) sel.value=String(savedInterval);
  loadBlacklist();
  loadAccountNetworks();
  await refreshDashboard();
  startCountdown();
}

function doLogout() {
  clearInterval(S.timer);
  S.apiKey=S.accountId=S.accountName='';
  S.devices={}; S.statistics={}; S.wlanClients={}; S.wlanStations=[]; S.wlanNeighbors=[]; S.wlanNetworkMap={}; S.accountNetworks=[];
  S.vpnConnections=[]; S.wanInterfaces=[]; S.lldpNeighbors=[]; S.lldpTable=[]; S.configStates={};
  siteFilter='all'; devFilter='all'; topoRootId=''; topoSiteFilter='';
  alertsData=[]; trafficHistory={}; ceData={};
  addinsData=[]; addinsNetworks={}; addinsScripts={};
  document.getElementById('badge-addins').textContent='–';
  document.getElementById('site-filter-toolbar').style.display='none';
  document.getElementById('site-tiles').style.display='none';
  localStorage.removeItem('lmc_api_key');
  document.getElementById('app').style.display='none';
  document.getElementById('login-screen').style.display='flex';
  document.getElementById('api-key-input').value='';
  document.getElementById('save-token-cb').checked=false;
  const btn=document.getElementById('login-btn');
  btn.disabled=false; btn.innerHTML='<i class="fa-solid fa-right-to-bracket"></i>&nbsp; Anmelden';
}

// ─── SIDEBAR ──────────────────────────────────────────────────────────────────
function toggleSidebar() {
  const sb=document.getElementById('sidebar');
  const collapsed=sb.classList.toggle('collapsed');
  localStorage.setItem('sidebarCollapsed', collapsed?'1':'0');
}
(function(){ if(localStorage.getItem('sidebarCollapsed')==='1') document.getElementById('sidebar')?.classList.add('collapsed'); })();

// ─── TABS ─────────────────────────────────────────────────────────────────────
function showTab(id) {
  S.activeTab=id;
  document.querySelectorAll('.tab-section').forEach(s=>s.classList.remove('active'));
  document.querySelectorAll('.tab-btn').forEach(b=>b.classList.remove('active'));
  document.getElementById('tab-'+id)?.classList.add('active');
  document.getElementById('tab-btn-'+id)?.classList.add('active');
  if(id==='topology'&&Object.keys(S.devices).length) setTimeout(()=>{renderTopology();setTimeout(topoFit,80);},30);
  if(id==='traffic'&&Object.keys(S.devices).length&&!Object.keys(trafficHistory).length) loadTrafficData();
  if(id==='alerts'&&S.accountId&&!alertsData.length) loadAlerts();
  if(id==='addins'&&S.accountId&&!addinsData.length) loadAddins();
  if(id==='client-explorer') ceInitDevices();
  if(id==='settings') loadSettingsUI();
  if(id==='energy') { loadEnergyPrice(); renderEnergy(); }
  if(id==='lifecycle') renderLifecycle();
  if(id==='anomaly') renderAnomalyPage();
  if(id==='firmware') renderFirmware();
  if(id==='sites') loadSites();
}

// ─── DATA LOADING ─────────────────────────────────────────────────────────────
async function refreshDashboard() {
  clearInterval(S.timer);
  document.getElementById('refresh-icon').classList.add('fa-spin');
  setLoading(true,'Lade Gerätedaten…');
  try {
    const [devList, stats] = await Promise.all([
      api('devices',`/accounts/${S.accountId}/devices`),
      api('devices',`/accounts/${S.accountId}/device_statistics`),
    ]);
    const devices=Array.isArray(devList)?devList:(devList?.devices||[]);
    S.devices={}; devices.forEach(d=>{ if(d.id) S.devices[d.id]=d; });
    S.statistics=stats||{};
    updateStats();

    const ids=Object.keys(S.devices);
    setLoading(true,'Lade Monitoring-Daten…');

    // Parallel: all monitoring data + config states
    const [wlanResult, vpnData, wanData, nbData, lldpData, lldpTableData, ...cfgResults] = await Promise.all([
      loadWlanData(ids),
      loadTable(ids, 'vpn-connection', ['deviceId','timeMs','type','hsvpn','peerName','peerIp','active','role','networkName','rxCounterBytes','txCounterBytes','packetLossPercent','rttAvgUs']),
      loadTable(ids, 'wan-interface',  ['deviceId','timeMs','connectionType','logicalState','ipV4','ipV6','rxCounterBytes','txCounterBytes','mobileModemSignalDecibelMw']),
      loadWlanNeighbors(ids),
      loadLldpData(ids),
      loadTable(ids, 'lan-interface',  ['deviceId','name','lldpName','active','description']),
      ...ids.map(id=>loadConfigState(id)),
    ]);

    S.wlanClients=wlanResult.counts;
    S.wlanStations=wlanResult.stations;
    S.wlanNetworkMap=wlanResult.networkMap||{};
    S.vpnConnections=vpnData;
    S.wanInterfaces=wanData;
    S.wlanNeighbors=nbData;
    S.lldpNeighbors=lldpData;
    S.lldpTable=lldpTableData;
    ids.forEach((id,i)=>{ S.configStates[id]=cfgResults[i]||{}; });

    S.lastSync=new Date();
    document.getElementById('sync-bar').textContent='Letzte Aktualisierung: '+S.lastSync.toLocaleTimeString('de-DE');

    updateAllBadges();
    buildSiteFilter();
    renderCurrentTab();

  } catch(e) {
    toast('error','Fehler beim Laden',e.message);
  } finally {
    setLoading(false);
    document.getElementById('refresh-icon').classList.remove('fa-spin');
    startCountdown();
  }
}

function renderCurrentTab() {
  renderDevices();
  renderWlan();
  renderVpn();
  renderWan();
  renderNeighbors();
  renderLldp();
  buildTopoSelector();
  renderEnergy();
  renderLifecycle();
  if(S.activeTab==='topology') setTimeout(()=>{renderTopology();setTimeout(topoFit,80);},30);
  if(S.activeTab==='addins') loadAddins();
}

// ─── WLAN DATA ────────────────────────────────────────────────────────────────
async function loadWlanData(deviceIds) {
  if(!deviceIds.length) return {counts:{}, stations:[], networkMap:{}};
  const [stationResults, ifRows] = await Promise.all([
    Promise.allSettled(deviceIds.map(async deviceId=>{
      try {
        const data=await api('monitoring',`/accounts/${S.accountId}/records/wlan_info_json?group=DEVICE&groupId=${deviceId}&period=MINUTE1&type=json&name=stations&latest=1`);
        const stations=(data?.items?.stations?.values?.[0])||[];
        const name=deviceName(S.devices[deviceId]);
        return {deviceId, stations:stations.map(s=>({...s,_deviceId:deviceId,_deviceName:name}))};
      } catch { return {deviceId, stations:[]}; }
    })),
    loadTable(deviceIds, 'wlan-interface', ['deviceId','ssid','name','networkName'], 'monitoring').catch(()=>[])
  ]);

  // Build networkMap: "{deviceId}:{ssid}" → internal LCOS LX network name (= lxTableIdentifier)
  // Priorität: interfaceName aus Station-Records (direkt vom Gerät) → wlan-interface Tabelle
  const networkMap={};
  const counts={}, allStations=[];

  // 1. Station-Records: interfaceName = lxTableIdentifier (höchste Priorität)
  stationResults.forEach(r=>{
    if(r.status==='fulfilled'){
      counts[r.value.deviceId]=r.value.stations.length;
      r.value.stations.forEach(s=>{
        if(s._deviceId && s.ssid && s.interfaceName)
          networkMap[s._deviceId+':'+s.ssid]=s.interfaceName;
        allStations.push(s);
      });
    }
  });

  // 2. wlan-interface Tabelle: nur ergänzen wo noch kein Eintrag
  ifRows.forEach(r=>{
    if(r.deviceId && r.ssid){
      const key=r.deviceId+':'+r.ssid;
      if(!networkMap[key]){
        const internalName=r.networkName||r.name;
        if(internalName) networkMap[key]=internalName;
      }
    }
  });

  return {counts, stations:allStations, networkMap};
}

async function loadWlanNeighbors(deviceIds) {
  if(!deviceIds.length) return [];
  const results=await Promise.allSettled(deviceIds.map(async deviceId=>{
    try {
      const data=await api('monitoring',`/accounts/${S.accountId}/records/wlan_info_json?group=DEVICE&groupId=${deviceId}&period=MINUTE1&type=json&name=neighbors&latest=1`);
      const neighbors=(data?.items?.neighbors?.values?.[0])||[];
      const name=deviceName(S.devices[deviceId]);
      return neighbors.map(n=>({...n,_deviceId:deviceId,_deviceName:name}));
    } catch { return []; }
  }));
  return results.flatMap(r=>r.status==='fulfilled'?r.value:[]);
}

async function loadRecords(deviceIds, recordType, metricName) {
  if(!deviceIds.length) return [];
  const results=await Promise.allSettled(deviceIds.map(async deviceId=>{
    try {
      const data=await api('monitoring',`/accounts/${S.accountId}/records/${recordType}?group=DEVICE&groupId=${deviceId}&period=MINUTE1&type=json&name=${metricName}&latest=1`);
      const rows=(data?.items?.[metricName]?.values?.[0])||[];
      const name=deviceName(S.devices[deviceId]);
      return rows.map(r=>({...r,_deviceId:deviceId,_deviceName:name}));
    } catch { return []; }
  }));
  return results.flatMap(r=>r.status==='fulfilled'?r.value:[]);
}

// Loads current-state data from the monitoring tables API (/api/{id}/tables/{tableName})
// Returns one row per logical entity (deduped by device+name, latest timeMs wins)
async function loadTable(deviceIds, tableName, columns, service) {
  if(!deviceIds.length) return [];
  const svc = service || 'monitoring';
  const from = new Date(Date.now() - 3600000).toISOString(); // last 1h
  const colStr = (columns||[]).map(c=>`column=${encodeURIComponent(c)}`).join('&');
  const all = [];
  for(let i=0; i<deviceIds.length; i+=10) {
    const chunk = deviceIds.slice(i,i+10);
    try {
      const qs = chunk.map(id=>`deviceId=${encodeURIComponent(id)}`).join('&')
               + `&from=${encodeURIComponent(from)}&limit=500`
               + (colStr ? `&${colStr}` : '');
      const data = await api(svc, `/api/${S.accountId}/tables/${tableName}?${qs}`);
      const rows = data?.data || [];
      // Deduplicate: per device keep one row per logical interface/tunnel (latest timeMs)
      // VPN key: connectionName; WAN key: connectionType+ip; fallback: timeMs
      const map = new Map();
      for(const r of rows) {
        const key = `${r.deviceId}__${
          r.peerName ||
          (r.connectionType ? r.connectionType+'__'+(r.ipV4||r.ipV6||'') : null) ||
          r.interfaceName || r.name ||
          r.timeMs
        }`;
        if(!map.has(key) || (r.timeMs||0) > (map.get(key).timeMs||0)) map.set(key, r);
      }
      for(const r of map.values()) {
        const dev = S.devices[r.deviceId];
        all.push({...r, _deviceId:r.deviceId, _deviceName: dev?.status?.name || deviceName(dev) || r.deviceId});
      }
    } catch(e) { console.error('[loadTable]', tableName, e.message); }
  }
  return all;
}

async function loadLldpData(deviceIds) {
  if(!deviceIds.length) return [];
  const all=[];
  // Batches of 3 to avoid rate limiting
  for(let i=0;i<deviceIds.length;i+=3){
    const batch=deviceIds.slice(i,i+3);
    const results=await Promise.allSettled(batch.map(async deviceId=>{
      for(let attempt=0;attempt<2;attempt++){
        try {
          const data=await api('monitoring',`/accounts/${S.accountId}/records/lan_info_json?group=DEVICE&groupId=${deviceId}&period=MINUTE1&type=json&source=NEW&name=interfaces&latest=1`);
          const ports=data?.items?.interfaces?.values?.[0];
          if(!ports||typeof ports!=='object') return [];
          const devName=S.devices[deviceId]?.status?.name||deviceId;
          return Object.entries(ports)
            .map(([portNum,p])=>({
              _deviceId: deviceId,
              _deviceName: devName,
              portNum: parseInt(portNum),
              portName: p.name||`LAN-${portNum}`,
              description: p.description||'',
              lldpNames: p.lldpNames||[],
              active: !!p.active,
              loops: p.loops||0,
              speed: p.speed,
              vlan: p.vlan,
              poeStatus: p.poeStatus,
              poePower: p.poePower,
              rxBitPerSec: p.rxBitPerSec,
              txBitPerSec: p.txBitPerSec,
              configuration: p.configuration||'',
              qosClass: p.qosClass,
            }))
            .sort((a,b)=>a.portNum-b.portNum);
        } catch(e) {
          if(attempt===0) await new Promise(r=>setTimeout(r,600));
        }
      }
      return [];
    }));
    all.push(...results.flatMap(r=>r.status==='fulfilled'?r.value:[]));
    if(i+3<deviceIds.length) await new Promise(r=>setTimeout(r,200));
  }
  return all;
}

async function loadConfigState(deviceId) {
  try { const d=await api('devices',`/accounts/${S.accountId}/devices/${deviceId}`); return d?.config||{}; } catch { return {}; }
}

// ─── STATS ────────────────────────────────────────────────────────────────────
function updateStats() {
  const set=(id,path)=>{
    const v=path.split('.').reduce((o,k)=>o?.[k],S.statistics);
    document.getElementById(id).textContent=v!==undefined?v:'–';
  };
  set('s-total','heartbeatState._total'); set('s-online','heartbeatState.active');
  set('s-offline','heartbeatState.inactive'); set('s-alerts','alertState.active');
  set('s-fw','firmwareState.obsolete'); set('s-cfg','configState.outdated');
}
function updateAllBadges() {
  const totalClients=Object.values(S.wlanClients).reduce((a,b)=>a+b,0);
  document.getElementById('s-wlan').textContent=Object.keys(S.wlanClients).length?totalClients:'–';
  document.getElementById('badge-devices').textContent=Object.keys(S.devices).length||'–';
  document.getElementById('badge-wlan').textContent=S.wlanStations.length||'–';
  document.getElementById('badge-vpn').textContent=S.vpnConnections.length||'–';
  document.getElementById('badge-wan').textContent=S.wanInterfaces.length||'–';
  document.getElementById('badge-neighbors').textContent=S.wlanNeighbors.length||'–';
  document.getElementById('badge-lldp').textContent=S.lldpNeighbors.filter(p=>p.lldpNames.length).length||'–';
}

// ─── TRAFFIC MONITOR ──────────────────────────────────────────────────────────
let trafficHistory = {};

async function loadTrafficData() {
  const ids = Object.keys(S.devices);
  if (!ids.length) return;
  const loading = document.getElementById('traffic-loading');
  const grid    = document.getElementById('traffic-grid');
  const empty   = document.getElementById('traffic-empty');
  loading.style.display = 'flex';
  grid.innerHTML = '';
  empty.style.display = 'none';
  trafficHistory = {};

  const from = new Date(Date.now() - 3600000).toISOString(); // last 1h
  for (let i = 0; i < ids.length; i += 5) {
    const batch = ids.slice(i, i + 5);
    await Promise.allSettled(batch.map(async deviceId => {
      try {
        const cols = ['deviceId','timeMs','connectionType','logicalState','ipV4','ipV6','rxCounterBytes','txCounterBytes'].map(c=>`column=${c}`).join('&');
        const qs = `deviceId=${encodeURIComponent(deviceId)}&from=${encodeURIComponent(from)}&limit=200&sort=timeMs&order=asc&${cols}`;
        const data = await api('monitoring', `/api/${S.accountId}/tables/wan-interface?${qs}`);
        const rows = data?.data;
        if (!rows?.length) return;
        // Group rows by interface key (connectionType + ip = one interface)
        const byIf = {};
        rows.forEach(r => {
          const key = (r.connectionType||'wan') + '__' + (r.ipV4||r.ipV6||'');
          if (!byIf[key]) byIf[key] = { pts:[], meta:null };
          byIf[key].pts.push({
            rx: r.rxCounterBytes ?? 0,
            tx: r.txCounterBytes ?? 0,
            up: isWanUp(r.logicalState||''),
            timeMs: r.timeMs || 0,
          });
          byIf[key].meta = r; // last row = most recent
        });
        Object.entries(byIf).forEach(([key, d]) => {
          const rxR=[], txR=[];
          for (let j=1; j<d.pts.length; j++) {
            const p=d.pts[j-1], c=d.pts[j];
            const dt = ((c.timeMs - p.timeMs) / 1000) || 60;
            rxR.push(Math.max(0, c.rx - p.rx) * 8 / dt);
            txR.push(Math.max(0, c.tx - p.tx) * 8 / dt);
          }
          if (!trafficHistory[deviceId]) trafficHistory[deviceId]={};
          trafficHistory[deviceId][key]={
            rxRates:rxR, txRates:txR,
            curRx: rxR[rxR.length-1]??0,
            curTx: txR[txR.length-1]??0,
            meta: d.meta||{}, up: d.pts[d.pts.length-1]?.up??false,
          };
        });
      } catch(e) { console.error('[traffic]', deviceId, e.message); }
    }));
    if (i+5 < ids.length) await new Promise(r=>setTimeout(r,200));
  }
  loading.style.display = 'none';
  renderTraffic();
}

function makeSpark(rates, color) {
  if (!rates.length) return '';
  const max=Math.max(...rates,1), W=100, H=40;
  const pts=rates.map((v,i)=>`${((i/Math.max(rates.length-1,1))*W).toFixed(1)},${(H-(v/max)*(H-6)-3).toFixed(1)}`).join(' ');
  return `<polygon points="0,${H} ${pts} ${W},${H}" fill="${color}" opacity="0.13"/>
    <polyline points="${pts}" fill="none" stroke="${color}" stroke-width="1.5" stroke-linejoin="round" stroke-linecap="round"/>`;
}

function renderTraffic() {
  const grid=document.getElementById('traffic-grid');
  const empty=document.getElementById('traffic-empty');
  const cards=[];
  Object.entries(trafficHistory).forEach(([deviceId,ifaces])=>{
    const dev=S.devices[deviceId]; if(!dev) return;
    Object.entries(ifaces).forEach(([ifKey,d])=>{
      cards.push({deviceId, devName:deviceName(dev), online:isOnline(dev), ifKey, ...d});
    });
  });
  document.getElementById('traffic-count').textContent=cards.length||0;
  document.getElementById('badge-traffic').textContent=cards.length||'–';
  const since=document.getElementById('traffic-since');
  if(S.lastSync) since.textContent='Stand: '+S.lastSync.toLocaleTimeString('de-DE');
  if(!cards.length){ grid.innerHTML=''; empty.style.display='block'; return; }
  empty.style.display='none';
  cards.sort((a,b)=>(b.online-a.online)||((b.curRx+b.curTx)-(a.curRx+a.curTx)));
  grid.innerHTML=cards.map(c=>{
    const m=c.meta;
    const ifLbl=[m.interfaceName||m.connectionType||m.name||c.ifKey.split('__')[0]].filter(Boolean).join(' · ');
    const ip=m.ipV4||m.ipV6||m.ip||m.ipAddress||'';
    const npts=Math.max(c.rxRates.length,c.txRates.length);
    const maxRx=c.rxRates.length?fmtRate(Math.max(...c.rxRates)/1000):'–';
    const maxTx=c.txRates.length?fmtRate(Math.max(...c.txRates)/1000):'–';
    const dot=c.up?'var(--green)':'var(--red)';
    const spark=npts?`
      <svg class="tc-spark" viewBox="0 0 100 40" preserveAspectRatio="none">
        ${makeSpark(c.rxRates.map(v=>v/1000),'#aadaf7')}
        ${makeSpark(c.txRates.map(v=>v/1000),'#a0ed3a')}
      </svg>
      <div class="tc-scale"><span>${npts}min</span><span style="color:var(--text2)">Max ↓${maxRx} ↑${maxTx}</span><span>jetzt</span></div>`
      :'<div style="font-size:11px;color:var(--text3);padding:6px 0;text-align:center">Keine Verlaufsdaten</div>';
    return `<div class="tc${c.online?'':' tc-offline'}">
      <div style="display:flex;align-items:flex-start;margin-bottom:2px;">
        <div style="min-width:0;flex:1">
          <div class="tc-dev"><span style="display:inline-block;width:7px;height:7px;border-radius:50%;background:${dot};margin-right:6px;vertical-align:middle;flex-shrink:0"></span>${escHtml(c.devName)}</div>
          <div class="tc-if">${escHtml(ifLbl)}${ip?' · <span class="mono" style="font-size:10px">'+escHtml(ip)+'</span>':''}</div>
        </div>
      </div>
      <div class="tc-rates">
        <div class="tc-rate" style="color:#aadaf7">↓ ${fmtRate(c.curRx/1000)}<div class="tc-rate-lbl">Download</div></div>
        <div class="tc-rate" style="color:#a0ed3a">↑ ${fmtRate(c.curTx/1000)}<div class="tc-rate-lbl">Upload</div></div>
      </div>
      ${spark}
    </div>`;
  }).join('');
}

async function reloadTraffic() {
  trafficHistory={};
  const icon=document.getElementById('traffic-refresh-icon');
  icon?.classList.add('fa-spin');
  await loadTrafficData();
  icon?.classList.remove('fa-spin');
}

// ─── SNMP settings (persisted) ────────────────────────────────────────────────
let snmpReadCommunity  = localStorage.getItem('snmpReadCommunity')  || 'public';
let snmpWriteCommunity = localStorage.getItem('snmpWriteCommunity') || 'private';

function loadSettingsUI() {
  const r = document.getElementById('set-snmp-read');
  const w = document.getElementById('set-snmp-write');
  if(r) r.value = snmpReadCommunity;
  if(w) w.value = snmpWriteCommunity;
}

function saveSnmpSettings() {
  snmpReadCommunity  = document.getElementById('set-snmp-read')?.value.trim()  || 'public';
  snmpWriteCommunity = document.getElementById('set-snmp-write')?.value.trim() || 'private';
  localStorage.setItem('snmpReadCommunity',  snmpReadCommunity);
  localStorage.setItem('snmpWriteCommunity', snmpWriteCommunity);
  const msg = document.getElementById('snmp-save-msg');
  if(msg){ msg.style.display=''; setTimeout(()=>{ msg.style.display='none'; }, 2500); }
}

// ─── SNMP CARD DEBUG ──────────────────────────────────────────────────────────
async function snmpCardTest(deviceId, host) {
  const area = document.getElementById(`snmp-debug-${deviceId}`);
  const btn  = document.getElementById(`snmp-btn-${deviceId}`);
  if (!area) return;

  // Toggle: wenn Ergebnis schon sichtbar → schließen
  if (area.style.display === 'block') {
    area.style.display = 'none';
    if (btn) btn.innerHTML = '<i class="fa-solid fa-network-wired"></i> SNMP';
    return;
  }

  area.style.display = 'block';
  area.innerHTML = '<i class="fa-solid fa-circle-notch fa-spin"></i> Teste SNMP…';
  if (btn) btn.innerHTML = '<i class="fa-solid fa-circle-notch fa-spin"></i> SNMP';

  try {
    const r = await fetch('/snmp', {
      method: 'POST',
      headers: {'Content-Type':'application/json'},
      body: JSON.stringify({ host, community: snmpReadCommunity||'public', version:'2c', type:'test' }),
    });
    const result = await r.json();
    if (result.ok) {
      area.innerHTML = `<span style="color:var(--green)"><i class="fa-solid fa-circle-check"></i> SNMP OK</span><br><span style="color:var(--text2)">${escHtml(result.sysDescr)}</span>`;
    } else {
      area.innerHTML = `<span style="color:var(--amber)"><i class="fa-solid fa-triangle-exclamation"></i> Keine Antwort</span><br><span style="color:var(--text3)">${escHtml(result.sysDescr||'Timeout oder SNMP deaktiviert')}</span>`;
    }
  } catch(e) {
    area.innerHTML = `<span style="color:var(--red)"><i class="fa-solid fa-circle-xmark"></i> Fehler: ${escHtml(e.message)}</span>`;
  }
  if (btn) btn.innerHTML = '<i class="fa-solid fa-network-wired"></i> SNMP';
}

// ─── FILTER / SEARCH / DEVICE RENDER ──────────────────────────────────────────
let devFilter='all';
function setFilter(f,btn) { devFilter=f; document.querySelectorAll('#status-filter-group .filter-btn').forEach(b=>b.classList.remove('active')); btn.classList.add('active'); renderDevices(); }
let siteFilter='all';
function setSiteFilter(f,btn) { siteFilter=f; document.querySelectorAll('#site-filter-group .filter-btn').forEach(b=>b.classList.remove('active')); btn.classList.add('active'); renderDevices(); renderSiteTiles(); }

function buildSiteFilter() {
  const sites=[...new Set(Object.values(S.devices).map(d=>d.siteName||'').filter(Boolean))].sort();
  const toolbar=document.getElementById('site-filter-toolbar');
  const group=document.getElementById('site-filter-group');
  if(sites.length<2){ toolbar.style.display='none'; renderSiteTiles(); return; }
  toolbar.style.display='flex';
  group.innerHTML=`<button class="filter-btn${siteFilter==='all'?' active':''}" onclick="setSiteFilter('all',this)">Alle</button>`
    +sites.map(s=>`<button class="filter-btn${siteFilter===s?' active':''}" data-site="${s.replace(/&/g,'&amp;').replace(/"/g,'&quot;')}" onclick="setSiteFilter(this.dataset.site,this)">${escHtml(s)}</button>`).join('');
  renderSiteTiles();
}
let wlanFilter='all';
let wlanBlacklist=[];
function setWlanFilter(f,btn) { wlanFilter=f; document.querySelectorAll('#tab-wlan .filter-btn').forEach(b=>b.classList.remove('active')); btn.classList.add('active'); renderWlan(); }
let nbFilter='all';
function setNbFilter(f,btn) { nbFilter=f; document.querySelectorAll('#tab-neighbors .filter-btn').forEach(b=>b.classList.remove('active')); btn.classList.add('active'); renderNeighbors(); }

function renderDevices() {
  const grid=document.getElementById('device-grid');
  const q=document.getElementById('search-input').value.toLowerCase();
  let visible=Object.values(S.devices).filter(d=>{
    if(devFilter==='online'&&!isOnline(d)) return false;
    if(devFilter==='offline'&&isOnline(d)) return false;
    if(devFilter==='alert'&&!d.alerting?.hasAlert) return false;
    if(siteFilter!=='all'&&(d.siteName||'')!==siteFilter) return false;
    if(q){
      const f=[d.label,d.name,d.siteName,d.status?.deviceLabel,d.status?.model,d.status?.serial,d.status?.ip,d.id];
      if(!f.some(x=>x&&x.toLowerCase().includes(q))) return false;
    }
    return true;
  });
  document.getElementById('device-count').textContent=visible.length;
  if(!visible.length){ grid.innerHTML=`<div class="empty-state" style="grid-column:1/-1"><i class="fa-solid fa-satellite-dish"></i><h3>Keine Geräte gefunden</h3><p>Anderer Filter oder Suchbegriff?</p></div>`; return; }

  // Sortierung: Standort → Alert → Online → Name
  visible.sort((a,b)=>{
    const sA=(a.siteName||'').localeCompare(b.siteName||'');
    if(sA!==0) return sA;
    const aA=a.alerting?.hasAlert?0:1, bA=b.alerting?.hasAlert?0:1;
    if(aA!==bA) return aA-bA;
    const aO=isOnline(a)?0:1, bO=isOnline(b)?0:1;
    if(aO!==bO) return aO-bO;
    return deviceName(a).localeCompare(deviceName(b));
  });

  // Gruppenheader nur wenn kein Standortfilter aktiv und mehrere Standorte vorhanden
  const multiSite=siteFilter==='all'&&new Set(visible.map(d=>d.siteName||'')).size>1;
  let html='', lastSite=null;
  for(const d of visible) {
    const site=d.siteName||'(kein Standort)';
    if(multiSite&&site!==lastSite) {
      const siteCount=visible.filter(x=>(x.siteName||'(kein Standort)')===site).length;
      html+=`<div class="site-header"><span class="site-header-name"><i class="fa-solid fa-map-marker-alt" style="margin-right:5px;opacity:.6"></i>${escHtml(site)}</span><div class="site-header-line"></div><span class="site-header-count">${siteCount}</span></div>`;
      lastSite=site;
    }
    html+=deviceCard(d);
  }
  grid.innerHTML=html;
}

function fmtRelTime(ts) {
  if(!ts) return '';
  const diff = Date.now() - new Date(ts).getTime();
  const m = Math.floor(diff/60000);
  const h = Math.floor(m/60);
  const d = Math.floor(h/24);
  if(d>0) return `seit ${d}d ${h%24}h`;
  if(h>0) return `seit ${h}h ${m%60}m`;
  if(m>0) return `seit ${m}m`;
  return 'gerade eben';
}

function deviceCard(d) {
  const id=d.id, online=isOnline(d), hasAlert=d.alerting?.hasAlert===true;
  const fwState=d.firmwareState||'', cfgCat=S.configStates[id]?.category||'';
  const wlan=S.wlanClients[id];
  const name=deviceName(d);
  const site=d.siteName&&d.siteName!==name?d.siteName:'';
  const model=d.status?.model||'–', ip=d.status?.ip||'–';
  const serial=d.status?.serial||'–', fw=d.status?.fwLabel||'–';
  const life=d.status?.lifecycle?.status||'–';
  const fwOld=fwState==='OBSOLETE', cfgOld=['OUTDATED','ROLLOUT_PENDING'].includes(cfgCat);
  const cardClass=hasAlert?'alert':(!online?'offline':'');
  const fwBadge=fwOld?`<span class="badge badge-fw-old"><i class="fa-solid fa-arrow-up-from-bracket"></i>${fwState}</span>`:(fwState==='CURRENT'?`<span class="badge badge-fw-ok"><i class="fa-solid fa-check"></i>FW OK</span>`:'');
  const cfgBadge=cfgOld?`<span class="badge badge-cfg-old"><i class="fa-solid fa-gear"></i>${cfgCat}</span>`:(cfgCat==='CURRENT'?`<span class="badge badge-cfg-ok"><i class="fa-solid fa-check"></i>CFG OK</span>`:'');
  const alertBadge=hasAlert?`<span class="badge badge-alert"><i class="fa-solid fa-triangle-exclamation"></i>ALERT</span>`:'';
  const onlineBadge=online?`<span class="badge badge-online"><i class="fa-solid fa-circle"></i>ONLINE</span>`:`<span class="badge badge-offline"><i class="fa-solid fa-circle"></i>OFFLINE</span>`;
  const wlanLoaded=Object.keys(S.wlanClients).length>0;
  const wlanRow=wlanLoaded?`<div class="info-row"><div class="info-lbl">WLAN Clients</div><div class="info-val">${wlan!==undefined?`<span style="${wlan>0?'color:var(--teal);font-weight:700':''}">${wlan}</span>`:'–'}</div></div>`:'';
  const lifecycleColor=life==='ACTIVE'?'color:var(--green)':(life!=='–'?'color:var(--amber)':'');
  const offlineTs = !online ? fmtRelTime(d.status?.lastHeartbeatDate) : '';
  const isBulkSel = bulkSelected.has(id);
  return `<div class="device-card ${cardClass}${isBulkSel?' bulk-selected':''}" id="card-${id}" onclick="if(bulkMode)bulkToggleDevice('${id}',event)">
  <div class="card-header">
    <div class="device-icon ${online?'online':'offline'}"><i class="fa-solid ${online?'fa-tower-broadcast':'fa-plug-circle-xmark'}"></i></div>
    <div class="card-header-info">
      <div class="device-name" title="${escHtml(name)}">${escHtml(name)}</div>
      ${site?`<div class="device-site"><i class="fa-solid fa-location-dot" style="margin-right:3px;color:var(--text3)"></i>${escHtml(site)}</div>`:''}
      ${offlineTs?`<div class="offline-since"><i class="fa-solid fa-clock" style="margin-right:3px;opacity:.5"></i>${offlineTs}</div>`:''}
    </div>
    <div class="card-badges">${onlineBadge}${alertBadge}</div>
    <div class="card-select" onclick="event.stopPropagation();bulkToggleDevice('${id}',event)">
      <input type="checkbox" ${isBulkSel?'checked':''} onclick="event.stopPropagation()" onchange="bulkToggleDevice('${id}',event)" style="width:17px;height:17px;cursor:pointer;accent-color:var(--accent)">
    </div>
  </div>
  <div class="card-body">
    <div class="info-grid">
      <div class="info-row"><div class="info-lbl">Modell</div><div class="info-val">${escHtml(model)}</div></div>
      <div class="info-row"><div class="info-lbl">IP-Adresse</div><div class="info-val mono">${ip}</div></div>
      <div class="info-row"><div class="info-lbl">Seriennummer</div><div class="info-val mono">${serial}</div></div>
      <div class="info-row"><div class="info-lbl">Firmware</div><div class="info-val mono" style="font-size:10px">${escHtml(fw)}</div></div>
      <div class="info-row"><div class="info-lbl">FW Status</div><div class="info-val">${fwBadge||`<span style="color:var(--text2)">${fwState||'–'}</span>`}</div></div>
      <div class="info-row"><div class="info-lbl">CFG Status</div><div class="info-val">${cfgBadge||`<span style="color:var(--text2)">${cfgCat||'–'}</span>`}</div></div>
      <div class="info-row"><div class="info-lbl">Lifecycle</div><div class="info-val" style="${lifecycleColor}">${life}</div></div>
      ${wlanRow}
    </div>
  </div>
  <div class="card-footer">
    <div class="card-footer-primary">
      <button class="action-btn btn-reboot" onclick="actionReboot('${id}','${escHtml(name)}')" title="Neu starten">
        <i class="fa-solid fa-power-off"></i> Neustart
      </button>
      <button class="action-btn btn-fw" ${!fwOld?'disabled':''} onclick="actionFirmwareUpdate('${id}','${escHtml(name)}')" title="${fwOld?'Firmware aktualisieren':'Firmware aktuell'}">
        <i class="fa-solid fa-microchip"></i> FW Update
      </button>
      <button class="action-btn btn-cfg" ${!cfgOld?'disabled':''} onclick="actionConfigRollout('${id}','${escHtml(name)}')" title="${cfgOld?'Konfig ausrollen':'Konfig aktuell'}">
        <i class="fa-solid fa-rotate"></i> Rollout
      </button>
    </div>
    <div class="card-footer-secondary">
      <button class="action-btn icon-only btn-snmp" id="snmp-btn-${id}" ${!online||ip==='–'?'disabled':''} onclick="snmpCardTest('${id}','${ip}')" title="${online&&ip!=='–'?'SNMP testen':'Gerät offline oder keine IP'}">
        <i class="fa-solid fa-network-wired"></i>
      </button>
      <button class="action-btn icon-only btn-web" ${!online?'disabled':''} onclick="openWebconfig('${id}','${escHtml(name)}')" title="${online?'WEBconfig öffnen':'Gerät offline'}">
        <i class="fa-solid fa-display"></i>
      </button>
      <button class="action-btn icon-only btn-preview" onclick="openCfgPreview('${id}','${escHtml(name)}')" title="Konfig-Vorschau">
        <i class="fa-solid fa-eye"></i>
      </button>
      <button class="action-btn icon-only" style="background:rgba(45,95,255,.08);border-color:rgba(45,95,255,.25);color:var(--purple)" onclick="openLogModal('${id}','${escHtml(name)}')" title="Gerätelog anzeigen">
        <i class="fa-solid fa-file-lines"></i>
      </button>
    </div>
  </div>
  <div class="snmp-card-debug" id="snmp-debug-${id}"></div>
</div>`;
}

// ─── WLAN TABLE ───────────────────────────────────────────────────────────────
function renderWlan() {
  const q=document.getElementById('wlan-search').value.toLowerCase();
  let rows=S.wlanStations.filter(s=>{
    const band=(s.band||'').toUpperCase();
    if(wlanFilter!=='all'&&!band.includes(wlanFilter.replace('GHZ',''))) return false;
    if(q){
      const apName=S.devices[s.deviceId]?.status?.name||s._deviceName||'';
      const f=[s.mac,s.ip,apName,s.interfaceName,s.ssid,s.name,s.vendor];
      if(!f.some(x=>x&&String(x).toLowerCase().includes(q))) return false;
    }
    return true;
  });
  document.getElementById('wlan-count').textContent=rows.length;

  // Mini stats
  const by24=S.wlanStations.filter(s=>(s.band||'').toUpperCase().includes('24')).length;
  const by5=S.wlanStations.filter(s=>(s.band||'').toUpperCase().includes('5')&&!(s.band||'').toUpperCase().includes('24')).length;
  const by6=S.wlanStations.filter(s=>(s.band||'').toUpperCase().includes('6')&&!(s.band||'').toUpperCase().includes('24')).length;
  document.getElementById('wlan-mini-stats').innerHTML=`
    <div class="mini-stat"><div class="ms-icon" style="background:rgba(119,200,210,.15);color:var(--teal)"><i class="fa-solid fa-wifi"></i></div><div><div class="ms-val sv-wlan">${S.wlanStations.length}</div><div class="ms-lbl">Gesamt</div></div></div>
    <div class="mini-stat"><div class="ms-icon" style="background:rgba(170,218,247,.15);color:var(--blue)"><i class="fa-solid fa-wifi"></i></div><div><div class="ms-val" style="color:var(--blue)">${by24}</div><div class="ms-lbl">2.4 GHz</div></div></div>
    <div class="mini-stat"><div class="ms-icon" style="background:rgba(45,95,255,.15);color:var(--purple)"><i class="fa-solid fa-wifi"></i></div><div><div class="ms-val" style="color:var(--purple)">${by5}</div><div class="ms-lbl">5 GHz</div></div></div>
    <div class="mini-stat"><div class="ms-icon" style="background:rgba(119,200,210,.15);color:var(--teal)"><i class="fa-solid fa-wifi"></i></div><div><div class="ms-val" style="color:var(--teal)">${by6}</div><div class="ms-lbl">6 GHz</div></div></div>`;

  const tbody=document.getElementById('wlan-tbody');
  const empty=document.getElementById('wlan-empty');
  if(!rows.length){ tbody.innerHTML=''; empty.style.display='block'; return; }
  empty.style.display='none';
  tbody.innerHTML=rows.map(s=>{
    const rssi=s.rssi||s.signalLevel||s.signal||0;
    const apName=S.devices[s.deviceId]?.status?.name||s._deviceName||'–';
    const hostname=s.name||'–';
    const vendorHint=s.vendor&&s.vendor!==s.mac?`<span class="muted" style="font-size:11px;display:block">${escHtml(s.vendor)}</span>`:'';
    const mac=s.mac||'';
    const ssid=s.ssid||'–';
    const networkName=S.wlanNetworkMap[s._deviceId+':'+s.ssid]||s.ssid||'–';
    const isBlocked=wlanBlacklist.some(e=>e.mac===mac);
    const blockFn=isBlocked?`unblockMac('${mac}')`:`blockWlanClient('${mac}')`;
    const blockBtn=mac?`<button class="btn-block${isBlocked?' blocked':''}" onclick="${blockFn}">${isBlocked?'<i class="fa-solid fa-lock-open"></i> Entsperren':'<i class="fa-solid fa-ban"></i> Sperren'}</button>`:'';
    return `<tr>
      <td class="device-ref">${escHtml(apName)}</td>
      <td class="muted">${escHtml(s.interfaceName||'–')}</td>
      <td class="mono" style="font-size:12px">${escHtml(ssid)}</td>
      <td class="muted" style="font-size:12px">${escHtml(networkName)}</td>
      <td>${escHtml(hostname)}${vendorHint}</td>
      <td class="mono">${escHtml(mac||'–')}</td>
      <td class="mono">${s.ip||'–'}</td>
      <td>${bandBadge(s.band)}</td>
      <td class="muted">${s.channel||'–'}</td>
      <td style="display:flex;align-items:center;gap:6px">${rssi?signalBar(rssi):''}<span class="muted" style="font-size:11px">${rssi?rssi+'dBm':''}</span></td>
      <td class="muted">${fmtRate(s.actualRxRate)}</td>
      <td class="muted">${fmtRate(s.actualTxRate)}</td>
      <td class="muted">${fmtRate(s.actualRate)}</td>
      <td>${blockBtn}</td>
    </tr>`;
  }).join('');
}

// ─── MAC BLACKLIST ────────────────────────────────────────────────────────────
function loadBlacklist() {
  try {
    const raw=localStorage.getItem('lmc_blacklist_'+S.accountId);
    wlanBlacklist=raw?JSON.parse(raw):[];
  } catch { wlanBlacklist=[]; }
  renderBlacklist();
}

function saveBlacklist() {
  localStorage.setItem('lmc_blacklist_'+S.accountId, JSON.stringify(wlanBlacklist));
}

function blockWlanClient(mac) {
  if(!mac||wlanBlacklist.some(e=>e.mac===mac.toUpperCase()||e.mac===mac)) return;
  const s=S.wlanStations.find(x=>x.mac===mac)||{};
  const apName=S.devices[s.deviceId]?.status?.name||s._deviceName||'';
  const hostname=s.name||'';
  const ssid=s.ssid||'';
  const networkName=S.wlanNetworkMap[s._deviceId+':'+s.ssid]||s.ssid||'';
  wlanBlacklist.push({ mac: mac.toUpperCase(), hostname, apName, ssid, networkName, blocked: new Date().toISOString() });
  saveBlacklist();
  renderBlacklist();
  renderWlan();
  toast('warn','Gesperrt',`${mac} wurde zur Sperrliste hinzugefügt.`);
}

function unblockMac(mac) {
  const idx=wlanBlacklist.findIndex(e=>e.mac===mac.toUpperCase()||e.mac===mac);
  if(idx<0) return;
  wlanBlacklist.splice(idx,1);
  saveBlacklist();
  renderBlacklist();
  renderWlan();
  toast('info','Entsperrt',`${mac} wurde von der Sperrliste entfernt.`);
}

function renderBlacklist() {
  const el=document.getElementById('blacklist-list');
  const countEl=document.getElementById('blacklist-count');
  const infoEl=document.getElementById('blacklist-addin-info');
  const nameEl=document.getElementById('blacklist-addin-name');
  if(!el) return;
  if(countEl) countEl.textContent=wlanBlacklist.length;

  // Show/hide addin info
  const savedAddin=S.accountId?JSON.parse(localStorage.getItem('lmc_blacklist_addin_'+S.accountId)||'null'):null;
  if(infoEl&&nameEl) {
    if(savedAddin?.name) { infoEl.style.display='flex'; nameEl.textContent='Add-in: '+savedAddin.name; }
    else { infoEl.style.display='none'; }
  }

  if(!wlanBlacklist.length) {
    el.innerHTML=`<div id="blacklist-empty" style="padding:20px;text-align:center;color:var(--text3);font-size:13px;"><i class="fa-solid fa-circle-check" style="display:block;font-size:20px;margin-bottom:8px;opacity:.3;color:var(--green)"></i>Keine MAC-Adressen gesperrt</div>`;
    return;
  }
  el.innerHTML=`<table class="blacklist-table">
    <thead><tr><th>MAC-Adresse</th><th>SSID</th><th>Netzwerk</th><th>Hostname</th><th>Gesperrt am</th><th></th></tr></thead>
    <tbody>${wlanBlacklist.map(e=>{
      const dt=e.blocked?new Date(e.blocked).toLocaleString('de-DE'):'–';
      return `<tr>
        <td class="mono">${escHtml(e.mac)}</td>
        <td class="mono" style="font-size:12px">${escHtml(e.ssid||'–')}</td>
        <td class="muted" style="font-size:12px">${escHtml(e.networkName||'–')}</td>
        <td>${escHtml(e.hostname||'–')}</td>
        <td class="muted" style="font-size:12px">${dt}</td>
        <td><button class="btn-unblock" onclick="unblockMac('${e.mac}')"><i class="fa-solid fa-trash-can"></i></button></td>
      </tr>`;
    }).join('')}</tbody>
  </table>`;
}

async function generateBlacklistAddin() {
  if(!wlanBlacklist.length) { toast('warn','Leer','Sperrliste ist leer – zuerst MACs sperren.'); return; }
  const btn=document.getElementById('btn-gen-addin');
  if(btn) { btn.disabled=true; btn.innerHTML='<i class="fa-solid fa-circle-notch fa-spin"></i> Generiere…'; }
  try {
    const script=generateBlacklistScript(wlanBlacklist);
    const savedAddin=JSON.parse(localStorage.getItem('lmc_blacklist_addin_'+S.accountId)||'null');
    const addinName='Dashboard-WLAN-MAC-Sperrliste';

    if(savedAddin?.id) {
      // Update existing add-in script
      await api('config',`/configapplication/accounts/${S.accountId}/applications/${savedAddin.id}/script`,'POST',{ content: script, lcosLx: true });
      toast('ok','Add-in aktualisiert',`"${addinName}" wurde aktualisiert.`);
    } else {
      // Create new add-in
      const newAddin=await api('config',`/configapplication/accounts/${S.accountId}/applications`,'POST',{
        name: addinName,
        comment: 'Automatisch generiert vom LANCOM LMC Dashboard. Aktiviert LEPS und setzt WLAN MAC-Sperrliste.',
        type: 'SCRIPT',
        enabled: true
      });
      const id=newAddin?.id||newAddin?.applicationId;
      if(!id) throw new Error('Keine Add-in-ID erhalten');
      await api('config',`/configapplication/accounts/${S.accountId}/applications/${id}/script`,'POST',{ content: script, lcosLx: true });
      localStorage.setItem('lmc_blacklist_addin_'+S.accountId, JSON.stringify({ id, name: addinName }));
      toast('ok','Add-in erstellt',`"${addinName}" wurde als neues Add-in erstellt.`);
    }
    renderBlacklist();
  } catch(err) {
    toast('error','Fehler','Add-in konnte nicht generiert werden: '+(err.message||err));
  } finally {
    if(btn) { btn.disabled=false; btn.innerHTML='<i class="fa-solid fa-code"></i> Add-in generieren'; }
  }
}

function generateBlacklistScript(entries) {
  // Gruppiere nach SSID — interner Name wird zur Laufzeit per context.network.ssids[ssid].lxTableIdentifier ermittelt
  const bySsid={};
  entries.forEach(e=>{
    const ssid=e.ssid||'Default';
    if(!bySsid[ssid]) bySsid[ssid]=[];
    bySsid[ssid].push(e);
  });

  const varLines=[];
  const profileLines=[];
  const userLines=[];
  Object.entries(bySsid).forEach(([ssid,macs])=>{
    // Sicherer JS-Variablenname aus der SSID
    const varName='lxNet_'+ssid.replace(/[^a-zA-Z0-9_]/g,'_');
    const profileName='Sperrliste-'+ssid;
    // Interner LCOS LX Netzwerkname wird zur Laufzeit aus dem Context gelesen
    varLines.push(`  var ${varName} = context.network.ssids[${JSON.stringify(ssid)}].lxTableIdentifier;`);
    profileLines.push(`  addLepsProfiles(${JSON.stringify(profileName)}, ${varName}, "Disabled", "0");`);
    macs.forEach(e=>{
      const label=e.hostname||e.mac;
      userLines.push(`  addLepsUUser(${JSON.stringify(label)}, ${JSON.stringify(profileName)}, "", "${e.mac.toUpperCase()}", "0");`);
    });
  });

  return `// LMC-Dashboard: MAC-Sperrliste (LCOS LX)
// Generiert: ${new Date().toLocaleString('de-DE')} | Eintraege: ${entries.length}
/**
* @param {Config} config
* @param {Context} context
* Do not edit this comment or parameter types. Required for code suggestions
*/
exports.main = function(config, context) {

  // LEPS auf Access Point aktivieren
  config.setScalarByOid("13.2.20.133.1", "1");

  var addLepsProfiles = function(Name, NetworkName, CheckMacAddress, Vlan) {
    var t = config.getTableByOid("13.2.20.133.2");
    var r = t.createNewRow();
    r.setByOid(1, Name);
    r.setByOid(2, NetworkName);
    r.setByOid(3, CheckMacAddress);
    r.setByOid(4, Vlan);
    t.addOrMerge(r);
  };

  var addLepsUUser = function(Name, Profile, Passwort, MacAddress, Vlan) {
    var t = config.getTableByOid("13.2.20.133.3");
    var r = t.createNewRow();
    r.setByOid(1, Name);
    r.setByOid(2, Profile);
    r.setByOid(3, Passwort);
    r.setByOid(7, MacAddress);
    r.setByOid(4, Vlan);
    t.addOrMerge(r);
  };

  // Internen LCOS LX Netzwerknamen pro SSID aus Context lesen
${varLines.join('\n')}

  // LEPS-Profile pro SSID
${profileLines.join('\n')}

  // Gesperrte MAC-Adressen
${userLines.join('\n')}

};`;
}

// ─── DEVICE LOG MODAL ─────────────────────────────────────────────────────────
let logState = { deviceId:'', deviceName:'', allLogs:[], nextOffset:null, sevFilter:'all', source:'device' };

const SEV_LABEL = ['Emergency','Alert','Critical','Error','Warning','Notice','Info','Debug'];

function sevClass(sev) {
  const n = parseInt(sev);
  if(isNaN(n)) return '6';
  if(n<=2) return '0';
  if(n<=3) return '2';
  if(n<=5) return '4';
  return '6';
}
function sevLabel(sev) {
  const n = parseInt(sev);
  return SEV_LABEL[n] || ('Sev '+sev);
}

// Normalize log entries from different sources into { _time, _sev, _msg }
function normalizeLogs(logs, source) {
  return logs.map(l => {
    const time = l.timestamp || l.createdAt || l.time || l.date || '';
    const sev  = l.severity ?? l.level ?? l.priority ?? 6;
    const msg  = l.message || l.rawMessage || l.text || l.description || l.msg || '';
    return { ...l, _time: time, _sev: sev, _msg: msg };
  });
}

async function openLogModal(deviceId, deviceName) {
  logState = { deviceId, deviceName, allLogs:[], nextOffset:null, sevFilter:'all', source:'device' };
  // Reset source tabs
  document.getElementById('log-src-device')?.classList.add('active');
  document.getElementById('log-src-siem')?.classList.remove('active');
  document.getElementById('log-modal-title').textContent = deviceName + ' – Gerätelog';
  document.getElementById('log-modal-sub').textContent = '';
  document.getElementById('log-tbody').innerHTML = '<tr><td colspan="3" class="log-empty"><i class="fa-solid fa-circle-notch fa-spin"></i> Lade…</td></tr>';
  document.getElementById('log-empty').style.display = 'none';
  document.getElementById('log-search-input').value = '';
  document.getElementById('log-count-info').textContent = 'Lade…';
  document.getElementById('log-load-more').disabled = true;
  // Reset severity filter
  document.querySelectorAll('.log-filter-btn').forEach((b,i) => b.classList.toggle('active', i===0));
  document.getElementById('log-modal').style.display = 'flex';
  await loadMoreLogs(true);
}

function closeLogModal() {
  document.getElementById('log-modal').style.display = 'none';
}

async function setLogSource(src, btn) {
  if(logState.source === src) return;
  logState.source = src;
  logState.allLogs = [];
  logState.nextOffset = null;
  document.querySelectorAll('.log-source-btn').forEach(b => b.classList.remove('active'));
  btn.classList.add('active');
  const title = src === 'device'
    ? logState.deviceName + ' – Gerätelog'
    : logState.deviceName + ' – SIEM';
  document.getElementById('log-modal-title').textContent = title;
  document.getElementById('log-modal-sub').textContent = '';
  document.getElementById('log-search-input').value = '';
  document.getElementById('log-count-info').textContent = 'Lade…';
  document.getElementById('log-load-more').disabled = true;
  document.getElementById('log-tbody').innerHTML = '<tr><td colspan="3" class="log-empty"><i class="fa-solid fa-circle-notch fa-spin"></i> Lade…</td></tr>';
  document.getElementById('log-empty').style.display = 'none';
  await loadMoreLogs(true);
}

function setLogSevFilter(f, btn) {
  logState.sevFilter = f;
  document.querySelectorAll('.log-filter-btn').forEach(b => b.classList.remove('active'));
  btn.classList.add('active');
  renderLogTable();
}

async function loadMoreLogs(initial=false) {
  const btn = document.getElementById('log-load-more');
  btn.disabled = true;
  btn.innerHTML = '<i class="fa-solid fa-circle-notch fa-spin"></i> Lade…';
  try {
    let rawLogs = [];
    let hasMore  = false;

    if(logState.source === 'device') {
      // cloud-service-logging — per-device paginated endpoint
      let url = `/accounts/${S.accountId}/logs/devices/${logState.deviceId}/paginated?lang=DE&limit=50`;
      if(!initial && logState.nextOffset !== null) url += `&offset=${logState.nextOffset}`;
      const data = await api('logging', url);
      // Normalize various response shapes
      rawLogs = data?.items || data?.logs || data?.entries || (Array.isArray(data) ? data : []);
      // Pagination: check common fields
      const next = data?.nextOffset ?? data?.next ?? data?.pagination?.next ?? null;
      logState.nextOffset = next;
      hasMore = next != null && next !== '' && next !== logState.nextOffset;
    } else {
      // cloud-service-siem — account-level, filter by deviceId client-side
      let url = `/accounts/${S.accountId}/logs?limit=100`;
      if(!initial && logState.nextOffset !== null) url += `&offset=${logState.nextOffset}`;
      const data = await api('siem', url);
      rawLogs = (data?.deviceLogs || []).filter(l => l.deviceId === logState.deviceId);
      logState.nextOffset = data?.nextOffset ?? null;
      hasMore = data?.nextOffset != null && data.nextOffset !== data.endOffset;
    }

    const normalized = normalizeLogs(rawLogs, logState.source);
    logState.allLogs.push(...normalized);
    renderLogTable();
    const total = logState.allLogs.length;
    document.getElementById('log-count-info').textContent =
      `${total} Eintr${total===1?'ag':'äge'} geladen`;
    btn.disabled = !hasMore;
    btn.innerHTML = '<i class="fa-solid fa-angles-down"></i> Mehr laden';
  } catch(e) {
    document.getElementById('log-tbody').innerHTML =
      `<tr><td colspan="3" style="padding:20px;color:var(--red);text-align:center"><i class="fa-solid fa-circle-exclamation"></i> Fehler: ${escHtml(e.message)}</td></tr>`;
    btn.innerHTML = '<i class="fa-solid fa-angles-down"></i> Mehr laden';
  }
}

function renderLogTable() {
  const q = document.getElementById('log-search-input').value.toLowerCase();
  const f = logState.sevFilter;
  let rows = logState.allLogs.filter(l => {
    const sev = parseInt(l._sev);
    if(f==='critical' && sev > 2) return false;
    if(f==='warning'  && (sev < 3 || sev > 4)) return false;
    if(f==='info'     && (sev < 5 || sev > 6)) return false;
    if(q && !l._msg.toLowerCase().includes(q)) return false;
    return true;
  });

  const tbody = document.getElementById('log-tbody');
  const empty = document.getElementById('log-empty');
  if(!rows.length) {
    tbody.innerHTML = '';
    empty.style.display = 'block';
    return;
  }
  empty.style.display = 'none';
  // Newest first
  rows = rows.slice().sort((a,b) => new Date(b._time) - new Date(a._time));
  tbody.innerHTML = rows.map(l => {
    const dt = l._time ? new Date(l._time).toLocaleString('de-DE') : '–';
    const sc = sevClass(l._sev);
    const sl = sevLabel(l._sev);
    const msg = escHtml(l._msg || '–');
    return `<tr>
      <td style="white-space:nowrap;color:var(--text3);font-size:11px">${dt}</td>
      <td><span class="log-sev log-sev-${sc}">${sl}</span></td>
      <td class="log-raw">${msg}</td>
    </tr>`;
  }).join('');
  document.getElementById('log-modal-sub').textContent = `${rows.length} angezeigt`;
}

// ─── VPN TABLE ────────────────────────────────────────────────────────────────
function renderVpn() {
  const q=document.getElementById('vpn-search').value.toLowerCase();
  let rows=S.vpnConnections.filter(v=>!q||[v._deviceName,v.peerName,v.networkName,v.peerIp,v.type,v.hsvpn===true?'HSVPN':'IPsec'].some(x=>x&&String(x).toLowerCase().includes(q)));
  document.getElementById('vpn-count').textContent=rows.length;
  const upCount=rows.filter(v=>v.active===true||v.active==='true').length;
  document.getElementById('vpn-mini-stats').innerHTML=`
    <div class="mini-stat"><div class="ms-icon" style="background:rgba(45,95,255,.15);color:var(--accent)"><i class="fa-solid fa-shield-halved"></i></div><div><div class="ms-val" style="color:var(--accent)">${rows.length}</div><div class="ms-lbl">Gesamt</div></div></div>
    <div class="mini-stat"><div class="ms-icon" style="background:rgba(160,237,58,.15);color:var(--green)"><i class="fa-solid fa-circle-check"></i></div><div><div class="ms-val sv-online">${upCount}</div><div class="ms-lbl">Aktiv</div></div></div>
    <div class="mini-stat"><div class="ms-icon" style="background:rgba(255,0,77,.15);color:var(--red)"><i class="fa-solid fa-circle-xmark"></i></div><div><div class="ms-val sv-offline">${rows.length-upCount}</div><div class="ms-lbl">Inaktiv</div></div></div>`;
  const tbody=document.getElementById('vpn-tbody');
  const empty=document.getElementById('vpn-empty');
  if(!rows.length){ tbody.innerHTML=''; empty.style.display='block'; return; }
  empty.style.display='none';
  tbody.innerHTML=rows.map(v=>{
    const up     = v.active === true || v.active === 'true';
    const name   = v.peerName || v.networkName || '–';
    const proto  = v.hsvpn===true ? 'HSVPN' : (v.type==='SD_VPN'?'SD-VPN':v.type==='LTA'?'LTA':'IPsec');
    const remote = v.peerIp || '–';
    const rtt    = v.rttAvgUs ? (v.rttAvgUs/1000).toFixed(1)+' ms' : '–';
    const loss   = v.packetLossPercent!=null ? v.packetLossPercent+'%' : '–';
    return `<tr>
      <td class="device-ref">${escHtml(v._deviceName)}</td>
      <td>${escHtml(name)}</td>
      <td class="muted">${escHtml(proto)}</td>
      <td>${statusDot(up)}</td>
      <td class="mono">${escHtml(v.role||'–')}</td>
      <td class="mono">${remote}</td>
      <td class="muted">${fmtBytes(v.rxCounterBytes)}</td>
      <td class="muted">${fmtBytes(v.txCounterBytes)}</td>
    </tr>`;
  }).join('');
}

// ─── WAN TABLE ────────────────────────────────────────────────────────────────
function renderWan() {
  const q=document.getElementById('wan-search').value.toLowerCase();
  let rows=S.wanInterfaces.filter(w=>!q||[w._deviceName,w.interfaceName,w.name,w.interface,w.ipV4,w.ipV6,w.ip,w.connectionType,w.type].some(x=>x&&String(x).toLowerCase().includes(q)));
  document.getElementById('wan-count').textContent=rows.length;
  const upCount=rows.filter(w=>isWanUp(w.logicalState||w.state||w.status||w.linkState||'')||w.connected===true).length;
  document.getElementById('wan-mini-stats').innerHTML=`
    <div class="mini-stat"><div class="ms-icon" style="background:rgba(170,218,247,.15);color:var(--blue)"><i class="fa-solid fa-globe"></i></div><div><div class="ms-val" style="color:var(--blue)">${rows.length}</div><div class="ms-lbl">Interfaces</div></div></div>
    <div class="mini-stat"><div class="ms-icon" style="background:rgba(160,237,58,.15);color:var(--green)"><i class="fa-solid fa-circle-check"></i></div><div><div class="ms-val sv-online">${upCount}</div><div class="ms-lbl">Online</div></div></div>`;
  const tbody=document.getElementById('wan-tbody');
  const empty=document.getElementById('wan-empty');
  if(!rows.length){ tbody.innerHTML=''; empty.style.display='block'; return; }
  empty.style.display='none';
  tbody.innerHTML=rows.map(w=>{
    const up = isWanUp(w.logicalState||w.state||w.status||w.linkState||'') || w.connected===true;
    const iface = w.interfaceName || w.name || w.interface || w.connectionType || '–';
    const type  = w.connectionType || w.type || w.medium || '–';
    const ip    = w.ipV4 || w.ipV6 || w.ip || w.ipAddress || '–';
    const gw    = w.gateway || w.defaultGateway || '–';
    return `<tr>
      <td class="device-ref">${escHtml(w._deviceName)}</td>
      <td>${escHtml(iface)}</td>
      <td class="muted">${escHtml(type)}</td>
      <td>${statusDot(up, fmtWanState(w.logicalState||w.state||''))}</td>
      <td class="mono">${ip}</td>
      <td class="mono">${gw}</td>
      <td class="muted">${fmtBytes(w.rxCounterBytes||w.rxBytes||w.rx)}</td>
      <td class="muted">${fmtBytes(w.txCounterBytes||w.txBytes||w.tx)}</td>
    </tr>`;
  }).join('');
}

// ─── NEIGHBORS TABLE ──────────────────────────────────────────────────────────
function renderNeighbors() {
  const q=document.getElementById('nb-search').value.toLowerCase();
  let rows=S.wlanNeighbors.filter(n=>{
    const band=(n.band||n.frequency||'').toUpperCase();
    if(nbFilter!=='all'&&!band.includes(nbFilter.replace('GHZ',''))) return false;
    if(q){
      const f=[n.ssid,n.bssid,n.mac,n._deviceName];
      if(!f.some(x=>x&&String(x).toLowerCase().includes(q))) return false;
    }
    return true;
  });
  document.getElementById('nb-count').textContent=rows.length;
  const ssids=new Set(rows.map(n=>n.ssid||n.bssid).filter(Boolean)).size;
  document.getElementById('nb-mini-stats').innerHTML=`
    <div class="mini-stat"><div class="ms-icon" style="background:rgba(119,200,210,.15);color:var(--pink)"><i class="fa-solid fa-satellite-dish"></i></div><div><div class="ms-val" style="color:var(--pink)">${rows.length}</div><div class="ms-lbl">AP gesamt</div></div></div>
    <div class="mini-stat"><div class="ms-icon" style="background:rgba(45,95,255,.15);color:var(--accent)"><i class="fa-solid fa-broadcast-tower"></i></div><div><div class="ms-val" style="color:var(--accent)">${ssids}</div><div class="ms-lbl">Netze</div></div></div>`;
  const tbody=document.getElementById('nb-tbody');
  const empty=document.getElementById('nb-empty');
  if(!rows.length){ tbody.innerHTML=''; empty.style.display='block'; return; }
  empty.style.display='none';
  // Sort by signal
  rows.sort((a,b)=>(Number(b.rssi||b.signal||0))-(Number(a.rssi||a.signal||0)));
  tbody.innerHTML=rows.map(n=>{
    const rssi=n.rssi||n.signal||n.signalLevel||0;
    const own=n.own===true||n.ownNetwork===true||n.isOwn===true;
    return `<tr>
      <td class="device-ref">${escHtml(n._deviceName)}</td>
      <td>${n.ssid?`<strong>${escHtml(n.ssid)}</strong>`:'<span class="muted">(hidden)</span>'}</td>
      <td class="mono">${escHtml(n.bssid||n.mac||'–')}</td>
      <td>${bandBadge(n.band||n.frequency)}</td>
      <td class="muted">${n.channel||'–'}</td>
      <td style="display:flex;align-items:center;gap:6px">${rssi?signalBar(rssi):''}<span class="muted" style="font-size:11px">${rssi?rssi+'dBm':''}</span></td>
      <td class="muted">${escHtml(n.security||n.encryption||n.authMode||'–')}</td>
      <td>${own?'<span class="badge badge-online"><i class="fa-solid fa-check"></i>Ja</span>':'<span class="muted">–</span>'}</td>
    </tr>`;
  }).join('');
}

// ─── LLDP / PORTS TABLES ──────────────────────────────────────────────────────
let lldpView='lldp';
function setLldpView(v,btn) {
  lldpView=v;
  document.querySelectorAll('#tab-lldp .filter-btn').forEach(b=>b.classList.remove('active'));
  btn.classList.add('active');
  document.getElementById('lldp-view-lldp').style.display=v==='lldp'?'':'none';
  document.getElementById('lldp-view-ports').style.display=v==='ports'?'':'none';
  renderLldp();
}

function lldpBadge(names) {
  if(!names||!names.length) return '<span class="muted">–</span>';
  return names.map(n=>`<span style="background:rgba(119,200,210,.15);color:var(--teal);padding:2px 7px;border-radius:4px;font-size:12px;font-weight:600">${escHtml(n)}</span>`).join(' ');
}
function speedMbit(s) { return s?Math.round(s/1000000)+'&nbsp;Mbit/s':'–'; }
function poeCell(status,power) {
  if(!status||status==='Unknown') return '<span class="muted">–</span>';
  return `${escHtml(status)}${power?` <span class="muted">${power}W</span>`:''}`;
}

function renderLldp() {
  const q=document.getElementById('lldp-search').value.toLowerCase();
  const allPorts=S.lldpNeighbors;
  const switches=new Set(allPorts.map(p=>p._deviceId)).size;
  const loopPorts=allPorts.filter(p=>p.loops>0).length;
  const withLldp=allPorts.filter(p=>p.lldpNames.length).length;

  document.getElementById('lldp-mini-stats').innerHTML=`
    <div class="mini-stat"><div class="ms-icon" style="background:rgba(119,200,210,.15);color:var(--amber)"><i class="fa-solid fa-server"></i></div><div><div class="ms-val" style="color:var(--amber)">${switches}</div><div class="ms-lbl">Switches</div></div></div>
    <div class="mini-stat"><div class="ms-icon" style="background:rgba(45,95,255,.15);color:var(--accent)"><i class="fa-solid fa-plug"></i></div><div><div class="ms-val" style="color:var(--accent)">${allPorts.filter(p=>p.active).length}</div><div class="ms-lbl">Ports aktiv</div></div></div>
    <div class="mini-stat"><div class="ms-icon" style="background:rgba(119,200,210,.15);color:var(--teal)"><i class="fa-solid fa-diagram-project"></i></div><div><div class="ms-val" style="color:var(--teal)">${withLldp}</div><div class="ms-lbl">LLDP Nachbarn</div></div></div>
    ${loopPorts?`<div class="mini-stat"><div class="ms-icon" style="background:rgba(255,0,77,.2);color:var(--red)"><i class="fa-solid fa-triangle-exclamation"></i></div><div><div class="ms-val" style="color:var(--red)">${loopPorts}</div><div class="ms-lbl">Loops!</div></div></div>`:''}`;

  if(lldpView==='lldp') {
    let rows=allPorts.filter(p=>{
      if(!p.lldpNames.length) return false;
      if(!q) return true;
      return [p._deviceName,p.portName,p.description,...p.lldpNames].some(x=>x&&x.toLowerCase().includes(q));
    });
    document.getElementById('lldp-count').textContent=rows.length;
    const tbody=document.getElementById('lldp-tbody');
    const empty=document.getElementById('lldp-empty');
    if(!rows.length){ tbody.innerHTML=''; empty.style.display='block'; return; }
    empty.style.display='none';
    tbody.innerHTML=rows.map(p=>`<tr>
      <td class="device-ref">${escHtml(p._deviceName)}</td>
      <td><strong>${escHtml(p.portName)}</strong></td>
      <td class="muted">${escHtml(p.description)||'–'}</td>
      <td>${lldpBadge(p.lldpNames)}</td>
      <td>${statusDot(p.active)}</td>
      <td class="muted">${speedMbit(p.speed)}</td>
      <td class="muted">${p.vlan??'–'}</td>
      <td class="muted" style="white-space:nowrap">${poeCell(p.poeStatus,p.poePower)}</td>
      <td class="muted">${fmtRate(p.rxBitPerSec)}</td>
      <td class="muted">${fmtRate(p.txBitPerSec)}</td>
    </tr>`).join('');

  } else {
    let rows=allPorts.filter(p=>{
      if(!q) return true;
      return [p._deviceName,p.portName,p.description,...p.lldpNames].some(x=>x&&x.toLowerCase().includes(q));
    });
    document.getElementById('lldp-count').textContent=rows.length;
    const tbody=document.getElementById('ports-tbody');
    const empty=document.getElementById('ports-empty');
    if(!rows.length){ tbody.innerHTML=''; empty.style.display='block'; return; }
    empty.style.display='none';
    tbody.innerHTML=rows.map(p=>{
      const loopCell=p.loops>0
        ? `<span style="background:rgba(255,0,77,.15);color:var(--red);padding:2px 8px;border-radius:4px;font-size:12px;font-weight:700"><i class="fa-solid fa-triangle-exclamation"></i> ${p.loops}</span>`
        : '<span class="muted">0</span>';
      const rowStyle=p.loops>0?'background:rgba(255,0,77,.05);':!p.active?'opacity:.5':'';
      return `<tr style="${rowStyle}">
        <td class="device-ref">${escHtml(p._deviceName)}</td>
        <td><strong>${escHtml(p.portName)}</strong></td>
        <td class="muted">${escHtml(p.description)||'–'}</td>
        <td>${lldpBadge(p.lldpNames)}</td>
        <td>${statusDot(p.active)}</td>
        <td>${loopCell}</td>
        <td class="muted">${speedMbit(p.speed)}</td>
        <td class="muted">${p.vlan??'–'}</td>
        <td class="muted">${escHtml(p.configuration)||'–'}</td>
        <td class="muted" style="white-space:nowrap">${poeCell(p.poeStatus,p.poePower)}</td>
        <td class="muted">${p.active?fmtRate(p.rxBitPerSec):'–'}</td>
        <td class="muted">${p.active?fmtRate(p.txBitPerSec):'–'}</td>
      </tr>`;
    }).join('');
  }
}

// ─── ACTIONS ──────────────────────────────────────────────────────────────────
async function actionReboot(deviceId, name) {
  if(!confirm(`Gerät "${name}" wirklich neu starten?`)) return;
  const btn=findActionBtn(deviceId,'btn-reboot');
  setButtonLoading(btn,true);
  try {
    await api('devices',`/accounts/${S.accountId}/actions/reboot`,'POST',[deviceId]);
    toast('success','Neustart gesendet',`"${name}" wird neu gestartet.`);
  } catch(e) { toast('error','Fehler beim Neustart',e.message); }
  finally { setButtonLoading(btn,false); }
}
async function actionFirmwareUpdate(deviceId, name) {
  if(!confirm(`Firmware von "${name}" aktualisieren?`)) return;
  const btn=findActionBtn(deviceId,'btn-fw');
  setButtonLoading(btn,true);
  try {
    const fwData=await api('devices',`/accounts/${S.accountId}/firmware/update?deviceIds=${deviceId}`);
    const recommendedId=fwData?.[deviceId]?.recommendedId;
    if(!recommendedId) throw new Error('Kein Firmware-Update verfügbar.');
    await api('devices',`/accounts/${S.accountId}/firmware/update`,'POST',[{deviceId,firmwareId:recommendedId}]);
    toast('success','Firmware-Update gestartet',`Update für "${name}" wurde eingeleitet.`);
  } catch(e) { toast('error','Fehler beim FW-Update',e.message); }
  finally { setButtonLoading(btn,false); }
}
async function actionConfigRollout(deviceId, name) {
  if(!confirm(`Konfiguration auf "${name}" ausrollen?`)) return;
  const btn=findActionBtn(deviceId,'btn-cfg');
  setButtonLoading(btn,true);
  try {
    await api('config',`/configdevice/accounts/${S.accountId}/devices/${deviceId}/rollout?forceRollout=false&addDependentCentralSites=false`,'POST');
    toast('success','Konfig-Rollout gestartet',`Konfiguration wird auf "${name}" ausgerollt.`);
  } catch(e) { toast('error','Fehler beim Konfig-Rollout',e.message); }
  finally { setButtonLoading(btn,false); }
}
function findActionBtn(deviceId,cls) { return document.getElementById(`card-${deviceId}`)?.querySelector(`.${cls}`); }
function setButtonLoading(btn,loading) {
  if(!btn) return;
  if(loading){ btn._orig=btn.innerHTML; btn.innerHTML='<i class="fa-solid fa-circle-notch fa-spin"></i>'; btn.disabled=true; }
  else { if(btn._orig) btn.innerHTML=btn._orig; btn.disabled=false; }
}

// ─── TOAST ────────────────────────────────────────────────────────────────────
function toast(type, title, msg) {
  const icons={success:'fa-circle-check',error:'fa-circle-xmark',info:'fa-circle-info'};
  const el=document.createElement('div');
  el.className=`toast ${type}`;
  el.innerHTML=`<div class="toast-icon"><i class="fa-solid ${icons[type]||icons.info}"></i></div><div class="toast-msg"><strong>${escHtml(title)}</strong>${msg?escHtml(msg):''}</div>`;
  document.getElementById('toast-container').appendChild(el);
  setTimeout(()=>{ el.classList.add('fade-out'); el.addEventListener('animationend',()=>el.remove()); },4500);
}

// ─── NETWORK TOPOLOGY ─────────────────────────────────────────────────────────
let topoTx=0, topoTy=0, topoScale=1, topoRootId='', topoSiteFilter='';
const topoDrag={active:false,sx:0,sy:0,tx:0,ty:0};
const NW=190, NH=66, HG=220, VG=140;

function buildTopoGraph() {
  const topoDevName=d=>d.status?.name||d.label||d.name||d.id?.substring(0,8)||'–';

  // Build name → device-id map (multiple name fields)
  const nameToId={};
  Object.values(S.devices).forEach(d=>{
    [d.status?.name, d.label, d.name, topoDevName(d)].filter(Boolean).forEach(n=>{
      if(n&&n!=='–') nameToId[n.toLowerCase()]=d.id;
    });
  });

  // Nodes: devices of selected site (or all)
  const nodes={};
  Object.values(S.devices).forEach(d=>{
    if(topoSiteFilter && (d.siteName||'')!==topoSiteFilter) return;
    nodes[d.id]={
      id:d.id,
      name:topoDevName(d),
      model:d.status?.model||'',
      siteName:d.siteName||'',
      online:isOnline(d),
      hasAlert:!!d.alerting?.hasAlert,
      isSwitch:false,
      wlanClients:S.wlanClients[d.id]||0,
    };
  });

  // Edges from LLDP port data — store port name per device side + bandwidth
  // Unknown neighbors → ghost nodes (unmanaged, shown as dashed gray boxes)
  const edgeMap={};
  S.lldpNeighbors.forEach(port=>{
    const fromId=port._deviceId;
    if(!nodes[fromId]) return; // switch filtered out by site
    nodes[fromId].isSwitch=true;
    port.lldpNames.forEach(lldpName=>{
      let toId=nameToId[lldpName.toLowerCase()];
      if(toId===fromId) return;
      if(!toId) {
        // Create ghost node for unmanaged / unresolved LLDP neighbor
        toId='ghost:'+lldpName;
        if(!nodes[toId]) nodes[toId]={
          id:toId, name:lldpName, model:'', siteName:'',
          online:false, hasAlert:false, isSwitch:false, wlanClients:0, isGhost:true,
        };
      }
      const key=[fromId,toId].sort().join('|');
      if(!edgeMap[key]) edgeMap[key]={from:fromId,to:toId,ports:{},maxBps:0};
      if(!edgeMap[key].ports[fromId]) edgeMap[key].ports[fromId]=[];
      if(!edgeMap[key].ports[fromId].includes(port.portName))
        edgeMap[key].ports[fromId].push(port.portName);
      const bps=(port.rxBitPerSec||0)+(port.txBitPerSec||0);
      if(bps>edgeMap[key].maxBps) edgeMap[key].maxBps=bps;
    });
  });
  // Supplement from lan-interface table: fills in port names that lldpNeighbors (JSON blob) may miss.
  // Each row: {deviceId, name (port name), lldpName (remote system name)}.
  S.lldpTable.forEach(row=>{
    const lldpName=(row.lldpName||'').trim();
    if(!lldpName) return;
    const fromId=row.deviceId||row._deviceId;
    if(!nodes[fromId]) return;
    nodes[fromId].isSwitch=true;
    const portName=row.name||'';

    let toId=nameToId[lldpName.toLowerCase()];
    if(!toId) {
      toId='ghost:'+lldpName;
      if(!nodes[toId]) nodes[toId]={
        id:toId, name:lldpName, model:'', siteName:'',
        online:false, hasAlert:false, isSwitch:false, wlanClients:0, isGhost:true,
      };
    }
    if(toId===fromId) return;

    const key=[fromId,toId].sort().join('|');
    if(!edgeMap[key]) edgeMap[key]={from:fromId,to:toId,ports:{},maxBps:0};
    if(!edgeMap[key].ports[fromId]) edgeMap[key].ports[fromId]=[];
    if(portName && !edgeMap[key].ports[fromId].includes(portName))
      edgeMap[key].ports[fromId].push(portName);
  });

  const edges=Object.values(edgeMap);

  return {nodes,edges};
}

function layoutTopo(nodes,edges,rootId) {
  // Adjacency list
  const adj={};
  Object.keys(nodes).forEach(id=>{adj[id]=[];});
  edges.forEach(e=>{adj[e.from]?.push(e.to);adj[e.to]?.push(e.from);});

  // BFS from root → assign levels
  const level={}, byLevel={};
  const queue=[rootId];
  let head=0;
  level[rootId]=0; byLevel[0]=[rootId];
  while(head<queue.length){
    const curr=queue[head++];
    (adj[curr]||[]).forEach(next=>{
      if(level[next]===undefined){
        level[next]=level[curr]+1;
        if(!byLevel[level[next]]) byLevel[level[next]]=[];
        byLevel[level[next]].push(next);
        queue.push(next);
      }
    });
  }

  // Position each layer horizontally centered
  const pos={};
  const levels=Object.keys(byLevel).map(Number).sort((a,b)=>a-b);
  levels.forEach(lvl=>{
    const ids=byLevel[lvl];
    const totalW=(ids.length-1)*HG;
    ids.forEach((id,i)=>{ pos[id]={x:i*HG-totalW/2, y:lvl*VG}; });
  });

  // Unconnected nodes below a separator
  const unconnected=Object.keys(nodes).filter(id=>level[id]===undefined);
  const maxLvl=levels.length?Math.max(...levels):0;
  const unconnY=(maxLvl+2)*VG;
  const totalUW=(unconnected.length-1)*HG;
  unconnected.forEach((id,i)=>{ pos[id]={x:i*HG-totalUW/2, y:unconnY}; });

  return {pos,level,byLevel,unconnected,maxLvl};
}

function buildTopoSelector() {
  const allDevices=Object.values(S.devices);
  if(!allDevices.length) return;

  // Populate site selector
  const siteSel=document.getElementById('topo-site-select');
  const prevSite=siteSel.value||topoSiteFilter;
  const sites=[...new Set(allDevices.map(d=>d.siteName||'').filter(Boolean))].sort();
  siteSel.innerHTML=`<option value="">Alle Standorte</option>`+sites.map(s=>`<option value="${escHtml(s)}"${s===topoSiteFilter?' selected':''}>${escHtml(s)}</option>`).join('');
  if(prevSite&&sites.includes(prevSite)) { siteSel.value=prevSite; topoSiteFilter=prevSite; }

  // Filtered device ids
  const ids=allDevices
    .filter(d=>!topoSiteFilter||(d.siteName||'')===topoSiteFilter)
    .map(d=>d.id);
  if(!ids.length) return;

  const sel=document.getElementById('topo-root-select');
  const prev=sel.value||topoRootId;

  // Default root: node with most LLDP edges in current site
  if(!topoRootId||!ids.includes(topoRootId)){
    const deg={};
    ids.forEach(id=>{deg[id]=0;});
    S.lldpNeighbors.forEach(p=>{
      if(deg[p._deviceId]!==undefined) deg[p._deviceId]++;
    });
    const sorted=[...ids].sort((a,b)=>deg[b]-deg[a]);
    topoRootId=sorted[0]||ids[0];
  }

  const topoDevName=d=>d.status?.name||d.label||d.name||d.id?.substring(0,8)||'–';
  const sorted=[...ids].sort((a,b)=>topoDevName(S.devices[a]).localeCompare(topoDevName(S.devices[b])));
  sel.innerHTML=sorted.map(id=>{
    const n=topoDevName(S.devices[id]);
    return `<option value="${id}"${id===topoRootId?' selected':''}>${escHtml(n)}</option>`;
  }).join('');
  if(prev&&ids.includes(prev)) { sel.value=prev; topoRootId=prev; }
}

function renderTopology() {
  const ids=Object.values(S.devices)
    .filter(d=>!topoSiteFilter||(d.siteName||'')===topoSiteFilter)
    .map(d=>d.id);
  const empty=document.getElementById('topo-empty');
  const gEl=document.getElementById('topo-g');
  if(!ids.length){ empty.style.display='flex'; gEl.innerHTML=''; return; }
  empty.style.display='none';

  buildTopoSelector();
  const rootId=document.getElementById('topo-root-select').value||topoRootId||ids[0];
  topoRootId=rootId;

  const {nodes,edges}=buildTopoGraph();
  const {pos,level,unconnected,maxLvl}=layoutTopo(nodes,edges,rootId);

  let svg='';

  // Separator line for unconnected nodes
  if(unconnected.length){
    const uy=unconnected.map(id=>pos[id].y).reduce((a,b)=>Math.min(a,b),Infinity);
    const xs=unconnected.map(id=>pos[id].x);
    const x1=Math.min(...xs)-NW/2-30, x2=Math.max(...xs)+NW/2+30;
    svg+=`<line x1="${x1}" y1="${uy-55}" x2="${x2}" y2="${uy-55}" stroke="rgba(255,255,255,.06)" stroke-width="1" stroke-dasharray="6,5"/>`;
    svg+=`<text x="${(x1+x2)/2}" y="${uy-64}" text-anchor="middle" font-size="9" font-weight="600" fill="rgba(148,163,184,.35)" font-family="'Segoe UI',sans-serif" letter-spacing="0.1em">KEINE VERBINDUNG</text>`;
  }

  // Helper: point on the rectangle border (cx,cy, half-width hw, half-height hh)
  // in the direction from (cx,cy) toward (tx,ty)
  const hw=NW/2, hh=NH/2;
  function borderPt(cx,cy,tx,ty){
    const dx=tx-cx, dy=ty-cy;
    if(!dx&&!dy) return {x:cx,y:cy+hh};
    const sX=dx?hw/Math.abs(dx):Infinity;
    const sY=dy?hh/Math.abs(dy):Infinity;
    const s=Math.min(sX,sY);
    return {x:cx+dx*s, y:cy+dy*s};
  }
  // Label position: just outside the border point, at fixed offset.
  // For top/bottom edge: same Y for all connections at that level (horizontal alignment).
  // For left/right edge: same X.
  const LOFF=13; // px outside border
  function labelPt(cx,cy,bx,by){
    const eps=0.5;
    if(Math.abs(Math.abs(by-cy)-hh)<eps){
      // top or bottom edge → Y is fixed, X follows the border point
      return {x:bx, y:cy+Math.sign(by-cy)*(hh+LOFF), anchor:'middle'};
    } else {
      // left or right edge → X is fixed, Y follows
      return {x:cx+Math.sign(bx-cx)*(hw+LOFF), y:by, anchor:bx>cx?'start':'end'};
    }
  }

  // Edges (curved bezier paths) with bandwidth coloring + port labels
  edges.forEach(e=>{
    const f=pos[e.from], t=pos[e.to];
    if(!f||!t) return;
    const bothOnline=nodes[e.from]?.online&&nodes[e.to]?.online;

    // Bezier control point Y = midpoint
    const cy=(f.y+t.y)/2;

    // Border entry/exit points — line ends at the node box border, not the center
    const fs=borderPt(f.x,f.y,t.x,t.y);
    const te=borderPt(t.x,t.y,f.x,f.y);

    // Bandwidth-based coloring
    const bps=e.maxBps||0;
    let color, w;
    if(!bothOnline){
      color='rgba(45,95,255,.2)'; w=1.5;
    } else if(bps>900000000){
      color='rgba(255,0,77,.75)'; w=3;
    } else if(bps>100000000){
      color='rgba(119,200,210,.75)'; w=2.5;
    } else if(bps>10000000){
      color='rgba(160,237,58,.65)'; w=2;
    } else if(bps>1000000){
      color='rgba(119,200,210,.65)'; w=2;
    } else {
      color='rgba(45,95,255,.55)'; w=2;
    }
    const dash=bothOnline?'':'5,4';
    // Path from border to border (not center to center)
    svg+=`<path d="M${fs.x.toFixed(1)},${fs.y.toFixed(1)} C${fs.x.toFixed(1)},${cy} ${te.x.toFixed(1)},${cy} ${te.x.toFixed(1)},${te.y.toFixed(1)}" stroke="${color}" stroke-width="${w}" fill="none"${dash?` stroke-dasharray="${dash}"`:''}/>`;

    // Bandwidth label at bezier midpoint
    if(bothOnline&&bps>1000000){
      const mx=(fs.x+te.x)/2, my=(fs.y+te.y)/2;
      const bLabel=bps>1000000000?`${(bps/1000000000).toFixed(1)}G`:(bps>1000000?`${Math.round(bps/1000000)}M`:`${Math.round(bps/1000)}K`);
      svg+=`<text x="${mx.toFixed(1)}" y="${my.toFixed(1)}" text-anchor="middle" font-size="9" fill="${color}" font-family="'Segoe UI',sans-serif" paint-order="stroke" stroke="rgba(1,9,30,.9)" stroke-width="3" stroke-linejoin="round">${bLabel}</text>`;
    }

    // Port labels: placed at the border point + LOFF px outward.
    // All labels leaving/entering a level node sit at the same Y (top/bottom edge).
    // X spreads naturally with the edge direction → no overlap even with 4+ connections.
    const lp=(e.ports?.[e.from]||[]).join(', ');
    const rp=(e.ports?.[e.to]  ||[]).join(', ');
    if(lp||rp){
      const ts=`font-size="10" font-weight="600" fill="rgba(203,213,225,.95)" font-family="'Segoe UI',sans-serif" paint-order="stroke" stroke="rgba(1,9,30,.98)" stroke-width="4" stroke-linejoin="round" dominant-baseline="middle"`;
      if(lp){
        const lpos=labelPt(f.x,f.y,fs.x,fs.y);
        svg+=`<text x="${lpos.x.toFixed(1)}" y="${lpos.y.toFixed(1)}" text-anchor="${lpos.anchor}" ${ts}>${escHtml(lp)}</text>`;
      }
      if(rp){
        const rpos=labelPt(t.x,t.y,te.x,te.y);
        svg+=`<text x="${rpos.x.toFixed(1)}" y="${rpos.y.toFixed(1)}" text-anchor="${rpos.anchor}" ${ts}>${escHtml(rp)}</text>`;
      }
    }
  });

  // Nodes
  Object.entries(pos).forEach(([id,{x,y}])=>{
    const node=nodes[id]; if(!node) return;
    const isRoot=id===rootId;
    const rx=x-NW/2, ry=y-NH/2;

    // ── Ghost node (unmanaged LLDP neighbor) ──────────────────────────────
    if(node.isGhost) {
      const dname=node.name.length>22?node.name.slice(0,21)+'…':node.name;
      svg+=`<g opacity="0.7">
        <rect x="${rx}" y="${ry}" width="${NW}" height="${NH}" rx="10"
          fill="rgba(15,20,40,.5)" stroke="rgba(100,116,139,.4)" stroke-width="1.5" stroke-dasharray="6,4"/>
        <text x="${rx+NW/2}" y="${ry+27}" text-anchor="middle" font-size="12" font-weight="600"
          fill="rgba(148,163,184,.8)" font-family="'Segoe UI',sans-serif">${escHtml(dname)}</text>
        <text x="${rx+NW/2}" y="${ry+44}" text-anchor="middle" font-size="9"
          fill="rgba(100,116,139,.7)" font-family="'Segoe UI',sans-serif" font-style="italic">nicht verwaltet</text>
      </g>`;
      return;
    }

    // ── Managed node ──────────────────────────────────────────────────────
    const borderColor=node.hasAlert?'rgba(119,200,210,.75)':node.online?'rgba(160,237,58,.55)':'rgba(255,0,77,.4)';
    const dotColor=node.hasAlert?'#77c8d2':node.online?'#a0ed3a':'#ff004d';
    const bgFill=node.hasAlert?'rgba(119,200,210,.06)':node.online?'rgba(160,237,58,.05)':'rgba(255,0,77,.04)';
    const filter=isRoot?'filter="url(#topo-glow)"':'';

    const dname=node.name.length>21?node.name.slice(0,20)+'…':node.name;
    const dsub=(node.model||node.siteName);
    const dsubT=dsub.length>24?dsub.slice(0,23)+'…':dsub;

    const typeLabel=node.isSwitch?'SW':node.wlanClients>0?'AP':'GW';
    const typeBg=node.isSwitch?'rgba(170,218,247,.15)':node.wlanClients>0?'rgba(45,95,255,.15)':'rgba(45,95,255,.15)';
    const typeColor=node.isSwitch?'#aadaf7':node.wlanClients>0?'#2d5fff':'#aadaf7';

    svg+=`<g class="topo-node" onclick="topoOpenDetail('${id}')" ${filter}>
      <rect class="topo-node-rect" x="${rx}" y="${ry}" width="${NW}" height="${NH}" rx="10"
        fill="${bgFill}" stroke="${borderColor}" stroke-width="${isRoot?2.5:1.5}"/>
      ${isRoot?`<rect x="${rx-2}" y="${ry-2}" width="${NW+4}" height="${NH+4}" rx="12" fill="none" stroke="${borderColor}" stroke-width="0.5" opacity="0.4"/>`:''}
      <circle cx="${rx+16}" cy="${y}" r="5" fill="${dotColor}"${node.online&&!node.hasAlert?' filter="url(#topo-glow)"':''}/>
      <rect x="${rx+NW-36}" y="${ry+6}" width="28" height="16" rx="4" fill="${typeBg}"/>
      <text x="${rx+NW-22}" y="${ry+17}" text-anchor="middle" font-size="9" font-weight="800" fill="${typeColor}" font-family="'Segoe UI',sans-serif">${typeLabel}</text>
      <text x="${rx+28}" y="${ry+24}" font-size="13" font-weight="700" fill="rgba(226,232,240,.95)" font-family="'Segoe UI',sans-serif">${escHtml(dname)}</text>
      <text x="${rx+28}" y="${ry+42}" font-size="10" fill="rgba(148,163,184,.6)" font-family="'Segoe UI',sans-serif">${escHtml(dsubT||'–')}</text>
    </g>`;
  });

  gEl.innerHTML=svg;
  updateTopoTransform();
}

function topoSetRoot(id) {
  topoRootId=id;
  document.getElementById('topo-root-select').value=id;
  renderTopology();
  setTimeout(topoFit,80);
}

function topoOpenDetail(id) {
  const device=S.devices[id]; if(!device) return;
  const topoDevName=d=>d.status?.name||d.label||d.name||d.id?.substring(0,8)||'–';
  const name=topoDevName(device);
  const online=isOnline(device), hasAlert=!!device.alerting?.hasAlert;

  // Header
  document.getElementById('topo-detail-dot').style.background=hasAlert?'#77c8d2':online?'#a0ed3a':'#ff004d';
  document.getElementById('topo-detail-name').textContent=name;
  const deviceIpLink = device.status?.ip
    ? `<a href="http://${device.status.ip}" target="_blank" rel="noopener" title="WEBconfig öffnen" style="color:var(--accent2);text-decoration:none">${device.status.ip}<i class="fa-solid fa-arrow-up-right-from-square" style="font-size:8px;margin-left:3px;opacity:.7"></i></a>`
    : null;
  document.getElementById('topo-detail-sub').innerHTML=[device.status?.model,device.siteName,deviceIpLink].filter(Boolean).join(' · ')||'–';
  document.getElementById('topo-detail-setroot').onclick=()=>{topoSetRoot(id);};

  let html='';

  // Switch-Ports / LLDP outgoing connections
  const myPorts=S.lldpNeighbors.filter(p=>p._deviceId===id);
  if(myPorts.length){
    html+=`<div class="detail-section-title">Switch-Ports (${myPorts.length})</div>`;
    html+=`<table class="data-table"><thead><tr><th>Port</th><th>LLDP-Nachbar</th><th>Status</th><th>Speed</th><th>PoE</th></tr></thead><tbody>`;
    myPorts.forEach(p=>{
      const neighbor=p.lldpNames.length?escHtml(p.lldpNames.join(', ')):'<span class="muted">–</span>';
      html+=`<tr${p.loops>0?' style="background:rgba(255,0,77,.05)"':''}>
        <td><strong>${escHtml(p.portName)}</strong>${p.description?`<div style="font-size:10px;color:var(--text2)">${escHtml(p.description)}</div>`:''}</td>
        <td>${neighbor}</td>
        <td>${statusDot(p.active)}</td>
        <td class="muted" style="white-space:nowrap">${speedMbit(p.speed)}</td>
        <td class="muted" style="white-space:nowrap">${poeCell(p.poeStatus,p.poePower)}</td>
      </tr>`;
    });
    html+=`</tbody></table>`;
  }

  // Incoming connections (other switches that see this device via LLDP)
  const incoming=S.lldpNeighbors.filter(p=>p._deviceId!==id&&p.lldpNames.some(n=>n.toLowerCase()===name.toLowerCase()));
  if(incoming.length){
    html+=`<div class="detail-section-title">Verbunden über</div>`;
    html+=`<table class="data-table"><thead><tr><th>Switch</th><th>Port</th><th>Status</th><th>Speed</th></tr></thead><tbody>`;
    incoming.forEach(p=>{
      html+=`<tr>
        <td class="device-ref">${escHtml(p._deviceName)}</td>
        <td><strong>${escHtml(p.portName)}</strong>${p.description?`<div style="font-size:10px;color:var(--text2)">${escHtml(p.description)}</div>`:''}</td>
        <td>${statusDot(p.active)}</td>
        <td class="muted" style="white-space:nowrap">${speedMbit(p.speed)}</td>
      </tr>`;
    });
    html+=`</tbody></table>`;
  }

  // WLAN clients (if AP)
  const clients=S.wlanStations.filter(s=>s._deviceId===id);
  if(clients.length){
    html+=`<div class="detail-section-title">WLAN Clients (${clients.length})</div>`;
    html+=`<table class="data-table"><thead><tr><th>Hostname</th><th>MAC</th><th>IP</th><th>Band</th><th>Signal</th><th>SSID</th></tr></thead><tbody>`;
    clients.forEach(c=>{
      const hostname=c.name||'–';
      const vendor=c.vendor?`<div style="font-size:10px;color:var(--text2)">${escHtml(c.vendor)}</div>`:'';
      html+=`<tr>
        <td>${escHtml(hostname)}${vendor}</td>
        <td class="mono">${escHtml(c.mac||'–')}</td>
        <td class="mono">${escHtml(c.ip||'–')}</td>
        <td>${bandBadge(c.band)}</td>
        <td>${signalBar(c.signal)}</td>
        <td class="muted">${escHtml(c.ssid||'–')}</td>
      </tr>`;
    });
    html+=`</tbody></table>`;
  }

  if(!myPorts.length&&!incoming.length&&!clients.length){
    html=`<div style="color:var(--text2);font-size:13px;padding:24px 0;text-align:center"><i class="fa-solid fa-diagram-project" style="display:block;font-size:28px;color:var(--text3);margin-bottom:10px"></i>Keine Verbindungsdaten verfügbar.</div>`;
  }

  // SNMP MAC-Tabelle (für alle Online-Geräte mit bekannter IP)
  if(online){
    const deviceIp=device.status?.ip||device.status?.ipAddress||'';
    html+=`<div class="detail-section-title">Verbundene Geräte (SNMP)</div>
    <div id="mac-table-area">
      <div style="display:flex;gap:6px;align-items:center;margin-bottom:8px;">
        ${deviceIp
          ?`<button onclick="loadSnmpMacTable('${id}','${deviceIp}')" style="background:rgba(45,95,255,.15);border:1px solid var(--border);border-radius:6px;color:var(--accent2);font-size:12px;font-weight:600;padding:5px 10px;cursor:pointer;white-space:nowrap;"><i class="fa-solid fa-ethernet"></i> SNMP abfragen</button>`
          :`<span style="color:var(--text3);font-size:11px">Keine IP bekannt</span>`
        }
      </div>
      <div id="snmp-result-area" style="color:var(--text3);font-size:11px">${deviceIp?escHtml(deviceIp):'Keine IP-Adresse verfügbar'}</div>
    </div>
    <div style="margin-top:8px">
      <button onclick="inspectLldpRaw('${id}')" style="background:none;border:none;color:var(--text3);font-size:10px;cursor:pointer;padding:0;text-decoration:underline">LLDP-Rohdaten (Debug)</button>
    </div>`;
  }

  document.getElementById('topo-detail-content').innerHTML=html;
  document.getElementById('topo-detail').style.display='flex';
}

async function loadSnmpMacTable(deviceId, host) {
  const area=document.getElementById('snmp-result-area');
  if(!area) return;
  const community=snmpReadCommunity||'public';

  area.innerHTML=`<div style="color:var(--text2);font-size:12px"><i class="fa-solid fa-circle-notch fa-spin"></i> SNMP-Abfrage (Bridge-MIB + ARP)…</div>`;
  try {
    const r=await fetch('/snmp',{method:'POST',headers:{'Content-Type':'application/json'},
      body:JSON.stringify({host,community,version:'2c',type:'mac-table'})});
    const result=await r.json();

    if(result.error){
      area.innerHTML=`<div style="color:var(--red);font-size:12px"><i class="fa-solid fa-triangle-exclamation"></i> ${escHtml(result.error)}</div>`;
      return;
    }
    if(!result.hasMacTable){
      area.innerHTML=`<div style="color:var(--text2);font-size:12px">Keine MAC-Einträge gefunden.<br><span style="font-size:10px;color:var(--text3)">Mögliche Ursachen: SNMP nicht aktiviert, falsche Community, kein Switch.</span></div>`;
      return;
    }

    const srcLabel = result.source === 'wlan-clients'
      ? `<span style="background:rgba(119,200,210,.15);border:1px solid rgba(119,200,210,.3);border-radius:3px;padding:1px 5px;color:var(--teal);margin-left:6px;font-size:10px"><i class="fa-solid fa-wifi"></i> WLAN-Clients</span>`
      : '';
    let html=`<div style="font-size:10px;color:var(--text3);margin-bottom:6px">${result.count} MACs · ${result.countWithIp} mit IP · ${escHtml(host)}${srcLabel}</div>`;
    const portHeader = result.source === 'wlan-clients' ? 'SSID / Kanal' : 'Port';
    html+=`<table class="data-table"><thead><tr><th>${portHeader}</th><th>MAC</th><th>IP</th></tr></thead><tbody>`;
    result.entries.forEach(e=>{
      html+=`<tr>
        <td><strong>${escHtml(e.portName)}</strong></td>
        <td class="mono" style="font-size:11px">${escHtml(e.mac)}</td>
        <td class="mono" style="font-size:11px">${e.ip?escHtml(e.ip):'<span class="muted">–</span>'}</td>
      </tr>`;
    });
    html+=`</tbody></table>`;
    area.innerHTML=html;
  } catch(e) {
    area.innerHTML=`<div style="color:var(--red);font-size:12px"><i class="fa-solid fa-triangle-exclamation"></i> Verbindungsfehler: ${escHtml(e.message)}</div>`;
  }
}

// Legacy API-Explorer (nicht mehr im UI, aber noch aufrufbar)
async function loadMacTable(deviceId) {
  const area=document.getElementById('snmp-result-area')||document.getElementById('mac-table-area');
  if(!area) return;
  area.innerHTML=`<div style="color:var(--text2);font-size:12px;padding:8px 0"><i class="fa-solid fa-circle-notch fa-spin"></i> Erkunde 28 Endpunkt-Varianten…</div>`;

  // Kandidaten: monitoring-API mit verschiedenen Parametern + devices-API
  const monBase=`/accounts/${S.accountId}/records`;
  const devBase=`/accounts/${S.accountId}`;
  const qBase=`group=DEVICE&groupId=${deviceId}&period=MINUTE1&type=json&latest=1`;

  const candidates=[
    // lan_info_json mit source=NEW, verschiedene name-Werte
    {svc:'monitoring', path:`${monBase}/lan_info_json?${qBase}&source=NEW&name=arp`,         label:'lan_info_json NEW name=arp'},
    {svc:'monitoring', path:`${monBase}/lan_info_json?${qBase}&source=NEW&name=arp-table`,   label:'lan_info_json NEW name=arp-table'},
    {svc:'monitoring', path:`${monBase}/lan_info_json?${qBase}&source=NEW&name=mac-table`,   label:'lan_info_json NEW name=mac-table'},
    {svc:'monitoring', path:`${monBase}/lan_info_json?${qBase}&source=NEW&name=mactable`,    label:'lan_info_json NEW name=mactable'},
    {svc:'monitoring', path:`${monBase}/lan_info_json?${qBase}&source=NEW&name=hosts`,       label:'lan_info_json NEW name=hosts'},
    {svc:'monitoring', path:`${monBase}/lan_info_json?${qBase}&source=NEW&name=stations`,    label:'lan_info_json NEW name=stations'},
    {svc:'monitoring', path:`${monBase}/lan_info_json?${qBase}&source=NEW&name=bridge`,      label:'lan_info_json NEW name=bridge'},
    {svc:'monitoring', path:`${monBase}/lan_info_json?${qBase}&source=NEW&name=eth`,         label:'lan_info_json NEW name=eth'},
    {svc:'monitoring', path:`${monBase}/lan_info_json?${qBase}&source=NEW&name=clients`,     label:'lan_info_json NEW name=clients'},
    {svc:'monitoring', path:`${monBase}/lan_info_json?${qBase}&source=NEW&name=forward`,     label:'lan_info_json NEW name=forward'},
    {svc:'monitoring', path:`${monBase}/lan_info_json?${qBase}&source=NEW`,                  label:'lan_info_json NEW (kein name)'},
    // lan_info_json OHNE source=NEW
    {svc:'monitoring', path:`${monBase}/lan_info_json?${qBase}&name=arp`,                    label:'lan_info_json (kein source) name=arp'},
    {svc:'monitoring', path:`${monBase}/lan_info_json?${qBase}&name=mac-table`,              label:'lan_info_json (kein source) name=mac-table'},
    {svc:'monitoring', path:`${monBase}/lan_info_json?${qBase}&name=hosts`,                  label:'lan_info_json (kein source) name=hosts'},
    {svc:'monitoring', path:`${monBase}/lan_info_json?${qBase}`,                             label:'lan_info_json (kein source, kein name)'},
    // Andere Record-Typen
    {svc:'monitoring', path:`${monBase}/arp_info_json?${qBase}&source=NEW`,                  label:'arp_info_json NEW'},
    {svc:'monitoring', path:`${monBase}/arp_info_json?${qBase}`,                             label:'arp_info_json (kein source)'},
    {svc:'monitoring', path:`${monBase}/mac_table_json?${qBase}&source=NEW`,                 label:'mac_table_json NEW'},
    {svc:'monitoring', path:`${monBase}/mac_table_json?${qBase}`,                            label:'mac_table_json (kein source)'},
    {svc:'monitoring', path:`${monBase}/neighbor_info_json?${qBase}&source=NEW`,             label:'neighbor_info_json NEW'},
    {svc:'monitoring', path:`${monBase}/dhcp_info?${qBase}&source=NEW`,                      label:'dhcp_info NEW'},
    {svc:'monitoring', path:`${monBase}/dhcp_info?${qBase}`,                                 label:'dhcp_info (kein source)'},
    {svc:'monitoring', path:`${monBase}/device_info?${qBase}&source=NEW`,                    label:'device_info NEW'},
    // devices-API: direkte Gerätendpunkte
    {svc:'devices', path:`${devBase}/devices/${deviceId}/neighbors`,   label:'devices-API: /neighbors'},
    {svc:'devices', path:`${devBase}/devices/${deviceId}/clients`,     label:'devices-API: /clients'},
    {svc:'devices', path:`${devBase}/devices/${deviceId}/arp`,         label:'devices-API: /arp'},
    {svc:'devices', path:`${devBase}/devices/${deviceId}/mac-table`,   label:'devices-API: /mac-table'},
    {svc:'devices', path:`${devBase}/devices/${deviceId}/connected`,   label:'devices-API: /connected'},
  ];

  const results=[];
  for(const c of candidates){
    try {
      const data=await api(c.svc, c.path);
      const json=JSON.stringify(data);
      const hasData=data&&json.length>30&&json!=='null'&&json!=='{}';
      results.push({...c, ok:true, hasData, data});
    } catch(e) {
      results.push({...c, ok:false, hasData:false, error:e.message});
    }
  }

  // Zeige Ergebnisse
  const working=results.filter(r=>r.ok&&r.hasData);
  let html='';

  if(working.length){
    html+=`<div style="margin-bottom:8px;font-size:11px;color:var(--green)"><i class="fa-solid fa-circle-check"></i> ${working.length} Endpunkt(e) mit Daten gefunden</div>`;
    working.forEach(r=>{
      const json=JSON.stringify(r.data,null,2);
      const preview=json.length>1200?json.slice(0,1200)+'…':json;
      html+=`<div style="margin-bottom:10px">
        <div style="font-size:11px;font-weight:700;color:var(--teal);margin-bottom:4px"><i class="fa-solid fa-circle-check"></i> ${escHtml(r.label)}</div>
        <pre style="background:var(--bg2);border:1px solid var(--border);border-radius:6px;padding:8px;font-size:10px;color:var(--text2);overflow-x:auto;white-space:pre-wrap;word-break:break-all;max-height:200px;overflow-y:auto;margin:0">${escHtml(preview)}</pre>
      </div>`;
    });
  } else {
    html+=`<div style="color:var(--amber);font-size:12px;margin-bottom:8px"><i class="fa-solid fa-triangle-exclamation"></i> Kein Endpunkt hat nutzbare Daten zurückgegeben.</div>`;
  }

  // Statusübersicht aller Kandidaten
  html+=`<details style="margin-top:8px"><summary style="font-size:10px;color:var(--text3);cursor:pointer;user-select:none">Alle Ergebnisse (${results.length})</summary>
    <div style="margin-top:6px;display:flex;flex-direction:column;gap:3px">`;
  results.forEach(r=>{
    const icon=r.ok&&r.hasData?'✓':r.ok?'○':'✗';
    const color=r.ok&&r.hasData?'var(--green)':r.ok?'var(--text3)':'var(--red)';
    html+=`<div style="font-size:10px;color:${color};font-family:monospace">${icon} ${escHtml(r.label)}</div>`;
  });
  html+=`</div></details>`;

  area.innerHTML=html;
}

function topoCloseDetail() {
  document.getElementById('topo-detail').style.display='none';
}

async function inspectLldpRaw(deviceId) {
  const area=document.getElementById('snmp-result-area')||document.getElementById('mac-table-area');
  if(!area) return;
  area.innerHTML=`<div style="color:var(--text2);font-size:12px;padding:8px 0"><i class="fa-solid fa-circle-notch fa-spin"></i> Lade Rohdaten…</div>`;

  const base=`/accounts/${S.accountId}/records/lan_info_json?group=DEVICE&groupId=${deviceId}&period=MINUTE1&type=json&latest=1`;
  const variants=[
    {label:'source=NEW, name=interfaces', url:`${base}&source=NEW&name=interfaces`},
    {label:'source=NEW (kein name)',       url:`${base}&source=NEW`},
    {label:'kein source, name=interfaces', url:`${base}&name=interfaces`},
    {label:'kein source, kein name',       url:`${base}`},
    {label:'source=NEW, name=lldp',        url:`${base}&source=NEW&name=lldp`},
    {label:'source=NEW, name=switch',      url:`${base}&source=NEW&name=switch`},
  ];

  let html='';
  for(const v of variants){
    let raw, parsed, err;
    try {
      // Fetch raw to show full response regardless of error
      const r=await fetch('/api',{method:'POST',headers:{'Content-Type':'application/json'},
        body:JSON.stringify({api_key:S.apiKey,service:'monitoring',path:v.url})});
      raw=await r.text();
      parsed=JSON.parse(raw);
    } catch(e) { err=e.message; }

    const isEmpty=!parsed||JSON.stringify(parsed).length<30;
    const color=err?'var(--red)':isEmpty?'var(--text3)':'var(--teal)';
    const icon=err?'✗':isEmpty?'○':'✓';
    const preview=err?err:(raw?.length>800?raw.slice(0,800)+'…':raw)||'(leer)';

    html+=`<div style="margin-bottom:10px">
      <div style="font-size:11px;font-weight:700;color:${color};margin-bottom:3px">${icon} ${escHtml(v.label)}</div>
      <pre style="background:var(--bg2);border:1px solid var(--border);border-radius:6px;padding:8px;font-size:9.5px;color:var(--text2);overflow-x:auto;white-space:pre-wrap;word-break:break-all;max-height:180px;overflow-y:auto;margin:0">${escHtml(preview)}</pre>
    </div>`;
  }
  area.innerHTML=html;
}

function topoChangeRoot() {
  topoRootId=document.getElementById('topo-root-select').value;
  renderTopology();
  setTimeout(topoFit,80);
}

function topoChangeSite(site) {
  topoSiteFilter=site;
  topoRootId=''; // reset root so it's re-picked for new site
  renderTopology();
  setTimeout(topoFit,80);
}

function topoToggleFullscreen() {
  const el=document.getElementById('tab-topology');
  if(!document.fullscreenElement){
    el.requestFullscreen().catch(()=>{});
  } else {
    document.exitFullscreen();
  }
}

document.addEventListener('fullscreenchange',()=>{
  const btn=document.getElementById('topo-fs-btn');
  if(!btn) return;
  if(document.fullscreenElement){
    btn.querySelector('i').className='fa-solid fa-compress';
    btn.title='Vollbild beenden';
  } else {
    btn.querySelector('i').className='fa-solid fa-expand';
    btn.title='Vollbild';
  }
});

function topoFit() {
  const g=document.getElementById('topo-g');
  const svg=document.getElementById('topo-svg');
  if(!g||!svg||!g.children.length) return;
  const bbox=g.getBBox();
  if(!bbox||bbox.width===0) return;
  const rect=svg.getBoundingClientRect();
  if(!rect.width||!rect.height) return;
  const pad=80;
  const sx=(rect.width-pad*2)/bbox.width;
  const sy=(rect.height-pad*2)/bbox.height;
  topoScale=Math.max(0.55, Math.min(sx,sy,1.6));
  topoTx=rect.width/2-(bbox.x+bbox.width/2)*topoScale;
  topoTy=rect.height/2-(bbox.y+bbox.height/2)*topoScale;
  updateTopoTransform();
}

function topoZoom(factor) {
  const svg=document.getElementById('topo-svg');
  const r=svg.getBoundingClientRect();
  const cx=r.width/2, cy=r.height/2;
  const ns=Math.max(0.15,Math.min(4,topoScale*factor));
  const sf=ns/topoScale;
  topoTx=cx-(cx-topoTx)*sf;
  topoTy=cy-(cy-topoTy)*sf;
  topoScale=ns;
  updateTopoTransform();
}

function updateTopoTransform() {
  document.getElementById('topo-g').setAttribute('transform',`translate(${topoTx.toFixed(2)},${topoTy.toFixed(2)}) scale(${topoScale.toFixed(4)})`);
}

function initTopoEvents() {
  const svg=document.getElementById('topo-svg');
  // Wheel zoom
  svg.addEventListener('wheel',e=>{
    e.preventDefault();
    const r=svg.getBoundingClientRect();
    const mx=e.clientX-r.left, my=e.clientY-r.top;
    const factor=e.deltaY<0?1.12:1/1.12;
    const ns=Math.max(0.15,Math.min(4,topoScale*factor));
    const sf=ns/topoScale;
    topoTx=mx-(mx-topoTx)*sf;
    topoTy=my-(my-topoTy)*sf;
    topoScale=ns;
    updateTopoTransform();
  },{passive:false});
  // Drag pan
  svg.addEventListener('mousedown',e=>{
    if(e.target.closest('.topo-node')) return;
    topoDrag.active=true; topoDrag.sx=e.clientX; topoDrag.sy=e.clientY;
    topoDrag.tx=topoTx; topoDrag.ty=topoTy;
    svg.style.cursor='grabbing';
  });
  window.addEventListener('mousemove',e=>{
    if(!topoDrag.active) return;
    topoTx=topoDrag.tx+(e.clientX-topoDrag.sx);
    topoTy=topoDrag.ty+(e.clientY-topoDrag.sy);
    updateTopoTransform();
  });
  window.addEventListener('mouseup',()=>{
    if(topoDrag.active){ topoDrag.active=false; document.getElementById('topo-svg').style.cursor='grab'; }
  });
}
initTopoEvents();

// ─── LOADING / COUNTDOWN ─────────────────────────────────────────────────────
function setLoading(show,text='') {
  document.getElementById('loading-overlay').style.display=show?'flex':'none';
  if(text) document.getElementById('loading-text').textContent=text;
}
function setRefreshInterval(seconds) {
  S.refreshInterval=seconds;
  localStorage.setItem('refreshInterval', seconds);
  clearInterval(S.timer);
  S.timer=null;
  const info=document.getElementById('sync-info-text');
  if(seconds>0){
    info.style.display='';
    S.countdown=seconds;
    document.getElementById('countdown').textContent=seconds;
    S.timer=setInterval(()=>{
      S.countdown--;
      document.getElementById('countdown').textContent=S.countdown;
      if(S.countdown<=0){ clearInterval(S.timer); S.timer=null; refreshDashboard(); }
    },1000);
  } else {
    info.style.display='none';
  }
}

function startCountdown() {
  const sel=document.getElementById('refresh-select');
  if(sel) setRefreshInterval(S.refreshInterval);
}

// ─── THEME TOGGLE ─────────────────────────────────────────────────────────────
function setTheme(t) {
  document.documentElement.setAttribute('data-theme', t);
  const icon = document.getElementById('theme-icon');
  if(icon) icon.className = t==='light' ? 'fa-solid fa-sun' : 'fa-solid fa-moon';
}
function toggleTheme() {
  const current = document.documentElement.getAttribute('data-theme') || 'dark';
  const next = current === 'dark' ? 'light' : 'dark';
  setTheme(next);
  localStorage.setItem('lmc_theme', next);
}
(function(){ setTheme(localStorage.getItem('lmc_theme') || 'dark'); })();

// ─── GLOBAL SEARCH ────────────────────────────────────────────────────────────
function openSearch() {
  const overlay = document.getElementById('search-overlay');
  overlay.style.display = 'flex';
  const inp = document.getElementById('search-modal-input');
  inp.value = '';
  inp.focus();
  runSearch('');
}
function closeSearch() {
  document.getElementById('search-overlay').style.display = 'none';
}
function runSearch(q) {
  const results = document.getElementById('search-results');
  const lq = (q||'').toLowerCase().trim();
  if(!lq || lq.length < 2) {
    results.innerHTML = `<div class="search-hint"><i class="fa-solid fa-magnifying-glass" style="font-size:28px;color:var(--text3);margin-bottom:12px;display:block;opacity:.5"></i>Mindestens 2 Zeichen eingeben…</div>`;
    return;
  }
  let html = '';

  // Devices
  const devHits = Object.values(S.devices).filter(d => {
    const f = [d.label,d.name,d.siteName,d.status?.name,d.status?.model,d.status?.serial,d.status?.ip].filter(Boolean);
    return f.some(x => String(x).toLowerCase().includes(lq));
  }).slice(0, 8);
  if(devHits.length) {
    html += `<div class="search-section-header"><i class="fa-solid fa-server" style="margin-right:5px"></i>Geräte</div>`;
    html += devHits.map(d => {
      const name = deviceName(d);
      const sub = [d.status?.model, d.siteName, d.status?.ip].filter(Boolean).join(' · ');
      const dot = isOnline(d) ? '#a0ed3a' : '#ff004d';
      return `<div class="search-result-item" onclick="closeSearch();showTab('devices');setTimeout(()=>{const el=document.getElementById('card-${d.id}');if(el){el.scrollIntoView({behavior:'smooth',block:'center'});el.style.outline='2px solid var(--accent)';setTimeout(()=>{el.style.outline='';},2000);}},120)">
        <div class="search-result-icon" style="background:rgba(45,95,255,.1)"><span style="width:9px;height:9px;border-radius:50%;background:${dot};display:inline-block"></span></div>
        <div style="min-width:0"><div class="search-result-name">${escHtml(name)}</div><div class="search-result-sub">${escHtml(sub)}</div></div>
        <span class="search-result-badge">Gerät</span>
      </div>`;
    }).join('');
  }

  // WLAN
  const wlanHits = S.wlanStations.filter(s => {
    const f = [s.mac, s.ip, s.name, s.ssid, s._deviceName, s.vendor].filter(Boolean);
    return f.some(x => String(x).toLowerCase().includes(lq));
  }).slice(0, 6);
  if(wlanHits.length) {
    html += `<div class="search-section-header"><i class="fa-solid fa-wifi" style="margin-right:5px"></i>WLAN Clients</div>`;
    html += wlanHits.map(s => {
      const sub = [s._deviceName, s.ssid, s.band].filter(Boolean).join(' · ');
      const searchVal = JSON.stringify(s.mac||s.name||'');
      return `<div class="search-result-item" onclick="closeSearch();showTab('wlan');setTimeout(()=>{const inp=document.getElementById('wlan-search');if(inp){inp.value=${searchVal};renderWlan();}},100)">
        <div class="search-result-icon" style="background:rgba(45,95,255,.12);color:var(--purple)"><i class="fa-solid fa-wifi" style="font-size:13px"></i></div>
        <div style="min-width:0"><div class="search-result-name">${escHtml(s.name||s.mac||'–')}</div><div class="search-result-sub">${escHtml(sub)}</div></div>
        <span class="search-result-badge">WLAN</span>
      </div>`;
    }).join('');
  }

  // VPN
  const vpnHits = S.vpnConnections.filter(c => {
    const f = [c._deviceName, c.peerName, c.networkName, c.peerIp].filter(Boolean);
    return f.some(x => String(x).toLowerCase().includes(lq));
  }).slice(0, 5);
  if(vpnHits.length) {
    html += `<div class="search-section-header"><i class="fa-solid fa-shield-halved" style="margin-right:5px"></i>VPN</div>`;
    html += vpnHits.map(c => `<div class="search-result-item" onclick="closeSearch();showTab('vpn')">
      <div class="search-result-icon" style="background:rgba(45,95,255,.12);color:var(--accent)"><i class="fa-solid fa-shield-halved" style="font-size:13px"></i></div>
      <div style="min-width:0"><div class="search-result-name">${escHtml(c.peerName||c.networkName||'–')}</div><div class="search-result-sub">${escHtml(c._deviceName||'')} ${c.peerIp?'→ '+escHtml(c.peerIp):''}</div></div>
      <span class="search-result-badge">VPN</span>
    </div>`).join('');
  }

  // WAN
  const wanHits = S.wanInterfaces.filter(w => {
    const f = [w._deviceName, w.interfaceName, w.name, w.ipV4, w.ipV6, w.ip, w.connectionType].filter(Boolean);
    return f.some(x => String(x).toLowerCase().includes(lq));
  }).slice(0, 4);
  if(wanHits.length) {
    html += `<div class="search-section-header"><i class="fa-solid fa-globe" style="margin-right:5px"></i>WAN</div>`;
    html += wanHits.map(w => `<div class="search-result-item" onclick="closeSearch();showTab('wan')">
      <div class="search-result-icon" style="background:rgba(170,218,247,.12);color:var(--blue)"><i class="fa-solid fa-globe" style="font-size:13px"></i></div>
      <div style="min-width:0"><div class="search-result-name">${escHtml(w.interfaceName||w.connectionType||w.name||'–')}</div><div class="search-result-sub">${escHtml(w._deviceName||'')} ${(w.ipV4||w.ipV6||w.ip)?'– '+(w.ipV4||w.ipV6||w.ip):''}</div></div>
      <span class="search-result-badge">WAN</span>
    </div>`).join('');
  }

  if(!html) {
    html = `<div class="search-hint"><i class="fa-solid fa-face-frown-open" style="font-size:28px;color:var(--text3);margin-bottom:12px;display:block;opacity:.5"></i>Keine Ergebnisse für „${escHtml(lq)}"</div>`;
  }
  results.innerHTML = html;
}
document.addEventListener('keydown', e => {
  if(e.key === '/' && !e.ctrlKey && !e.altKey && !e.metaKey) {
    const tag = (e.target.tagName||'').toLowerCase();
    if(tag !== 'input' && tag !== 'textarea' && tag !== 'select') { e.preventDefault(); openSearch(); }
  }
  if(e.key === 'Escape') { closeSearch(); ceMacTableClose(); }
});

// ─── ADD-INS ──────────────────────────────────────────────────────────────────
let addinsData      = [];   // full list of ConfigApplicationResponseDto
let addinsNetworks  = {};   // { applicationId: [{networkName,...}] }
let addinsScripts   = {};   // { applicationId: ConfigScript }
let addinsFilterQ   = '';

async function loadAddins() {
  const loadEl = document.getElementById('addins-loading');
  const empty  = document.getElementById('addins-empty');
  const wrap   = document.getElementById('addins-table-wrap');
  const icon   = document.getElementById('addins-refresh-icon');
  if(!S.accountId) return;
  if(loadEl) loadEl.style.display='flex';
  if(wrap)   wrap.style.display='none';
  if(empty)  empty.style.display='none';
  if(icon)   icon.classList.add('fa-spin');
  try {
    const data = await api('config', `/configapplication/accounts/${S.accountId}/applications`);
    addinsData = Array.isArray(data) ? data : [];
    // Fetch network assignments for all add-ins (parallel, ignore errors)
    const netResults = await Promise.allSettled(addinsData.map(a =>
      api('config', `/configapplication/accounts/${S.accountId}/applications/${a.id}/networks`)
        .then(r => ({ id: a.id, nets: Array.isArray(r) ? r : [] }))
        .catch(() => ({ id: a.id, nets: [] }))
    ));
    addinsNetworks = {};
    netResults.forEach(r => { if(r.status==='fulfilled') addinsNetworks[r.value.id] = r.value.nets; });
    document.getElementById('badge-addins').textContent = addinsData.length || '–';
    document.getElementById('addins-count').textContent = addinsData.length;
    addinsRender();
  } catch(e) {
    toast('error', 'Add-ins Fehler', e.message);
    if(empty) { empty.style.display='flex'; empty.querySelector('div').textContent = 'Fehler: ' + e.message; }
  } finally {
    if(loadEl) loadEl.style.display='none';
    if(icon)   icon.classList.remove('fa-spin');
  }
}

function addinsFilter(q) {
  addinsFilterQ = q.trim().toLowerCase();
  addinsRender();
}

function addinsRender() {
  const tbody = document.getElementById('addins-tbody');
  const wrap  = document.getElementById('addins-table-wrap');
  const empty = document.getElementById('addins-empty');
  if(!tbody) return;
  const rows = addinsFilterQ
    ? addinsData.filter(a => a.name?.toLowerCase().includes(addinsFilterQ) || (a.comment||'').toLowerCase().includes(addinsFilterQ))
    : addinsData;
  if(!rows.length) {
    if(wrap)  wrap.style.display='none';
    if(empty) { empty.style.display='flex'; }
    return;
  }
  if(empty) empty.style.display='none';
  if(wrap)  wrap.style.display='block';
  tbody.innerHTML = rows.map(a => {
    const nets  = addinsNetworks[a.id] || [];
    const onetimeBadge = a.usedForOneTimeExecution
      ? `<span style="background:rgba(119,200,210,.12);border:1px solid rgba(119,200,210,.25);color:var(--amber);font-size:10px;font-weight:600;padding:1px 6px;border-radius:4px;margin-left:5px" title="Einmalige Ausführung"><i class="fa-solid fa-bolt"></i></span>`
      : '';
    const netStr = nets.length
      ? `<span style="font-weight:600;color:var(--teal)">${nets.length}</span> <span style="font-size:11px;color:var(--text3)">${nets.slice(0,2).map(n=>escHtml(n.networkName||'–')).join(', ')}${nets.length>2?', …':''}</span>`
      : '<span style="color:var(--text3);font-size:11px">–</span>';
    const chk = a.enabled ? 'checked' : '';
    return `<tr>
      <td style="text-align:center;vertical-align:middle">
        <label class="toggle-switch" style="margin:0" title="${a.enabled?'Aktiv – zum Deaktivieren klicken':'Inaktiv – zum Aktivieren klicken'}">
          <input type="checkbox" ${chk} onchange="addinToggleEnabled('${a.id}',this.checked)">
          <span class="toggle-slider"></span>
        </label>
      </td>
      <td>
        <div style="font-weight:700;font-size:13px">${escHtml(a.name||'–')}${onetimeBadge}</div>
        <div style="margin-top:2px;font-size:11px;color:var(--text3)">${escHtml(a.type||'SCRIPT')}</div>
      </td>
      <td>${netStr}</td>
      <td style="font-size:12px;color:var(--text2);max-width:240px">${escHtml(a.comment||'')}</td>
      <td style="white-space:nowrap">
        <button onclick="addinEditOpen('${a.id}')"
          style="background:rgba(255,255,255,.06);border:1px solid var(--border);border-radius:6px;color:var(--text2);font-size:11px;font-weight:600;padding:4px 10px;cursor:pointer;margin-right:5px">
          <i class="fa-solid fa-pen" style="margin-right:3px"></i>Edit</button>
        <button onclick="addinScriptOpen('${a.id}','${escHtml(a.name||'')}')"
          style="background:rgba(45,95,255,.1);border:1px solid rgba(45,95,255,.25);border-radius:6px;color:var(--accent2);font-size:11px;font-weight:600;padding:4px 10px;cursor:pointer;white-space:nowrap">
          <i class="fa-solid fa-code" style="margin-right:3px"></i>Skript</button>
      </td>
    </tr>`;
  }).join('');
}

async function addinToggleEnabled(id, enabled) {
  const app = addinsData.find(a => a.id === id);
  if(!app) return;
  const prev = app.enabled;
  app.enabled = enabled; // optimistic update
  try {
    await api('config', `/configapplication/accounts/${S.accountId}/applications/${id}`, 'PUT',
      { name: app.name, enabled, comment: app.comment || '', type: app.type || 'SCRIPT' });
    toast('success', enabled ? 'Add-in aktiviert' : 'Add-in deaktiviert', app.name);
  } catch(e) {
    app.enabled = prev; // rollback
    addinsRender();
    toast('error', 'Fehler', e.message);
  }
}

const OS_LABELS = { lcos:'LCOS', lcosLx:'LCOS-LX', swos:'GS-2xxx (SwOS)', lcosSxSdk4:'GS-3xxx (SDK4)', lcosSxXs:'XS-5xxx', lcosFx:'LCOS-FX' };

async function addinScriptOpen(applicationId, name) {
  const modal    = document.getElementById('addin-script-modal');
  const title    = document.getElementById('addin-script-title');
  const content  = document.getElementById('addin-script-content');
  const osTabs   = document.getElementById('addin-script-os-tabs');
  const infoBar  = document.getElementById('addin-script-info');
  if(!modal) return;
  title.textContent = name;
  content.textContent = '⏳ Lade Skript…';
  osTabs.innerHTML = '';
  infoBar.innerHTML = '';
  modal.style.display = 'flex';
  try {
    let script = addinsScripts[applicationId];
    if(!script) {
      script = await api('config', `/configapplication/accounts/${S.accountId}/applications/${applicationId}/script`);
      addinsScripts[applicationId] = script;
    }
    // Build OS tab buttons for OS types that are true
    const osList = Object.entries(OS_LABELS).filter(([k]) => script[k] === true || (Object.values(OS_LABELS).length === 1 && k === 'lcos'));
    // If none explicitly true, show all content in one block
    if(osList.length <= 1) {
      content.textContent = script.content || '(kein Skript-Inhalt)';
      if(osList[0]) {
        osTabs.innerHTML = `<span style="background:rgba(45,95,255,.15);border:1px solid rgba(45,95,255,.3);border-radius:6px;padding:3px 10px;font-size:11px;font-weight:700;color:var(--accent2)">${OS_LABELS[osList[0][0]]}</span>`;
      }
    } else {
      // Multiple OS scripts: each OS key may have its own content in the future;
      // Currently API has single `content` + boolean flags. Show OS tags.
      osList.forEach(([k,label],i) => {
        const btn = document.createElement('button');
        btn.textContent = label;
        btn.style.cssText = `background:rgba(45,95,255,.${i===0?'2':'1'});border:1px solid rgba(45,95,255,.${i===0?'4':'25'});border-radius:6px;padding:3px 10px;font-size:11px;font-weight:700;color:var(--accent2);cursor:default`;
        osTabs.appendChild(btn);
      });
      content.textContent = script.content || '(kein Skript-Inhalt)';
    }
    // Info bar: meta from addinsData
    const meta = addinsData.find(a => a.id === applicationId);
    if(meta) {
      const tags = [
        meta.resetToDefault ? `<span style="background:rgba(119,200,210,.12);border:1px solid rgba(119,200,210,.25);color:var(--amber);font-size:11px;padding:2px 8px;border-radius:4px">Reset to Default</span>` : '',
        meta.usedForOneTimeExecution ? `<span style="background:rgba(45,95,255,.12);border:1px solid rgba(45,95,255,.25);color:var(--accent2);font-size:11px;padding:2px 8px;border-radius:4px"><i class="fa-solid fa-bolt" style="margin-right:3px"></i>Einmalige Ausführung</span>` : '',
      ].filter(Boolean).join('');
      if(meta.markdown) {
        infoBar.innerHTML = `<div style="font-size:12px;color:var(--text2);flex:1;padding-bottom:8px">${escHtml(meta.markdown).replace(/\n/g,'<br>')}</div>`;
      } else if(tags) {
        infoBar.innerHTML = `<div style="padding-bottom:8px;display:flex;gap:6px">${tags}</div>`;
      }
    }
  } catch(e) {
    content.textContent = 'Fehler: ' + e.message;
  }
}

function addinScriptClose() {
  const modal = document.getElementById('addin-script-modal');
  if(modal) modal.style.display='none';
}

let addinEditId = null; // null = create mode, string = edit mode (id of app)

const OS_ID_MAP = { lcos:'addin-os-lcos', lcosLx:'addin-os-lcoslx', swos:'addin-os-swos',
                    lcosSxSdk4:'addin-os-sdk4', lcosSxXs:'addin-os-xs', lcosFx:'addin-os-fx' };

function osLabelClick(lbl) {
  const radio = lbl.querySelector('input[type=radio]');
  if(!radio) return;
  // deactivate all labels in the group first
  document.querySelectorAll('#addin-create-os-wrap label').forEach(l => {
    const r = l.querySelector('input[type=radio]');
    if(r) { r.checked = false; osApplyStyle(l, false); }
  });
  radio.checked = true;
  osApplyStyle(lbl, true);
}
function osApplyStyle(lbl, active) {
  if(active) {
    lbl.style.border      = '1px solid rgba(45,95,255,.5)';
    lbl.style.background  = 'rgba(45,95,255,.18)';
    lbl.style.color       = 'var(--accent2)';
    lbl.style.fontWeight  = '600';
  } else {
    lbl.style.border      = '1px solid var(--border)';
    lbl.style.background  = 'rgba(255,255,255,.04)';
    lbl.style.color       = 'var(--text2)';
    lbl.style.fontWeight  = '';
  }
}
function osResetAll(defaultCheckedId) {
  Object.values(OS_ID_MAP).forEach(elId => {
    const rb  = document.getElementById(elId);
    const lbl = rb?.closest('label');
    if(!rb || !lbl) return;
    rb.checked = (elId === defaultCheckedId);
    osApplyStyle(lbl, rb.checked);
  });
}

function _addinModalReset() {
  document.getElementById('addin-create-name').value = '';
  document.getElementById('addin-create-name').readOnly = false;
  document.getElementById('addin-create-name').style.borderColor = '';
  document.getElementById('addin-create-name').style.color = '';
  document.getElementById('addin-create-name-err').style.display = 'none';
  document.getElementById('addin-create-enabled').checked = true;
  document.getElementById('addin-create-comment').value = '';
  document.getElementById('addin-create-script').value = '';
  document.getElementById('addin-create-error').style.display = 'none';
  const netWrap = document.getElementById('addin-net-section-wrap');
  if(netWrap) netWrap.style.display = 'none';
  osResetAll('addin-os-lcos');
  const saveBtn = document.getElementById('addin-create-save-btn');
  if(saveBtn) { saveBtn.disabled=false; saveBtn.style.opacity='1'; }
}

function addinCreateOpen() {
  addinEditId = null;
  _addinModalReset();
  document.getElementById('addin-modal-title').textContent = 'Neues Add-in erstellen';
  document.getElementById('addin-save-icon').className = 'fa-solid fa-floppy-disk';
  document.getElementById('addin-save-text').textContent = 'Erstellen';
  document.getElementById('addin-create-modal').style.display = 'flex';
  setTimeout(() => document.getElementById('addin-create-name').focus(), 50);
}

async function addinEditOpen(id) {
  const app = addinsData.find(a => a.id === id);
  if(!app) return;
  addinEditId = id;
  _addinModalReset();
  // Fill metadata
  document.getElementById('addin-create-name').value = app.name || '';
  document.getElementById('addin-create-name').readOnly = true; // name cannot be changed
  document.getElementById('addin-create-name').style.color = 'var(--text3)';
  document.getElementById('addin-create-enabled').checked = !!app.enabled;
  document.getElementById('addin-create-comment').value = app.comment || '';
  document.getElementById('addin-modal-title').textContent = 'Add-in bearbeiten: ' + (app.name || '');
  document.getElementById('addin-save-icon').className = 'fa-solid fa-check';
  document.getElementById('addin-save-text').textContent = 'Speichern';
  document.getElementById('addin-create-modal').style.display = 'flex';
  // Show network assignment section
  const netWrap = document.getElementById('addin-net-section-wrap');
  const netSection = document.getElementById('addin-net-section');
  if(netWrap) netWrap.style.display = '';
  if(netSection) netSection.innerHTML = addinNetworksSectionHtml(id);
  // Lazy-load network list if not yet available
  if(S.accountNetworks.length === 0) {
    loadAccountNetworks().then(() => {
      const s2 = document.getElementById('addin-net-section');
      if(s2 && addinEditId === id) s2.innerHTML = addinNetworksSectionHtml(id);
    });
  }
  // Load script (from cache or API)
  try {
    let script = addinsScripts[id];
    if(!script) {
      script = await api('config', `/configapplication/accounts/${S.accountId}/applications/${id}/script`);
      addinsScripts[id] = script;
    }
    if(script) {
      document.getElementById('addin-create-script').value = script.content || '';
      // Find which OS is active (first true flag wins) and select it
      const activeOs = Object.entries(OS_ID_MAP).find(([k]) => script[k] === true);
      osResetAll(activeOs ? activeOs[1] : 'addin-os-lcos');
    }
  } catch(e) {
    // script load failed - not fatal, user can still edit metadata
  }
  setTimeout(() => document.getElementById('addin-create-comment').focus(), 50);
}

function addinCreateClose() {
  document.getElementById('addin-create-modal').style.display = 'none';
  addinEditId = null;
  // Reset name field appearance
  const nameEl = document.getElementById('addin-create-name');
  if(nameEl) { nameEl.readOnly = false; nameEl.style.color = ''; }
}

function addinCreateValidateName(input) {
  const errEl = document.getElementById('addin-create-name-err');
  if(!errEl) return true;
  const ok = /^[a-zA-Z0-9\-]+$/.test(input.value) || input.value === '';
  errEl.style.display = ok ? 'none' : 'block';
  input.style.borderColor = ok ? '' : 'var(--red)';
  return ok || input.value === '';
}

async function addinCreateSave() {
  const nameEl  = document.getElementById('addin-create-name');
  const errEl   = document.getElementById('addin-create-error');
  const saveBtn = document.getElementById('addin-create-save-btn');
  const name    = (nameEl?.value || '').trim();
  const enabled = document.getElementById('addin-create-enabled').checked;
  const comment = document.getElementById('addin-create-comment').value.trim();
  const script  = document.getElementById('addin-create-script').value;
  const osFlags = {};
  Object.entries(OS_ID_MAP).forEach(([k, elId]) => {
    osFlags[k] = document.getElementById(elId)?.checked === true;
  });

  if(!addinEditId) {
    // Create mode: validate name
    if(!name) { nameEl.focus(); return; }
    if(!/^[a-zA-Z0-9\-]+$/.test(name)) {
      document.getElementById('addin-create-name-err').style.display='block';
      nameEl.focus(); return;
    }
  }

  errEl.style.display='none';
  saveBtn.disabled=true; saveBtn.style.opacity='0.6';
  try {
    if(addinEditId) {
      // ── Edit mode: PUT metadata + POST script ──
      const app = addinsData.find(a => a.id === addinEditId);
      await api('config', `/configapplication/accounts/${S.accountId}/applications/${addinEditId}`, 'PUT',
        { name: app.name, enabled, comment, type: app.type || 'SCRIPT' });
      await api('config', `/configapplication/accounts/${S.accountId}/applications/${addinEditId}/script`, 'POST',
        { content: script, ...osFlags });
      delete addinsScripts[addinEditId]; // invalidate cache
      toast('success', 'Add-in gespeichert', app.name);
    } else {
      // ── Create mode: POST app + POST script ──
      const created = await api('config', `/configapplication/accounts/${S.accountId}/applications`, 'POST',
        { name, enabled, comment, type: 'SCRIPT' });
      if(script || Object.values(osFlags).some(Boolean)) {
        await api('config', `/configapplication/accounts/${S.accountId}/applications/${created.id}/script`, 'POST',
          { content: script, ...osFlags });
      }
      toast('success', 'Add-in erstellt', name);
    }
    addinCreateClose();
    await loadAddins();
  } catch(e) {
    errEl.textContent = 'Fehler: ' + e.message;
    errEl.style.display='block';
    saveBtn.disabled=false; saveBtn.style.opacity='1';
  }
}

// ─── ALERTS ───────────────────────────────────────────────────────────────────
let alertsData = [];
async function loadAlerts() {
  const loadEl = document.getElementById('alerts-loading');
  const empty  = document.getElementById('alerts-empty');
  const tbody  = document.getElementById('alerts-tbody');
  if(loadEl) loadEl.style.display = 'flex';
  if(empty)  empty.style.display = 'none';
  if(tbody)  tbody.innerHTML = '';
  try {
    const data = await api('notification', `/accounts/${S.accountId}/alerts`);
    alertsData = Array.isArray(data) ? data : (data?.alerts || data?.items || data?.content || []);
    renderAlerts();
  } catch(e) {
    toast('error', 'Fehler beim Laden der Alerts', e.message);
    if(empty) empty.style.display = 'block';
  } finally {
    if(loadEl) loadEl.style.display = 'none';
  }
}
function renderAlerts() {
  const tbody   = document.getElementById('alerts-tbody');
  const empty   = document.getElementById('alerts-empty');
  const countEl = document.getElementById('alerts-count');
  const badgeEl = document.getElementById('badge-alerts');
  if(countEl) countEl.textContent = alertsData.length;
  if(badgeEl) badgeEl.textContent = alertsData.length || '–';

  const critN = alertsData.filter(a => (a.severity||a.level||'').toUpperCase() === 'CRITICAL').length;
  const warnN = alertsData.filter(a => (a.severity||a.level||'').toUpperCase() === 'WARNING').length;
  const miniEl = document.getElementById('alerts-mini-stats');
  if(miniEl) miniEl.innerHTML = `
    <div class="mini-stat"><div class="ms-icon" style="background:rgba(255,0,77,.15);color:var(--red)"><i class="fa-solid fa-circle-xmark"></i></div><div><div class="ms-val" style="color:var(--red)">${critN}</div><div class="ms-lbl">Kritisch</div></div></div>
    <div class="mini-stat"><div class="ms-icon" style="background:rgba(119,200,210,.15);color:var(--amber)"><i class="fa-solid fa-triangle-exclamation"></i></div><div><div class="ms-val" style="color:var(--amber)">${warnN}</div><div class="ms-lbl">Warnung</div></div></div>
    <div class="mini-stat"><div class="ms-icon" style="background:rgba(45,95,255,.15);color:var(--accent)"><i class="fa-solid fa-bell"></i></div><div><div class="ms-val" style="color:var(--accent)">${alertsData.length}</div><div class="ms-lbl">Gesamt</div></div></div>`;

  if(!alertsData.length) { if(tbody) tbody.innerHTML=''; if(empty) empty.style.display='block'; return; }
  if(empty) empty.style.display='none';
  if(!tbody) return;
  tbody.innerHTML = alertsData.map(a => {
    const rawSev = (a.severity||a.level||a.alertSeverity||'INFO').toUpperCase();
    const sevClass = rawSev==='CRITICAL'?'alert-sev-critical':rawSev==='WARNING'?'alert-sev-warning':'alert-sev-info';
    const icon = rawSev==='CRITICAL'?'fa-circle-xmark':rawSev==='WARNING'?'fa-triangle-exclamation':'fa-circle-info';
    const devId = a.deviceId||a.device?.id||'';
    const devName = a.deviceName||a.device?.name||(devId&&S.devices[devId]?S.devices[devId].status?.name||deviceName(S.devices[devId]):'–')||'–';
    const site = a.siteName||a.site?.name||(devId&&S.devices[devId]?S.devices[devId].siteName:'–')||'–';
    const msg  = a.message||a.description||a.summary||a.details||a.alertType||a.type||'–';
    const ts   = a.createdAt||a.timestamp||a.alertTimestamp||a.created||a.startTime||'';
    const tsF  = ts ? new Date(ts).toLocaleString('de-DE') : '–';
    const status = a.status||a.state||a.alertState||'';
    const rowCls = rawSev==='CRITICAL'?'alert-row-critical':rawSev==='WARNING'?'alert-row-warning':'';
    return `<tr class="${rowCls}">
      <td><span class="${sevClass}"><i class="fa-solid ${icon}"></i> ${escHtml(rawSev)}</span></td>
      <td class="device-ref">${escHtml(devName)}</td>
      <td class="muted">${escHtml(site)}</td>
      <td style="max-width:300px;white-space:normal">${escHtml(msg)}</td>
      <td class="muted mono" style="white-space:nowrap;font-size:11px">${tsF}</td>
      <td class="muted">${escHtml(status||'–')}</td>
    </tr>`;
  }).join('');
}
async function reloadAlerts() {
  alertsData = [];
  const icon = document.getElementById('alerts-refresh-icon');
  if(icon) icon.classList.add('fa-spin');
  await loadAlerts();
  if(icon) icon.classList.remove('fa-spin');
}

// ─── SITE TILES ───────────────────────────────────────────────────────────────
function renderSiteTiles() {
  const tileEl = document.getElementById('site-tiles');
  if(!tileEl) return;
  const devs = Object.values(S.devices);
  const sites = [...new Set(devs.map(d=>d.siteName||'').filter(Boolean))].sort();
  if(sites.length < 2) { tileEl.style.display = 'none'; return; }
  tileEl.style.display = 'flex';
  tileEl.innerHTML = sites.map(s => {
    const sd = devs.filter(d => d.siteName === s);
    const onl = sd.filter(d => isOnline(d)).length;
    const al  = sd.filter(d => d.alerting?.hasAlert).length;
    const act = siteFilter === s;
    return `<div class="site-tile${act?' active':''}" onclick="tileSiteFilter(${JSON.stringify(s)})">
      <div class="site-tile-name"><i class="fa-solid fa-location-dot" style="margin-right:4px;opacity:.5"></i>${escHtml(s)}</div>
      <div class="site-tile-count">${sd.length}</div>
      <div class="site-tile-detail">
        <span style="color:var(--green)"><i class="fa-solid fa-circle" style="font-size:7px"></i> ${onl}</span>
        <span style="color:var(--red)"><i class="fa-solid fa-circle" style="font-size:7px"></i> ${sd.length-onl}</span>
        ${al?`<span style="color:var(--amber)"><i class="fa-solid fa-triangle-exclamation" style="font-size:9px"></i> ${al}</span>`:''}
      </div>
    </div>`;
  }).join('') + `<div class="site-tile${siteFilter==='all'?' active':''}" onclick="tileSiteFilter('all')" style="min-width:80px">
    <div class="site-tile-name">Alle</div>
    <div class="site-tile-count">${devs.length}</div>
    <div class="site-tile-detail" style="color:var(--text3)">Standorte: ${sites.length}</div>
  </div>`;
}
function tileSiteFilter(name) {
  siteFilter = name;
  // Sync with site-filter-group buttons
  document.querySelectorAll('#site-filter-group .filter-btn').forEach(b => {
    b.classList.toggle('active', (b.dataset.site||'all') === name || (name==='all' && !b.dataset.site));
  });
  renderDevices();
  renderSiteTiles();
}

// ─── CE MAC TABLE MODAL ───────────────────────────────────────────────────────
let _ceMacRows = [];  // all rows, built once on open

function ceMacTableOpen() {
  // Collect all entries from scanned devices
  _ceMacRows = [];
  Object.values(ceData).forEach(cd => {
    if(cd.status !== 'done' || !cd.entries?.length) return;
    const devName = cd.device?.status?.name || deviceName(cd.device) || cd.deviceId;
    cd.entries.forEach(e => {
      _ceMacRows.push({
        mac:      e.mac,
        ip:       e.ip || '',
        devName,
        port:     e.portName || '',
        scannedAt: cd.scannedAt,
      });
    });
  });
  // Sort: device name, then port (natural)
  _ceMacRows.sort((a,b) => {
    const d = a.devName.localeCompare(b.devName);
    if(d !== 0) return d;
    return a.port.localeCompare(b.port, undefined, {numeric:true});
  });

  const modal = document.getElementById('ce-mac-modal');
  if(modal) modal.style.display = 'flex';
  const q = document.getElementById('ce-mac-modal-q');
  if(q) { q.value = ''; setTimeout(()=>q.focus(), 60); }
  ceMacTableRender('');
}

function ceMacTableClose() {
  const modal = document.getElementById('ce-mac-modal');
  if(modal) modal.style.display = 'none';
}

function ceMacTableFilter(q) {
  ceMacTableRender(q.trim().toLowerCase());
}

function ceMacTableRender(q) {
  const rows = q
    ? _ceMacRows.filter(r => r.mac.includes(q) || r.ip.includes(q) ||
        r.devName.toLowerCase().includes(q) || r.port.toLowerCase().includes(q))
    : _ceMacRows;

  const count  = document.getElementById('ce-mac-modal-count');
  const tbody  = document.getElementById('ce-mac-modal-tbody');
  const empty  = document.getElementById('ce-mac-modal-empty');
  if(count) count.textContent = rows.length + ' Einträge';
  if(!tbody || !empty) return;

  if(!rows.length) {
    tbody.innerHTML = '';
    empty.style.display = 'block';
    return;
  }
  empty.style.display = 'none';

  tbody.innerHTML = rows.map(r => {
    const ts = r.scannedAt ? fmtRelTime(r.scannedAt) : '–';
    return `<tr>
      <td class="mono" style="font-size:12px;user-select:all">${escHtml(r.mac)}</td>
      <td class="mono" style="font-size:12px">${r.ip ? escHtml(r.ip) : '<span class="muted">–</span>'}</td>
      <td class="device-ref">${escHtml(r.devName)}</td>
      <td><span style="background:var(--bg2);border:1px solid var(--border);border-radius:5px;padding:2px 8px;font-size:11px;font-weight:600">${escHtml(r.port)}</span></td>
      <td class="muted" style="text-align:right;font-size:11px">${ts}</td>
    </tr>`;
  }).join('');
}

// ─── CLIENT EXPLORER ──────────────────────────────────────────────────────────
let ceData         = {};   // { deviceId: {device, ip, status, entries, error, scannedAt, macCount} }
let ceScanActive   = false;
let ceScanAbort    = false;

// Normalize MAC to xx:xx:xx:xx:xx:xx lowercase
function ceNormalizeMac(raw) {
  const c = (raw||'').replace(/[^0-9a-fA-F]/g,'').toLowerCase();
  if(c.length !== 12) return null;
  return c.match(/.{2}/g).join(':');
}

function ceFormatHint(val) {
  const hint = document.getElementById('ce-mac-hint');
  if(!hint) return;
  const norm = ceNormalizeMac(val);
  const hexLen = val.replace(/[^0-9a-fA-F]/g,'').length;
  if(!val) {
    hint.innerHTML = 'Formate: <code>aa:bb:cc:dd:ee:ff</code> &nbsp;·&nbsp; <code>aa-bb-cc-dd-ee-ff</code> &nbsp;·&nbsp; <code>aabbccddeeff</code>';
  } else if(norm) {
    hint.innerHTML = `<span style="color:var(--green)"><i class="fa-solid fa-circle-check"></i> Erkannt: <code>${norm}</code></span>`;
  } else {
    hint.innerHTML = `<span style="color:var(--amber)">${hexLen}/12 Hex-Zeichen eingegeben</span>`;
  }
}

function ceClearResult() {
  const a = document.getElementById('ce-result-area');
  if(a) { a.style.display='none'; a.innerHTML=''; }
  const inp = document.getElementById('ce-mac-input');
  if(inp) { inp.value=''; ceFormatHint(''); }
}

function ceInitDevices() {
  // Register all devices without clearing existing scan results
  Object.values(S.devices).forEach(d => {
    if(!ceData[d.id]) {
      ceData[d.id] = { device:d, ip:d.status?.ip||'', status:'pending', entries:[], error:null, scannedAt:null, macCount:0 };
    } else {
      ceData[d.id].device = d;
      ceData[d.id].ip     = d.status?.ip||'';
    }
  });
  ceRenderDeviceTable();
  const badge = document.getElementById('badge-client-explorer');
  const total = Object.values(ceData).filter(d=>d.status==='done').reduce((s,d)=>s+(d.macCount||0),0);
  if(badge) badge.textContent = total || Object.keys(S.devices).length || '–';
}

async function startCeScan() {
  if(ceScanActive) return;
  ceScanActive = true;
  ceScanAbort  = false;

  // Only scan online devices with known IP
  const ids = Object.values(S.devices).filter(d => d.status?.ip && isOnline(d)).map(d => d.id);

  // Reset status for all to-be-scanned devices
  ids.forEach(id => {
    if(!ceData[id]) ceData[id] = { device:S.devices[id], ip:S.devices[id].status?.ip||'', status:'pending', entries:[], error:null, scannedAt:null, macCount:0 };
    else { ceData[id].status='pending'; }
  });

  const startBtn  = document.getElementById('ce-scan-start-btn');
  const cancelBtn = document.getElementById('ce-scan-cancel-btn');
  const progWrap  = document.getElementById('ce-progress-wrap');
  if(startBtn)  startBtn.disabled = true;
  if(cancelBtn) cancelBtn.style.display = '';
  if(progWrap)  progWrap.style.display = 'flex';

  ceRenderDeviceTable();

  let done = 0;
  const total = ids.length;

  for(const id of ids) {
    if(ceScanAbort) break;
    await ceScanOneDevice(id);
    done++;
    const pct = Math.round(done/total*100);
    const bar  = document.getElementById('ce-prog');
    const txt  = document.getElementById('ce-progress-text');
    if(bar) bar.style.width = pct+'%';
    if(txt) txt.textContent = `${done} / ${total}`;
  }

  ceScanActive = false;
  ceScanAbort  = false;
  if(startBtn)  startBtn.disabled = false;
  if(cancelBtn) cancelBtn.style.display = 'none';
  if(progWrap)  progWrap.style.display = 'none';

  const doneCnt   = Object.values(ceData).filter(d=>d.status==='done').length;
  const totalMacs = Object.values(ceData).reduce((s,d)=>s+(d.macCount||0),0);
  const summary   = document.getElementById('ce-scan-summary');
  if(summary) summary.textContent = `${doneCnt} Geräte · ${totalMacs} MACs`;
  const badge = document.getElementById('badge-client-explorer');
  if(badge) badge.textContent = totalMacs || '–';

  if(!ceScanAbort) toast('success','Scan abgeschlossen',`${doneCnt} Geräte · ${totalMacs} MACs gefunden`);
}

function cancelCeScan() {
  ceScanAbort = true;
  toast('info','Scan abgebrochen','Laufende Anfrage wird noch abgeschlossen.');
}

function ceDeviceIp(dev) {
  return dev?.status?.ip || dev?.status?.ipAddress || dev?.status?.lastIp || '';
}

function ceDeviceType(dev) {
  const t = (dev?.status?.type || '').toUpperCase();
  if(t === 'SWITCH')       return { label:'Switch',       color:'#aadaf7', icon:'fa-network-wired' };
  if(t === 'ACCESS_POINT') return { label:'Access Point', color:'#2d5fff', icon:'fa-wifi' };
  if(t === 'FIREWALL')     return { label:'Firewall',     color:'#ff004d', icon:'fa-shield-halved' };
  if(t === 'ROUTER')       return { label:'Router',       color:'#aadaf7', icon:'fa-route' };
  // Fallback from LLDP / WLAN heuristics
  if(S.lldpNeighbors.some(p => p._deviceId === dev?.id))
    return { label:'Switch',       color:'#aadaf7', icon:'fa-network-wired' };
  if((S.wlanClients[dev?.id] || 0) > 0)
    return { label:'Access Point', color:'#2d5fff', icon:'fa-wifi' };
  return { label:'Router', color:'#aadaf7', icon:'fa-route' };
}

async function ceScanOneDevice(deviceId) {
  const d  = S.devices[deviceId];
  const ip = ceDeviceIp(d);
  if(!ip) { ceData[deviceId].status = 'no-ip'; ceRenderDeviceRow(deviceId); return; }

  ceData[deviceId].status = 'scanning';
  ceRenderDeviceRow(deviceId);

  try {
    const r = await fetch('/snmp', {
      method:'POST', headers:{'Content-Type':'application/json'},
      body: JSON.stringify({ host:ip, community:snmpReadCommunity||'public', version:'2c', type:'mac-table' })
    });
    const result = await r.json();
    if(result.error) {
      ceData[deviceId].status = 'error';
      ceData[deviceId].error  = result.error;
      ceData[deviceId].entries = [];
    } else if(!result.hasMacTable) {
      ceData[deviceId].status = 'no-table';
      ceData[deviceId].entries = [];
    } else {
      ceData[deviceId].status   = 'done';
      ceData[deviceId].entries  = result.entries || [];
      ceData[deviceId].macCount = result.count   || 0;
      ceData[deviceId].source   = result.source  || 'bridge';
    }
  } catch(e) {
    ceData[deviceId].status = 'error';
    ceData[deviceId].error  = e.message;
  }
  ceData[deviceId].scannedAt = new Date();
  ceRenderDeviceRow(deviceId);
}

async function ceScanSingle(deviceId) {
  if(ceScanActive) { toast('info','Scan läuft','Warte bis der aktuelle Scan beendet ist.'); return; }
  const dev = S.devices[deviceId];
  if(!ceDeviceIp(dev)) { toast('warning','Keine IP','Für dieses Gerät ist keine IP-Adresse bekannt.'); return; }
  await ceScanOneDevice(deviceId);
}

// ── MAC Lookup ────────────────────────────────────────────────────────────────
function ceLookup() {
  const raw = (document.getElementById('ce-mac-input')?.value||'').trim();
  const mac = ceNormalizeMac(raw);
  const area = document.getElementById('ce-result-area');
  if(!area) return;
  area.style.display = 'block';

  if(!mac) {
    area.innerHTML = `<div style="background:rgba(255,0,77,.1);border:1px solid rgba(255,0,77,.3);border-radius:10px;padding:14px 18px;color:var(--red);font-size:13px"><i class="fa-solid fa-triangle-exclamation" style="margin-right:7px"></i>Ungültige MAC-Adresse. Erwartet: 6 Byte Hex, z.B. <code>aa:bb:cc:dd:ee:ff</code></div>`;
    return;
  }

  const scannedDevices = Object.values(ceData).filter(d=>d.status==='done');
  if(!scannedDevices.length) {
    area.innerHTML = `<div style="background:rgba(119,200,210,.1);border:1px solid rgba(119,200,210,.3);border-radius:10px;padding:14px 18px;color:var(--amber);font-size:13px"><i class="fa-solid fa-triangle-exclamation" style="margin-right:7px"></i>Noch kein erfolgreicher Scan vorhanden. Bitte zuerst <strong>"Online-Geräte scannen"</strong> klicken.</div>`;
    return;
  }

  // Find all devices that have this MAC in their table
  const hits = [];
  Object.entries(ceData).forEach(([deviceId, cd]) => {
    if(cd.status !== 'done') return;
    const entry = cd.entries.find(e => e.mac === mac);
    if(!entry) return;

    const portName = entry.portName;

    // Determine if this is a direct port or an uplink:
    // A port is INDIRECT if it has an LLDP neighbor → the MAC arrived through another managed device
    const lldpEntry = S.lldpNeighbors.find(p =>
      p._deviceId === deviceId && p.portName === portName && p.lldpNames.length > 0
    );

    // Find which managed device is behind this LLDP port
    let viaName = null, viaId = null;
    if(lldpEntry) {
      viaName = lldpEntry.lldpNames[0];
      // Try to find that device in our device list
      viaId = Object.values(S.devices).find(dev => {
        const n = (dev.status?.name||dev.label||dev.name||'').toLowerCase();
        return n === viaName.toLowerCase();
      })?.id || null;
    }

    const hitDev = S.devices[deviceId];
    hits.push({
      deviceId,
      devName:   hitDev?.status?.name || hitDev?.label || hitDev?.name || deviceName(hitDev),
      portName,
      ip:        entry.ip,
      isDirect:  !lldpEntry,
      viaName,
      viaId,
      lldpEntry,
      online:    isOnline(hitDev),
      scannedAt: cd.scannedAt,
    });
  });

  if(!hits.length) {
    area.innerHTML = `<div style="background:var(--card);border:1px solid var(--border);border-radius:12px;padding:20px 24px;">
      <div style="display:flex;align-items:center;gap:10px;margin-bottom:10px">
        <i class="fa-solid fa-circle-xmark" style="font-size:20px;color:var(--text3)"></i>
        <div>
          <div style="font-size:14px;font-weight:700">MAC nicht gefunden</div>
          <div style="font-size:12px;color:var(--text2);margin-top:2px">
            <code style="font-size:13px;background:var(--bg2);padding:2px 7px;border-radius:5px">${escHtml(mac)}</code>
            wurde in ${scannedDevices.length} Geräten nicht gefunden.
          </div>
        </div>
      </div>
      <div style="font-size:11px;color:var(--text3);line-height:1.6;border-top:1px solid var(--border);padding-top:10px;margin-top:4px">
        Mögliche Ursachen: Gerät gerade nicht verbunden · SNMP-Scan veraltet (neu scannen) ·
        Gerät hinter einem nicht gescannten oder nicht erreichbaren Switch
      </div>
    </div>`;
    return;
  }

  // Sort: direct first
  hits.sort((a,b) => (b.isDirect?1:0)-(a.isDirect?1:0));
  const directHits   = hits.filter(h => h.isDirect);
  const indirectHits = hits.filter(h => !h.isDirect);

  let html = `<div style="display:flex;align-items:center;gap:10px;margin-bottom:14px;flex-wrap:wrap">
    <i class="fa-solid fa-magnifying-glass" style="color:var(--accent);font-size:14px"></i>
    <span style="font-size:12px;font-weight:700;color:var(--text2);text-transform:uppercase;letter-spacing:.07em">Ergebnis für</span>
    <code style="font-size:14px;font-weight:700;background:var(--bg2);padding:3px 10px;border-radius:7px;border:1px solid var(--border)">${escHtml(mac)}</code>
    <span style="font-size:11px;color:var(--text3)">${hits.length} Treffer in ${scannedDevices.length} gescannten Geräten</span>
  </div>`;

  // ── Direct hits ──
  if(directHits.length) {
    html += `<div style="font-size:11px;font-weight:700;color:var(--green);text-transform:uppercase;letter-spacing:.07em;margin-bottom:8px;display:flex;align-items:center;gap:6px">
      <i class="fa-solid fa-plug-circle-check"></i> Direkter Anschluss
    </div>`;
    directHits.forEach(h => {
      html += `<div class="ce-hit direct" style="margin-bottom:10px">
        <div style="display:flex;align-items:center;gap:10px;margin-bottom:14px;flex-wrap:wrap">
          <span style="width:10px;height:10px;border-radius:50%;background:${h.online?'var(--green)':'var(--red)'};flex-shrink:0"></span>
          <span class="ce-hit-device">${escHtml(h.devName)}</span>
          <span style="background:rgba(160,237,58,.15);color:var(--green);border:1px solid rgba(160,237,58,.3);font-size:10px;font-weight:700;padding:2px 9px;border-radius:10px">DIREKTER ANSCHLUSS</span>
        </div>
        <div style="display:flex;gap:24px;flex-wrap:wrap">
          <div class="ce-field">
            <div class="ce-field-lbl">Switch-Port</div>
            <div class="ce-hit-port">${escHtml(h.portName)}</div>
          </div>
          ${h.ip ? `<div class="ce-field"><div class="ce-field-lbl">IP-Adresse (ARP)</div><div class="ce-field-val" style="font-family:'Courier New',monospace">${escHtml(h.ip)}</div></div>` : ''}
          <div class="ce-field">
            <div class="ce-field-lbl">MAC</div>
            <div class="ce-field-val" style="font-family:'Courier New',monospace">${escHtml(mac)}</div>
          </div>
          <div class="ce-field">
            <div class="ce-field-lbl">Gerät-Status</div>
            <div class="ce-field-val"><span class="sdot ${h.online?'sdot-green':'sdot-red'}">${h.online?'Online':'Offline'}</span></div>
          </div>
          <div class="ce-field">
            <div class="ce-field-lbl">Scan-Zeit</div>
            <div class="ce-field-val" style="color:var(--text2);font-size:11px">${h.scannedAt?h.scannedAt.toLocaleTimeString('de-DE'):'–'}</div>
          </div>
        </div>
      </div>`;
    });
  }

  // ── Indirect hits (uplink path) ──
  if(indirectHits.length) {
    html += `<div style="font-size:11px;font-weight:700;color:var(--text2);text-transform:uppercase;letter-spacing:.07em;margin:${directHits.length?14:0}px 0 8px;display:flex;align-items:center;gap:6px">
      <i class="fa-solid fa-route"></i> Uplink-Pfad (MAC auch gesehen auf)
    </div>`;
    indirectHits.forEach(h => {
      const viaLabel = h.viaName
        ? `<i class="fa-solid fa-arrow-right" style="font-size:10px;color:var(--text3);margin:0 4px"></i><span style="color:var(--accent2)">${escHtml(h.viaName)}</span> (LLDP-Nachbar auf diesem Port)`
        : `<span style="color:var(--text3)">LLDP-Uplink</span>`;
      html += `<div class="ce-hit via" style="margin-bottom:8px">
        <div style="display:flex;align-items:center;gap:8px;flex-wrap:wrap">
          <span style="width:8px;height:8px;border-radius:50%;background:${h.online?'var(--green)':'var(--red)'};flex-shrink:0"></span>
          <span style="font-size:13px;font-weight:700">${escHtml(h.devName)}</span>
          <span style="background:var(--card2);border:1px solid var(--border);font-size:10px;font-weight:600;padding:2px 8px;border-radius:8px;color:var(--text3)">Port ${escHtml(h.portName)}</span>
          ${viaLabel}
        </div>
      </div>`;
    });
    if(directHits.length) {
      html += `<div style="font-size:11px;color:var(--text3);margin-top:4px;padding:8px 12px;background:var(--bg2);border-radius:8px"><i class="fa-solid fa-circle-info" style="margin-right:5px"></i>Diese Geräte sehen die MAC auf einem Trunk-/Uplink-Port – der Client ist <strong>nicht direkt</strong> dort angeschlossen.</div>`;
    }
  }

  area.innerHTML = html;
}

// ── Render helpers ────────────────────────────────────────────────────────────
function ceRenderDeviceTable() {
  const tbody = document.getElementById('ce-device-tbody');
  const empty = document.getElementById('ce-device-empty');
  if(!tbody) return;
  const devs = Object.values(S.devices);
  if(!devs.length) { tbody.innerHTML=''; if(empty) empty.style.display='block'; return; }
  if(empty) empty.style.display='none';
  tbody.innerHTML = devs
    .sort((a,b)=>deviceName(a).localeCompare(deviceName(b)))
    .map(d=>ceBuildDeviceRow(d.id)).join('');
}

function ceBuildDeviceRow(deviceId) {
  const dev = S.devices[deviceId];
  if(!dev) return '';
  const cd     = ceData[deviceId];
  const name   = dev.status?.name || dev.label || dev.name || deviceName(dev);
  const ip     = ceDeviceIp(dev) || '–';
  const online = isOnline(dev);
  const type   = ceDeviceType(dev);
  const scanningThis = cd?.status === 'scanning';

  let statusCell = `<span style="color:var(--text3);font-size:11px"><i class="fa-solid fa-clock"></i> Ausstehend</span>`;
  let macCell    = '<span style="color:var(--text3)">–</span>';
  let rowCls     = '';

  if(cd) {
    if(cd.status === 'scanning') {
      statusCell = `<span style="color:var(--accent);font-size:11px"><i class="fa-solid fa-circle-notch fa-spin"></i> Scanne…</span>`;
      rowCls = 'ce-row-scanning';
    } else if(cd.status === 'done') {
      const srcBadge = cd.source === 'wlan-clients'
        ? `<span style="font-size:10px;background:rgba(119,200,210,.15);border:1px solid rgba(119,200,210,.3);border-radius:3px;padding:1px 5px;color:var(--teal);margin-left:5px" title="LANCOM Enterprise WLAN-Clients MIB"><i class="fa-solid fa-wifi"></i> WLAN</span>`
        : '';
      statusCell = `<span style="color:var(--green);font-size:11px"><i class="fa-solid fa-circle-check"></i> ${cd.scannedAt?cd.scannedAt.toLocaleTimeString('de-DE'):''}${srcBadge}</span>`;
      macCell = `<span style="font-weight:700;color:var(--teal)">${cd.macCount}</span>`;
      rowCls = 'ce-row-done';
    } else if(cd.status === 'no-table') {
      statusCell = `<span style="color:var(--text2);font-size:11px"><i class="fa-solid fa-minus-circle"></i> Keine MAC-Tabelle</span>`;
    } else if(cd.status === 'no-ip') {
      statusCell = `<span style="color:var(--text3);font-size:11px"><i class="fa-solid fa-unlink"></i> Keine IP</span>`;
    } else if(cd.status === 'error') {
      const errMsg = (cd.error||'Fehler').substring(0,40);
      statusCell = `<span style="color:var(--red);font-size:11px" title="${escHtml(cd.error||'')}"><i class="fa-solid fa-circle-xmark"></i> ${escHtml(errMsg)}</span>`;
      rowCls = 'ce-row-error';
    }
  }

  const btnDisabled = scanningThis || ceScanActive;
  return `<tr id="ce-row-${deviceId}" class="${rowCls}">
    <td><span style="display:inline-block;width:7px;height:7px;border-radius:50%;background:${online?'var(--green)':'var(--red)'};margin-right:7px;vertical-align:middle;flex-shrink:0"></span><span class="device-ref">${escHtml(name)}</span></td>
    <td class="mono">${ip}</td>
    <td><span style="background:rgba(45,95,255,.12);border:1px solid var(--border);font-size:11px;font-weight:700;padding:2px 8px;border-radius:4px;color:${type.color}"><i class="fa-solid ${type.icon}" style="margin-right:4px;font-size:10px"></i>${type.label}</span></td>
    <td>${macCell}</td>
    <td>${statusCell}</td>
    <td><button onclick="ceScanSingle('${deviceId}')" ${btnDisabled?'disabled':''} style="background:rgba(45,95,255,.1);border:1px solid rgba(45,95,255,.2);border-radius:5px;color:var(--accent2);font-size:11px;font-weight:600;padding:4px 10px;cursor:${btnDisabled?'not-allowed':'pointer'};opacity:${btnDisabled?.4:1};white-space:nowrap"><i class="fa-solid fa-ethernet"></i> Scan</button></td>
  </tr>`;
}

function ceRenderDeviceRow(deviceId) {
  const el = document.getElementById(`ce-row-${deviceId}`);
  if(!el) return;
  const tmp = document.createElement('tbody');
  tmp.innerHTML = ceBuildDeviceRow(deviceId);
  const newRow = tmp.firstElementChild;
  if(newRow) el.replaceWith(newRow);
}

// ─── BULK SELECTION ───────────────────────────────────────────────────────────
let bulkMode = false;
let bulkSelected = new Set();

function toggleBulkMode() {
  bulkMode = !bulkMode;
  bulkSelected.clear();
  const btn  = document.getElementById('bulk-mode-btn');
  const bar  = document.getElementById('bulk-bar');
  const grid = document.getElementById('device-grid');
  if(bulkMode) {
    if(btn)  { btn.style.background='rgba(45,95,255,.25)'; btn.style.borderColor='var(--accent)'; btn.style.color='var(--accent2)'; }
    if(grid) grid.classList.add('bulk-mode');
  } else {
    if(btn)  { btn.style.background=''; btn.style.borderColor=''; btn.style.color=''; }
    if(grid) grid.classList.remove('bulk-mode');
    if(bar)  bar.style.display='none';
  }
  renderDevices();
}

function bulkToggleDevice(id, ev) {
  if(ev) ev.stopPropagation();
  if(!bulkMode) return;
  if(bulkSelected.has(id)) bulkSelected.delete(id);
  else bulkSelected.add(id);
  updateBulkBar();
  const card = document.getElementById(`card-${id}`);
  if(card) card.classList.toggle('bulk-selected', bulkSelected.has(id));
  const cb = card?.querySelector('input[type=checkbox]');
  if(cb) cb.checked = bulkSelected.has(id);
}

function updateBulkBar() {
  const bar = document.getElementById('bulk-bar');
  const cnt = document.getElementById('bulk-count');
  if(!bar) return;
  if(bulkSelected.size > 0) {
    bar.style.display = 'flex';
    if(cnt) cnt.textContent = `${bulkSelected.size} Gerät${bulkSelected.size>1?'e':''} ausgewählt`;
  } else {
    bar.style.display = 'none';
  }
}

function bulkSelectAll() {
  const q = document.getElementById('search-input').value.toLowerCase();
  Object.values(S.devices).forEach(d => {
    if(devFilter==='online'&&!isOnline(d)) return;
    if(devFilter==='offline'&&isOnline(d)) return;
    if(devFilter==='alert'&&!d.alerting?.hasAlert) return;
    if(siteFilter!=='all'&&(d.siteName||'')!==siteFilter) return;
    if(q){const f=[d.label,d.name,d.siteName,d.status?.deviceLabel,d.status?.model,d.status?.serial,d.status?.ip,d.id];if(!f.some(x=>x&&x.toLowerCase().includes(q)))return;}
    bulkSelected.add(d.id);
  });
  updateBulkBar();
  renderDevices();
}

function bulkClear() {
  bulkSelected.clear();
  updateBulkBar();
  renderDevices();
}

async function bulkActionReboot() {
  if(!bulkSelected.size) return;
  const ids = [...bulkSelected];
  const names = ids.map(id=>deviceName(S.devices[id])||id).join(', ');
  if(!confirm(`${ids.length} Gerät(e) neu starten?\n\n${names}`)) return;
  openActionModal('Neustart', ids);
  let done=0, errs=0;
  for(const id of ids) {
    try {
      await api('devices',`/accounts/${S.accountId}/actions/reboot`,'POST',[id]);
      updateActionDeviceStatus(id,'ok'); done++;
    } catch(e) { updateActionDeviceStatus(id,'error',e.message); errs++; }
  }
  finalizeActionModal(done, errs);
}

async function bulkActionFirmware() {
  if(!bulkSelected.size) return;
  const ids = [...bulkSelected].filter(id=>S.devices[id]?.firmwareState==='OBSOLETE');
  if(!ids.length) { toast('info','Keine Updates','Alle ausgewählten Geräte haben aktuelle Firmware.'); return; }
  if(!confirm(`Firmware für ${ids.length} Gerät(e) aktualisieren?`)) return;
  openActionModal('Firmware-Update', ids);
  let done=0, errs=0;
  for(const id of ids) {
    try {
      const fwData = await api('devices',`/accounts/${S.accountId}/firmware/update?deviceIds=${id}`);
      const recId  = fwData?.[id]?.recommendedId;
      if(!recId) throw new Error('Kein Update verfügbar');
      await api('devices',`/accounts/${S.accountId}/firmware/update`,'POST',[{deviceId:id,firmwareId:recId}]);
      updateActionDeviceStatus(id,'ok'); done++;
    } catch(e) { updateActionDeviceStatus(id,'error',e.message); errs++; }
  }
  finalizeActionModal(done, errs);
}

async function bulkActionRollout() {
  if(!bulkSelected.size) return;
  const ids = [...bulkSelected];
  if(!confirm(`Konfiguration auf ${ids.length} Gerät(e) ausrollen?`)) return;
  openActionModal('Konfig-Rollout', ids);
  let done=0, errs=0;
  for(const id of ids) {
    try {
      await api('config',`/configdevice/accounts/${S.accountId}/devices/${id}/rollout?forceRollout=false&addDependentCentralSites=false`,'POST');
      updateActionDeviceStatus(id,'ok'); done++;
    } catch(e) { updateActionDeviceStatus(id,'error',e.message); errs++; }
  }
  finalizeActionModal(done, errs);
}

// ─── ACTION STATUS MODAL ──────────────────────────────────────────────────────
function openActionModal(title, deviceIds) {
  const modal  = document.getElementById('action-modal');
  const titleEl= document.getElementById('action-modal-title');
  const list   = document.getElementById('action-device-list');
  if(!modal||!list) return;
  if(titleEl) titleEl.textContent = title + '…';
  list.innerHTML = deviceIds.map(id => {
    const name = S.devices[id] ? deviceName(S.devices[id]) : id;
    return `<div class="action-device-row" id="adr-${id}">
      <div class="action-device-status" id="ads-${id}"><i class="fa-solid fa-circle-notch fa-spin" style="color:var(--text3)"></i></div>
      <div style="font-size:13px;font-weight:600;flex:1;min-width:0;white-space:nowrap;overflow:hidden;text-overflow:ellipsis">${escHtml(name)}</div>
      <div id="ade-${id}" style="font-size:11px;color:var(--red);max-width:200px;text-align:right"></div>
    </div>`;
  }).join('');
  document.getElementById('action-modal-summary').textContent = '';
  document.getElementById('action-modal-close-btn').style.display = 'none';
  modal.style.display = 'flex';
}

function updateActionDeviceStatus(id, status, errMsg) {
  const statusEl = document.getElementById(`ads-${id}`);
  const errEl    = document.getElementById(`ade-${id}`);
  if(!statusEl) return;
  if(status==='ok') statusEl.innerHTML = '<i class="fa-solid fa-circle-check" style="color:var(--green)"></i>';
  else {
    statusEl.innerHTML = '<i class="fa-solid fa-circle-xmark" style="color:var(--red)"></i>';
    if(errEl&&errMsg) errEl.textContent = errMsg.slice(0,55);
  }
}

function finalizeActionModal(done, errs) {
  const sum     = document.getElementById('action-modal-summary');
  const closeBtn= document.getElementById('action-modal-close-btn');
  const titleEl = document.getElementById('action-modal-title');
  const icon    = document.querySelector('#action-modal .fa-gear');
  if(icon)    { icon.classList.remove('fa-spin'); }
  if(titleEl) titleEl.textContent = titleEl.textContent.replace('…','');
  if(sum)     sum.textContent = `${done} OK${errs?', '+errs+' Fehler':''}`;
  if(closeBtn)closeBtn.style.display = '';
  if(!errs)   toast('success','Aktion abgeschlossen',`${done} Gerät(e) erfolgreich`);
  else        toast('error','Teilweise fehlgeschlagen',`${done} OK · ${errs} Fehler`);
}

function closeActionModal() {
  document.getElementById('action-modal').style.display = 'none';
}

// ─── WEBCONFIG ────────────────────────────────────────────────────────────────
async function openWebconfig(deviceId, name) {
  const dev = S.devices[deviceId];
  if(!dev||!isOnline(dev)) { toast('info','Gerät offline','WEBconfig nur für Online-Geräte verfügbar.'); return; }
  const btn = document.querySelector(`#card-${deviceId} .btn-web`);
  if(btn) { btn._orig=btn.innerHTML; btn.innerHTML='<i class="fa-solid fa-circle-notch fa-spin"></i>'; btn.disabled=true; }
  try {
    const result = await api('devicetunnel',`/accounts/${S.accountId}/webconfig`,'POST',{type:'WEBCONFIG',deviceIds:[deviceId]});
    const entry  = Array.isArray(result) ? (result.find(r=>r.deviceId===deviceId)||result[0]) : result;
    const token  = entry?.entryToken||entry?.token||entry?.accessToken;
    if(token) {
      window.open(`https://cloud.lancom.de/webconfig?token=${encodeURIComponent(token)}`,'_blank');
      toast('success','WEBconfig gestartet', name);
    } else if(entry?.url) {
      window.open(entry.url,'_blank');
      toast('success','WEBconfig gestartet', name);
    } else {
      toast('error','WEBconfig fehlgeschlagen','Kein Token in der Antwort: '+JSON.stringify(result).slice(0,80));
    }
  } catch(e) {
    toast('error','WEBconfig Fehler', e.message);
  } finally {
    if(btn) { if(btn._orig) btn.innerHTML=btn._orig; btn.disabled=false; }
  }
}

// ─── CONFIG PREVIEW ───────────────────────────────────────────────────────────
async function openCfgPreview(deviceId, name) {
  const modal   = document.getElementById('cfg-preview-modal');
  const content = document.getElementById('cfg-preview-content');
  const titleEl = document.getElementById('cfg-preview-title');
  if(!modal) return;
  if(titleEl)   titleEl.textContent = 'Konfig-Vorschau: '+name;
  if(content)   content.textContent = 'Lade Vorschau…';
  modal.style.display = 'flex';
  try {
    const result = await api('config',`/configbuilder/accounts/${S.accountId}/devices/${deviceId}/preview`,'PUT',{});
    if(typeof result==='string') {
      if(content) content.textContent = result||'(leer)';
    } else {
      if(content) content.textContent = JSON.stringify(result,null,2);
    }
  } catch(e) {
    if(content) content.textContent = 'Fehler: '+e.message;
  }
}

function closeCfgPreview() {
  document.getElementById('cfg-preview-modal').style.display = 'none';
}

// ─── CSV EXPORT ───────────────────────────────────────────────────────────────
function exportDevicesCsv() {
  const devices = Object.values(S.devices);
  if(!devices.length) { toast('info','Keine Daten','Zuerst Geräte laden.'); return; }
  const headers = ['Name','Modell','Seriennummer','IP-Adresse','Standort','Status','Firmware','FW-Status','CFG-Status','WLAN-Clients','Lifecycle'];
  const rows = devices.map(d => {
    const wlan = S.wlanClients[d.id]!==undefined ? String(S.wlanClients[d.id]) : '–';
    return [
      deviceName(d), d.status?.model||'–', d.status?.serial||'–', d.status?.ip||'–',
      d.siteName||'–', isOnline(d)?'Online':'Offline', d.status?.fwLabel||'–',
      d.firmwareState||'–', S.configStates[d.id]?.category||'–', wlan,
      d.status?.lifecycle?.status||'–',
    ].map(v=>`"${String(v).replace(/"/g,'""')}"`).join(',');
  });
  const csv = [headers.join(','),...rows].join('\n');
  const blob = new Blob(['\ufeff'+csv],{type:'text/csv;charset=utf-8;'});
  const a = document.createElement('a');
  a.href = URL.createObjectURL(blob);
  a.download = `lancom-geraete-${new Date().toISOString().slice(0,10)}.csv`;
  a.click();
  URL.revokeObjectURL(a.href);
  toast('success','Export erfolgreich',`${devices.length} Geräte exportiert.`);
}

// ─── FIRMWARE OVERVIEW ────────────────────────────────────────────────────────
function renderFirmware() {
  const wrap  = document.getElementById('firmware-wrap');
  const badge = document.getElementById('badge-firmware');
  const cnt   = document.getElementById('firmware-count');
  if(!wrap) return;
  const devices = Object.values(S.devices);
  if(!devices.length) {
    wrap.innerHTML = '<div class="empty-state"><i class="fa-solid fa-microchip"></i><h3>Keine Geräte</h3><p>Zuerst Geräte laden.</p></div>';
    return;
  }
  // Group by firmware label
  const groups = {};
  devices.forEach(d => {
    const fw = d.status?.fwLabel||'(unbekannt)';
    if(!groups[fw]) groups[fw] = {fw, devices:[], obsolete:0, online:0};
    groups[fw].devices.push(d);
    if(d.firmwareState==='OBSOLETE') groups[fw].obsolete++;
    if(isOnline(d)) groups[fw].online++;
  });
  const sorted = Object.values(groups).sort((a,b)=>b.obsolete-a.obsolete||b.devices.length-a.devices.length);
  if(cnt) cnt.textContent = devices.length;
  if(badge) badge.textContent = sorted.length;
  let html = '';
  sorted.forEach(g => {
    const isObs = g.obsolete>0;
    const bStyle = isObs
      ? 'background:rgba(170,218,247,.15);color:var(--blue);border:1px solid rgba(170,218,247,.3)'
      : 'background:rgba(160,237,58,.15);color:var(--green);border:1px solid rgba(160,237,58,.3)';
    html += `<div class="fw-group">
      <div class="fw-group-header">
        <span class="fw-group-label">${escHtml(g.fw)}</span>
        <span style="padding:2px 10px;border-radius:5px;font-size:11px;font-weight:700;${bStyle}">${isObs?'Veraltet':'Aktuell'}</span>
        <span style="font-size:12px;color:var(--text2)">${g.devices.length} Gerät${g.devices.length>1?'e':''} &nbsp;·&nbsp; ${g.online} online</span>
        <div style="flex:1"></div>
        ${isObs?`<button onclick="fwGroupUpdate(${JSON.stringify(g.devices.map(d=>d.id))})" style="background:rgba(170,218,247,.1);border:1px solid rgba(170,218,247,.3);border-radius:7px;color:var(--blue);font-size:12px;font-weight:600;padding:6px 14px;cursor:pointer;white-space:nowrap"><i class="fa-solid fa-arrow-up"></i> Alle updaten</button>`:''}
      </div>
      <div style="padding:0;overflow:auto">
        <table class="data-table">
          <thead><tr><th>Gerät</th><th>Modell</th><th>Seriennummer</th><th>Standort</th><th>Status</th><th>FW-Status</th></tr></thead>
          <tbody>${g.devices.map(d=>`<tr>
            <td class="device-ref">${escHtml(deviceName(d))}</td>
            <td class="muted">${escHtml(d.status?.model||'–')}</td>
            <td class="mono">${escHtml(d.status?.serial||'–')}</td>
            <td class="muted">${escHtml(d.siteName||'–')}</td>
            <td>${isOnline(d)?'<span class="sdot sdot-green">Online</span>':'<span class="sdot sdot-red">Offline</span>'}</td>
            <td>${d.firmwareState==='OBSOLETE'?'<span class="badge badge-fw-old"><i class="fa-solid fa-arrow-up-from-bracket"></i> OBSOLETE</span>':'<span class="badge badge-fw-ok"><i class="fa-solid fa-check"></i> CURRENT</span>'}</td>
          </tr>`).join('')}</tbody>
        </table>
      </div>
    </div>`;
  });
  wrap.innerHTML = html;
}

async function fwGroupUpdate(deviceIds) {
  const obsolete = deviceIds.filter(id=>S.devices[id]?.firmwareState==='OBSOLETE');
  if(!obsolete.length) { toast('info','Nichts zu tun','Alle Geräte dieser Gruppe haben aktuelle Firmware.'); return; }
  if(!confirm(`Firmware für ${obsolete.length} Gerät(e) dieser Gruppe aktualisieren?`)) return;
  openActionModal('Firmware-Update', obsolete);
  let done=0, errs=0;
  for(const id of obsolete) {
    try {
      const fwData = await api('devices',`/accounts/${S.accountId}/firmware/update?deviceIds=${id}`);
      const recId  = fwData?.[id]?.recommendedId;
      if(!recId) throw new Error('Kein Update verfügbar');
      await api('devices',`/accounts/${S.accountId}/firmware/update`,'POST',[{deviceId:id,firmwareId:recId}]);
      updateActionDeviceStatus(id,'ok'); done++;
    } catch(e) { updateActionDeviceStatus(id,'error',e.message); errs++; }
  }
  finalizeActionModal(done, errs);
}

// ─── SITES TAB ────────────────────────────────────────────────────────────────
let sitesData = [];

async function loadSites() {
  const wrap  = document.getElementById('sites-grid');
  const badge = document.getElementById('badge-sites');
  if(!wrap) return;
  wrap.innerHTML = '<div class="empty-state" style="grid-column:1/-1"><i class="fa-solid fa-circle-notch fa-spin" style="font-size:28px;color:var(--accent)"></i><p style="color:var(--text2);margin-top:10px">Lade Standorte…</p></div>';
  try {
    const data = await api('devices',`/accounts/${S.accountId}/sites`);
    sitesData  = Array.isArray(data) ? data : (data?.sites||[]);
    if(sitesData.length) renderSites();
    else renderSitesFromDevices();
  } catch(e) {
    renderSitesFromDevices();
  }
}

function renderSites() {
  const wrap  = document.getElementById('sites-grid');
  const cnt   = document.getElementById('sites-count');
  const badge = document.getElementById('badge-sites');
  if(!wrap) return;
  const items = sitesData.length ? sitesData : null;
  if(!items) { renderSitesFromDevices(); return; }
  if(cnt)   cnt.textContent   = items.length;
  if(badge) badge.textContent = items.length;
  let html = '';
  items.forEach(site => {
    const siteDevs = Object.values(S.devices).filter(d=>d.siteId===site.id||d.siteName===site.name);
    const online   = siteDevs.filter(d=>isOnline(d)).length;
    const alerts   = siteDevs.filter(d=>d.alerting?.hasAlert).length;
    const fwOld    = siteDevs.filter(d=>d.firmwareState==='OBSOLETE').length;
    html += siteCardHtml(site.name||(site.siteName||'Unbekannt'), siteDevs.length, online, alerts, fwOld, site.name||'');
  });
  wrap.innerHTML = html || '<div class="empty-state" style="grid-column:1/-1"><i class="fa-solid fa-location-dot"></i><h3>Keine Standorte</h3><p>Keine Standort-Daten vorhanden.</p></div>';
}

function renderSitesFromDevices() {
  const wrap  = document.getElementById('sites-grid');
  const cnt   = document.getElementById('sites-count');
  const badge = document.getElementById('badge-sites');
  if(!wrap) return;
  const map = {};
  Object.values(S.devices).forEach(d => {
    const n = d.siteName||'(kein Standort)';
    if(!map[n]) map[n] = {name:n, devices:[]};
    map[n].devices.push(d);
  });
  const sites = Object.values(map).sort((a,b)=>a.name.localeCompare(b.name));
  if(cnt)   cnt.textContent   = sites.length;
  if(badge) badge.textContent = sites.length||'–';
  if(!sites.length) { wrap.innerHTML='<div class="empty-state" style="grid-column:1/-1"><i class="fa-solid fa-location-dot"></i><h3>Keine Standorte</h3><p>Zuerst Geräte laden.</p></div>'; return; }
  wrap.innerHTML = sites.map(s => {
    const online = s.devices.filter(d=>isOnline(d)).length;
    const alerts = s.devices.filter(d=>d.alerting?.hasAlert).length;
    const fwOld  = s.devices.filter(d=>d.firmwareState==='OBSOLETE').length;
    return siteCardHtml(s.name, s.devices.length, online, alerts, fwOld, s.name);
  }).join('');
}

function siteCardHtml(name, total, online, alerts, fwOld, siteName) {
  return `<div class="site-card" onclick="showTab('devices');setTimeout(()=>{const btn=document.querySelector('#site-filter-group [data-site]');if(btn)setSiteFilter(${JSON.stringify(siteName)},document.querySelector('#site-filter-group [data-site=\\''+${JSON.stringify(siteName)}+'\\']')||document.createElement('button'));},200)">
    <div class="site-card-name"><i class="fa-solid fa-location-dot" style="color:var(--accent);font-size:13px;flex-shrink:0"></i><span style="white-space:nowrap;overflow:hidden;text-overflow:ellipsis">${escHtml(name)}</span></div>
    <div class="site-stat-row">
      <div class="site-stat"><div class="site-stat-val" style="color:var(--text)">${total}</div><div class="site-stat-lbl">Gesamt</div></div>
      <div class="site-stat"><div class="site-stat-val" style="color:var(--green)">${online}</div><div class="site-stat-lbl">Online</div></div>
      <div class="site-stat"><div class="site-stat-val" style="color:var(--red)">${total-online}</div><div class="site-stat-lbl">Offline</div></div>
      ${alerts?`<div class="site-stat"><div class="site-stat-val" style="color:var(--amber)">${alerts}</div><div class="site-stat-lbl">Alerts</div></div>`:''}
      ${fwOld?`<div class="site-stat"><div class="site-stat-val" style="color:var(--blue)">${fwOld}</div><div class="site-stat-lbl">FW alt</div></div>`:''}
    </div>
  </div>`;
}

// ─── VARIABLES MANAGEMENT ─────────────────────────────────────────────────────
let varsData = [];

async function openVarsModal() {
  const modal = document.getElementById('vars-modal');
  const list  = document.getElementById('vars-list');
  if(!modal) return;
  if(list) list.innerHTML = '<div style="color:var(--text2);font-size:13px;padding:24px 20px"><i class="fa-solid fa-circle-notch fa-spin"></i> Lade Variablen…</div>';
  modal.style.display = 'flex';
  try {
    const data = await api('config',`/configapplication/accounts/${S.accountId}/staticvariables`);
    varsData = Array.isArray(data) ? data : (data?.variables||data?.items||[]);
    renderVars();
  } catch(e) {
    if(list) list.innerHTML = `<div style="color:var(--red);font-size:13px;padding:24px 20px"><i class="fa-solid fa-circle-xmark"></i> Fehler: ${escHtml(e.message)}</div>`;
  }
}

function renderVars() {
  const list  = document.getElementById('vars-list');
  const cntEl = document.getElementById('vars-count');
  if(!list) return;
  if(cntEl) cntEl.textContent = varsData.length ? `${varsData.length} Variable${varsData.length>1?'n':''}` : '';
  if(!varsData.length) {
    list.innerHTML = '<div class="empty-state"><i class="fa-solid fa-sliders"></i><h3>Keine Variablen</h3><p>Es wurden noch keine Add-in Variablen definiert.</p></div>';
    return;
  }
  list.innerHTML = `<div style="display:grid;grid-template-columns:180px 1fr 90px;gap:10px;padding:10px 20px 6px;background:var(--bg2);border-bottom:1px solid var(--border)">
    <div style="font-size:10px;font-weight:700;color:var(--text3);text-transform:uppercase">Name</div>
    <div style="font-size:10px;font-weight:700;color:var(--text3);text-transform:uppercase">Wert</div>
    <div style="font-size:10px;font-weight:700;color:var(--text3);text-transform:uppercase">Typ</div>
  </div>
  <div style="padding:8px 20px 16px">` +
    varsData.map((v,i) => `<div class="var-row">
      <div style="font-size:13px;font-weight:600;font-family:'Courier New',monospace;color:var(--accent2)">${escHtml(v.name||v.key||'–')}</div>
      <div><input class="var-val-input" id="var-val-${i}" type="text" value="${escHtml(v.value||v.defaultValue||'')}" placeholder="(kein Wert)" onfocus="this.style.borderColor='var(--accent)'" onblur="this.style.borderColor='var(--border)'"></div>
      <div style="font-size:11px;color:var(--text3)">${escHtml(v.type||'String')}</div>
    </div>`).join('')
  + '</div>';
}

function closeVarsModal() {
  document.getElementById('vars-modal').style.display = 'none';
}

// ─── ADD-IN NETWORK ASSIGNMENT ────────────────────────────────────────────────
function addinNetworksSectionHtml(appId) {
  const nets = addinsNetworks[appId] || [];
  const items = nets.map(n => {
    const nid  = n.networkId||n.id||'';
    const nname= n.networkName||n.name||nid;
    return `<div style="display:flex;align-items:center;gap:8px;padding:5px 0;border-bottom:1px solid rgba(255,255,255,.04)">
      <i class="fa-solid fa-network-wired" style="color:var(--text3);font-size:11px;flex-shrink:0"></i>
      <span style="font-size:13px;flex:1;min-width:0;overflow:hidden;text-overflow:ellipsis">${escHtml(nname)}</span>
      <span style="font-size:10px;color:var(--text3);font-family:monospace">${escHtml(nid.slice(0,8))}…</span>
      <button onclick="addinNetworkRemove('${appId}','${nid}')" style="background:rgba(255,0,77,.1);border:1px solid rgba(255,0,77,.25);border-radius:5px;color:var(--red);font-size:11px;padding:3px 8px;cursor:pointer;flex-shrink:0">
        <i class="fa-solid fa-times"></i>
      </button>
    </div>`;
  }).join('');
  // Build network options: S.accountNetworks minus already-assigned ones
  const assignedIds = new Set(nets.map(n => n.networkId||n.id||''));
  const availableNets = S.accountNetworks.filter(n => !assignedIds.has(n.id));
  let netSelector;
  if(availableNets.length) {
    const opts = availableNets.map(n =>
      `<option value="${escHtml(n.id)}">${escHtml(n.name)}${n.name!==n.id?' ('+n.id.slice(0,8)+'…)':''}</option>`
    ).join('');
    netSelector = `<select id="addin-net-add-id" style="flex:1;background:rgba(255,255,255,.06);border:1px solid var(--border);border-radius:7px;color:var(--text);padding:7px 10px;font-size:12px;outline:none;cursor:pointer"
      onfocus="this.style.borderColor='var(--accent)'" onblur="this.style.borderColor='var(--border)'">
      <option value="">— Netzwerk wählen —</option>${opts}</select>`;
  } else if(S.accountNetworks.length === 0) {
    netSelector = `<input id="addin-net-add-id" type="text" placeholder="Netzwerk-UUID eingeben"
      style="flex:1;background:rgba(255,255,255,.06);border:1px solid var(--border);border-radius:7px;color:var(--text);padding:7px 10px;font-size:12px;outline:none;font-family:'Courier New',monospace"
      onfocus="this.style.borderColor='var(--accent)'" onblur="this.style.borderColor='var(--border)'">`;
  } else {
    netSelector = `<div style="flex:1;font-size:12px;color:var(--text3);padding:7px 10px;background:rgba(255,255,255,.04);border:1px solid var(--border);border-radius:7px">Alle Netzwerke bereits zugewiesen</div>`;
  }
  return `<div>${nets.length ? items : '<div style="font-size:12px;color:var(--text3);padding:4px 0">Keine Netzwerke zugewiesen</div>'}</div>
  <div style="display:flex;gap:8px;margin-top:10px">
    ${netSelector}
    <button onclick="addinNetworkAdd()" style="background:rgba(45,95,255,.15);border:1px solid rgba(45,95,255,.3);border-radius:7px;color:var(--accent2);font-size:12px;font-weight:600;padding:7px 14px;cursor:pointer;white-space:nowrap">
      <i class="fa-solid fa-plus"></i> Hinzufügen
    </button>
  </div>`;
}

async function addinNetworkAdd() {
  if(!addinEditId) return;
  const el = document.getElementById('addin-net-add-id');
  const networkId = (el?.value||'').trim();
  if(!networkId) { toast('info','Nichts gewählt','Bitte ein Netzwerk auswählen.'); return; }
  const netObj = S.accountNetworks.find(n => n.id === networkId);
  const networkName = netObj?.name || networkId;
  try {
    await api('config',`/configapplication/accounts/${S.accountId}/applications/${addinEditId}/networks/${networkId}`,'PUT',{});
    if(!addinsNetworks[addinEditId]) addinsNetworks[addinEditId] = [];
    addinsNetworks[addinEditId].push({networkId, networkName});
    const netSection = document.getElementById('addin-net-section');
    if(netSection) netSection.innerHTML = addinNetworksSectionHtml(addinEditId);
    toast('success','Netzwerk hinzugefügt', networkName);
  } catch(e) { toast('error','Fehler', e.message); }
}

async function addinNetworkRemove(appId, networkId) {
  try {
    await api('config',`/configapplication/accounts/${S.accountId}/applications/${appId}/networks/${networkId}`,'DELETE');
    if(addinsNetworks[appId]) addinsNetworks[appId] = addinsNetworks[appId].filter(n=>(n.networkId||n.id)!==networkId);
    const netSection = document.getElementById('addin-net-section');
    if(netSection) netSection.innerHTML = addinNetworksSectionHtml(appId);
    toast('success','Netzwerk entfernt','');
  } catch(e) { toast('error','Fehler', e.message); }
}

/// ─── NETWORKS LIST ────────────────────────────────────────────────────────────
async function loadAccountNetworks() {
  try {
    const data = await api('config', `/confignetwork/accounts/${S.accountId}/networks`);
    const list = Array.isArray(data) ? data : (data?.items || data?.networks || data?.data || []);
    S.accountNetworks = list.map(n => ({
      id:   n.networkId || n.id || '',
      name: n.networkName || n.name || n.networkId || n.id || ''
    })).filter(n => n.id);
  } catch(e) {
    console.warn('loadAccountNetworks failed:', e.message);
    S.accountNetworks = [];
  }
}

// ─── TOPOLOGY: SVG EXPORT ─────────────────────────────────────────────────────
function topoExportSvg() {
  const gEl  = document.getElementById('topo-g');
  if(!gEl || !gEl.children.length) { toast('info','Netzwerkplan leer','Kein Inhalt zum Exportieren.'); return; }
  const bbox = gEl.getBBox();
  const pad  = 50;
  const W = Math.ceil(bbox.width  + pad*2);
  const H = Math.ceil(bbox.height + pad*2);
  const tx = (pad - bbox.x).toFixed(1);
  const ty = (pad - bbox.y).toFixed(1);
  const svgStr = `<?xml version="1.0" encoding="UTF-8"?>
<svg xmlns="http://www.w3.org/2000/svg" width="${W}" height="${H}" viewBox="0 0 ${W} ${H}">
<rect width="100%" height="100%" fill="#07091a"/>
<defs>
  <filter id="topo-glow" x="-40%" y="-40%" width="180%" height="180%">
    <feGaussianBlur in="SourceGraphic" stdDeviation="5" result="blur"/>
    <feMerge><feMergeNode in="blur"/><feMergeNode in="SourceGraphic"/></feMerge>
  </filter>
</defs>
<g transform="translate(${tx},${ty})">${gEl.innerHTML}</g>
</svg>`;
  const blob = new Blob([svgStr], {type:'image/svg+xml'});
  const a = document.createElement('a');
  a.href = URL.createObjectURL(blob);
  a.download = 'netzwerkplan.svg';
  a.click();
  URL.revokeObjectURL(a.href);
  toast('success', 'SVG exportiert', 'Netzwerkplan als SVG gespeichert.');
}

// ─── PREDICTIVE ANOMALY ───────────────────────────────────────────────────────
const PA_DAYS = 30;

let paState = {
  loaded: false,
  loading: false,
  results: {},          // deviceId → { predictions[], riskScore }
  progress: { total: 0, done: 0, current: '' },
  lastRun: null
};

/* ── ML Helpers ── */

// Exponential Moving Average (smoothing, α=0.3)
function paEMA(vals, alpha = 0.3) {
  if (!vals.length) return [];
  let e = vals[0];
  return vals.map(v => { e = alpha * v + (1 - alpha) * e; return e; });
}

// Linear Regression → { slope, intercept, r2, predict(x) }
function paLinReg(vals) {
  const n = vals.length;
  if (n < 2) return { slope: 0, intercept: vals[0] || 0, r2: 0, predict: () => vals[0] || 0 };
  let sumX = 0, sumY = 0, sumXY = 0, sumX2 = 0;
  vals.forEach((v, i) => { sumX += i; sumY += v; sumXY += i * v; sumX2 += i * i; });
  const slope = (n * sumXY - sumX * sumY) / (n * sumX2 - sumX * sumX) || 0;
  const intercept = (sumY - slope * sumX) / n;
  const mean = sumY / n;
  let ssTot = 0, ssRes = 0;
  vals.forEach((v, i) => { ssTot += (v - mean) ** 2; ssRes += (v - (slope * i + intercept)) ** 2; });
  const r2 = ssTot > 0 ? Math.max(0, 1 - ssRes / ssTot) : 0;
  return { slope, intercept, r2, predict: x => slope * x + intercept };
}

// Isolation Forest via Z-score → anomaly score [0..1] per value
function paAnomalyScores(vals) {
  if (vals.length < 3) return vals.map(() => 0);
  const mean = vals.reduce((a, b) => a + b, 0) / vals.length;
  const std = Math.sqrt(vals.reduce((a, v) => a + (v - mean) ** 2, 0) / vals.length) || 1;
  return vals.map(v => Math.min(1, Math.abs(v - mean) / (std * 3)));
}

// Days until trend reaches threshold from index fromIdx
function paDaysTo(reg, fromIdx, threshold) {
  if (Math.abs(reg.slope) < 0.0001) return Infinity;
  const d = (threshold - reg.predict(fromIdx)) / reg.slope;
  return d > 0 ? d : Infinity;
}

// Confidence score [0..1] combining trend strength, anomaly frequency, urgency
function paConf(r2, aniFreq, urgencyDays) {
  const trendScore  = Math.min(1, r2);
  const freqScore   = Math.min(1, aniFreq / 0.3);
  const urgScore    = urgencyDays < Infinity ? Math.max(0, 1 - urgencyDays / 30) : 0;
  return Math.round((trendScore * 0.4 + freqScore * 0.35 + urgScore * 0.25) * 100);
}

// Overall device risk score 0-100
function paRiskScore(predictions) {
  if (!predictions.length) return 0;
  let score = 0;
  predictions.forEach(p => {
    const base = p.severity === 'critical' ? 20 : 8;
    score += base * (p.conf / 100);
  });
  return Math.min(100, Math.round(score));
}

/* ── Data Fetching ── */

// Parse Records API type=table response { keys/columns, values } → array of row-objects
function paParseTableRecord(tableData) {
  if (!tableData) return [];
  const keys = tableData.keys || tableData.columns || [];
  const values = tableData.values || [];
  const rows = values.map(row => {
    const obj = {};
    keys.forEach((k, i) => { obj[k] = row[i]; });
    // Normalize timestamp → timeMs if needed
    if (obj.timestamp !== undefined && obj.timeMs === undefined) obj.timeMs = obj.timestamp;
    return obj;
  });
  return rows.sort((a, b) => (a.timeMs || 0) - (b.timeMs || 0));
}

// Fetch 30-day telemetry for one device
async function paFetchDevice(deviceId) {
  const fromMs = Date.now() - PA_DAYS * 86400000;
  const fromStr = new Date(fromMs).toISOString().slice(0, 19) + 'Z';
  // All tables via monitor-frontend service (correct field names + period support)
  const tables = {
    'device-info':    ['timeMs','cpuLoadPercent','totalMemoryKb','freeMemoryKb','temperature'],
    'lan-interface':  ['timeMs','name','active','loopCounter','poePowerMilliWatt','rxDeltaBytes','txDeltaBytes'],
    'vpn-connection': ['timeMs','peerName','active','packetLossPercent','rttAvgUs','jitterUs'],
    'wan-interface':  ['timeMs','connectionType','logicalState','mobileModemSignalDecibelMw','backupInActiveUse'],
    'wlan-interface': ['timeMs','clientCount','band','transmitPowerDecibelMw','noiseDecibelMw','rxErrorPermill'],
  };
  const results = {};

  await Promise.allSettled(Object.entries(tables).map(async ([table, cols]) => {
    try {
      const colStr = cols.map(c => `column=${encodeURIComponent(c)}`).join('&');
      const qs = `deviceId=${encodeURIComponent(deviceId)}&from=${encodeURIComponent(fromStr)}&limit=2000&sort=timeMs&order=asc&${colStr}`;
      const data = await api('monitor-frontend', `/api/${S.accountId}/tables/${table}?${qs}`);
      results[table] = (data?.data || []);
    } catch { results[table] = []; }
  }));

  // WLAN time-series (Records API)
  try {
    const data = await api('monitoring', `/accounts/${S.accountId}/records/wlan_info_json?group=DEVICE&groupId=${deviceId}&period=DAY1&type=json&name=stations&latest=${PA_DAYS}`);
    results['wlan'] = data?.items?.stations?.values || [];
  } catch { results['wlan'] = []; }
  return results;
}

// Bin rows by day-index (0 = oldest) → array of daily avg values for a field
function paBinByDay(rows, timeField, valueField, aggFn = 'avg') {
  const fromMs = Date.now() - PA_DAYS * 86400000;
  const buckets = {};
  rows.forEach(r => {
    const t = r[timeField] || r.timeMs;
    if (!t || t < fromMs) return;
    const dayIdx = Math.floor((t - fromMs) / 86400000);
    if (!buckets[dayIdx]) buckets[dayIdx] = [];
    const v = parseFloat(r[valueField]);
    if (!isNaN(v)) buckets[dayIdx].push(v);
  });
  const result = [];
  for (let i = 0; i < PA_DAYS; i++) {
    const vals = buckets[i] || [];
    if (!vals.length) { result.push(null); continue; }
    if (aggFn === 'avg') result.push(vals.reduce((a, b) => a + b, 0) / vals.length);
    else if (aggFn === 'max') result.push(Math.max(...vals));
    else if (aggFn === 'min') result.push(Math.min(...vals));
  }
  return result;
}

// Fill nulls with linear interpolation for ML (use last-seen for gaps)
function paFillNulls(arr) {
  const filled = [...arr];
  let last = 0;
  for (let i = 0; i < filled.length; i++) {
    if (filled[i] !== null) { last = filled[i]; }
    else { filled[i] = last; }
  }
  return filled;
}

/* ── Analysis ── */

function paAnalyzeDevice(deviceId, raw) {
  const dev = S.devices[deviceId] || {};
  const name = deviceName(dev);
  const predictions = [];

  // Helper: push prediction
  const push = (type, title, desc, severity, conf, vals, unit, threshold, daysTo, autofix) => {
    predictions.push({ type, title, desc, severity, conf: Math.max(1, Math.min(99, conf)), vals, unit, threshold, daysTo, autofix });
  };

  // ── 1. CPU overload trend ──────────────────────────────────────────────────
  const cpuRows = raw['device-info'] || [];
  const cpuDaily = paFillNulls(paBinByDay(cpuRows, 'timeMs', 'cpu_load', 'avg'));
  if (cpuDaily.length >= 5) {
    const smooth = paEMA(cpuDaily);
    const reg = paLinReg(smooth);
    const ani = paAnomalyScores(cpuDaily);
    const aniFreq = ani.filter(s => s > 0.5).length / ani.length;
    const last = smooth[smooth.length - 1];
    const daysTo90 = paDaysTo(reg, smooth.length - 1, 90);
    if (last > 70 || (reg.slope > 1.5 && reg.r2 > 0.4)) {
      const sev = last > 85 || daysTo90 < 7 ? 'critical' : 'warning';
      const conf = paConf(reg.r2, aniFreq, daysTo90);
      if (conf > 20) push('cpu_overload',
        `CPU-Überlastung: ${name}`,
        daysTo90 < Infinity ? `Trend: 90 % in ~${Math.round(daysTo90)} Tagen erreicht (aktuell ${Math.round(last)} %)` : `Aktuell ${Math.round(last)} % – Anomaliefrequenz erhöht`,
        sev, conf, cpuDaily, '%', 90, daysTo90, ['Prozesse prüfen', 'Firmware-Update', 'Gerät neustarten']);
    }
  }

  // ── 2. Memory leak ────────────────────────────────────────────────────────
  // Compute utilization % from totalMemoryKb + freeMemoryKb
  const memComputedRows = cpuRows.map(r => {
    const total = r.totalMemoryKb || 0;
    const free  = r.freeMemoryKb  || 0;
    return { ...r, _memUtil: total > 0 ? Math.round((1 - free / total) * 100) : 0 };
  });
  const memDaily = paFillNulls(paBinByDay(memComputedRows, 'timeMs', '_memUtil', 'avg'));
  if (memDaily.length >= 5) {
    const smooth = paEMA(memDaily);
    const reg = paLinReg(smooth);
    const last = smooth[smooth.length - 1];
    const daysTo95 = paDaysTo(reg, smooth.length - 1, 95);
    if (reg.slope > 0.5 && reg.r2 > 0.45 && last > 60) {
      const sev = daysTo95 < 14 ? 'critical' : 'warning';
      const conf = paConf(reg.r2, 0, daysTo95);
      if (conf > 20) push('memory_leak',
        `Memory-Leak-Verdacht: ${name}`,
        `RAM-Auslastung steigt monoton (${Math.round(reg.slope * 10) / 10}%/Tag). 95 % in ~${isFinite(daysTo95) ? Math.round(daysTo95) : '>30'} Tagen.`,
        sev, conf, memDaily, '%', 95, daysTo95, ['Gerät neustarten', 'Firmware-Update', 'Prozess-Diagnose via LCOS']);
    }
  }

  // ── 3. Overheating ────────────────────────────────────────────────────────
  const tempDaily = paFillNulls(paBinByDay(cpuRows, 'timeMs', 'temperature', 'max'));
  if (tempDaily.some(v => v > 0)) {
    const reg = paLinReg(paEMA(tempDaily));
    const last = tempDaily.filter(v => v > 0).slice(-1)[0] || 0;
    const daysTo75 = paDaysTo(reg, tempDaily.length - 1, 75);
    if (last > 60 || (reg.slope > 0.3 && reg.r2 > 0.4)) {
      const sev = last > 70 ? 'critical' : 'warning';
      const conf = paConf(reg.r2, 0, daysTo75);
      if (conf > 15) push('overheating',
        `Überhitzung: ${name}`,
        `Temperatur: ${Math.round(last)} °C${isFinite(daysTo75) ? ` – 75 °C in ~${Math.round(daysTo75)} Tagen` : ''}`,
        sev, conf, tempDaily, '°C', 75, daysTo75, ['Belüftung prüfen', 'Montageort optimieren', 'Hardware-Check']);
    }
  }

  // ── 4. Port flapping (LAN-Interface) ─────────────────────────────────────
  const lanRows = raw['lan-interface'] || [];
  const portMap = {};
  lanRows.forEach(r => {
    const p = r.name || 'unk';
    if (!portMap[p]) portMap[p] = [];
    portMap[p].push(r);
  });
  Object.entries(portMap).forEach(([port, rows]) => {
    if (rows.length < 10) return;
    // Count state changes (active flips)
    let flaps = 0;
    let prev = rows[0].active;
    rows.forEach(r => { if (r.active !== prev) { flaps++; prev = r.active; } });
    const flapsPerDay = flaps / PA_DAYS;
    if (flapsPerDay > 0.5) {
      const sev = flapsPerDay > 2 ? 'critical' : 'warning';
      const conf = Math.min(90, 30 + Math.round(flapsPerDay * 15));
      const daysTo = flapsPerDay > 3 ? 2 : 7;
      push('port_flapping',
        `Port-Flapping: ${name} – ${port}`,
        `Port ${port} schaltete ${flaps}× in ${PA_DAYS} Tagen (${Math.round(flapsPerDay * 10) / 10}×/Tag). Ausfall in ~${daysTo} Tagen möglich.`,
        sev, conf, [], 'Flaps/Tag', 2, daysTo, ['Kabel tauschen', 'SFP prüfen', 'PoE-Reset', 'Port deaktivieren & aktivieren']);
    }
  });

  // ── 5. VPN instability ────────────────────────────────────────────────────
  const vpnRows = raw['vpn-connection'] || [];
  const vpnLoss  = paFillNulls(paBinByDay(vpnRows, 'timeMs', 'packetLossPercent', 'avg'));
  const vpnRtt   = paFillNulls(paBinByDay(vpnRows, 'timeMs', 'rttAvgUs', 'avg'));
  if (vpnLoss.some(v => v > 0)) {
    const reg = paLinReg(paEMA(vpnLoss));
    const ani = paAnomalyScores(vpnLoss);
    const aniFreq = ani.filter(s => s > 0.5).length / ani.length;
    const last = vpnLoss.filter(v => v > 0).slice(-1)[0] || 0;
    if (last > 3 || (reg.slope > 0.1 && reg.r2 > 0.35)) {
      const sev = last > 8 ? 'critical' : 'warning';
      const daysTo = paDaysTo(reg, vpnLoss.length - 1, 15);
      const conf = paConf(reg.r2, aniFreq, daysTo);
      if (conf > 15) push('vpn_instability',
        `VPN-Instabilität: ${name}`,
        `Paketverlust ${Math.round(last * 10) / 10} %${isFinite(daysTo) ? `, 15 % in ~${Math.round(daysTo)} Tagen` : ''}. RTT ⌀ ${Math.round((vpnRtt.filter(v=>v>0).slice(-1)[0]||0)/1000)} ms.`,
        sev, conf, vpnLoss, '%', 15, daysTo, ['WAN-Interface prüfen', 'MTU anpassen', 'ISP-Ticket', 'Backup-VPN aktivieren']);
    }
  }

  // ── 6. WAN signal degradation ─────────────────────────────────────────────
  const wanRows = raw['wan-interface'] || [];
  const sigDaily = paFillNulls(paBinByDay(wanRows, 'timeMs', 'mobileModemSignalDecibelMw', 'avg'));
  if (sigDaily.some(v => v < -50)) {
    const smooth = paEMA(sigDaily.map(v => v || 0));
    const reg = paLinReg(smooth);
    const last = smooth[smooth.length - 1];
    if (reg.slope < -0.2 && reg.r2 > 0.35 && last < -70) {
      const daysToLost = paDaysTo(reg, smooth.length - 1, -95);
      const conf = paConf(reg.r2, 0, daysToLost);
      if (conf > 15) push('wan_signal',
        `LTE-Signal-Abbau: ${name}`,
        `Signalpegel ${Math.round(last)} dBm und sinkend. Verbindungsabbruch in ~${isFinite(daysToLost) ? Math.round(daysToLost) : '>30'} Tagen.`,
        'warning', conf, sigDaily, 'dBm', -95, daysToLost, ['Antenne ausrichten', 'Antennen-Upgrade', 'SIM-Karte wechseln']);
    }
  }

  // ── 7. WLAN capacity saturation ───────────────────────────────────────────
  // Sum clientCount across all radios per day
  const wlanRows = raw['wlan-interface'] || [];
  const wlanVals = paFillNulls(paBinByDay(wlanRows, 'timeMs', 'clientCount', 'avg'));
  if (wlanVals.length >= 5) {
    const reg = paLinReg(paEMA(wlanVals));
    const last = wlanVals[wlanVals.length - 1];
    const daysTo40 = paDaysTo(reg, wlanVals.length - 1, LC_AP_MAX_CLIENTS);
    if (last > 20 || (reg.slope > 0.3 && reg.r2 > 0.35)) {
      const sev = last > 35 || daysTo40 < 14 ? 'critical' : 'warning';
      const conf = paConf(reg.r2, 0, daysTo40);
      if (conf > 20) push('wlan_capacity',
        `WLAN-Sättigung: ${name}`,
        `${Math.round(last)} Clients aktuell. Kapazitätsgrenze (${LC_AP_MAX_CLIENTS}) in ~${isFinite(daysTo40) ? Math.round(daysTo40) : '>30'} Tagen.`,
        sev, conf, wlanVals, 'Clients', LC_AP_MAX_CLIENTS, daysTo40, ['AP hinzufügen', 'Band Steering aktivieren', 'TX-Power optimieren']);
    }
  }

  // ── Collect current telemetry snapshot ────────────────────────────────────
  const lastPos = arr => arr.filter(v => v !== null && !isNaN(v) && v > 0).slice(-1)[0] ?? null;
  // Latest raw values directly from last device-info row
  const lastDevRow = cpuRows.slice(-1)[0] || {};
  const rawCpu  = lastDevRow.cpuLoadPercent != null ? Math.round(lastDevRow.cpuLoadPercent) : (cpuDaily.length ? Math.round(paEMA(cpuDaily).slice(-1)[0]) : null);
  const rawTotal = lastDevRow.totalMemoryKb || 0;
  const rawFree  = lastDevRow.freeMemoryKb  || 0;
  const rawMem   = rawTotal > 0 ? Math.round((1 - rawFree / rawTotal) * 100) : (memDaily.length ? Math.round(paEMA(memDaily).slice(-1)[0]) : null);
  const rawTemp  = lastDevRow.temperature   != null ? Math.round(lastDevRow.temperature) : lastPos(tempDaily);
  const currentVals = {
    cpu:         rawCpu,
    mem:         rawMem,
    temp:        rawTemp != null ? Math.round(rawTemp) : null,
    vpnLoss:     vpnLoss.some(v => v > 0) ? Math.round(vpnLoss.filter(v=>v>0).slice(-1)[0] * 10) / 10 : null,
    vpnRtt:      vpnRtt.some(v => v > 0)  ? Math.round(vpnRtt.filter(v=>v>0).slice(-1)[0] / 1000)      : null,
    wanSignal:   sigDaily.some(v => v < -10) ? Math.round(sigDaily.filter(v=>v<-10).slice(-1)[0])       : null,
    wlanClients: wlanVals.length ? Math.round(wlanVals.filter(v=>v!==null).slice(-1)[0] ?? 0) : null,
    ports: Object.entries(portMap).map(([pname, prows]) => {
      let flaps = 0, prev = prows[0]?.active;
      prows.forEach(r => { if (r.active !== prev) { flaps++; prev = r.active; } });
      return { name: pname, active: !!(prows[prows.length - 1]?.active), flapsTotal: flaps };
    })
  };
  return { predictions, currentVals };
}

/* ── SVG Sparkline ── */

function paSparkSvg(vals, sev, threshold) {
  const w = 120, h = 36, pad = 4;
  const clean = vals.filter(v => v !== null && !isNaN(v));
  if (clean.length < 2) return '<svg width="120" height="36"></svg>';
  const mn = Math.min(...clean), mx = Math.max(...clean, threshold || 0);
  const rng = mx - mn || 1;
  const sx = i => pad + (i / (vals.length - 1)) * (w - 2 * pad);
  const sy = v => pad + (1 - (v - mn) / rng) * (h - 2 * pad);
  const pts = vals.map((v, i) => [sx(i), sy(v !== null ? v : mn)]);
  const polyline = pts.map(([x, y]) => `${x.toFixed(1)},${y.toFixed(1)}`).join(' ');
  const col = sev === 'critical' ? '#ff004d' : '#2d5fff';
  let thLine = '';
  if (threshold !== undefined) {
    const ty = sy(threshold).toFixed(1);
    thLine = `<line x1="${pad}" y1="${ty}" x2="${w-pad}" y2="${ty}" stroke="rgba(255,255,255,.25)" stroke-width="1" stroke-dasharray="3,3"/>`;
  }
  return `<svg width="${w}" height="${h}" style="display:block"><polyline points="${polyline}" fill="none" stroke="${col}" stroke-width="1.8" stroke-linejoin="round"/>${thLine}</svg>`;
}

function paRenderCurrentVals(cv) {
  if (!cv) return '<em style="color:var(--text3);font-size:12px">Keine Messdaten verfügbar.</em>';
  const chip = (col, icon, text) => {
    const bg  = col==='r' ? 'rgba(255,0,77,.12)'    : col==='a' ? 'rgba(45,95,255,.1)'   : 'rgba(160,237,58,.1)';
    const bdr = col==='r' ? 'rgba(255,0,77,.3)'     : col==='a' ? 'rgba(45,95,255,.3)'   : 'rgba(160,237,58,.25)';
    const clr = col==='r' ? '#ff004d'               : col==='a' ? '#2d5fff'              : '#a0ed3a';
    return `<span style="display:inline-flex;align-items:center;gap:4px;padding:3px 9px;border-radius:6px;font-size:11.5px;font-weight:600;background:${bg};border:1px solid ${bdr};color:${clr}"><i class="fa-solid fa-${icon}" style="font-size:10px;opacity:.8"></i>${text}</span>`;
  };
  const chips = [];
  if (cv.cpu         !== null) chips.push(chip(cv.cpu  >= 70 ? 'r' : cv.cpu  >= 50 ? 'a' : 'g', 'microchip',        `CPU: ${cv.cpu} %`));
  if (cv.mem         !== null) chips.push(chip(cv.mem  >= 75 ? 'r' : cv.mem  >= 60 ? 'a' : 'g', 'memory',           `RAM: ${cv.mem} %`));
  if (cv.temp        !== null) chips.push(chip(cv.temp >= 65 ? 'r' : cv.temp >= 50 ? 'a' : 'g', 'temperature-half', `Temp: ${cv.temp} °C`));
  if (cv.vpnLoss     !== null) chips.push(chip(cv.vpnLoss >= 5 ? 'r' : cv.vpnLoss >= 2 ? 'a' : 'g', 'shield-halved', `VPN-Verlust: ${cv.vpnLoss} %`));
  if (cv.vpnRtt      !== null) chips.push(chip(cv.vpnRtt  >= 100 ? 'r' : cv.vpnRtt  >= 50 ? 'a' : 'g', 'clock',     `VPN-RTT: ${cv.vpnRtt} ms`));
  if (cv.wanSignal   !== null) chips.push(chip(cv.wanSignal <= -80 ? 'r' : cv.wanSignal <= -70 ? 'a' : 'g', 'signal', `LTE: ${cv.wanSignal} dBm`));
  if (cv.wlanClients !== null) chips.push(chip(cv.wlanClients >= 30 ? 'r' : cv.wlanClients >= 20 ? 'a' : 'g', 'wifi', `WLAN: ${cv.wlanClients} Clients`));
  if (cv.ports?.length) {
    const active = cv.ports.filter(p => p.active).length;
    chips.push(chip(active < cv.ports.length * 0.5 ? 'a' : 'g', 'ethernet', `Ports: ${active}/${cv.ports.length} aktiv`));
    cv.ports.filter(p => p.flapsTotal > 0).forEach(p => {
      const fpd = Math.round(p.flapsTotal / PA_DAYS * 10) / 10;
      chips.push(chip(fpd > 2 ? 'r' : 'a', 'bolt', `${p.name}: ${fpd}×/Tag`));
    });
  }
  if (!chips.length) return '<em style="color:var(--text3);font-size:12px">Keine Messdaten in 30 Tagen.</em>';
  return chips.join('');
}

/* ── Progress & Rendering ── */

function paToggleDetail(id) {
  const el = document.getElementById(`pa-detail-${id}`);
  if (el) el.style.display = el.style.display === 'none' ? 'block' : 'none';
}

async function paLoadAll() {
  if (!S.accountId || !Object.keys(S.devices).length) return;
  paState.loading = true;
  paState.loaded  = false;
  paState.results = {};
  const ids = Object.keys(S.devices).filter(id => isOnline(S.devices[id]));
  paState.progress = { total: ids.length, done: 0, current: '' };
  renderAnomalyPage();

  // Process in batches of 3
  const batchSize = 3;
  for (let i = 0; i < ids.length; i += batchSize) {
    const batch = ids.slice(i, i + batchSize);
    await Promise.allSettled(batch.map(async id => {
      paState.progress.current = deviceName(S.devices[id]);
      try {
        const raw = await paFetchDevice(id);
        const { predictions: preds, currentVals } = paAnalyzeDevice(id, raw);
        paState.results[id] = { predictions: preds, riskScore: paRiskScore(preds), currentVals };
      } catch { paState.results[id] = { predictions: [], riskScore: 0, currentVals: null }; }
      paState.progress.done++;
    }));
    // Update progress bar
    const wrap = document.getElementById('pa-wrap');
    const pb = wrap?.querySelector('.pa-progress-bar');
    if (pb) { pb.style.width = `${Math.round(paState.progress.done / paState.progress.total * 100)}%`; }
    const pl = wrap?.querySelector('.pa-progress-label');
    if (pl) pl.textContent = `Analysiere ${paState.progress.current}… (${paState.progress.done}/${paState.progress.total})`;
  }
  paState.loading = false;
  paState.loaded  = true;
  paState.lastRun = new Date();
  const lr = document.getElementById('pa-last-run');
  if (lr) lr.textContent = 'Letzte Analyse: ' + paState.lastRun.toLocaleTimeString('de-DE');
  renderAnomalyPage();
}

function renderAnomalyPage() {
  const wrap = document.getElementById('pa-wrap');
  if (!wrap) return;

  // No devices loaded yet
  if (!Object.keys(S.devices).length) {
    wrap.innerHTML = `<div class="empty-state"><i class="fa-solid fa-brain"></i><h3>Keine Geräte geladen</h3><p>Zuerst oben verbinden und Gerätedaten laden.</p></div>`;
    return;
  }

  // Not yet started → show start button
  if (!paState.loaded && !paState.loading) {
    wrap.innerHTML = `
      <div class="empty-state">
        <i class="fa-solid fa-brain" style="color:#2d5fff"></i>
        <h3>30-Tage Telemetry-Analyse</h3>
        <p>Analysiert CPU, RAM, Temperatur, Port-Flapping, VPN, WAN-Signal und WLAN-Kapazität<br>
        für ${Object.values(S.devices).filter(d=>isOnline(d)).length} online Geräte (von ${Object.keys(S.devices).length} gesamt) mit 3 ML-Modellen.</p>
        <div style="margin-top:16px;display:flex;gap:10px;justify-content:center;flex-wrap:wrap">
          <div class="pa-model-row"><span class="pa-model-badge">EMA</span> Exponential Moving Average</div>
          <div class="pa-model-row"><span class="pa-model-badge" style="background:rgba(119,200,210,.15);color:#77c8d2">LinReg</span> Linear Regression</div>
          <div class="pa-model-row"><span class="pa-model-badge" style="background:rgba(255,0,77,.15);color:#ff004d">IsoForest</span> Isolation Forest (Z-Score)</div>
        </div>
        <button onclick="paLoadAll()" style="margin-top:20px;background:linear-gradient(135deg,#001d41,#2d5fff);border:none;border-radius:10px;color:#fff;font-size:14px;font-weight:700;padding:12px 28px;cursor:pointer;display:inline-flex;align-items:center;gap:8px">
          <i class="fa-solid fa-play"></i> Analyse starten
        </button>
      </div>`;
    return;
  }

  // Loading / Progress
  if (paState.loading) {
    const pct = paState.progress.total ? Math.round(paState.progress.done / paState.progress.total * 100) : 0;
    wrap.innerHTML = `
      <div style="max-width:500px;margin:60px auto;text-align:center">
        <i class="fa-solid fa-brain fa-spin" style="font-size:40px;color:#2d5fff;margin-bottom:20px"></i>
        <h3 style="color:var(--text);margin-bottom:12px">Telemetry wird analysiert…</h3>
        <div style="background:var(--border);border-radius:8px;height:10px;overflow:hidden;margin-bottom:12px">
          <div class="pa-progress-bar" style="height:100%;width:${pct}%;background:linear-gradient(90deg,#001d41,#2d5fff);transition:width .3s"></div>
        </div>
        <p class="pa-progress-label" style="color:var(--text2);font-size:13px">Analysiere… (${paState.progress.done}/${paState.progress.total})</p>
      </div>`;
    return;
  }

  // Results
  const allPreds = [];
  const deviceScores = Object.entries(paState.results)
    .map(([id, r]) => ({ id, dev: S.devices[id], score: r.riskScore, preds: r.predictions, cv: r.currentVals || null }))
    .sort((a, b) => b.score - a.score);

  deviceScores.forEach(d => d.preds.forEach(p => allPreds.push({ ...p, deviceId: d.id, deviceName: deviceName(d.dev || {}) })));

  const critical = allPreds.filter(p => p.severity === 'critical');
  const warnings = allPreds.filter(p => p.severity === 'warning');
  const devWithRisk = deviceScores.filter(d => d.score > 0).length;
  const avgRisk = deviceScores.length ? Math.round(deviceScores.reduce((a, d) => a + d.score, 0) / deviceScores.length) : 0;

  // Update sidebar badge
  const badge = document.getElementById('badge-anomaly');
  if (badge) badge.textContent = (critical.length + warnings.length) || '–';

  // 48h predictions (high-confidence, short timeframe)
  const next48h = allPreds.filter(p => p.daysTo !== undefined && p.daysTo < 3 && p.conf > 40)
    .sort((a, b) => a.daysTo - b.daysTo).slice(0, 5);

  let html = `
    <!-- KPI Row -->
    <div class="pa-kpi-row">
      <div class="pa-kpi">
        <div class="pa-kpi-icon pki-red"><i class="fa-solid fa-triangle-exclamation"></i></div>
        <div class="pa-kpi-val">${critical.length}</div>
        <div class="pa-kpi-lbl">Kritische Anomalien</div>
      </div>
      <div class="pa-kpi">
        <div class="pa-kpi-icon pki-amber"><i class="fa-solid fa-circle-exclamation"></i></div>
        <div class="pa-kpi-val">${warnings.length}</div>
        <div class="pa-kpi-lbl">Warnungen</div>
      </div>
      <div class="pa-kpi">
        <div class="pa-kpi-icon pki-blue"><i class="fa-solid fa-server"></i></div>
        <div class="pa-kpi-val">${devWithRisk}</div>
        <div class="pa-kpi-lbl">Geräte mit Risiko</div>
      </div>
      <div class="pa-kpi">
        <div class="pa-kpi-icon pki-green"><i class="fa-solid fa-gauge-high"></i></div>
        <div class="pa-kpi-val">${avgRisk}</div>
        <div class="pa-kpi-lbl">Ø Risk-Score</div>
      </div>
    </div>

    <!-- Analysetypen Info-Panel -->
    <details style="background:var(--card);border:1px solid var(--border);border-radius:10px;overflow:hidden;margin-bottom:4px;">
      <summary style="padding:11px 16px;cursor:pointer;font-size:12px;font-weight:700;color:var(--text2);display:flex;align-items:center;gap:8px;list-style:none;user-select:none;">
        <i class="fa-solid fa-circle-info" style="color:#2d5fff"></i>
        Analysetypen &amp; Erkennungsschwellenwerte
        <i class="fa-solid fa-chevron-down" style="margin-left:auto;font-size:10px;opacity:.5"></i>
      </summary>
      <div style="padding:0 16px 14px;display:grid;grid-template-columns:repeat(auto-fill,minmax(260px,1fr));gap:8px;margin-top:4px;">
        <div style="background:var(--bg2);border-radius:8px;padding:10px 12px;font-size:11.5px;">
          <div style="font-weight:700;margin-bottom:6px;display:flex;align-items:center;gap:6px;color:var(--text)">
            <i class="fa-solid fa-microchip" style="color:#ff004d"></i> CPU-Überlastung
          </div>
          <div style="color:var(--text2);line-height:1.8">
            <span class="pa-conf-badge" style="background:rgba(255,0,77,.15);color:#ff004d">Kritisch</span> Last &gt; <strong style="color:var(--text)">85 %</strong> oder Trend → 90 % in &lt; 7 Tagen<br>
            <span class="pa-conf-badge" style="background:rgba(45,95,255,.1);color:#2d5fff">Warnung</span> Last &gt; <strong style="color:var(--text)">70 %</strong> oder Trend steigend (R² &gt; 0.4)<br>
            <span style="opacity:.5;font-size:11px">Quelle: records/device_info · cpu_load</span>
          </div>
        </div>
        <div style="background:var(--bg2);border-radius:8px;padding:10px 12px;font-size:11.5px;">
          <div style="font-weight:700;margin-bottom:6px;display:flex;align-items:center;gap:6px;color:var(--text)">
            <i class="fa-solid fa-memory" style="color:#ff004d"></i> Memory-Leak
          </div>
          <div style="color:var(--text2);line-height:1.8">
            <span class="pa-conf-badge" style="background:rgba(255,0,77,.15);color:#ff004d">Kritisch</span> Monotoner Anstieg → 95 % in &lt; 14 Tagen<br>
            <span class="pa-conf-badge" style="background:rgba(45,95,255,.1);color:#2d5fff">Warnung</span> Slope &gt; 0.5 %/Tag &amp; RAM &gt; <strong style="color:var(--text)">60 %</strong> &amp; R² &gt; 0.45<br>
            <span style="opacity:.5;font-size:11px">Quelle: records/device_info · (total_memory − free_memory) / total_memory</span>
          </div>
        </div>
        <div style="background:var(--bg2);border-radius:8px;padding:10px 12px;font-size:11.5px;">
          <div style="font-weight:700;margin-bottom:6px;display:flex;align-items:center;gap:6px;color:var(--text)">
            <i class="fa-solid fa-temperature-half" style="color:#ff004d"></i> Überhitzung
          </div>
          <div style="color:var(--text2);line-height:1.8">
            <span class="pa-conf-badge" style="background:rgba(255,0,77,.15);color:#ff004d">Kritisch</span> Temperatur &gt; <strong style="color:var(--text)">70 °C</strong><br>
            <span class="pa-conf-badge" style="background:rgba(45,95,255,.1);color:#2d5fff">Warnung</span> &gt; <strong style="color:var(--text)">60 °C</strong> oder Trend steigend → 75 °C<br>
            <span style="opacity:.5;font-size:11px">Quelle: records/device_info · temperature</span>
          </div>
        </div>
        <div style="background:var(--bg2);border-radius:8px;padding:10px 12px;font-size:11.5px;">
          <div style="font-weight:700;margin-bottom:6px;display:flex;align-items:center;gap:6px;color:var(--text)">
            <i class="fa-solid fa-ethernet" style="color:#2d5fff"></i> Port-Flapping
          </div>
          <div style="color:var(--text2);line-height:1.8">
            <span class="pa-conf-badge" style="background:rgba(255,0,77,.15);color:#ff004d">Kritisch</span> &gt; <strong style="color:var(--text)">2 Flaps/Tag</strong> (Link up/down)<br>
            <span class="pa-conf-badge" style="background:rgba(45,95,255,.1);color:#2d5fff">Warnung</span> &gt; <strong style="color:var(--text)">0.5 Flaps/Tag</strong> in 30 Tagen<br>
            <span style="opacity:.5;font-size:11px">Quelle: lan-interface · active (Zustandswechsel)</span>
          </div>
        </div>
        <div style="background:var(--bg2);border-radius:8px;padding:10px 12px;font-size:11.5px;">
          <div style="font-weight:700;margin-bottom:6px;display:flex;align-items:center;gap:6px;color:var(--text)">
            <i class="fa-solid fa-shield-halved" style="color:#2d5fff"></i> VPN-Instabilität
          </div>
          <div style="color:var(--text2);line-height:1.8">
            <span class="pa-conf-badge" style="background:rgba(255,0,77,.15);color:#ff004d">Kritisch</span> Paketverlust &gt; <strong style="color:var(--text)">8 %</strong><br>
            <span class="pa-conf-badge" style="background:rgba(45,95,255,.1);color:#2d5fff">Warnung</span> Paketverlust &gt; <strong style="color:var(--text)">3 %</strong> oder Trend → 15 %<br>
            <span style="opacity:.5;font-size:11px">Quelle: vpn-connection · packetLossPercent, rttAvgUs</span>
          </div>
        </div>
        <div style="background:var(--bg2);border-radius:8px;padding:10px 12px;font-size:11.5px;">
          <div style="font-weight:700;margin-bottom:6px;display:flex;align-items:center;gap:6px;color:var(--text)">
            <i class="fa-solid fa-signal" style="color:#2d5fff"></i> LTE-Signal-Abbau
          </div>
          <div style="color:var(--text2);line-height:1.8">
            <span class="pa-conf-badge" style="background:rgba(45,95,255,.1);color:#2d5fff">Warnung</span> Signal &lt; <strong style="color:var(--text)">-70 dBm</strong> &amp; Slope &lt; -0.2 dBm/Tag<br>
            Trend-Grenzwert: <strong style="color:var(--text)">-95 dBm</strong> (Verbindungsabbruch)<br>
            <span style="opacity:.5;font-size:11px">Quelle: wan-interface · mobileModemSignalDecibelMw</span>
          </div>
        </div>
        <div style="background:var(--bg2);border-radius:8px;padding:10px 12px;font-size:11.5px;">
          <div style="font-weight:700;margin-bottom:6px;display:flex;align-items:center;gap:6px;color:var(--text)">
            <i class="fa-solid fa-wifi" style="color:var(--blue)"></i> WLAN-Sättigung
          </div>
          <div style="color:var(--text2);line-height:1.8">
            <span class="pa-conf-badge" style="background:rgba(255,0,77,.15);color:#ff004d">Kritisch</span> &gt; <strong style="color:var(--text)">35 Clients</strong> oder Trend → ${LC_AP_MAX_CLIENTS} in &lt; 14 Tagen<br>
            <span class="pa-conf-badge" style="background:rgba(45,95,255,.1);color:#2d5fff">Warnung</span> &gt; <strong style="color:var(--text)">20 Clients</strong> oder Trend steigend (R² &gt; 0.35)<br>
            <span style="opacity:.5;font-size:11px">Quelle: wlan_info_json · stations (DAY1-Period)</span>
          </div>
        </div>
        <div style="background:var(--bg2);border-radius:8px;padding:10px 12px;font-size:11.5px;">
          <div style="font-weight:700;margin-bottom:6px;display:flex;align-items:center;gap:6px;color:var(--text)">
            <i class="fa-solid fa-brain" style="color:#2d5fff"></i> ML-Modelle &amp; Konfidenz
          </div>
          <div style="color:var(--text2);line-height:1.8">
            <span class="pa-model-badge">EMA</span> Glättung (α=0.3) · Rauschen reduzieren<br>
            <span class="pa-model-badge" style="background:rgba(119,200,210,.15);color:#77c8d2">LinReg</span> Trendstärke via R² (0–1)<br>
            <span class="pa-model-badge" style="background:rgba(255,0,77,.15);color:#ff004d">IsoForest</span> Z-Score Anomalie-Frequenz<br>
            <span style="opacity:.5;font-size:11px">Konfidenz = Trend×40% + Frequenz×35% + Dringlichkeit×25%</span>
          </div>
        </div>
      </div>
    </details>

    <!-- 48h Predictions -->
    ${next48h.length ? `
    <div class="pa-section-title"><i class="fa-solid fa-clock" style="color:#ff004d"></i> Vorhersagen nächste 48 Stunden</div>
    <div class="pa-alert-list">
      ${next48h.map(p => `
        <div class="pa-alert ${p.severity === 'critical' ? 'pa-alert-critical' : 'pa-alert-warning'}">
          <div class="pa-alert-icon ${p.severity === 'critical' ? 'pai-critical' : 'pai-warning'}">
            <i class="fa-solid fa-${p.severity === 'critical' ? 'skull' : 'bolt'}"></i>
          </div>
          <div class="pa-alert-body">
            <div class="pa-alert-title">${p.title}</div>
            <div class="pa-alert-desc">${p.desc}</div>
            <div class="pa-alert-meta">
              <span class="pa-model-badge">EMA+LinReg</span>
              <span class="pa-conf-badge" style="color:${p.conf>70?'#a0ed3a':p.conf>40?'#2d5fff':'var(--text3)'}">Konfidenz ${p.conf}%</span>
              <span style="color:var(--text3);font-size:11px">In ~${Math.round(p.daysTo * 24)} Stunden</span>
            </div>
            ${p.autofix?.length ? `<div class="pa-fixes">${p.autofix.map(f=>`<span class="pa-fix-chip"><i class="fa-solid fa-wrench"></i>${f}</span>`).join('')}</div>` : ''}
          </div>
        </div>`).join('')}
    </div>` : ''}

    <!-- Risk Table -->
    <div class="pa-section-title"><i class="fa-solid fa-table-cells" style="color:#2d5fff"></i> Geräte-Risikoübersicht</div>
    ${!deviceScores.filter(d => d.score > 0).length
      ? `<div style="padding:10px 14px;background:rgba(160,237,58,.07);border:1px solid rgba(160,237,58,.25);border-radius:8px;color:#a0ed3a;font-size:13px;display:flex;align-items:center;gap:8px;margin-bottom:10px"><i class="fa-solid fa-circle-check"></i> Keine Anomalien erkannt – alle Geräte im Normbereich.</div>`
      : ''}
    <table class="pa-risk-table">
      <thead><tr><th>Gerät</th><th>Standort</th><th>CPU</th><th>RAM</th><th>Temp</th><th>Risk-Score</th><th>Anomalien</th><th></th></tr></thead>
      <tbody>
      ${deviceScores.map(d => {
        const riskCol = d.score >= 60 ? '#ff004d' : d.score >= 30 ? '#2d5fff' : '#a0ed3a';
        const riskLabel = d.score >= 60 ? 'Kritisch' : d.score >= 30 ? 'Warnung' : 'OK';
        const devInfo = d.dev || {};
        const devLabel = devInfo.status?.name || devInfo.label || devInfo.name || devInfo.id?.substring(0,8) || '–';
        const cpu = d.cv?.cpu; const mem = d.cv?.mem; const temp = d.cv?.temp;
        const cpuCol  = cpu  >= 70 ? '#ff004d' : cpu  >= 50 ? '#2d5fff' : '#a0ed3a';
        const memCol  = mem  >= 75 ? '#ff004d' : mem  >= 60 ? '#2d5fff' : '#a0ed3a';
        const tempCol = temp >= 65 ? '#ff004d' : temp >= 50 ? '#2d5fff' : '#a0ed3a';
        return `<tr>
          <td style="font-weight:600;color:var(--text)">${devLabel}</td>
          <td style="color:var(--text2);font-size:12px">${devInfo.siteName || '–'}</td>
          <td style="font-size:12px;font-weight:700;color:${cpu  != null ? cpuCol  : 'var(--text3)'}">
            ${cpu  != null ? cpu  + ' %' : '–'}</td>
          <td style="font-size:12px;font-weight:700;color:${mem  != null ? memCol  : 'var(--text3)'}">
            ${mem  != null ? mem  + ' %' : '–'}</td>
          <td style="font-size:12px;font-weight:700;color:${temp != null ? tempCol : 'var(--text3)'}">
            ${temp != null ? temp + ' °C' : '–'}</td>
          <td>
            <div style="display:flex;align-items:center;gap:8px">
              <div style="flex:1;background:var(--border);border-radius:4px;height:6px;min-width:60px">
                <div style="width:${d.score}%;height:100%;background:${riskCol};border-radius:4px"></div>
              </div>
              <span style="color:${riskCol};font-weight:700;font-size:13px;min-width:24px">${d.score}</span>
              <span style="color:${riskCol};font-size:11px">${riskLabel}</span>
            </div>
          </td>
          <td>${d.preds.length ? d.preds.map(p => `<span style="font-size:11px;padding:2px 6px;border-radius:4px;margin-right:3px;background:${p.severity==='critical'?'rgba(255,0,77,.15)':'rgba(45,95,255,.1)'};color:${p.severity==='critical'?'#ff004d':'#2d5fff'}">${p.type.replace(/_/g,' ')}</span>`).join('') : '<span style="color:var(--text3);font-size:12px">–</span>'}</td>
          <td><button onclick="paToggleDetail('${d.id}')" style="background:rgba(255,255,255,.06);border:1px solid var(--border);border-radius:6px;color:var(--text2);font-size:12px;padding:4px 10px;cursor:pointer" title="Messwerte & Details"><i class="fa-solid fa-chevron-down"></i></button></td>
        </tr>
        <tr id="pa-detail-${d.id}" style="display:none"><td colspan="8" style="padding:0">
          <div class="pa-device-detail">
            <!-- Current values row -->
            <div style="padding:10px 14px 8px;border-bottom:${d.preds.length?'1px solid var(--border)':'none'}">
              <div style="font-size:11px;font-weight:700;color:var(--text3);text-transform:uppercase;letter-spacing:.05em;margin-bottom:7px"><i class="fa-solid fa-chart-simple"></i> Aktuelle Messwerte (30-Tage-Ø / letzter Wert)</div>
              <div style="display:flex;flex-wrap:wrap;gap:6px">${paRenderCurrentVals(d.cv)}</div>
            </div>
            <!-- Anomaly prediction cards -->
            ${d.preds.map(p => `
              <div class="pa-pred-card ${p.severity === 'critical' ? 'pa-pred-critical' : 'pa-pred-warning'}">
                <div class="pa-pred-header">
                  <span class="pa-pred-icon ${p.severity === 'critical' ? 'ppi-critical' : 'ppi-warning'}"><i class="fa-solid fa-${p.severity==='critical'?'triangle-exclamation':'circle-exclamation'}"></i></span>
                  <div>
                    <div class="pa-pred-title">${p.title}</div>
                    <div class="pa-pred-desc">${p.desc}</div>
                  </div>
                  <div style="display:flex;flex-direction:column;align-items:flex-end;gap:4px;margin-left:auto;flex-shrink:0">
                    ${p.vals?.length ? paSparkSvg(p.vals, p.severity, p.threshold) : ''}
                    <span class="pa-conf-badge">Konfidenz ${p.conf}%</span>
                  </div>
                </div>
                ${p.autofix?.length ? `<div class="pa-fixes">${p.autofix.map(f=>`<span class="pa-fix-chip"><i class="fa-solid fa-wrench"></i>${f}</span>`).join('')}</div>` : ''}
              </div>`).join('')}
          </div>
        </td></tr>`;
      }).join('')}
      </tbody>
    </table>
  `;

  wrap.innerHTML = html;
}

// ─── LIFECYCLE PLANNER ────────────────────────────────────────────────────────
const LC_AP_MAX_CLIENTS = 40;   // Max. WLAN-Clients pro AP (konservativ)
const LC_GROWTH_RATE    = 0.08; // Angenommenes Wachstum 8 %/Monat

let lcFilter = 'all';

function lcMonthsToFull(current, max) {
  if (current <= 0) return Infinity;
  if (current >= max) return 0;
  return Math.log(max / current) / Math.log(1 + LC_GROWTH_RATE);
}

function lcRiskBadge(months) {
  if (months <= 3)  return { cls:'lrm-critical', label: months <= 0 ? 'Jetzt kritisch' : `In ${Math.round(months)} Mon.` };
  if (months <= 7)  return { cls:'lrm-soon',     label: `In ~${Math.round(months)} Monaten` };
  if (months <= 12) return { cls:'lrm-medium',   label: `In ~${Math.round(months)} Monaten` };
  return null;
}

function lcSetFilter(f, btn) {
  lcFilter = f;
  document.querySelectorAll('.lc-filter-btn').forEach(b => b.classList.remove('active'));
  btn.classList.add('active');
  renderLifecycle();
}

function renderLifecycle() {
  const wrap = document.getElementById('lc-wrap');
  if (!wrap) return;
  const devs = Object.values(S.devices);
  if (!devs.length) {
    wrap.innerHTML = '<div class="empty-state"><i class="fa-solid fa-timeline"></i><h3>Keine Daten</h3><p>Zuerst Geräte laden.</p></div>';
    return;
  }

  // ── Jedes Gerät analysieren ───────────────────────────────────────
  const deviceRows = devs.map(d => {
    const risks  = [];
    const online = isOnline(d);
    const type   = energyDeviceType(d);

    // 1. Lifecycle-Status (EOL / EOS)
    const lcStat = (d.status?.lifecycle?.status || '').toUpperCase();
    if (/END.OF.LIFE|EOL/.test(lcStat)) {
      risks.push({
        icon:'fa-skull', icls:'lri-red', level:'critical', months:0,
        title:'End-of-Life erreicht',
        desc:'Kein Hersteller-Support mehr – Sicherheitslücken werden nicht mehr gepatcht.',
        upgrade:'Sofortiger Geräteersatz empfohlen – aktuelle LANCOM-Generation evaluieren.',
      });
    } else if (/END.OF.SALE|EOS|END.OF.SUPPORT/.test(lcStat)) {
      risks.push({
        icon:'fa-cart-flatbed', icls:'lri-amber', level:'soon', months:6,
        title:'End-of-Sale / End-of-Support',
        desc:'Gerät wird nicht mehr aktiv verkauft oder ist außerhalb des regulären Supports.',
        upgrade:'Nachfolgemodell evaluieren und Migrationstermin mittelfristig planen.',
      });
    }

    // 2. Firmware OBSOLETE
    if (d.firmwareState === 'OBSOLETE' && online) {
      risks.push({
        icon:'fa-microchip', icls:'lri-amber', level:'soon', months:3,
        title:'Firmware veraltet (OBSOLETE)',
        desc:'Veraltete Firmware: Sicherheitsrisiken, fehlende Bugfixes und Power-Management-Verbesserungen.',
        upgrade:'Firmware-Update sofort über LMC → Verwaltung → Firmware durchführen.',
      });
    }

    // 3. WLAN-Kapazität (nur APs)
    if (type === 'ap' && online) {
      const clients = S.wlanClients[d.id] || 0;
      const pct = clients / LC_AP_MAX_CLIENTS;
      if (pct >= 0.4) {
        const months = lcMonthsToFull(clients, LC_AP_MAX_CLIENTS);
        const level  = pct >= 0.8 ? 'critical' : pct >= 0.6 ? 'soon' : 'medium';
        const iCls   = pct >= 0.8 ? 'lri-red'  : pct >= 0.6 ? 'lri-amber' : 'lri-blue';
        risks.push({
          icon:'fa-wifi', icls:iCls, level, months, pct,
          title:`WLAN-Kapazität: ${clients}/${LC_AP_MAX_CLIENTS} Clients (${Math.round(pct*100)} %)`,
          desc: pct >= 0.8
            ? `AP nahezu ausgelastet – Verbindungsabbrüche und Performanceverlust können jederzeit auftreten.`
            : `Bei ${Math.round(LC_GROWTH_RATE*100)} % monatlichem Wachstum: Überlast in ~${Math.max(0,Math.round(months))} Monaten.`,
          upgrade:'Weiteren Access Point installieren oder Zellenplanung überarbeiten (TX-Power reduzieren, Clients auf 5/6 GHz steuern).',
        });
      }
    }

    // 4. VPN-Qualität (Paketverlust / Latenz)
    const devVpn = (S.vpnConnections||[]).filter(v => (v._deviceId||v.deviceId)===d.id && v.active);
    for (const vpn of devVpn) {
      const loss = parseFloat(vpn.packetLossPercent) || 0;
      const rtt  = parseFloat(vpn.rttAvgUs) || 0;
      const peer = vpn.peerName || vpn.networkName || '–';
      if (loss > 5) {
        risks.push({
          icon:'fa-shield-halved', icls:'lri-red', level:'critical', months:0,
          title:`VPN-Paketverlust kritisch: ${loss.toFixed(1)} %`,
          desc:`Tunnel „${peer}": Hoher Paketverlust – Verbindungsqualität gefährdet produktiven Betrieb.`,
          upgrade:'ISP-Leitungsqualität prüfen, MTU/MSS anpassen oder redundanten WAN-Anschluss ergänzen.',
        });
      } else if (loss > 2) {
        risks.push({
          icon:'fa-shield-halved', icls:'lri-amber', level:'soon', months:2,
          title:`VPN-Paketverlust erhöht: ${loss.toFixed(1)} %`,
          desc:`Tunnel „${peer}": Erhöhter Paketverlust – Trend beobachten, Ursache klären.`,
          upgrade:'WAN-Verbindungsqualität überwachen, QoS-Konfiguration und ISP-Vertrag prüfen.',
        });
      } else if (rtt > 100000) {
        risks.push({
          icon:'fa-network-wired', icls:'lri-blue', level:'medium', months:6,
          title:`VPN-Latenz hoch: ${(rtt/1000).toFixed(0)} ms`,
          desc:`Tunnel „${peer}": Hohe Latenz beeinträchtigt Echtzeitanwendungen (VoIP, Video, RDP).`,
          upgrade:'ISP-Wechsel prüfen oder QoS-Priorisierung für Echtzeit-Traffic einrichten.',
        });
      }
    }

    // 5. WAN: Mobile-Backup als primäre Leitung
    const devWan = (S.wanInterfaces||[]).filter(w => (w._deviceId||w.deviceId)===d.id);
    const primaryMobile = devWan.filter(w =>
      w.mobileModemSignalDecibelMw != null ||
      /mobile|lte|4g|5g|umts/i.test(w.connectionType||''));
    if (primaryMobile.length && online) {
      risks.push({
        icon:'fa-signal', icls:'lri-blue', level:'medium', months:12,
        title:`Mobiles WAN aktiv (${primaryMobile.length} Interface${primaryMobile.length>1?'s':''})`,
        desc:'LTE/5G-Verbindungen sind teurer, weniger stabil und haben höhere Latenz als kabelgebundene Anschlüsse.',
        upgrade:'Kabelgebundenen Anschluss (DSL/Glasfaser) als primäre Leitung evaluieren, Mobilfunk als Backup.',
      });
    }

    // 6. Aktive Alerts
    if (d.alerting?.hasAlert && online) {
      risks.push({
        icon:'fa-bell', icls:'lri-red', level:'critical', months:0,
        title:'Aktive Meldungen in LMC',
        desc:'Dieses Gerät hat aktive Alarme – mögliche Hardware-, Konfigurations- oder Verbindungsprobleme.',
        upgrade:'Meldungen unter Verwaltung → Alerts prüfen und beheben.',
      });
    }

    // Gesamt-Dringlichkeit
    let urgency = 'ok';
    if (risks.some(r => r.level==='critical')) urgency = 'critical';
    else if (risks.some(r => r.level==='soon'))   urgency = 'soon';
    else if (risks.some(r => r.level==='medium'))  urgency = 'medium';

    return { d, risks, urgency, online, type };
  });

  // ── Zähler ────────────────────────────────────────────────────────
  const nCritical = deviceRows.filter(r => r.urgency==='critical').length;
  const nSoon     = deviceRows.filter(r => r.urgency==='soon').length;
  const nMedium   = deviceRows.filter(r => r.urgency==='medium').length;
  const nOk       = deviceRows.filter(r => r.urgency==='ok').length;

  // Badge in Sidebar updaten
  const lcBadge = document.getElementById('badge-lifecycle');
  if (lcBadge) lcBadge.textContent = (nCritical + nSoon) || '–';

  // ── Filter anwenden ───────────────────────────────────────────────
  const urgOrder = {critical:0, soon:1, medium:2, ok:3};
  const filtered = deviceRows
    .filter(r => {
      if (lcFilter==='critical') return r.urgency==='critical';
      if (lcFilter==='soon')     return r.urgency==='critical' || r.urgency==='soon';
      if (lcFilter==='medium')   return r.urgency !== 'ok';
      return true;
    })
    .sort((a,b) => urgOrder[a.urgency]-urgOrder[b.urgency] || deviceName(a.d).localeCompare(deviceName(b.d)));

  // ── Rendern ───────────────────────────────────────────────────────
  wrap.innerHTML = `

    <!-- KPIs -->
    <div class="lc-kpi-row">
      <div class="lc-kpi">
        <div class="lc-kpi-icon lki-red"><i class="fa-solid fa-circle-exclamation"></i></div>
        <div class="lc-kpi-val" style="color:var(--red)">${nCritical}</div>
        <div class="lc-kpi-lbl">Sofort handeln</div>
      </div>
      <div class="lc-kpi">
        <div class="lc-kpi-icon lki-amber"><i class="fa-solid fa-triangle-exclamation"></i></div>
        <div class="lc-kpi-val" style="color:var(--amber)">${nSoon}</div>
        <div class="lc-kpi-lbl">≤ 6 Monate</div>
      </div>
      <div class="lc-kpi">
        <div class="lc-kpi-icon lki-blue"><i class="fa-solid fa-clock"></i></div>
        <div class="lc-kpi-val" style="color:var(--blue)">${nMedium}</div>
        <div class="lc-kpi-lbl">≤ 12 Monate</div>
      </div>
      <div class="lc-kpi">
        <div class="lc-kpi-icon lki-green"><i class="fa-solid fa-circle-check"></i></div>
        <div class="lc-kpi-val" style="color:var(--green)">${nOk}</div>
        <div class="lc-kpi-lbl">Kein Handlungsbedarf</div>
      </div>
    </div>

    <!-- Filter -->
    <div class="lc-filter-row">
      <button class="lc-filter-btn${lcFilter==='all'?' active':''}" onclick="lcSetFilter('all',this)">
        Alle <span class="lc-count-badge lcb-green">${deviceRows.length}</span>
      </button>
      <button class="lc-filter-btn${lcFilter==='critical'?' active':''}" onclick="lcSetFilter('critical',this)">
        Kritisch <span class="lc-count-badge lcb-red">${nCritical}</span>
      </button>
      <button class="lc-filter-btn${lcFilter==='soon'?' active':''}" onclick="lcSetFilter('soon',this)">
        ≤ 6 Monate <span class="lc-count-badge lcb-amber">${nSoon}</span>
      </button>
      <button class="lc-filter-btn${lcFilter==='medium'?' active':''}" onclick="lcSetFilter('medium',this)">
        ≤ 12 Monate <span class="lc-count-badge lcb-blue">${nMedium}</span>
      </button>
    </div>

    <!-- Kriterien-Info -->
    <details style="background:var(--card);border:1px solid var(--border);border-radius:10px;overflow:hidden;">
      <summary style="padding:11px 16px;cursor:pointer;font-size:12px;font-weight:700;color:var(--text2);display:flex;align-items:center;gap:8px;list-style:none;user-select:none;">
        <i class="fa-solid fa-circle-info" style="color:var(--accent2)"></i>
        Analysekriterien &amp; Schwellenwerte
        <i class="fa-solid fa-chevron-down" style="margin-left:auto;font-size:10px;opacity:.5"></i>
      </summary>
      <div style="padding:0 16px 14px;display:grid;grid-template-columns:repeat(auto-fill,minmax(260px,1fr));gap:8px;margin-top:4px;">
        <div style="background:var(--bg2);border-radius:8px;padding:10px 12px;font-size:11.5px;">
          <div style="font-weight:700;margin-bottom:6px;display:flex;align-items:center;gap:6px;color:var(--text)">
            <i class="fa-solid fa-skull" style="color:var(--red)"></i> Lifecycle-Status
          </div>
          <div style="color:var(--text2);line-height:1.8">
            <span class="lc-risk-months lrm-critical">Kritisch</span> Status <code style="font-size:10px;color:var(--accent2)">END_OF_LIFE</code><br>
            <span class="lc-risk-months lrm-soon">≤ 6 Mon.</span> Status <code style="font-size:10px;color:var(--accent2)">END_OF_SALE / END_OF_SUPPORT</code>
          </div>
        </div>
        <div style="background:var(--bg2);border-radius:8px;padding:10px 12px;font-size:11.5px;">
          <div style="font-weight:700;margin-bottom:6px;display:flex;align-items:center;gap:6px;color:var(--text)">
            <i class="fa-solid fa-microchip" style="color:var(--amber)"></i> Firmware
          </div>
          <div style="color:var(--text2);line-height:1.8">
            <span class="lc-risk-months lrm-soon">≤ 6 Mon.</span> <code style="font-size:10px;color:var(--accent2)">firmwareState = OBSOLETE</code><br>
            <span style="opacity:.4;font-size:11px">kein Risiko bei CURRENT</span>
          </div>
        </div>
        <div style="background:var(--bg2);border-radius:8px;padding:10px 12px;font-size:11.5px;">
          <div style="font-weight:700;margin-bottom:6px;display:flex;align-items:center;gap:6px;color:var(--text)">
            <i class="fa-solid fa-wifi" style="color:var(--blue)"></i> WLAN-Kapazität
          </div>
          <div style="color:var(--text2);line-height:1.8">
            Max. <strong style="color:var(--text)">${LC_AP_MAX_CLIENTS} Clients/AP</strong> · Wachstum <strong style="color:var(--text)">${Math.round(LC_GROWTH_RATE*100)} %/Mon.</strong><br>
            <span class="lc-risk-months lrm-critical">Kritisch</span> ≥ 80 % Auslastung (≥ ${Math.round(LC_AP_MAX_CLIENTS*0.8)} Clients)<br>
            <span class="lc-risk-months lrm-soon">≤ 6 Mon.</span> ≥ 60 % (≥ ${Math.round(LC_AP_MAX_CLIENTS*0.6)} Clients)<br>
            <span class="lc-risk-months lrm-medium">≤ 12 Mon.</span> ≥ 40 % (≥ ${Math.round(LC_AP_MAX_CLIENTS*0.4)} Clients)
          </div>
        </div>
        <div style="background:var(--bg2);border-radius:8px;padding:10px 12px;font-size:11.5px;">
          <div style="font-weight:700;margin-bottom:6px;display:flex;align-items:center;gap:6px;color:var(--text)">
            <i class="fa-solid fa-shield-halved" style="color:var(--red)"></i> VPN-Qualität
          </div>
          <div style="color:var(--text2);line-height:1.8">
            <span class="lc-risk-months lrm-critical">Kritisch</span> Paketverlust &gt; <strong style="color:var(--text)">5 %</strong><br>
            <span class="lc-risk-months lrm-soon">≤ 6 Mon.</span> Paketverlust &gt; <strong style="color:var(--text)">2 %</strong><br>
            <span class="lc-risk-months lrm-medium">≤ 12 Mon.</span> Latenz &gt; <strong style="color:var(--text)">100 ms</strong>
          </div>
        </div>
        <div style="background:var(--bg2);border-radius:8px;padding:10px 12px;font-size:11.5px;">
          <div style="font-weight:700;margin-bottom:6px;display:flex;align-items:center;gap:6px;color:var(--text)">
            <i class="fa-solid fa-signal" style="color:var(--blue)"></i> Mobiles WAN
          </div>
          <div style="color:var(--text2);line-height:1.8">
            <span class="lc-risk-months lrm-medium">≤ 12 Mon.</span> LTE/5G als aktive WAN-Verbindung<br>
            <span style="opacity:.4;font-size:11px">erkannt via mobileModemSignal oder connectionType</span>
          </div>
        </div>
        <div style="background:var(--bg2);border-radius:8px;padding:10px 12px;font-size:11.5px;">
          <div style="font-weight:700;margin-bottom:6px;display:flex;align-items:center;gap:6px;color:var(--text)">
            <i class="fa-solid fa-bell" style="color:var(--red)"></i> Aktive Alerts
          </div>
          <div style="color:var(--text2);line-height:1.8">
            <span class="lc-risk-months lrm-critical">Kritisch</span> <code style="font-size:10px;color:var(--accent2)">alerting.hasAlert = true</code><br>
            <span style="opacity:.4;font-size:11px">Details unter Verwaltung → Alerts</span>
          </div>
        </div>
      </div>
    </details>

    <!-- Gerätekarten -->
    <div class="lc-grid">
      ${filtered.length ? filtered.map(r => {
        const cardCls = r.urgency==='critical'?'lc-critical':r.urgency==='soon'?'lc-soon':'';
        const upgrades = [...new Set(r.risks.map(rx=>rx.upgrade).filter(Boolean))];
        return `<div class="lc-card ${cardCls}">
          <div class="lc-card-header">
            <div class="lc-card-name">${escHtml(deviceName(r.d))}</div>
            <div class="lc-card-meta">
              ${r.d.siteName?`<span><i class="fa-solid fa-location-dot" style="color:var(--accent);font-size:10px"></i> ${escHtml(r.d.siteName)}</span>`:''}
              ${energyTypeBadge(r.type)}
              ${r.online?'<span class="sdot sdot-green">Online</span>':'<span class="sdot sdot-red">Offline</span>'}
              ${r.d.status?.model?`<span style="color:var(--text3);font-family:monospace;font-size:10px">${escHtml(r.d.status.model)}</span>`:''}
            </div>
          </div>
          ${r.risks.length ? `
          <div class="lc-risks">
            ${r.risks.map(risk => {
              const badge = lcRiskBadge(risk.months);
              const barColor = risk.pct>=0.8?'var(--red)':risk.pct>=0.6?'var(--amber)':'var(--blue)';
              return `<div class="lc-risk">
                <div class="lc-risk-icon ${risk.icls}"><i class="fa-solid ${risk.icon}"></i></div>
                <div class="lc-risk-body">
                  <div class="lc-risk-title">${risk.title}</div>
                  <div class="lc-risk-desc">${risk.desc}</div>
                  ${risk.pct !== undefined ? `<div class="lc-cap-bar-wrap"><div class="lc-cap-bar" style="width:${Math.min(100,Math.round(risk.pct*100))}%;background:${barColor}"></div></div>` : ''}
                </div>
                ${badge ? `<div class="lc-risk-months ${badge.cls}">${badge.label}</div>` : ''}
              </div>`;
            }).join('')}
          </div>
          ${upgrades.length ? `<div class="lc-upgrade">
            <i class="fa-solid fa-lightbulb" style="color:var(--accent2)"></i>
            <strong>Empfehlung:</strong> ${escHtml(upgrades[0])}
            ${upgrades.slice(1).map(u=>`<br><i class="fa-solid fa-arrow-right" style="color:var(--accent2);margin-right:3px"></i>${escHtml(u)}`).join('')}
          </div>` : ''}
          ` : `<div class="lc-ok-state"><i class="fa-solid fa-circle-check"></i> Kein Handlungsbedarf</div>`}
        </div>`;
      }).join('')
      : `<div class="empty-state" style="grid-column:1/-1">
          <i class="fa-solid fa-circle-check" style="color:var(--green)"></i>
          <h3>Keine Geräte in dieser Kategorie</h3>
          <p>Wähle einen anderen Filter.</p>
        </div>`}
    </div>

    <div class="energy-note" style="text-align:center;padding-bottom:8px">
      Kapazitätsprognose: Max. ${LC_AP_MAX_CLIENTS} Clients/AP · Wachstumsannahme: ${Math.round(LC_GROWTH_RATE*100)} %/Monat.
      Lifecycle-Daten aus LANCOM LMC · VPN-Qualität und WLAN-Clients aus Live-Monitoring.
    </div>
  `;
}

// ─── ENERGIE / CO₂ DASHBOARD ──────────────────────────────────────────────────
// Schätzwerte Grundlast je Gerätetyp (Watt)
const ENERGY_BASE = { router: 18, ap: 12, switch: 9, other: 15 };
const CO2_PER_KWH = 400; // g CO₂/kWh (DE-Strommix ~2024)
const EUR_PER_KWH = 0.32; // €/kWh Standardwert

function saveEnergyPrice() {
  const v = document.getElementById('energy-price-input')?.value;
  if (v) localStorage.setItem('lmc_energy_price', v);
}
function loadEnergyPrice() {
  const saved = localStorage.getItem('lmc_energy_price');
  const el = document.getElementById('energy-price-input');
  if (saved && el) el.value = saved;
}

function energyDeviceType(d) {
  const m = (d.status?.model || d.label || d.name || '').toUpperCase();
  if (/\bW-\d|\bWAP\b|ACCESS.?POINT|\bAP\b|W\d{3,}/.test(m)) return 'ap';
  if (/\bGS-|\bGS\d|SWITCH|SW\d/.test(m)) return 'switch';
  if (/ROUTER|FIREWALL|GATEWAY|VPN|IAP-\d|R\d{3,}|FX\d|1[0-9]{3}|OAP/.test(m)) return 'router';
  // Fallback: Geräte ohne WLAN-Clients = Router, sonst AP
  if (S.wlanClients[d.id] > 0) return 'ap';
  return 'router';
}

function energyTypeBadge(type) {
  const map = {
    router: ['etb-router','fa-shield-halved','Router'],
    ap:     ['etb-ap',    'fa-wifi',         'Access Point'],
    switch: ['etb-switch','fa-diagram-project','Switch'],
    other:  ['etb-other', 'fa-microchip',    'Sonstige'],
  };
  const [cls, icon, label] = map[type] || map.other;
  return `<span class="energy-type-badge ${cls}"><i class="fa-solid ${icon}"></i>${label}</span>`;
}

function renderEnergy() {
  const wrap = document.getElementById('energy-wrap');
  if (!wrap) return;
  const devs = Object.values(S.devices);
  if (!devs.length) {
    wrap.innerHTML = '<div class="empty-state"><i class="fa-solid fa-leaf"></i><h3>Keine Daten</h3><p>Zuerst Geräte laden.</p></div>';
    return;
  }

  // ── PoE-Daten aus lldpNeighbors ──────────────────────────────────
  // S.lldpNeighbors enthält pro Port: { _deviceId, poePower, poeStatus }
  const poeByDevice = {};
  for (const port of (S.lldpNeighbors || [])) {
    const w = parseFloat(port.poePower) || 0;
    if (w > 0) {
      if (!poeByDevice[port._deviceId]) poeByDevice[port._deviceId] = 0;
      poeByDevice[port._deviceId] += w;
    }
  }

  // ── Pro Gerät: Typ + Leistung schätzen ────────────────────────────
  const deviceRows = devs.map(d => {
    const type     = energyDeviceType(d);
    const baseW    = ENERGY_BASE[type];
    const poeW     = poeByDevice[d.id] || 0;
    const totalW   = baseW + poeW;
    const online   = isOnline(d);
    return { d, type, baseW, poeW, totalW, online, site: d.siteName || '(kein Standort)' };
  });

  // ── Gesamtwerte ───────────────────────────────────────────────────
  const totalW    = deviceRows.reduce((s,r) => s + (r.online ? r.totalW : 0), 0);
  const totalPoeW = deviceRows.reduce((s,r) => s + (r.online ? r.poeW  : 0), 0);
  const totalPoeCount = (S.lldpNeighbors||[]).filter(p => (parseFloat(p.poePower)||0) > 0).length;
  const eurPerKwh = parseFloat(document.getElementById('energy-price-input')?.value) || EUR_PER_KWH;
  const co2PerDay = (totalW * 24 / 1000) * CO2_PER_KWH;       // g
  const costMonth = (totalW * 24 * 30 / 1000) * eurPerKwh;    // €

  // ── Per-Standort ──────────────────────────────────────────────────
  const siteMap = {};
  for (const r of deviceRows) {
    if (!siteMap[r.site]) siteMap[r.site] = { name:r.site, rows:[] };
    siteMap[r.site].rows.push(r);
  }
  const sites = Object.values(siteMap).sort((a,b)=>a.name.localeCompare(b.name));
  const maxSiteW = Math.max(1, ...sites.map(s => s.rows.reduce((x,r)=>x+(r.online?r.totalW:0),0)));

  // ── Optimierungsvorschläge ────────────────────────────────────────
  const suggestions = [];
  // Monatliche Ersparnis in Euro berechnen: saveW Watt für hoursDay Stunden/Tag
  const eurSave = (saveW, hoursDay=24) => {
    const eur = saveW * hoursDay * 30 / 1000 * eurPerKwh;
    return eur >= 0.01 ? `~${eur.toFixed(2)} €/Monat` : null;
  };

  // 1. TX-Power Reduktion: APs mit wenig Clients
  const sparseAPs = deviceRows.filter(r => r.type==='ap' && r.online && (S.wlanClients[r.d.id]||0) <= 2);
  if (sparseAPs.length) {
    const saveW = sparseAPs.length * 3;
    suggestions.push({
      icon:'fa-wifi', cls:'esi-green',
      title:'TX-Power-Reduktion möglich',
      desc: `${sparseAPs.length} Access Point${sparseAPs.length>1?'s haben':'hat'} ≤ 2 WLAN-Clients. `+
            `Durch Reduktion der Sendeleistung (z. B. auf 50 %) lassen sich ca. ~${saveW} W einsparen.`,
      badge: `~${saveW} W`, eur: eurSave(saveW),
    });
  }

  // 2. Zeitplan für APs nachts (6 h Abschaltung/Dimmung)
  const apCount = deviceRows.filter(r => r.type==='ap' && r.online).length;
  if (apCount > 0) {
    const saveW = Math.round(apCount * ENERGY_BASE.ap * 0.5);
    suggestions.push({
      icon:'fa-clock', cls:'esi-blue',
      title:'WLAN-Zeitplan einrichten',
      desc: `Ein Nacht-Zeitplan (00:00–06:00) für ${apCount} Access Point${apCount>1?'s':''} `+
            `reduziert den Verbrauch um ca. ${saveW} W während 6 h/Tag.`,
      badge: `${apCount} APs`, eur: eurSave(saveW, 6),
    });
  }

  // 3. PoE-Zeitplan für Bürozeiten (12 h Off außerhalb der Arbeitszeit)
  const poeActiveCount = (S.lldpNeighbors||[]).filter(p=>(parseFloat(p.poePower)||0)>0).length;
  if (poeActiveCount > 0) {
    suggestions.push({
      icon:'fa-plug', cls:'esi-amber',
      title:'PoE-Zeitplan für Bürozeiten',
      desc: `${poeActiveCount} PoE-Port${poeActiveCount>1?'s liefern':'liefert'} zusammen ${totalPoeW.toFixed(1)} W. `+
            `Ein Schedule (Mo–Fr 07:00–19:00) spart außerhalb der Bürozeiten ~${(totalPoeW*12/24).toFixed(0)} Wh/Tag.`,
      badge: `${totalPoeW.toFixed(0)} W`, eur: eurSave(totalPoeW, 12),
    });
  }

  // 4. Hohe PoE-Einzelverbraucher (> 20 W pro Port)
  const heavyPoe = (S.lldpNeighbors||[]).filter(p=>(parseFloat(p.poePower)||0)>20);
  if (heavyPoe.length) {
    const totalSaveW = heavyPoe.reduce((s,p)=>s+Math.max(0,parseFloat(p.poePower)-15),0);
    const names = [...new Set(heavyPoe.map(p=>p._deviceName||''))].filter(Boolean).slice(0,3).join(', ');
    suggestions.push({
      icon:'fa-bolt', cls:'esi-amber',
      title:`${heavyPoe.length} PoE-Port${heavyPoe.length>1?'s':''} mit hohem Verbrauch (> 20 W)`,
      desc: `Prüfen Sie ob Geräte an diesen Ports (${names||'–'}) durch effizientere Alternativen `+
            `ersetzt werden können. Potenzial bei Reduktion auf 15 W: ~${totalSaveW.toFixed(0)} W.`,
      badge: `${heavyPoe.length} Ports`, eur: eurSave(totalSaveW),
    });
  }

  // 5. 2.4 GHz-dominierte APs → Band-Steering-Potenzial
  const apBy24 = {}, apByTotal = {};
  for (const st of (S.wlanStations||[])) {
    const id = st._deviceId||st.deviceId; if(!id) continue;
    apByTotal[id] = (apByTotal[id]||0)+1;
    if ((st.band||'').includes('24')) apBy24[id] = (apBy24[id]||0)+1;
  }
  const band24APs = deviceRows.filter(r => r.type==='ap' && r.online &&
    (apByTotal[r.d.id]||0) >= 3 && (apBy24[r.d.id]||0) / apByTotal[r.d.id] > 0.6);
  if (band24APs.length) {
    suggestions.push({
      icon:'fa-signal', cls:'esi-purple',
      title:`Band-Steering aktivieren (${band24APs.length} AP${band24APs.length>1?'s':''})`,
      desc: `${band24APs.length} Access Point${band24APs.length>1?'s haben':'hat'} > 60 % der Clients auf 2.4 GHz. `+
            `2.4 GHz belegt mehr Airtime pro Client → höhere AP-Auslastung. `+
            `Band-Steering auf 5 GHz/6 GHz spart Energie und verbessert den Durchsatz.`,
      badge: `${band24APs.length} APs`, eur: null,
    });
  }

  // 6. Mobile WAN-Verbindungen (Modem ~6 W Mehrverbrauch ggü. Kabel)
  const mobileWans = (S.wanInterfaces||[]).filter(w =>
    w.mobileModemSignalDecibelMw != null ||
    /mobile|lte|4g|5g|umts|gsm/i.test(w.connectionType||''));
  const mobileDevIds = [...new Set(mobileWans.map(w=>w._deviceId||w.deviceId).filter(Boolean))];
  if (mobileDevIds.length) {
    const saveW = mobileDevIds.length * 6;
    suggestions.push({
      icon:'fa-tower-broadcast', cls:'esi-blue',
      title:`${mobileDevIds.length} Gerät${mobileDevIds.length>1?'e nutzen':'e nutzt'} mobiles WAN`,
      desc: `LTE/5G-Modems verbrauchen ~6 W mehr als kabelgebundene Anschlüsse (DSL/Glasfaser). `+
            `Falls ein Kabelanschluss verfügbar ist, lohnt sich ein Wechsel.`,
      badge: `${mobileDevIds.length} Geräte`, eur: eurSave(saveW),
    });
  }

  // 7. Veraltete Firmware (fehlende Power-Management-Verbesserungen)
  const obsoleteFw = deviceRows.filter(r=>r.d.firmwareState==='OBSOLETE' && r.online);
  if (obsoleteFw.length) {
    suggestions.push({
      icon:'fa-microchip', cls:'esi-purple',
      title:`Firmware-Update für ${obsoleteFw.length} Gerät${obsoleteFw.length>1?'e':''}`,
      desc: `Neuere Firmware enthält oft verbesserte Power-Management-Features und Bugfixes. `+
            `${obsoleteFw.length} Online-Gerät${obsoleteFw.length>1?'e haben':'hat'} eine veraltete Firmware (OBSOLETE).`,
      badge: `${obsoleteFw.length} Geräte`, eur: null,
    });
  }

  // 8. Offline-Geräte (Info – könnten noch Strom ziehen)
  const offlineCount = deviceRows.filter(r=>!r.online).length;
  if (offlineCount > 0) {
    suggestions.push({
      icon:'fa-power-off', cls:'esi-purple',
      title:`${offlineCount} Gerät${offlineCount>1?'e offline':' offline'}`,
      desc: `Offline-Geräte werden im Verbrauch nicht gezählt. Prüfen Sie, ob diese physisch `+
            `ausgeschaltet sind oder ein Problem vorliegt – im letzteren Fall ziehen sie ggf. noch Strom.`,
      badge: `${offlineCount} Geräte`, eur: null,
    });
  }

  // ── Rendern ───────────────────────────────────────────────────────
  wrap.innerHTML = `

    <!-- KPI-Zeile -->
    <div class="energy-kpi-row">
      <div class="energy-kpi">
        <div class="energy-kpi-icon eki-power"><i class="fa-solid fa-bolt"></i></div>
        <div class="energy-kpi-val" style="color:var(--amber)">${totalW.toFixed(0)} <span style="font-size:16px;font-weight:400">W</span></div>
        <div class="energy-kpi-lbl">Echtzeit-Verbrauch</div>
        <div class="energy-kpi-sub">davon ${totalPoeW.toFixed(0)} W PoE</div>
      </div>
      <div class="energy-kpi">
        <div class="energy-kpi-icon eki-co2"><i class="fa-solid fa-leaf"></i></div>
        <div class="energy-kpi-val" style="color:var(--green)">${co2PerDay>=1000?(co2PerDay/1000).toFixed(2)+' <span style="font-size:16px;font-weight:400">kg</span>':co2PerDay.toFixed(0)+' <span style="font-size:16px;font-weight:400">g</span>'}</div>
        <div class="energy-kpi-lbl">CO₂ pro Tag</div>
        <div class="energy-kpi-sub">@ ${CO2_PER_KWH} g/kWh (DE-Strommix)</div>
      </div>
      <div class="energy-kpi">
        <div class="energy-kpi-icon eki-cost"><i class="fa-solid fa-euro-sign"></i></div>
        <div class="energy-kpi-val" style="color:var(--accent2)">${costMonth.toFixed(2)} <span style="font-size:16px;font-weight:400">€</span></div>
        <div class="energy-kpi-lbl">Kosten / Monat</div>
        <div class="energy-kpi-sub">@ ${EUR_PER_KWH} €/kWh</div>
      </div>
      <div class="energy-kpi">
        <div class="energy-kpi-icon eki-poe"><i class="fa-solid fa-plug"></i></div>
        <div class="energy-kpi-val" style="color:var(--blue)">${totalPoeCount}</div>
        <div class="energy-kpi-lbl">PoE-Ports aktiv</div>
        <div class="energy-kpi-sub">${totalPoeW.toFixed(1)} W gesamt</div>
      </div>
      <div class="energy-kpi">
        <div class="energy-kpi-icon eki-dev"><i class="fa-solid fa-server"></i></div>
        <div class="energy-kpi-val" style="color:var(--purple)">${devs.filter(d=>isOnline(d)).length}</div>
        <div class="energy-kpi-lbl">Geräte online</div>
        <div class="energy-kpi-sub">von ${devs.length} gesamt</div>
      </div>
    </div>

    <!-- Pro Standort -->
    <div>
      <div class="energy-section-title"><i class="fa-solid fa-location-dot"></i>Verbrauch pro Standort</div>
      <div class="energy-sites-grid">
        ${sites.map(s => {
          const sW   = s.rows.reduce((x,r)=>x+(r.online?r.totalW:0),0);
          const sPoe = s.rows.reduce((x,r)=>x+(r.online?r.poeW:0),0);
          const sCo2 = (sW*24/1000)*CO2_PER_KWH;
          const pct  = Math.round((sW/maxSiteW)*100);
          const onl  = s.rows.filter(r=>r.online).length;
          const aps  = s.rows.filter(r=>r.type==='ap').length;
          const rtrs = s.rows.filter(r=>r.type==='router').length;
          const swts = s.rows.filter(r=>r.type==='switch').length;
          return `<div class="energy-site-card">
            <div class="energy-site-name"><i class="fa-solid fa-location-dot"></i>${escHtml(s.name)}</div>
            <div class="energy-site-stats">
              <div class="energy-site-stat">
                <div class="energy-site-stat-val" style="color:var(--amber)">${sW.toFixed(0)} W</div>
                <div class="energy-site-stat-lbl">Verbrauch</div>
              </div>
              <div class="energy-site-stat">
                <div class="energy-site-stat-val" style="color:var(--green)">${sCo2>=1000?(sCo2/1000).toFixed(1)+' kg':sCo2.toFixed(0)+' g'}</div>
                <div class="energy-site-stat-lbl">CO₂/Tag</div>
              </div>
              <div class="energy-site-stat">
                <div class="energy-site-stat-val" style="color:var(--blue)">${sPoe.toFixed(1)} W</div>
                <div class="energy-site-stat-lbl">PoE</div>
              </div>
              <div class="energy-site-stat">
                <div class="energy-site-stat-val" style="color:var(--text2)">${onl}/${s.rows.length}</div>
                <div class="energy-site-stat-lbl">Online</div>
              </div>
            </div>
            <div class="energy-bar-wrap"><div class="energy-bar" style="width:${pct}%"></div></div>
            <div class="energy-note" style="margin-top:8px">
              ${rtrs?`<i class="fa-solid fa-shield-halved" style="color:var(--accent2)"></i> ${rtrs} Router &nbsp;`:''}
              ${aps?`<i class="fa-solid fa-wifi" style="color:var(--teal)"></i> ${aps} APs &nbsp;`:''}
              ${swts?`<i class="fa-solid fa-diagram-project" style="color:var(--blue)"></i> ${swts} Switches`:''}
            </div>
          </div>`;
        }).join('')}
      </div>
    </div>

    <!-- Gerätdetails-Tabelle -->
    <div>
      <div class="energy-section-title"><i class="fa-solid fa-table-list"></i>Gerätedetails</div>
      <div style="background:var(--card);border:1px solid var(--border);border-radius:10px;overflow:hidden;">
        <table class="energy-dev-table">
          <thead><tr>
            <th>Gerät</th><th>Standort</th><th>Typ</th>
            <th>Grundlast</th><th>PoE</th><th>Gesamt</th><th>Status</th>
          </tr></thead>
          <tbody>
            ${deviceRows
              .sort((a,b)=>b.totalW-a.totalW)
              .map(r=>`<tr>
                <td style="font-weight:600">${escHtml(deviceName(r.d))}</td>
                <td class="muted">${escHtml(r.site)}</td>
                <td>${energyTypeBadge(r.type)}</td>
                <td class="muted">${r.online?r.baseW+' W':'–'}</td>
                <td>${r.poeW>0?`<span style="color:var(--blue);font-weight:600">${r.poeW.toFixed(1)} W</span>`:'<span class="muted">–</span>'}</td>
                <td><span style="font-weight:700;color:${r.online?'var(--amber)':'var(--text3)'}">${r.online?r.totalW.toFixed(0)+' W':'offline'}</span></td>
                <td>${r.online?'<span class="sdot sdot-green">Online</span>':'<span class="sdot sdot-red">Offline</span>'}</td>
              </tr>`).join('')}
          </tbody>
        </table>
      </div>
    </div>

    <!-- Optimierungsvorschläge -->
    <div>
      <div class="energy-section-title"><i class="fa-solid fa-lightbulb"></i>Optimierungsvorschläge</div>
      ${suggestions.length ? `<div class="energy-suggest-list">
        ${suggestions.map(s=>`<div class="energy-suggest">
          <div class="energy-suggest-icon ${s.cls}"><i class="fa-solid ${s.icon}"></i></div>
          <div class="energy-suggest-body">
            <div class="energy-suggest-title">${s.title}</div>
            <div class="energy-suggest-desc">${s.desc}</div>
          </div>
          <div style="display:flex;flex-direction:column;gap:4px;align-self:flex-start;flex-shrink:0;text-align:right">
            <div class="energy-suggest-badge">${s.badge}</div>
            ${s.eur ? `<div class="energy-suggest-badge" style="background:rgba(160,237,58,.15);color:var(--green);border-color:rgba(160,237,58,.25)">${s.eur}</div>` : ''}
          </div>
        </div>`).join('')}
      </div>` : `<div class="empty-state" style="padding:30px"><i class="fa-solid fa-circle-check" style="color:var(--green)"></i><h3>Alles optimal</h3><p>Keine Verbesserungsvorschläge.</p></div>`}
    </div>

    <div class="energy-note" style="text-align:center;padding-bottom:8px">
      Grundlastschätzung: Router ${ENERGY_BASE.router} W · Access Point ${ENERGY_BASE.ap} W · Switch ${ENERGY_BASE.switch} W.
      PoE-Werte stammen aus dem Live-Monitoring (lan_info_json).
      CO₂: ${CO2_PER_KWH} g/kWh · Strompreis: ${eurPerKwh.toFixed(4)} €/kWh.
    </div>
  `;
}
</script>
</body>
</html>
